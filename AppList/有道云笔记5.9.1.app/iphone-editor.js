/* iphone 5.2.0 - editor 0.5.7.1 */
this.JST=this.JST||{},this.JST["templates/common/editor_button"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<button class="button '+(null==(__t=className)?"":__t)+'" title="'+(null==(__t=label)?"":__t)+'">'+(null==(__t=label)?"":__t)+"</button>";return __p},this.JST["templates/common/editor_menu"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj){__p+='<ul class="menu '+(null==(__t=className)?"":__t)+'">\n    ';for(item in items)__p+='\n        <li data-value="'+(null==(__t=item)?"":__t)+'" class="menu-item">'+(null==(__t=items[item])?"":__t)+"</li>\n    ";__p+="\n</ul>"}return __p},this.JST["templates/common/editor_panel"]=function(obj){obj||(obj={});var __p="";_.escape;with(obj)__p+='<div class="panel"></div>\n<div class="float-panel"></div>';return __p},this.JST["templates/common/editor_select"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<div class="select '+(null==(__t=className)?"":__t)+'" title="'+(null==(__t=label)?"":__t)+'"><span class="value"></span><span class="arrow-down"></span></div>';return __p},this.JST["templates/common/editor_table"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj){__p+='<div class="table-status">Insert Table</div>\n';for(var i=0;i<row;i++){__p+="\n    ";for(var j=0;j<col;j++)__p+='\n        <div class="table-cell" data-row="'+(null==(__t=i)?"":__t)+'" data-col="'+(null==(__t=j)?"":__t)+'">'+(null==(__t=i)?"":__t)+(null==(__t=j)?"":__t)+"</div>\n    ";__p+="\n"}}return __p},this.JST["templates/common/table_insert"]=function(obj){obj||(obj={});var __p="";_.escape,Array.prototype.join;with(obj){__p+='<table class="new_insert" border="1" cellpadding="2" cellspacing="0">\n    ';for(var i=0;i<=row;i++){__p+="\n        <tr>\n            ";for(var j=0;j<=col;j++)__p+='\n                <td valign="top"><div><br /></div></td>\n            ';__p+="\n        </tr>\n    "}__p+="\n</table>"}return __p},this.JST["templates/iphone/attachment_input"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;Array.prototype.join;with(obj)__p+='<img class="editor-attachment" data-media-type="attachment" src="./wf_attachment_default.png" alt="'+__e(fileName)+'" data-file-name="'+__e(fileName)+'" data-file-length="'+(null==(__t=length)?"":__t)+'" data-yne-orig-src="'+(null==(__t=origSrc)?"":__t)+'" data-res-id="'+(null==(__t=resId)?"":__t)+'" ',distinguish&&(__p+=' data-distinguish="'+(null==(__t=distinguish)?"":__t)+'" '),__p+=" />";return __p},this.JST["templates/iphone/attachment_insert"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<img src="'+(null==(__t=image)?"":__t)+'" alt="'+__e(fileName)+'" data-file-name="'+__e(fileName)+'" data-file-length="'+(null==(__t=length)?"":__t)+'" data-res-id="'+(null==(__t=resId)?"":__t)+'" data-media-type="attachment" class="editor-attachment" />';return __p},this.JST["templates/iphone/attachment_output"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;Array.prototype.join;with(obj)__p+='<img src="'+(null==(__t=src)?"":__t)+'" filelength="'+(null==(__t=fileLength)?"":__t)+'" filename="'+__e(fileName)+'" path="'+(null==(__t=resId)?"":__t)+'" data-media-type="attachment" ',distinguish&&(__p+='distinguish="'+(null==(__t=distinguish)?"":__t)+'" '),__p+=" />";return __p},this.JST["templates/iphone/handwrite_small_image"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<img src="'+(null==(__t=imgSrc)?"":__t)+'" data-handwrite-id="'+(null==(__t=id)?"":__t)+'" class="ynote-handwrite-item" />';return __p},this.JST["templates/iphone/todo_group"]=function(obj){obj||(obj={});var __t,__p="";_.escape;with(obj)__p+='<img src="DEFAULTIMAGE" data-media-type="todogroup" data-note-id="'+(null==(__t=noteUniqueId)?"":__t)+'" data-group-id="'+(null==(__t=groupId)?"":__t)+'"/>';return __p},function(a){"use strict";if(!a.define){var b,c={},d=null,e=function(a){return"[object Function]"===Object.prototype.toString.call(a)},f=function(a){var b=c[a];if(!b)throw new Error("Module "+a+" is not defined.");return b.inited===!1&&g(a),b.ret},g=function(a){var b,d={},g=c[a],h=g.factory;e(h)?(b=h.apply(void 0,[f,d,void 0]),g.ret=void 0===b?d:b):g.ret=h,g.inited=!0},h=a.document.getElementsByTagName("script"),i=h.length;for(b=0;i>b&&!d;b++)d=h[b].getAttribute("data-main");if(!d)throw new Error("No data-main attribute in script tag.");a.define=function(a,b,f){if(c[a])throw new Error("Module "+a+" has been defined already.");e(b)&&(f=b),c[a]={factory:f,inited:!1},a===d&&g(a)}}}(window),define("core/Base",function(a){var b=a("core/Class"),c=a("core/Events"),d=b.extend(c);return d}),define("core/Class",function(a){function b(a){var b=this;b.options=c.extend({},a),b.initialize.apply(b,arguments)}var c=a("core/underscore"),d=function(a,b){var d,e,f=this;return d=a&&c.has(a,"constructor")?a.constructor:function(){return f.apply(this,arguments)},c.extend(d,f,b),e=function(){this.constructor=d},e.prototype=f.prototype,d.prototype=new e,a&&c.extend(d.prototype,a),d.__super__=f.prototype,d};return b.prototype.initialize=function(){},b.extend=d,b}),define("core/Events",function(a){var b,c=a("core/underscore"),d=Array.prototype.slice,e=/\s+/,f=function(a,b,c,d){var f,g,h;if(!c)return!0;if(e.test(c)){for(f=c.split(e),h=f.length,g=0;h>g;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},g=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}},h={listenTo:"on",listenToOnce:"once"};return b={on:function(a,b,c){var d=this;return f(d,"on",a,[b,c])&&b?(d.__events||(d.__events={}),d.__events[a]||(d.__events[a]=[]),d.__events[a].push({callback:b,context:c,ctx:c||d}),d):d},once:function(a,b,d){var e,g=this;return f(g,"once",a,[b,d])&&b?(e=c.once(function(){g.off(a,e),b.apply(g,arguments)}),e._callback=b,g.on(a,e,d)):g},off:function(a,b,d){var e,g,h,i,j,k,l,m,n=this;if(!n.__events||!f(n,"off",a,[b,d]))return n;if(!a&&!b&&!d)return n.__events={},n;for(i=a?[a]:c.keys(n.__events),j=0,k=i.length;k>j;j++)if(a=i[j],h=n.__events[a]){if(n.__events[a]=e=[],b||d)for(l=0,m=h.length;m>l;l++)g=h[l],(b&&b!==g.callback&&b!==g.callback._callback||d&&d!==g.context)&&e.push(g);e.length||delete n.__events[a]}return n},trigger:function(a){var b,c,e,h=this;return h.__events?(b=d.call(arguments,1),f(h,"trigger",a,b)?(c=h.__events[a],e=h.__events.all,c&&g(c,b),e&&g(e,arguments),h):h):h},stopListening:function(a,b,c){var d,e,f=this,g=f.__listeners;if(!g)return f;d=!b&&!c,"object"==typeof b&&(c=f),a&&((g={})[a.__listenerId]=a);for(e in g)g[e].off(b,c,f),d&&delete f.__listeners[e];return f}},c.each(h,function(a,d){b[d]=function(b,d,e){var f,g,h=this;return f=h.__listeners||(h.__listeners={}),g=b.__listenerId||(b.__listenerId=c.uniqueId("l")),f[g]=b,"object"==typeof d&&(e=h),b[a](d,e,h),h}}),b.bind=b.on,b.unbind=b.off,b}),define("core/arr/remove",function(){return function(a,b,c){if(a&&a.length){var d,e=[];if(c===!0){for(d=a.length-1;d>=0;d--)a[d]===b&&(a.splice(d,1),e.push(d));return e.reverse()}return b>=0&&b<a.length?a.splice(b,1):void 0}}}),define("core/console",function(){var a,b=this,c=function(){},d={DEBUG:!1,EXPORTS:b.JTK_EXPORTS||{},log:c,warn:c,error:c};return b.DEBUG!==!0?d:b.console&&b.console.log?(a=b.console,d.DEBUG=!0,d.log=function(){var b,c=[],d=arguments.length;for(b=0;d>b;b++)c.push(String(arguments[b]));a.log(c.join(";"))},d.warn=function(a,b){var c=this;if(b=b?"["+b+"]":"",c.log(b+"WARN: "+a+"."),"object"==typeof a)throw a},d.error=function(a,b){var c=this;if(b=b?"["+b+"]":"",c.log(b+"ERROR: "+a+"!"),"object"==typeof a)throw a},d):d}),define("core/fn/Until",function(){function a(a){var b=this;b._init(a)}return a.STATUS={NOT_START:1,RUNNING:2,STOPPED:3,COMPLETE:4},a.prototype._init=function(b){var c=this;c._interval=b.interval||50,c._tryTimes=b.tryTimes||5,c._counter=0,c._status=a.STATUS.NOT_START,c._run=function(){if(c._status!==a.STATUS.RUNNING){c._isRunning=a.STATUS.RUNNING;var d=!1;try{d=b.condition(c._counter)}catch(e){}if(c._counter++,d===!0){try{b.task()}catch(f){}return void(c._status=a.STATUS.COMPLETE)}c._counter<c._tryTimes&&(c._timeout=window.setTimeout(c._run,c._interval))}}},a.prototype.startRun=function(){var a=this;a._run()},a.prototype.stopRun=function(){var b=this;window.clearTimeout(b._timeout),b._timeout=null,b._status=a.STATUS.STOPPED},a.prototype.hasRunTask=function(){return this._status===a.STATUS.COMPLETE},a.prototype.getStatus=function(){return this._status},a.prototype.finalize=function(){var a=this;a.stopRun(),a=a._run=null},a.create=function(b,c,d,e){return b&&c?new a({task:b,condition:c,interval:d,tryTimes:e}):void 0},a}),define("core/math/unique",function(a){var b=String((new Date).getTime()),c=a("core/underscore");return function(a){return a=a||"",c.uniqueId(a+b)}}),define("core/obj/guid",function(a){var b=a("core/underscore"),c=a("core/math/unique");return{auto:function(a){var b=this;if(!a)return!1;if(b.has(a))return a.__guid;try{a.__guid=c("guid_")}catch(d){return!1}return a.__guid},has:function(a){return a&&a.__guid&&b.isString(a.__guid)&&b.has(a,"__guid")?!0:!1},get:function(a){var b=this;return b.has(a)?a.__guid:!1},set:function(a,c,d){var e,f=this;if(!a||!b.isString(c))return!1;if(e=f.has(a),!e||e&&d===!0)try{a.__guid=c}catch(g){return!1}return a.__guid}}}),define("core/reg/encode",function(){return function(a){return String(a).replace(/([.*?\^$=!:{}()|\[\]\/\\+])/g,"\\$1")}}),define("core/str/camelize",function(a){var b=a("core/str/trim");return function(a){return null==a?"":b(String(a)).replace(/[\-_\s]+([^\-])?/g,function(a,b){return b?b.toUpperCase():""})}}),define("core/str/dasherize",function(a){var b=a("core/str/trim");return function(a){return b(a).replace(/([A-Z])/g,"-$1").replace(/[\-_\s]+/g,"-").toLowerCase()}}),define("core/str/endsWith",function(){return function(a,b){if(""===b)return!0;if(null==b||null==a)return!1;var c=a.length-b.length;return c>=0&&a.indexOf(b,c)===c}}),define("core/str/startsWith",function(){return function(a,b){return""===b?!0:null==a||null==b?!1:0===String(a).indexOf(String(b))}}),define("core/str/times",function(){return function(a,b){return null==a||""===a?"":1>b?"":new Array(b+1).join(String(a))}}),define("core/str/trim",function(){return function(a){return null==a||""===a?"":String(a).replace(/^[\s\t\xA0\u3000]+/,"").replace(/[\s\t\xA0\u3000]+$/,"")}}),define("core/underscore",function(a){var b=a("core/console"),c=this._||this.underscore;return c?(b.EXPORTS.underscore===!1&&c.noConflict&&(c=c.noConflict()),c):void b.error("no underscore library","core/underscore.js")}),define("editor/cmd/CmdBall",function(a){function b(a,b,d,e){var f=this;f.name=a,f.value=b,f.isNative=d===!0,f.callback=c.isFunction(e)?e:null}var c=a("core/underscore");return b.prototype.isCmdBall=!0,b.create=function(a,d,e,f){return a&&a.isCmdBall?a:a&&c.isString(a)?new b(a,d,e,f):void 0},b.clone=function(a){return a&&a.isCmdBall?new b(a.name,a.value,a.isNative,a.callback):b.create.apply(b,arguments)},b}),define("editor/cmd/Commander",function(a){var b,c=a("core/underscore"),d=a("web/console"),e=a("core/Class"),f=a("editor/cmd/CmdBall");return b=e.extend({initialize:function(a){var b=this;b.options=a,b.editor=b.options.editor,b._commands={}},addCmd:function(a){var b=this,c=b._commands;if(a&&a.name&&a.action){if(c[a.name])return void d.warn("command has defined: "+a.name,"editor/cmd/Commander");c[a.name]=a}},addCmds:function(a){var b=this;c.each(a,function(a){b.addCmd(a)})},resetCmds:function(){var a=this,b=a._commands;c.each(b,function(b){b&&b.reset&&b.reset.call(a)})},exec:function(a,b,c,e){var g,h=this,i=h._commands,j=f.create(a,b,c,e),k=h.editor;if(j&&j.name){if(j.isNative)return k.trigger("edit"),g=h.execNative(j.name,j.value),j.callback&&j.callback(g),g;if(i[j.name])return i[j.name].triggersEdit&&k.trigger("edit"),d.log("exec NOT-native cmd: "+j.name),g=i[j.name].action.call(h,j.value),j.callback&&j.callback(g),g}d.error("Commander->commands["+j.name+"] is undefined")},execNative:function(a,b){var c=this,e=c.editor.document;return d.log("exec NATIVE cmd: "+a),e.execCommand(a,!1,b||"")}})}),define("editor/dom/isZeroRect",function(){return function(a){return a?null==a.top||null==a.bottom||null==a.left||null==a.right?!0:0===a.top&&0===a.bottom&&0===a.left&&0===a.right:!0}}),define("editor/dom/mediaType",function(a){var b=a("web/dom/dataset"),c=a("web/dom/className"),d=a("web/dom/isTag");return{getMediaType:function(a){return(b.get(a,"mediaType")||"").toLowerCase()},isImage:function(a){return d(a,"img")},isLocalImage:function(a){var b=this;return b.isImage(a)&&0===a.src.indexOf("file://")},isImageType:function(a){var b,d=this;if(d.isImage(a))return b=d.getMediaType(a),"image"===b?!0:b?!1:!c.has("editor-attachment")},isAttachmentType:function(a){var b,d=this;if(d.isImage(a))return b=d.getMediaType(a),"attachment"===b?!0:b?!1:c.has("editor-attachment")},isTodoType:function(a){var b=this;if(b.isImage(a))return"todo"===b.getMediaType(a)},isHandwriteType:function(a){var b=this;if(b.isImage(a))return"handwrite"===b.getMediaType(a)},isHandwriteTypeEditable:function(a){var c=this;if(c.isHandwriteType(a))return!!b.get(a,"resHandwrite")}}}),define("editor/filters/FilterManager",function(a){var b=a("core/underscore"),c=a("core/Class");return c.extend({initialize:function(a){var b=this;b.options=a,b.editor=b.options.editor,b._filters=[]},_addOne:function(a){a&&a.name&&a.action&&this._filters.push(a)},add:function(a){var c=this;a&&a.name&&a.action?c._addOne(a):a&&a.length&&b.each(a,function(a){c._addOne(a)})},exec:function(a){var c=this,d=b.toArray(arguments),e=c._filters,f=a&&a.length;d.shift(),b.each(e,function(e){f&&b.contains(a,e.name)||e.action.apply(c,d)})},execOnly:function(a){var c=this,d=c._filters,e=b.toArray(arguments);e.shift(),b.each(d,function(d){b.contains(a,d.name)&&d.action.apply(c,e)})}})}),define("editor/fn/checkAndRunOne",function(a){var b=a("core/underscore");return function(a,c,d){var e,f,g;return d=d||null,g=b.some(a,function(a,b){var g=a.check.apply(d,c);if(g)return g=a.action.apply(d,[g].concat(c)),g?(e=b,f=g,!0):!1}),{name:e,result:f,success:g}}}),define("editor/math/attachUniqueId",function(a){var b=a("core/math/unique");return function(){return b("attach")}}),define("editor/math/handwriteAreaUniqueId",function(a){var b=a("core/math/unique");return function(){return b("hwa")}}),define("editor/math/noteUniqueId",function(a){var b=a("core/math/unique");return function(){return b("note")}}),define("editor/math/todoUniqueId",function(a){var b=a("core/math/unique");return function(){return b("todo")}}),define("editor/queryCmd/getRange",function(){return{name:"getRange",action:function(){return this.editor.getRange()}}}),define("editor/queryCmd/queryStyle",function(){return{name:"queryStyle",action:function(){var a,b=this,c=b.editor,d=c.getRange(),e=c.area.window.getComputedStyle,f=null;return d?(a=d.startContainer,3===a.nodeType&&(a=a.parentNode),f=e(a)):f=e(c.article),f}}}),define("editor/str/base64",function(){return{encode:function(a){return window.btoa(window.unescape(encodeURIComponent(a)))},decode:function(a){return decodeURIComponent(window.escape(window.atob(a)))}}}),define("editor/str/uniqueSuffix",function(a){var b=a("core/underscore");return{isDataUrl:function(a){return/^data:/i.test(a)},has:function(a){return/\?\d+$/.test(String(a))},remove:function(a){return String(a).replace(/\?\d+$/,"")},add:function(a,c){var d=this;return a=String(a),d.isDataUrl(a)?a:c!==!0&&d.has(a)?a:(a=d.remove(a),a+"?"+b.uniqueId())}}}),define("editor/str/uriReg",function(a){var b=a("core/str/startsWith"),c=a("core/str/trim");return{test:function(a){var b=/(https?:\/\/|www\.|ssh:\/\/|ftp:\/\/)[a-z0-9&_+\-\?\/\.=\#,:]+/i,d=/[a-z0-9_+\-\.]+@[a-z0-9_+\-\.]+/i;return a=c(a+""),b.test(a)||d.test(a)||!1},fullMatch:function(a){var d=/^(https?:\/\/|www\.|ssh:\/\/|ftp:\/\/)[a-z0-9&_+\-\?\/\.=\#,:]+$/i,e=/^[a-z0-9_+\-\.]+@[a-z0-9_+\-\.]+$/i;return a=c(a+""),d.test(a)?{mail:!1,fullURI:b(a.toLowerCase(),"www.")?"http://"+a:a}:(b(a.toLowerCase(),"mailto:")&&(a=a.replace(/^mailto:/i,""),a=c(a)),e.test(a)?{mail:!0,fullURI:"mailto:"+a}:void 0)},matchEnd:function(a){var c,d,e=/(https?:\/\/|www\.|ssh:\/\/|ftp:\/\/)[a-z0-9&_+\-\?\/\.=\#,:]+$/i,f=/[a-z0-9_+\-\.]+@[a-z0-9_+\-\.]+$/i;return a+="",(c=e.exec(a))?(d=c[0],{mail:!1,fullURI:b(d.toLowerCase(),"www.")?"http://"+d:d,result:c}):(c=f.exec(a),c?(d=c[0],{mail:!0,fullURI:"mailto:"+d,result:c}):void 0)},exec:function(a,c,d){a+="",d=d>0?d:0;var e,f,g=/(https?:\/\/|www\.|ssh:\/\/|ftp:\/\/)[a-z0-9&_+\-\?\/\.=\#,:]+/gi,h=/[a-z0-9_+\-\.]+@[a-z0-9_+\-\.]+/gi,i=function(a){var c,d;return(c=g.exec(a))?(d=c[0],{mail:!1,index:c.index,uri:d,fullURI:b(d.toLowerCase(),"www.")?"http://"+d:d,result:c}):(c=h.exec(a),c?(d=c[0],{mail:!0,index:c.index,uri:d,fullURI:"mailto:"+d,result:c}):void 0)};if(g.lastIndex=d,h.lastIndex=d,c!==!0)return i(a);for(f=[],e=i(a);e;)f.push(e),e=i(a);return f},replace:function(a,d){var e=/(https?:\/\/|www\.|ssh:\/\/|ftp:\/\/)[a-z0-9&_+\-\?\/\.=\#,:]+/gi,f=/[a-z0-9_+\-\.]+@[a-z0-9_+\-\.]+/gi;return a=c(a+""),a=a.replace(e,function(a){var c=d({mail:!1,fullURI:b(a.toLowerCase(),"www.")?"http://"+a:a,match:a});return null==c?a:c}),a=a.replace(f,function(a){var b=d({mail:!0,fullURI:"mailto:"+a,match:a});return null==b?a:b})}}}),define("editor/view/AreaView",function(a){var b=a("core/underscore"),c=a("web/util/View"),d=a("web/event/events"),e=c.extend({tagName:"article",className:"area-wrap",window:null,getArticle:function(){var a=this;return"article"===a.tagName?a.el:a.window.document.querySelector(".editor-area")},bindArticleEvent:function(){var a=this,c=a.getArticle();b.each(["DOMSubtreeModified","paste"],function(b){var e,f=a.trigger.bind(a,b);"DOMSubtreeModified"===b&&window.MutaionObserver?(e=new window.MutationObserver(function(a){a.forEach(function(a){("attributes"!==a.type||a.target!==c)&&f.apply(null,arguments)})}),e.observe(c,{childList:!0,characterData:!0,attributes:!0,subtree:!0})):d.bind(c,b,f)})},bindEvent:function(){var a=this,c=a.window.document;b.each(["selectionchange","keydown"],function(b){d.bind(c,b,a.trigger.bind(a,b))}),a.bindArticleEvent(),a.trigger("ready")}});return e}),define("editor/view/EditorView",function(a){var b,c=a("core/underscore"),d=a("web/dom/className"),e=a("editor/math/noteUniqueId"),f=a("editor/math/attachUniqueId"),g=a("editor/math/todoUniqueId"),h=a("web/util/View"),i=a("web/console"),j=a("web/dom/doc"),k=a("web/dom/win"),l=a("web/dom/parseHTML"),m=a("web/dom/position"),n=a("editor/cmd/Commander"),o=a("web/event/events"),p=a("web/bom/userAgent");return b=h.extend({el:"null",tagName:"div",className:"yne-container",defaults:{panelItems:[],filters:[],commands:[],plugins:[]},panel:null,commander:null,area:null,article:null,isReadOnlyMode:!1,attachments:null,selection:null,document:null,topHint:null,_isMonitorChange:!1,_isReady:!1,_onReadyTasks:null,plugins:null,noteUniqueId:e(),bridge:null,initialize:function(){var a=this,b=a.options;return c.defaults(b,a.defaults),c.isString(b.container)&&(b.container=document.querySelector(b.container)),b.container?(a.el=b.container,d.add(a.el,a.className),a.features=b.features,a.supports=b.supports,a._onReadyTasks=[],a._undoLengthUpperLimit=4e5,a._undoLengthWarningLimit=399e3,a._undoLengthLowerLimit=35e4,a._initFilters(),a._initViews(),a._initShortCuts(),a._initCommander(),void a._initBridge()):void i.error("no container","editor/view/EditorView.js")},_initCommander:function(){var a=this;a.commander=new n({editor:a}),a.commander.addCmds(a.options.commands)},_initBridge:function(){var a,b=this,d=b.options;d.bridge&&(b.bridge=d.bridge,a=b.bridge.nativeApiInterface,c.each(a,function(a,d){c.isFunction(a)&&b.commander.addCmd({name:"bridge.nativeApi."+d,action:function(a){return b.bridge.callNativeApi(d,a)}})}))},_initFilters:function(){var a=this,b=a.options,d=b.FilterManager;a.filters={},c.each(["input","output","key","paste","beforePaste","runtime"],function(c){var e=b.filters[c];e&&e.length&&(a.filters[c]=new d({editor:a}),a.filters[c].add(e))})},_initViews:function(){var a=this,b=a.options,c=b.AreaView,d=b.PanelView;a.area=new c({resourcePath:b.resourcePath}),a.area.on("ready",a.onAreaReady,a),d&&b.panelItems&&b.panelItems.length&&(a.panel=new d,a.panel.addItems(b.panelItems))},_initShortCuts:function(){var a=this,b=a.options,d=b.ShortCutManager;d&&b.shortCuts&&b.shortCuts.length&&(a.shortCutManager=new d,c.each(b.shortCuts,function(b){var c,e=d.createShortCut(b.shortCut||b);return e&&b.name?(c=a.shortCutManager.set(b.name,e),void(c||i.warn("failed to add short cut `"+b.name+"`"))):void i.warn("no short cut: "+b.name)}))},isReady:function(){return this._isReady},clearFloatLayer:function(){},onEdit:function(a){i.log("******** onEdit ********");var b,c,d=this,e=d.getFormatPainterManager(),f=d.undoManager;if(e&&e.isActivated()&&!e.isEditByPainter&&(i.log("EditorView.js: onEdit fmp.rest()"),e.reset()),f){if(b=new Date,c=d.article.innerHTML.length,i.log("content length: "+c),!f.disabled&&c>d._undoLengthWarningLimit&&c<=d._undoLengthUpperLimit)return void f.willDisable();if(c>d._undoLengthUpperLimit)return void f.disable();d.undoManager.disabled&&c<d._undoLengthLowerLimit&&d.undoManager.enable(),d.undoManager.disabled||(d.undoManager.save(a),i.log("Snapshot save :"+(new Date-b)+" ms elapsed."))}},onTextInput:function(a){var b,c=this;c.undoManager&&(b=/[\n\r]/.test(a.data),c.trigger("edit",{status:"textInput",forced:b}),c._compositionStart=!1)},onCompositionStart:function(){var a,b=this;b.undoManager&&(a=b.article.innerHTML.length,b.undoManager.disabled||a>b._undoLengthUpperLimit||(b._compositionStart=!0,b.undoManager.prepareComposition()))},undo:function(){var a=this;a.undoManager&&(a.undoManager.undo(),a.notifyNativeDocChange&&a.notifyNativeDocChange(),a._resetFormatPainterManager())},redo:function(){var a=this;a.undoManager&&(a.undoManager.redo(),a.notifyNativeDocChange&&a.notifyNativeDocChange(),a._resetFormatPainterManager())},_resetFormatPainterManager:function(){var a=this;a.formatPainterManager&&a.formatPainterManager.reset()},_getDOM:function(a){a=a||{},i.log("beginclone.......");var b=this,c=b.article.ownerDocument,d=b.article.innerHTML,e=l(d,c,!0);return e||(e=c.createElement("div"),e.innerHTML=d),!a.ignoreFilter&&b.filters.output&&b.filters.output.exec(null,{},e),e.innerHTML},getContent:function(a){var b=this,c=b._getDOM(a);return c=c.replace(/(<img [^>]*)>/gi,function(a,b){return"/"===b.charAt(b.length-1)?b+">":b+" />"}),i.log("getContent:"+c),c},getRawContent:function(){return this.article.innerHTML},setRawContent:function(a){this.article.innerHTML=a},setContent:function(){var a=this;a.noteUniqueId=a.newNoteUniqueId(),a.resetAllChangeTracers()},render:function(){},fitSize:function(){},onReady:function(a){var b=this;b.isReady()?a():b._onReadyTasks.push(a)},setHtmlReadOnly:function(a){var b=this;b.isHtmlReadOnly()!==a&&b.article.setAttribute("contenteditable",a?"false":"true")},isHtmlReadOnly:function(){var a=this,b=a.article,c=b.getAttribute("contenteditable");return"true"!==c},setReadOnlyMode:function(a,b,c,d){var e=this;i.log("setReadOnlyMode: ====> "+a+" "+d),a=a!==!1,(e.isReadOnlyMode!==a||b===!0)&&(e.setHtmlReadOnly(a),d===!0&&e.silentDo(function(){e.setTodoDisabled(a)}),c&&e._resetFormatPainterManager(),e.panel&&(a?e.panel.disable():e.panel.enable()),e.isReadOnlyMode=a)},setTodoDisabled:function(){},silentDo:function(a){var b=this,c=b._isMonitorChange===!0;if(c&&b.stopMonitorChange(),i.DEBUG)a();else try{a()}catch(d){}c&&b.startMonitorChange()},startMonitorChange:function(){this._isMonitorChange=!0},stopMonitorChange:function(){this._isMonitorChange=!1},addChangeTracer:function(a){var b=this,d=c.uniqueId("tracer_");return a===!0?(b._domChangeTracers=b._domChangeTracers||{},b._domChangeTracers[d]=0):(b._changeTracers=b._changeTracers||{},b._changeTracers[d]=0),d},getChangeTimesById:function(a,b){var c,d=this;return a?(c=(d._changeTracers||{})[a]||(d._domChangeTracers||{})[a],b!==!1&&d.removeChangeTracer(a),c):void i.error("getChangeTimesById(): no tracerId","EditorView.js")},removeChangeTracer:function(a){var b=this;delete(b._changeTracers||{})[a],delete(b._domChangeTracers||{})[a]},traceChanges:function(a,b){var c=this,d=c.addChangeTracer();return b(),c.getChangeTimesById(d)},resetAllChangeTracers:function(){var a=this;a._changeTracers=a._domChangeTracers=null},resetUndoHistory:function(a){a=a===!0;var b=this,c=b.article,d=c.cloneNode(a),e=b.document;for(o.unbind(c),c.parentNode.replaceChild(d,c),b.article=b.area.el=d,b.area.bindArticleEvent();e.queryCommandEnabled("undo");)e.execCommand("undo")},rebuildAttachments:function(){},rebuildTodos:function(){},focusArticle:function(){var a=this;a._focusArticle.apply(a,arguments),a._checkFocus()},_checkFocus:function(){var a=this,b=a.getRange(),c=a.article,d={collapsed:!0,collapseToStart:!1};i.log("_checkFocus.... range..."),i.log(b),b&&b.collapsed&&b.startContainer===c&&b.endContainer===c&&b.commonAncestorContainer===c&&b.startOffset<=1&&b.endOffset<=1&&a.selectNodeContents(c,d)},_focusArticle:function(a){var b,c,d,e=this,f=!1,g={collapsed:!0,collapseToStart:!1},h=a&&null!=a.clientX,i=!0,j=function(){e.lastSelection&&(e.area.window.focus(),e.selectRange(e.lastSelection))};if(p.CHROME){if(b=document.activeElement,b.webkitMatchesSelector(".ydlg-container")||b.webkitMatchesSelector(".ydlg-container *")||b.webkitMatchesSelector(".todo-edit-box"))return;i=b!==e.area.el||e.document.activeElement!==e.article}i&&(e.area.window.focus(),h&&(f=e.selectNearby(a))),d=e.getRange(),f||d||(j(),d=e.getRange(),d||a&&null!=a.clientY&&null!=a.clientX&&(e.area.window.focus(),f=e.selectNearby(a))||(e.article.lastChild||e.article.insertAdjacentHTML("beforeEnd","<div><br/></div>"),c=e.article.lastChild,e[c.firstChild?"selectNodeContents":"selectNode"](c,g)))},selectNearby:function(a){if(a&&null!=a.clientX){var b,c=this,d=a.clientX,e=a.clientY,f=function(a){var b,e,f=5,g=f;for(g;g>0;g--)if(e=d*g/f,b=c.selectPosition(e,a))return b;return!1};return b=f(e),b?!0:f(e+6)}},focusArticleLastLine:function(a){var b,c=this,d=c.article;a=a||{clientX:0},b=m.atDoc(d).top+d.clientHeight,c.selectPosition({clientX:a.clientX,clientY:b-1})},selectNode:function(a,b){b=b||{},this.range.selectNode(a),b.collapsed&&this.range.collapse(b.collapseToStart),this.selectRange(this.range)},selectNodeContents:function(a,b){var c=this,d=c.range;b=b||{},d&&d.selectNodeContents&&(d.selectNodeContents(a),b.collapsed&&d.collapse(b.collapseToStart),c.selectRange(d))},selectRange:function(a){if(a){var b=this,c=b.range,d=b.selection;c!==a&&c&&c.detach&&c.detach(),b.range=a,d.removeAllRanges(),d.addRange(a)}},selectPosition:function(a){var b=this.document.caretRangeFromPoint(a.clientX,a.clientY);return null!==b?(this.selectRange(b),!0):!1},getRange:function(){if(this.selection.rangeCount>0){var a=this.selection.getRangeAt(0);return"BODY"===a.startContainer.tagName?null:a}return null},getOffsetInArticle:function(a){var b,c=this,d=m.atWin(a);return a.ownerDocument===c.document&&(b=m.atWin(c.area.el),i.log("baseOffset ------ ",b),d.left+=b.left,d.top+=b.top),d},getElementOffset:function(a,b){var c=this;if(a&&a.ownerDocument===c.document)return b===!0?m.atWin(a):m.atDoc(a)},getArticleVisibleRect:function(){var a=m.atDoc(this.area.el),b=this.area.el.offsetWidth,c=this.area.el.offsetHeight;return{top:a.top,left:a.left,width:b,height:c,bottom:a.top+c,right:a.left+b}},newNoteUniqueId:function(){return e()},newAttachUniqueId:function(){return f()},newTodoUniqueId:function(){return g()},hasScrollBar:function(){var a=this,b=a.document,c=j.size(b),d=k.size(b);return{horizontal:c.width>d.width,vertical:c.height>d.height}},onCommand:function(a){var b=this;if(!b.isReadOnlyMode)return i.log("EditorView.js on command.... "),i.log(a),b.commander.exec(a)},onAreaReady:function(){var a=this;a.document=a.area.window.document,a.area.window.getSelection?a.selection=a.area.window.getSelection():a.area.window.document.selection&&(a.selection=a.area.window.document.selection.createRange()),a.article=a.area.getArticle(),a.range=a.document.createRange(),a._initOnReady(),a._bindEventsOnReady(),a.setReadOnlyMode(!1,!0),a.startMonitorChange()},_initOnReady:function(){var a=this,b=a.options;b.UndoManager&&(a.undoManager=new b.UndoManager({editor:a})),b.TopHint&&(a.topHint=b.TopHint.create({editor:a,message:"提示"})),a.plugins=[],a.options.plugins&&a.options.plugins.length>0&&a.options.plugins.forEach(function(b){var d;c.isFunction(b)?d=b(a):b&&b.init&&(b.init(a),d=b),d&&a.plugins.push(d)})},_bindEventsOnReady:function(){var a=this;a.onAreaChange=c.debounce(a.onAreaChange.bind(a),50),a.area.on("command",a.onCommand,a).on("paste",a.onAreaPaste,a).on("selectionchange",a.onSelectionChange,a).on("DOMSubtreeModified",function(){a._domChangeTracers&&c.each(a._domChangeTracers,function(b,c){a._domChangeTracers[c]=b+1}),a._isMonitorChange===!0&&a.onAreaChange.apply(a,arguments)},a),a.undoManager&&(a.on("edit",a.onEdit.bind(a)),a.area.on("textInput",a.onTextInput,a).on("compositionstart",a.onCompositionStart,a)),a.filters.key&&a.area.on("keydown",function(b){a.filters.key.exec(null,{},b)}),o.on(a.el,"selectstart",function(b){a.document!==document&&b.preventDefault()}).on(a.el,"contextmenu",function(b){i.DEBUG||(a.clearFloatLayer(),b.preventDefault())}),a.panel&&a.panel.bind&&a.panel.bind("command",a.onCommand,a)},_onAreaReadyEnd:function(){var a=this;c.invoke(a._onReadyTasks,"call"),a._onReadyTasks=[],a._isReady=!0},onAreaChange:function(){var a=this;i.log("EditorView.js onAreaChange...."),a._changeTracers&&c.each(a._changeTracers,function(b,c){a._changeTracers[c]=b+1}),a.panel&&a.panel.checkStatus&&a.panel.checkStatus(),a.runRuntimeFilters()},runRuntimeFilters:function(a){var b,c=this,d=c.filters,e=function(){c.silentDo(function(){d.runtime.exec(null,{},c.article)})};if(d&&d.runtime&&d.runtime.exec){if(a===!1)return void e();b=c.traceChanges(!0,e),b>0&&c.notifyNativeDocChange&&c.notifyNativeDocChange()}},setZoom:function(a){var b=this,c=b.article;c.style.zoom=a,b.trigger("zoom",a)},onAreaPaste:function(){},onSelectionChange:function(){}})}),define("htmlize/htmlize",function(a){var b,c=a("core/underscore"),d=a("htmlize/parse"),e=a("core/str/times"),f=a("core/console");return b=function(a,b,g){var h,i,j,k,l,m,n,o,p,q,r,s="",t=[],u=0,v=function(a){if(!a||!a[0])return!1;var b=a[0];return!b||b.plain?!1:/<li>/i.test(b.content)?{level:b.level,orderList:b.orderList}:!1},w=["blankLine","horizotalLine","unorderList","orderList","inline"];if(!a)return"";for(b=b||{},b=c.defaults(b,{blankLine:!0,horizotalLine:!0,unorderList:!0,orderList:!0,inline:{}}),h=a.split(/\r?\n/),r=b.inline,i=c.map(h,function(a){var e;return c.some(w,function(c){var f=b[c]!==!1;if(f)return e=d[c](a,r),e?!0:void 0}),e||[{content:a,plain:!0}]}),k=i.length,q=function(a){var b;a&&a.content&&(a.plain?(b=c.escape(a.content).replace(/ /g,"&nbsp;"),b=b.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;"),s+=b):s+=a.content)},j=0;k>j;j++)if(l=i[j],n=v(l))if(n.level===u)f.log("level == currentLevel",l),c.each(l,q);else if(n.level>u)f.log("level > currentLevel",l),o=n.orderList?"ol":"ul",p=n.level-u,s+=e("<"+o+">",p),c.each(l,q),t.push(e("</"+o+">",p)),u=n.level;else{for(f.log("level < currentLevel",l),p=u-n.level;p>0;)s+=t.pop()||"",p--;u=n.level,c.each(l,q)}else{if(u)for(m=t.pop();m;)s+=m,m=t.pop();g!==!1&&(s+="<div>"),c.each(l,q),g!==!1&&(s+="</div>"),u=0}return s},{htmlize:b}}),define("htmlize/parse",function(a){var b=a("core/str/trim"),c=a("core/str/startsWith"),d=a("core/underscore"),e=function(a){var b,c,d,e=/^[\s\t\xA0\u3000]+/.exec(a),f=0;if(!e)return 1;for(e=e[0],c=e.length,b=0;c>b;b++)d=e.charAt(b),f+="	"===d?4:1;return f=Math.ceil(f/4)+1,1>f?1:f},f=function(a,b){var c,e=[],f=0;return d.each(b,function(b){var c=a.substring(f,b.index),g='<a href="'+d.escape(b.full)+'">'+d.escape(b.text)+"</a>";
c&&c.length&&e.push({content:c,plain:!0}),e.push({content:g,plain:!1}),f=b.index+b.size}),c=a.substring(f),c&&c.length&&e.push({content:c,plain:!0}),e&&e.length?e:[{content:a,plain:!0}]},g={url:function(a){a+="";var b,d,e,g=/(https?:\/\/|www\.|ssh:\/\/|ftp:\/\/)[a-z0-9&_+\-\?\/\.=\#,:%\(\)@]+/gi;for(d=[],b=g.exec(a);b;)e=b[0],d.push({index:b.index,size:e.length,text:e,full:c(e.toLowerCase(),"www.")?"http://"+e:e}),b=g.exec(a);return d&&d.length?f(a,d):[{content:a,plain:!0}]},mail:function(a){a+="";var b,c,d,e=/[a-z0-9_+\-\.]+@[a-z0-9_+\-\.]+/gi;for(c=[],b=e.exec(a);b;)d=b[0],c.push({index:b.index,size:d.length,text:d,full:"mailto:"+d}),b=e.exec(a);return c&&c.length?f(a,c):[{content:a,plain:!0}]},phoneNumber:function(a){a+="";var b,c,d,e=/\d{2,3}[\d- ]{1,11}\d{2,3}/g;for(c=[],b=e.exec(a);b;)d=b[0],c.push({index:b.index,size:d.length,text:d,full:"tel:"+d.replace(/[- ]/g,"")}),b=e.exec(a);return c&&c.length?f(a,c):[{content:a,plain:!0}]}},h=function(a,b){a=d.flatten(a);var c=[];return d.each(a,function(a){a&&a.content&&(a.plain?c.push(b(a.content)):c.push(a))}),c=d.flatten(c)};return{blankLine:function(a){var c=b(a);return c?void 0:[{content:"<br/>",plain:!1}]},horizotalLine:function(a){var b=/^\s*-{3,}\s*$/;return b.test(a)?[{content:"<hr/>",plain:!1}]:void 0},inline:function(a,b){a+="",b=b||{},b=d.defaults(b,{url:!0,mail:!0,phoneNumber:!0});var c=[{content:a,plain:!0}];return d.each(["url","mail","phoneNumber"],function(a){b[a]!==!1&&(c=h(c,g[a]))}),c},orderList:function(a,c,f){f=f!==!1;var g,h,i,j,k,l=this,m=b(a),n=f?/^\d+\.?\s+/:/^[-*]\s+/,o=n.exec(m);if(o)return i=e(a),h=[{content:"<li>",plain:!1,level:i,orderList:f}],g=o[0],j=m.substring(g.length),k=l.inline(j,c),k?h.push(k):h.push({content:j,plain:!0}),h.push({content:"</li>",plain:!1}),d.flatten(h)},unorderList:function(a,b){var c=this;return c.orderList(a,b,!1)}}}),define("iphone/attachment/getFileName",function(){return function(a){return a.getAttribute("title")||a.dataset.fileName||a.getAttribute("filename")||a.getAttribute("alt")}}),define("iphone/cmd/appendBlankLines",function(a){var b=a("iphone/util/blankLine");return{name:"appendBlankLines",triggersEdit:!1,action:function(a){if(a&&a.lines){var c,d,e,f,g,h,i=this.editor,j=i.article,k=i.document,l=function(a,c){for(;c>0;)d=b.create(k),a.appendChild(d),c--};if(a.force)c=a.lines;else{for(e=0,g=j.childNodes,h=g.length,f=h-1;f>=0&&b.is(g[f]);f--)e++;c=a.lines-e}a.silent?i.silentDo(function(){l(j,c)}):l(j,c)}}}}),define("iphone/cmd/appendTodo",function(a){var b=a("core/underscore"),c=a("editor/str/uniqueSuffix");return{name:"appendTodo",triggersEdit:!1,action:function(a){if(a&&a.groupId&&a.todoId&&a.imgSrc){var d=this,e=d.editor,f=e.todoGroupManager,g="img[data-group-id="+a.groupId+"]",h=e.article.querySelectorAll(g);h&&h.length&&(a.imgSrc=c.add(a.imgSrc,!0),h=b.toArray(h),b.each(h,function(b){b.setAttribute("src",a.imgSrc)}),f.appendInGroup(a.groupId,f.createTodoInfo(a.todoId)),a.notifyChange&&e.notifyNativeDocChange())}}}}),define("iphone/cmd/doPaste",function(a){var b=a("editor/cmd/CmdBall"),c=a("web/console");return{name:"doPaste",triggersEdit:!1,action:function(a){if(a&&a.html){var d=this,e=d.editor,f=e.handwriteArea,g=e.getRange(),h=function(a){var b=a.commonAncestorContainer;return b=3===b.nodeType?b.parentNode:b,f.isMatched(b)||f.isChild(b)?!1:!0};if(!g)return void c.log("no range @ iphone/cmd/doPaste.js");g.collapsed||(g.collapse(),e.selectRange(g)),h(g)&&(a.isPlainText?d.exec(b.create("doPasteAsText",{text:a.html})):d.exec(b.create("doPasteHtml",a)))}}}}),define("iphone/cmd/doPasteAsText",function(a){var b=a("htmlize/htmlize"),c=a("editor/cmd/CmdBall"),d=a("core/underscore"),e=a("web/console");return{name:"doPasteAsText",triggersEdit:!1,action:function(a){var f,g,h,i=this,j=i.editor;return a&&a.text?(f=b.htmlize(a.text,{blankLine:!0,horizotalLine:!1,unorderList:!1,orderList:!1,inline:{url:!0,mail:!0,phoneNumber:!0}}),f?(g=document.createElement("div"),g.innerHTML=f,h=g.querySelectorAll("a"),d.each(h,function(a){/^tel:/.test(a.href)&&a.setAttribute("data-yne-recognition","tel")}),f=g.innerHTML,i.exec(c.create("insertHTML",f,!0))):i.exec(c.create("insertText",a.text,!0)),void window.setTimeout(function(){var a=j.filters;e.log("execOnly br...................."),a.paste&&j.silentDo(function(){a.paste.execOnly(["br"],{},j.article)})},0)):void e.log("no data or data.text")}}}),define("iphone/cmd/doPasteHtml",function(a){var b=a("parser/parse"),c=a("iphone/parse/pasteRules"),d=a("editor/cmd/CmdBall"),e=a("web/console");return{name:"doPasteHtml",triggersEdit:!1,action:function(a){if(a&&a.html){var f,g=this,h=g.editor,i=h.filters,j=h.document.createElement("article");try{j.innerHTML=a.html||""}catch(k){return void e.error("set innerHTML error","IPhoneEditorView.js")}i.beforePaste&&i.beforePaste.exec(null,a,j),j=b(j,c,document,!0,!0),f=j.innerHTML,e.log("parsed paste html: "+f),j=null,f&&(g.exec(d.create("insertHTML",f,!0)),i.paste&&window.setTimeout(function(){i.paste.exec(null,{},h.article)},0))}}}}),define("iphone/cmd/handwriteBackspace",function(){return{name:"handwriteBackspace",triggersEdit:!0,action:function(){for(var a,b,c,d=this.editor,e=".ynote-handwrite-item",f=d.handwriteNeedle.queryOne(),g=f.previousSibling;g&&g.nodeType===Node.TEXT_NODE;)a=g,g=g.previousSibling,a.parentNode.removeChild(a);if(g)g.parentNode.removeChild(g),f.parentNode.dataset.changed="true";else{if(b=f.parentNode,!d.handwriteArea.isMatched(b))return;if(c=b.querySelector(e))return;b.parentNode.removeChild(b),d.setEditingMode({mode:1})}}}}),define("iphone/cmd/insertAttachment",function(a){var b=a("templates/jst"),c=a("iphone/util/blankLine");return{name:"insertAttachment",triggersEdit:!0,action:function(a){var d,e,f,g,h=this,i=h.editor,j=b.render("iphone","attachment_insert",{image:a.image,fileName:a.fileName,length:a.length,resId:a.id});i.focusArticle(),d=i.getRange(),g=i.handwriteArea.getByRange(d),g&&(g.nextSibling||c.insertAfter(g),i.selectNode(g.nextSibling,{collapsed:!0}),i.setHtmlReadOnly(!1)),d=i.getRange(),d?h.execNative("insertHTML",j):(f=i.document.createElement("div"),f.innerHTML=j,f=f.querySelector("img"),e.insertBefore(f,e.lastChild))}}}),define("iphone/cmd/insertBlankLinesAfterNode",function(a){var b=a("iphone/util/blankLine"),c=a("web/dom/isTag"),d=a("web/dom/nodeType");return{name:"insertBlankLinesAfterNode",triggersEdit:!1,action:function(a){if(a&&a.node&&a.lines){var e,f=this,g=f.editor,h=a.node,i=h.nextSibling,j=0,k=function(a){for(var b=a.parentNode,e=a.textSibling;e&&(c(e,"br")||d.isText(e)&&""===e.textContent);)b.removeChild(e),e=a.nextSibling},l=function(a,c){for(;c>0;)b.insertAfter(a),c--};for(a.silent?g.silentDo(function(){k(a.node)}):k(a.node),i=h.nextSibling;i&&b.is(i,!0);)j++,i=i.nextSibling;e=a.lines-j,1>e||(a.silent?g.silentDo(function(){l(h,e)}):l(h,e))}}}}),define("iphone/cmd/insertHandwriteArea",function(a){var b=a("web/dom/isTag"),c=a("web/dom/insert"),d=a("iphone/util/blankLine"),e=a("web/dom/nodeType"),f=a("core/str/trim");return{name:"insertHandwriteArea",triggersEdit:!0,action:function(a){var g,h,i,j,k,l=this,m=l.editor,n=m.article,o=m.document,p=function(a,b){a.setEndAfter(n.lastChild);var c=a.extractContents(),d=o.createDocumentFragment();d.appendChild(b),d.appendChild(c),n.appendChild(d)},q=function(a,b){for(var d=a.commonAncestorContainer;d&&d.parentNode&&d.parentNode!==n;)d=d.parentNode;c(b).after(d)},r=function(a){var b,c,g=a.childNodes,h=g.length,i=!0;for(b=0;h>b;b++)if(c=g[b],e.isElement(c)){if(!d.is(c)&&0!==c.childNodes.length){i=!1;break}}else if(e.isText(c)&&""!==f(c.nodeValue)){i=!1;break}return i};if(m.handwriteNeedle.remove(),m.focusArticle(!0),h=m.getRange(),g=m.handwriteArea.createNew(a,!0),j=m.handwriteNeedle.createNew(),g.appendChild(j),m.setHtmlReadOnly(!0),h){if(r(n))for(;n.lastChild;)n.removeChild(n.lastChild);n.lastChild?(i=h.commonAncestorContainer,i&&3===i.nodeType&&(i=i.parentNode),i&&i.webkitMatchesSelector&&i.webkitMatchesSelector("table *")?q(h,g):p(h,g)):n.appendChild(g),m.handwriteCaret.showAtNeedle(m.handwriteNeedle),k=g.nextSibling,b(k,"br")&&k.parentNode.removeChild(k),l.exec("appendBlankLines",{lines:1})}}}}),define("iphone/cmd/insertHandwriteBr",function(a){var b=a("web/dom/sibling");return{name:"insertHandwriteBr",triggersEdit:!0,action:function(){var a,c,d,e=this.editor,f=e.handwriteNeedle.queryOne();f&&(a=b.prevElement(f),a&&!e.handwriteBr.isMatched(a)&&(c=e.handwriteBr.createNew(),d=f.parentNode,d.dataset.changed="true",d.insertBefore(c,f)))}}}),define("iphone/cmd/insertHandwriteCharacter",function(){return{name:"insertHandwriteCharacter",triggersEdit:!0,action:function(a){var b,c=this,d=c.editor,e=d.handwriteNeedle.queryOne(),f=new Image;e&&(f.src=a.path,f.dataset.handwriteId=a.id,f.className="ynote-handwrite-item",b=e.parentNode,b.dataset.changed="true",b.insertBefore(f,e))}}}),define("iphone/cmd/insertImage",function(a){var b=a("web/dom/attr"),c=a("core/underscore");return{name:"insertImage",triggersEdit:!0,action:function(a){if(a&&a.src){var d,e,f,g,h=this,i=h.editor,j=i.document.createElement("div");if(c.isString(a.src))d=[a.src];else{if(!c.isArray(a.src))return;d=a.src}c.each(d,function(c){var d=new Image;b.set(d,a.attr).set(d,"src",c),j.appendChild(d)}),g=j.innerHTML,i.focusArticle(),e=i.getRange(),f=i.handwriteArea.getByRange(e),f&&(f.nextSibling||f.insertAdjacentHTML("afterEnd","<div><br/></div>"),i.selectNode(f.nextSibling,{collapsed:!0})),h.execNative("insertHTML",g)}}}}),define("iphone/cmd/insertTodoGroup",function(a){var b=a("core/underscore"),c=a("web/dom/dataset"),d=a("editor/str/uniqueSuffix"),e=a("editor/cmd/CmdBall"),f=a("web/dom/isTag"),g=a("web/dom/nodeType");return{name:"insertTodoGroup",triggersEdit:!0,action:function(a){if(a&&a.groupId&&a.todoIds&&a.todoIds.length&&a.imgSrc){var h,i,j,k=this,l=k.editor,m=l.todoGroupManager,n=l.article,o=l.document,p=l.getRange(),q=o.createElement("img"),r=[],s=function(a){return a?g.isText(h)&&!h.nodeValue?{empty:!0,type:"text"}:f(h,"br")?{empty:!0,type:"br"}:{empty:!1}:{empty:!0,type:"null"}};a.imgSrc=d.add(a.imgSrc,!0),c.set(q,"mediaType","todogroup"),c.set(q,"noteId",l.noteUniqueId),c.set(q,"groupId",a.groupId),q.setAttribute("src",a.imgSrc),b.each(a.todoIds,function(a){r.push(m.createTodoInfo(a))}),m.add(a.groupId,r),p&&p.insertNode?p.insertNode(q):l.article.appendChild(q),h=q.nextSibling,j=s(h),j.empty&&(i=q.parentNode,i!==n&&(h=i.nextSibling)),j=s(h),j.empty&&("null"!==j.type&&h.parentNode.removeChild(h),k.exec(e.create("insertBlankLinesAfterNode",{node:q,lines:1})),h=q.nextSibling),h&&l.selectNodeContents(h,{collapsed:!0,collapseToStart:!0})}}}}),define("iphone/cmd/redo",function(a){var b=a("web/console");return{name:"redo",action:function(){var a=this,c=a.editor,d=c.undoManager;d&&d.redo&&c.silentDo(function(){var a=d.redo();b.log(">>>>>----> redo isSuccess: "+a),a&&c.notifyNativeDocChange()})}}}),define("iphone/cmd/undo",function(a){var b=a("web/console");return{name:"undo",action:function(){var a=this,c=a.editor,d=c.undoManager;d&&d.undo&&c.silentDo(function(){var a=d.undo();b.log("undo isSuccess: "+a),a&&c.notifyNativeDocChange()})}}}),define("iphone/edit/HandwriteArea",function(a){var b=a("core/Class"),c=a("core/underscore"),d=a("web/dom/findParent"),e=a("editor/math/handwriteAreaUniqueId"),f=b.extend({initialize:function(){},isMatched:function(a){return a&&a.webkitMatchesSelector&&a.webkitMatchesSelector(f.querySelector)?!0:!1},isChild:function(a){var b=f.querySelector+" *";return a&&a.webkitMatchesSelector&&a.webkitMatchesSelector(b)?!0:!1},isImageCharacter:function(a){var b="img[data-handwrite-id]";return a&&a.webkitMatchesSelector&&a.webkitMatchesSelector(b)?!0:!1},isHandwriteBr:function(a){var b="br[data-handwrite-id]";return a&&a.webkitMatchesSelector&&a.webkitMatchesSelector(b)?!0:!1},isHandwriteItem:function(a){var b=this;return b.isImageCharacter(a)||b.isHandwriteBr(a)},getByRange:function(a){if(a){var b=this,c=a.commonAncestorContainer;return c=c&&3===c.nodeType?c.parentNode:c,b.isMatched(c)?c:b.getByChild(c)}},getByChild:function(a){var b=this;return b.isChild(a)?d(a,b.isMatched):void 0},getAsElement:function(a){var b,d=this,e=this.options;return c.isString(a)&&(b='[data-area-id="'+a+'"]',a=e.editor.article.querySelector(b)),d.isMatched(a)?a:null},createNew:function(a,b){var c=this,d=c.options.editor,g=d.document.createElement("div");return g.className=f.className,g.dataset.mediaType="handwrite",g.dataset.areaId=a||e(),b&&(g.dataset.changed="true"),g},queryOne:function(a,b){var c=this,d=c.options;return b=b||d.editor.article,b&&b.querySelector?b.querySelector(f.querySelector+(a||"")):void 0},queryAll:function(a,b){var d=this,e=d.options;return b=b||e.editor.article,b&&b.querySelectorAll?(a=a||f.querySelector,c.toArray(b.querySelectorAll(a))):void 0},queryByAreaId:function(a,b){var c=this;if(a)return c.queryAll('[data-area-id="'+a+'"]',b)},getDeepFirstChildAsArea:function(a){var b,c=this,d=c.options;if(a=a||d.editor.article){for(b=a.firstChild;b&&!c.isMatched(b);)b=b.firstChild;return b}}},{querySelector:"div.ynote-handwrite-area",className:"ynote-handwrite-area"});return f}),define("iphone/edit/HandwriteBr",function(a){var b=a("core/Class"),c=b.extend({initialize:function(){},createNew:function(){var a=this,b=a.options.editor,d=b.document.createElement("br");return d.dataset.handwriteId="BR",d.className=c.className,d},isMatched:function(a){return a&&a.webkitMatchesSelector&&a.webkitMatchesSelector(c.querySelector)}},{className:"ynote-handwrite-br ynote-handwrite-item",querySelector:"br.ynote-handwrite-br",html:'<br data-handwrite-id="BR" class="ynote-handwrite-br ynote-handwrite-item" />'});return c}),define("iphone/edit/HandwriteCaret",function(a){var b=a("core/Class"),c=a("web/dom/className"),d=a("web/dom/style"),e=a("web/dom/position"),f=a("web/console"),g=b.extend({initialize:function(){},getElement:function(){return this.options.element},show:function(){var a=this;c.remove(a.getElement(),"hide")},hide:function(){var a=this;c.add(a.getElement(),"hide")},stopBlink:function(){var a=this.getElement();a.style.webkitAnimationName="none"},startBlink:function(){var a=this.getElement();a.style.webkitAnimationName="blink"},getHeight:function(){var a=this;return a.getElement().offsetHeight||40},getPosition:function(){var a=this;return e.atDoc(a.options.element)},showAtPosition:function(a){var b=this;a&&a.left&&a.top&&d.set(b.getElement(),{left:a.left+"px",top:a.top+"px"}),b.show()},showAtNeedle:function(a){if(!a||!a.getPosition)return void f.log("needle is not valid!");var b=this,c=a.getPosition();f.log("needlePostion"),f.log(c),b.showAtPosition(c)},computeRect:function(){var a=this,b=0,c=a.getHeight(),d=a.getPosition();return{left:d.left,top:d.top,right:d.left+b,bottom:d.top+c,width:b,height:c}},moveToStart:function(a){var b=this,c=b.options.editor;a&&(c.handwriteNeedle.moveToStart(a),b.showAtNeedle(c.handwriteNeedle))},moveToRange:function(a,b,c){var d=this,e=d.options.editor;a&&a.commonAncestorContainer&&e.silentDo(function(){e.handwriteNeedle.moveToRange(a,b,c),d.showAtNeedle(e.handwriteNeedle)})}});return g}),define("iphone/edit/HandwriteNeedle",function(a){var b=a("core/underscore"),c=a("core/Class"),d=a("web/dom/remove"),e=a("web/dom/position"),f=c.extend({initialize:function(){},isMatched:function(a){return a&&a.webkitMatchesSelector&&a.webkitMatchesSelector(f.querySelector)?!0:!1},queryOne:function(){var a=this,b=a.options.editor.article;return b.querySelector(f.querySelector)},remove:function(){var a,c=this,e=c.options.editor,g=e.article,h=f.querySelector,i=g.querySelectorAll(h);return i=b.toArray(i),b.each(i,function(b){a=d(b)}),a},createNew:function(){var a=this,b=a.options.editor,c=b.document.createElement("span");return c.className=f.className,c},removeAndCreateNew:function(){var a=this;return a.remove()||a.createNew()},getPosition:function(){var a=this,b=a.queryOne(),c=e.atDoc(b);return c},moveToStart:function(a){var b=this,c=b.options.editor;a=c.handwriteArea.getAsElement(a),a&&c.silentDo(function(){var c=b.removeAndCreateNew();a.insertBefore(c,a.firstChild)})},moveToRange:function(a,b,c){var d,e=this,f=e.options.editor,g=f.handwriteArea;a&&a.commonAncestorContainer&&(d=a.commonAncestorContainer,d=3===d.nodeType?d.parentNode:d,(g.isMatched(d)||g.isChild(d))&&f.silentDo(function(){var d=e.removeAndCreateNew();b&&a.collapse(c===!0),a.insertNode(d)}))}},{className:"ynote-handwrite-needle",querySelector:"span.ynote-handwrite-needle"});return f}),define("iphone/edit/TodoGroup",function(a){var b=a("core/underscore"),c=a("core/Class"),d=a("core/arr/remove"),e=c.extend({initialize:function(a){var b=this;b._id=a.groupId,b._todoInfos=a.todoInfos,b._isDeleted=!1,b._isAppended=!1,b._isEdited=!1},getTodoIds:function(){var a=this;return b.map(a._todoInfos,function(a){return a.id})},getSize:function(){var a=this;return a._todoInfos.length},getTodoInfos:function(){return this._todoInfos},remove:function(a){var c=this,e=c._todoInfos,f=function(a,b){var c,d=a.length-1;for(d;d>=0;d--)if(c=a[d],c&&c.id===b)return d;return-1};b.isArray(a)||(a=[a]),b.each(a,function(a){for(var b,g=f(e,a);g>-1;)b=d(e,g),b&&(c._isDeleted=!0),g=f(e,a)})},removeAtIndex:function(a){var b=this,c=b._todoInfos,e=d(c,a);e&&(b._isDeleted=!0)},append:function(a){var b=this;a&&(b._todoInfos.push(a),b._isAppended=!0)},setEdited:function(){this._isEdited=!0},isDeleted:function(){return this._isDeleted},isAppended:function(){return this._isAppended},isEdited:function(){return this._isEdited},isChanged:function(){var a=this;return a._isDeleted||a._isAppended||a._isEdited}},{create:function(a,b){return a&&b?new e({groupId:a,todoInfos:b}):void 0}});return e}),define("iphone/edit/TodoGroupManager",function(a){var b=a("core/Class"),c=a("iphone/edit/TodoInfo"),d=a("iphone/edit/TodoGroup"),e=b.extend({initialize:function(){var a=this;a._todoGroups={}},get:function(a){var b=this;if(a)return b._todoGroups[a]},getTodoIds:function(a){var b=this,c=b.get(a);return c?c.getTodoIds():void 0},add:function(a,b){var c,e=this;b&&b.length&&(e._todoGroups[a]||(c=d.create(a,b),c&&(e._todoGroups[a]=c)))},remove:function(a){var b=this;a&&delete b._todoGroups[a]},removeInGroup:function(a,b){var c=this,d=c._todoGroups[a],e=-1;d&&(b&&(d.remove(b),e=d.getSize()),0!==e&&b||delete c._todoGroups[a])},removeAtIndexInGroup:function(a,b){var c=this,d=c._todoGroups[a],e=-1;d&&(d.removeAtIndex(b),e=d.getSize(),0===e&&delete c._todoGroups[a])},appendInGroup:function(a,b){var c=this,d=c._todoGroups[a];d&&d.append(b)},createTodoInfo:function(){return c.create.apply(c,arguments)}});return e}),define("iphone/edit/TodoInfo",function(){function a(a,b){var c=this;c.id=a,c.wrapped=b}return a.create=function(b,c){return b?new a(b,c||!1):void 0},a}),define("iphone/edit/clickHandlers",function(a){var b=a("web/dom/findParent"),c=a("iphone/util/linkHref"),d=a("iphone/edit/keyboardModes");return{link:{check:function(a){return b(a,"a")},action:function(a,b){var e=this,f=a.href;if(c.isInlineJS(f))return b.preventDefault(),!0;if(e._isTouchEndFired){if(e._keyboardMode===d.HIDE&&!c.isHttpPage(f))return!0;b.preventDefault()}return!0}}}}),define("iphone/edit/editingModes",function(){return{NO_EDIT:0,NORMAL:1,HANDWRITE:2}}),define("iphone/edit/keyboardModes",function(){return{HIDE:1,SHOW:2}}),define("iphone/edit/nextLine",function(a){var b=a("web/dom/nodeType"),c=a("web/dom/isTag");return function(a,d){if(a&&d&&a.parentNode){var e,f,g=d.article,h=function(a){return a?b.isText(a)&&!a.nodeValue?!0:c(a,"br")?!0:d.handwriteArea.isMatched(a)?!0:void 0:!0};return f=a.nextSibling,h(f)?(e=a.parentNode,e===g||(f=e.nextSibling,h(f))?void 0:f):f}}}),define("iphone/edit/touchHandlers",function(a){var b=a("core/underscore"),c=a("editor/str/uniqueSuffix"),d=a("web/dom/findParent"),e=a("web/dom/dataset"),f=a("web/dom/sibling"),g=a("iphone/util/linkHref"),h=a("iphone/util/isRemoteImage"),i=a("iphone/edit/keyboardModes"),j=function(a,b){var c=b,d=c;if(a.handwriteBr.isMatched(b))return f.prevElement(b);do{if(!d||a.handwriteBr.isMatched(d))return c;c=d,d=f.nextElement(c)}while(c)},k={LEFT:1,MIDDLE:2,RIGHT:3},l=function(a,b){var c,d=b.getBoundingClientRect();return d.width<88?k.MIDDLE:(c=a.clientX-d.left,d.width<132?c>44?k.MIDDLE:k.LEFT:44>=c?k.LEFT:d.right-a.clientX>44?k.MIDDLE:k.RIGHT)},m=function(a,b){var c=b.getBoundingClientRect();return a.clientX-c.left<=10?k.LEFT:c.right-a.clientX<=10?k.RIGHT:k.MIDDLE},n=function(a,b){var c=b.getBoundingClientRect();return{width:c.width,height:c.height,x:a.clientX-c.left,y:a.clientY-c.top}},o=function(a,d){var e=-1,f="img[data-media-type=image], img[data-media-type=handwrite]:not([data-res-handwrite])",g=a.querySelectorAll(f),i=[];return g=b.toArray(g),b.each(g,function(a){var b=c.remove(a.dataset.yneOrigSrc||a.getAttribute("src"));b&&!h(a)&&(i.push(b),a===d&&(e=i.length-1))}),-1!==e?{info:i,index:e}:void 0};return{attachment:{check:function(a){var b="img[data-media-type=attachment]";return a&&a.webkitMatchesSelector&&a.webkitMatchesSelector(b)},action:function(a,b,c,d){if(!b||!b.dataset||!b.dataset.resId)return!1;var e,f=this,g=m(d,b);return g!==k.MIDDLE?(f.selectNode(b,{collapsed:!0,collapseToStart:g===k.LEFT}),!0):(c.preventDefault(),e=b.dataset,f.bridge.callNativeApi("ClickOnAttachment",[{resId:e.resId,fileName:e.fileName,fileLength:e.fileLength}]),{preventModeChange:!0})}},image:{check:function(a){var b="img[data-media-type=image], img[data-media-type=handwrite]:not([data-res-handwrite])";return a&&a.webkitMatchesSelector&&a.webkitMatchesSelector(b)&&!a.webkitMatchesSelector("a img")},action:function(a,b,c,d){var e,f=this,g=f.article,j=l(d,b),m=h(b);return j!==k.MIDDLE?(f.selectNode(b,{collapsed:!0,collapseToStart:j===k.LEFT}),!0):f._keyboardMode===i.SHOW?(f.selectNode(b),!0):(m||(e=o(g,b)),m||!e?(f.selectNode(b,{collapsed:!0,collapseToStart:!0}),!0):(c.preventDefault(),f.bridge.callNativeApi("EnterImageBrowser",[e.info,e.index]),{preventModeChange:!0}))}},handwriteImg:{check:function(a){return a&&a.webkitMatchesSelector&&a.webkitMatchesSelector("img.ynote-handwrite-item")},action:function(a,b,c,d){var e=this,f=b.getBoundingClientRect(),g=d.clientX<f.left+f.width/2;return e.moveHandwriteCaretToItem(b,g),!0}},handwriteArea:{check:function(a){return this.handwriteArea.isMatched(a)},action:function(a,b,c,d){var e,f,g,h,i,k=this,l=".ynote-handwrite-item";return k.selectPosition({clientX:15,clientY:d.clientY}),e=k.getRange(),e&&e.commonAncestorContainer&&(f=e.commonAncestorContainer,f.webkitMatchesSelector&&(f.webkitMatchesSelector(l)?h=f:k.handwriteArea.isMatched(f)&&(g=f.querySelectorAll(l),h=g[e.startOffset])),i=j(k,h))?(k.moveHandwriteCaretToItem(i),!0):(g=b.querySelectorAll(l),g&&g.length&&k.moveHandwriteCaretToItem(g[g.length-1]),!0)}},articleSelf:{check:function(a){return a&&a.webkitMatchesSelector&&a.webkitMatchesSelector("article.editor-area")},action:function(a,b,c,d){var e=d.clientX;return(10>=e||e>=310)&&c.preventDefault(),!0}},link:{check:function(a){var b=d(a,"a");return b&&null==b.querySelector("img")},action:function(a,b,c){var e=this,f=d(b,"a"),h=f.href;return g.isInlineJS(h)?(c.preventDefault(),!0):e._keyboardMode===i.HIDE?g.isHttpPage(h)?(c.preventDefault(),e.bridge.callNativeApi("OpenLink",[h]),{preventModeChange:!0}):(c.preventDefault(),{preventModeChange:!0}):void 0}},imageLink:{check:function(a){var b=d(a,"a");return b&&b.querySelector("img")},action:function(a,b,c,e){var f,j,m=this,n=d(b,"a"),p=n.href,q=n.querySelector("img"),r=c.target,s=!1;if(m._keyboardMode===i.SHOW){if(r===q){if(f=l(e,q),h(q)&&(f=k.LEFT),f!==k.MIDDLE)return m.selectNode(q,{collapsed:!0,collapseToStart:f===k.LEFT}),!0;s=!0}}else if(m._keyboardMode===i.HIDE){if(h(q))return g.isInlineJS(p)?(c.preventDefault(),{preventModeChange:!0}):g.isHttpPage(p)?(c.preventDefault(),m.bridge.callNativeApi("OpenLink",[p]),{preventModeChange:!0}):{preventModeChange:!0};s=!0}return s&&(j=o(m.article,q),j&&g.isHttpPage(p)&&(c.preventDefault(),m.bridge.callNativeApi("OpenImageLink",[{linkHref:p,imgSrc:j.info,index:j.index}]))),{preventModeChange:!0}}},todoGroup:{check:function(a){var b="img[data-media-type=todogroup]";return a&&a.webkitMatchesSelector&&a.webkitMatchesSelector(b)&&"DEFAULTIMAGE"!==a.getAttribute("src")},action:function(a,c,d,f){var g,h,i=this,j=n(f,c),k="",l=55,m=55;if(d.preventDefault(),j&&j.x<m&&j.height-j.y>l){if(i.todoGroupCheckboxKey)return;i.todoGroupCheckboxKey=k=b.uniqueId("todo_check_")}return g=e.get(c,"groupId"),h=i.todoGroupManager.getTodoIds(g),i.bridge.callNativeApi("ClickTodoGroup",[g,h,j.x,j.y,k]),{preventModeChange:!0}}}}}),define("iphone/filters/beforePaste/format",function(a){var b=a("core/underscore");return{name:"format",action:function(a,c){var d="br.Apple-interchange-newline",e=c.getElementsByTagName("span");e=b.toArray(e),b.each(e,function(a){var b;if(a.querySelector("div")){for(b=document.createElement("div");null!=a.firstChild;)b.appendChild(a.firstChild);a.parentNode.insertBefore(b,a),a.parentNode.removeChild(a)}}),e=c.querySelectorAll(d),e=b.toArray(e),b.each(e,function(a){var b=document.createElement("div");a.parentNode.insertBefore(b,a),a.parentNode.removeChild(a),b.appendChild(a)})}}}),define("iphone/filters/beforePaste/image",function(a){var b=a("core/underscore"),c=a("core/str/startsWith");return{name:"image",action:function(a,d){var e,f=a.images,g=function(a){var b,d="file:///";return c(a,d)?(b=a.indexOf("//",d.length),-1===b?a:d+a.substring(b+2)):a};f&&f.length&&(e=d.querySelectorAll("img"),e=b.toArray(e),b.each(e,function(a){var c,d=a.src;b.each(f,function(b){(d===b.origSrc||g(d)===b.origSrc)&&a.setAttribute("src",b.newSrc)}),c=document.createElement("img"),c.setAttribute("data-media-type","image"),c.setAttribute("src",a.getAttribute("src")),a.parentNode.replaceChild(c,a)}))}}}),define("iphone/filters/beforePaste/media",function(a){var b=a("core/underscore");return{name:"media",action:function(a,c){var d=[["[data-media-type=attachment]","img[data-media-type=todogroup]","[data-media-type=handwrite]"],["br[data-handwrite-id=BR]","img[data-handwrite-id]"]];b.each(d,function(a){var d=c.querySelectorAll(a.join(","));d=b.toArray(d),b.each(d,function(a){a&&a.parentNode&&a.parentNode.removeChild(a)})})}}}),define("iphone/filters/input/attachment",function(a){var b=a("core/underscore"),c=a("templates/jst"),d=a("iphone/attachment/getFileName"),e=a("web/console");return{name:"attachment",action:function(a,f){var g="img[path]",h=f.querySelectorAll(g);h=b.toArray(h),a.requests.RequestReplaceAttachment||(a.requests.RequestReplaceAttachment=[]),b.each(h,function(b){e.log("filters/input/attachment ",b);var f,g,h=b.getAttribute("path")||b.dataset.resId,i=d(b),j=b.getAttribute("filelength")||b.dataset.fileLength,k=b.getAttribute("distinguish"),l=b.src,m=b.parentNode,n=m.childNodes.length;g="SPAN"===m.tagName&&1===n?m:b,f=c.render("iphone","attachment_input",{resId:h,length:j,fileName:i,origSrc:l,distinguish:k}),e.log("html => : "+f),g.outerHTML=f,a.requests.RequestReplaceAttachment.push([{src:l,title:i,length:parseInt(j,10),path:h}])})}}}),define("iphone/filters/input/br",function(a){var b=a("core/underscore"),c=a("web/dom/isTag");return{name:"br",action:function(a,d){var e=this.editor,f=e.document,g=d.children;g&&g.length&&(g=b.toArray(g),b.each(g,function(a){var b,e;c(a,"br")&&(e=f.createElement("div"),b=a.cloneNode(!0),e.appendChild(b),d.replaceChild(e,a))}))}}}),define("iphone/filters/input/handwrite",function(a){var b=a("core/underscore"),c=a("editor/cmd/CmdBall"),d=a("editor/math/handwriteAreaUniqueId"),e=a("iphone/util/isRemoteYoudaoURL"),f=function(a){if(a){a=String(a);var b=a.lastIndexOf("/"),c=a.substr(b);if(c)return c=c.toLowerCase(),c.replace(".zip","").replace(/[^a-z0-9]/g,"")}};return{name:"handwrite",action:function(a,g){var h=this,i=h.editor,j=[],k="img[data-media-type=handwrite],img.ynote-handwrite-image",l=g.querySelectorAll(k);l=b.toArray(l),a.requests.RequestReplaceImage||(a.requests.RequestReplaceImage=[]),a.requests.RequestSetHandwriteEditable||(a.requests.RequestSetHandwriteEditable=[]),b.each(l,function(b){if(b.dataset&&!b.dataset.yneOrigSrc){var c,g=b.getAttribute("src"),h=b.dataset.resHandwrite;b.dataset.yneOrigSrc=g,e(g)&&(b.src="./blank.png"),h&&(c=f(h)||d(),b.dataset.areaId=c,j.push({areaId:c,resSrc:h,imgSrc:g})),a.requests.RequestReplaceImage.push([g])}}),j.length&&(a.requests.RequestSetHandwriteEditable.push([j]),i.onCommand(c.create("appendBlankLines",{lines:1})))}}}),define("iphone/filters/input/image",function(a){var b=a("core/underscore"),c=a("web/bom/userAgent"),d=a("iphone/util/isRemoteImage"),e=a("iphone/util/isRemoteYoudaoURL"),f=["image","attachment","handwrite","todo"],g="unknown-media-type"+(c.RETINA?"@2x":"")+".png",h="303px",i="62px";return{name:"image",action:function(a,c){var j,k,l=this,m=l.editor;a.requests.RequestReplaceImage||(a.requests.RequestReplaceImage=[]),k=c.getElementsByTagName("img"),k=b.toArray(k),b.each(k,function(b){if(!b.dataset||!b.dataset.yneOrigSrc){var c,k,l,n=b.getAttribute("src"),o=(b.dataset.mediaType||"").toLowerCase();if(o&&-1===f.indexOf(o))return b.dataset.yneOrigSrc=n,b.dataset.unknownMedia="true",b.src=g,b.style.width=h,void(b.style.height=i);k="handwrite"===o||b.classList.contains("ynote-handwrite-image"),k||(c="attachment"===o||b.getAttribute("path"),c||"todo"!==o&&(o||(b.dataset.mediaType="image"),d(b)?(l=m.document.createElement("img"),l.onload=function(){l.onload=l.onerror=l.onabort=null;var a,b=l.width,c=l.height,d=m.document.createElement("canvas"),e=d.getContext("2d");d.width=b,d.height=c,e.drawImage(l,0,0);try{a=d.toDataURL("image/jpeg")}catch(f){}a&&a.length>10&&m.bridge.callNativeApi("RequestSaveImage",[n,a])},l.onerror=l.onabort=function(){l.onload=l.onerror=l.onabort=null},l.src=n):n?(e(b.src)&&(b.src="./blank.png"),b.dataset.yneOrigSrc=n,a.requests.RequestReplaceImage.push([n])):(j=b.parentNode,j&&j.removeChild&&j.removeChild(b))))}})}}}),define("iphone/filters/input/script",function(a){var b=a("core/underscore"),c=a("web/dom/isTag");return{name:"script",action:function(a,d){var e=/javascript:/i,f="script, style, iframe",g=d.querySelectorAll(f);g=b.toArray(g),b.each(g,function(a){a.parentNode&&a.parentNode.removeChild(a)}),g=d.querySelectorAll("*"),g=b.toArray(g),b.each(g,function(a){var d=b.toArray(a.attributes);b.each(d,function(b){var c=b.nodeName;0===c.indexOf("on")&&a.removeAttribute(c)}),c(a,"a")&&e.test(a.href)&&(a.href="")})}}}),define("iphone/filters/input/todo",function(a){var b=a("core/underscore"),c=a("web/dom/dataset"),d=a("core/str/trim"),e=a("core/math/unique"),f=a("templates/jst"),g="img[data-media-type=todo]";return{name:"todo",action:function(a,h){var i,j,k,l,m,n,o,p,q,r=this,s=r.editor,t=s.todoGroupManager,u=s.noteUniqueId,v=[],w=function(a){return a&&"div"===(a.tagName||"").toLowerCase()},x=function(a){var b,c,e=a.childNodes,f=e.length;if(0===f)return!1;for(b=0;f>b;b++)if(c=e[b],3===c.nodeType){if(d(c.nodeValue))return!1}else if(1===c.nodeType&&!c.webkitMatchesSelector("br")&&!c.webkitMatchesSelector(g))return!1;return!0},y=function(a){var d=a.querySelectorAll(g),e=a.parentNode;d=b.toArray(d),b.each(d,function(b){c.set(b,"yneWrap","div"),e.insertBefore(b,a)}),e.removeChild(a)};for(a.requests.RequestTodoGroupImg||(a.requests.RequestTodoGroupImg=[]),i=b.toArray(h.querySelectorAll(g)),j=i.length,k=j-1;k>=0;k--)for(l=i[k],n=l.parentNode;w(n)&&x(n);)o=n.parentNode,y(n),n=o;for(i=b.toArray(h.querySelectorAll(g)),j=i.length,k=0;j>k;k++){for(l=i[k],m=[],q=i[k+1];l;)m.push(l),p=l.nextSibling,p&&q&&(p===q||p.nextSibling===q&&(1!==p.nodeType&&!d(p.nodeValue)||"BR"===p.tagName))?(l=q,k+=1,q=i[k+1]):l=null;v.push(m)}b.each(v,function(d){var g,h,i,j,k=e("group"),l=d.length,m=[];if(b.each(d,function(a){var b=c.get(a,"resTodo"),d="div"===c.get(a,"yneWrap");m.push(t.createTodoInfo(b,d))}),t.add(k,m),g=f.render("iphone","todo_group",{noteUniqueId:u,groupId:k}),i=b.first(d),l>1){for(h=b.last(d),j=i.parentNode;i.nextSibling!==h;)j.removeChild(i.nextSibling);j.removeChild(h)}i.outerHTML=g,a.requests.RequestTodoGroupImg.push([k,t.getTodoIds(k)])})}}}),define("iphone/filters/key/autoLink",function(a){var b=a("editor/str/uriReg"),c=a("web/dom/findParent");
return{name:"autoLink",triggersEdit:!1,action:function(a,d){var e,f,g,h,i,j,k,l,m,n,o=[13,32],p=d.which,q=this.editor;-1!==o.indexOf(p)&&(n=q.getRange(),n&&n.collapsed&&(e=n.commonAncestorContainer,e&&3===e.nodeType&&(c(e,"a")||(k=n.startOffset,f=e.nodeValue,g=f.substring(0,k),j=b.matchEnd(g),j&&(h=j.result[0],l=j.result.index,m=l+h.length,m===g.length&&(i=j.fullURI,n.setStart(e,l),n.setEnd(e,m),q.selectRange(n),q.commander.exec("createLink",i,!0),n.collapse(!1),q.selectRange(n)))))))}}}),define("iphone/filters/key/backspace",function(a){var b=a("web/event/keyMouseMap"),c=a("editor/fn/checkAndRunOne"),d=a("iphone/filters/key/backspaceHandlers"),e=a("iphone/filters/key/backspaceTimeoutHandlers"),f=a("web/console");return{name:"backspace",action:function(a,g){var h,i,j=this,k=j.editor;b.match(g,b.BACKSPACE)&&(h=[a,g],window.setTimeout(function(){c(e,h,k)},50),i=c(d,h,k),i&&f.log("backspaceHandlers name: "+i.name+" - "+i.success))}}}),define("iphone/filters/key/backspaceHandlers",function(a){var b=a("core/underscore"),c=a("web/dom/isTag");return{atListItemStart:{check:function(){var a=this,b=a.getRange();return b&&0===b.startOffset?c(b.startContainer,"li"):!1},action:function(){var a=this;return a.commander.execNative("outdent"),!0}},gotoTableLastTd:{check:function(){var a,b,d=this,e=d.article,f=d.getRange();if(!f||0!==f.startOffset)return!1;if(a=f.startContainer,a===e)return!1;for(b=a.parentNode;a===b.firstChild&&b!==e;)a=b,b=a.parentNode;if(a===b.firstChild)return!1;for(a=a.previousSibling;a&&!c(a,"table");)a=a.lastChild;return c(a,"table")?a:!1},action:function(a,c,d){var e=this,f=b.toArray(a.querySelectorAll("td"));return f&&f.length?(d.preventDefault(),e.selectNodeContents(f[f.length-1],{collapsed:!0}),!0):!0}},ensureCaret:{check:function(){var a,b,d=this,e=d.article;return e&&e.childNodes&&1===e.childNodes.length?(a=e.childNodes[0],c(a,"br")?!0:c(a,"div")?(b=a.childNodes,!b||!b.length||1===b.length&&c(b[0],"br")):void 0):!1},action:function(a,b,c){return c.preventDefault(),!0}},imageSelect:{check:function(){var a,d,e,f=this,g=f.getRange();return g&&g.collapsed?(a=g.startContainer,e=g.startOffset,b.isElement(a)&&e>0?(d=a.childNodes[e-1],c(d,"img")?d:!1):!1):!1},action:function(a,b,c){return c.preventDefault(),this.selectNode(a),!0}}}}),define("iphone/filters/key/backspaceTimeoutHandlers",function(a){var b=a("web/dom/isTag"),c=a("iphone/util/blankLine"),d=a("iphone/edit/editingModes"),e=a("web/dom/insert");return{ensureCaret:{check:function(){var a=this,c=a.article,d=c.childNodes;return!d||0===d.length||1===d.length&&(""===c.innerHTML||b(d[0],"br"))},action:function(){var a=this;return a.article.innerHTML="<div><br/></div>",a.focusArticle(),!0}},enterHandwriteArea:{check:function(){var a=this,b=a.getRange(),c=a.handwriteArea.getByRange(b);return c||!1},action:function(a){var b,f,g,h,i=this,j=i.document,k=!1,l=function(a){var b,d=a.ownerDocument;i.handwriteArea.isMatched(a.lastChild)&&(b=c.create(d),a.appendChild(b))};if(l(i.article),i.editingMode===d.HANDWRITE)return!0;if(g=a.dataset.areaId,!g)return!1;if(b=i.getRange(),!b||!b.collapsed)return!1;for(i.handwriteNeedle.moveToRange(b),f=j.createElement("div");a.lastChild&&!i.handwriteArea.isHandwriteItem(a.lastChild)&&!i.handwriteNeedle.isMatched(a.lastChild);)h=a.removeChild(a.lastChild),k=!0,f.firstChild?f.appendChild(h):f.insertBefore(h,f.firstChild);return k&&e(f).after(a),i.setEditingMode({mode:d.HANDWRITE,force:!0,fromApi:!1,dataId:g}),!0}}}}),define("iphone/filters/key/editKeys",function(a){var b=a("web/event/keyMouseMap");return{name:"editKeys",action:function(a,c){var d=this.editor;b.match(c,b.BACKSPACE)&&d.trigger("edit",{status:"delete"})}}}),define("iphone/filters/key/linkUpdate",function(a){var b=a("editor/str/uriReg"),c=a("web/dom/isTag");return{name:"linkUpdate",triggersEdit:!1,action:function(a,d){var e,f,g,h,i=50,j=this.editor;!d||d.keyCode>=37&&d.keyCode<=40||(e=j.getRange(),e&&e.commonAncestorContainer&&(f=e.commonAncestorContainer,3===f.nodeType&&(f=f.parentNode),c(f,"a")&&(g=f.getAttribute("href"),h=f.innerText||f.textContent,g&&h&&b.fullMatch(g)&&b.fullMatch(h)&&window.setTimeout(function(){if(f.parentNode){var a,c,d=f.innerText||f.textContent;d&&d!==h&&(a=b.fullMatch(d),a&&(c=a.fullURI,c!==g&&(f.setAttribute("href",c),j.notifyNativeDocChange())))}},i))))}}}),define("iphone/filters/key/tab",function(a){var b=a("web/event/keyMouseMap"),c=a("editor/fn/checkAndRunOne"),d=a("iphone/filters/key/tabHandlers");return{name:"tab",action:function(a,e){var f,g=this;b.match(e,b.TAB)&&(f=c(d,[a,e],g),f.success||(e.shiftKey?g.commander.exec("outdent"):g.commander.exec("indent"),e.preventDefault()))}}}),define("iphone/filters/key/tabHandlers",function(a){var b=a("web/dom/findParent");return{rangeInTd:{check:function(){var a=this,c=a.getRange();return c?b(c.commonAncestorContainer,"td"):!1},action:function(a,c,d){var e,f,g,h,i,j,k,l=this;return d.shiftKey?(e="previousSibling",f="lastChild",g="insertBefore"):(e="nextSibling",f="firstChild",g="appendChild"),a[e]?h=a[e]:(i=b(a,"tr"),i[e]?h=i[e][f]:(j=b(i,"table"),j[e]?h=j[e]:(h=j.ownerDocument.createElement("p"),j.parentNode[g](h,j)))),h.nodeType!==Node.TEXT_NODE&&(h[f]&&h[f].nodeType===Node.TEXT_NODE?h=h[f]:(k=h.ownerDocument.createTextNode(""),h[g](k,h[f]),h=k)),l.selectNode(h,{collapsed:!0,collapseToStart:!1}),d.preventDefault(),!0}}}}),define("iphone/filters/output/attachment",function(a){var b=a("core/underscore"),c=a("templates/jst");return{name:"attachment",action:function(a,d){var e=d.ownerDocument,f="img[data-media-type=attachment]",g=d.querySelectorAll(f);g=b.toArray(g),b.each(g,function(a){var b=e.createElement("div"),d=a.dataset,f=d.yneOrigSrc||decodeURI(a.src.replace(/\?\d+$/g,""));b.innerHTML=c.render("iphone","attachment_output",{src:f,fileLength:d.fileLength,resId:d.resId,fileName:d.fileName,distinguish:d.distinguish}),a.parentNode.replaceChild(b.firstChild,a)})}}}),define("iphone/filters/output/font",function(a){var b=a("core/underscore"),c=a("web/dom/dataset");return{name:"font",action:function(a,d){var e=d.querySelectorAll("[data-font-face]");e=b.toArray(e),b.each(e,function(a){var b=c.get(a,"fontFace");b&&a.setAttribute("face",b),a.removeAttribute("data-font-face")}),e=d.querySelectorAll("[data-font-family]"),e=b.toArray(e),b.each(e,function(a){var b=c.get(a,"fontFamily");b&&(a.style.fontFamily=b),a.removeAttribute("data-font-family")})}}}),define("iphone/filters/output/format",function(a){var b=a("core/underscore");return{name:"format",action:function(a,c){1===c.childNodes.length&&"BR"===c.firstChild.tagName&&c.removeChild(c.firstChild);var d='[data-yne-recognition="tel"]',e=b.toArray(c.querySelectorAll(d));b.each(e,function(a){var b,c=a.parentNode;if(c){for(b=a.firstChild;b;)c.insertBefore(b,a),b=a.firstChild;c.removeChild(a)}})}}}),define("iphone/filters/output/handwrite",function(a){var b=a("core/underscore"),c=a("web/console");return{name:"handwrite",action:function(a,d){var e,f,g=this,h=g.editor,i=h.document,j="img[data-media-type=handwrite]",k=d.querySelectorAll(j);k=b.toArray(k),b.each(k,function(a){a.dataset&&a.dataset.yneOrigSrc&&(a.src=a.dataset.yneOrigSrc,delete a.dataset.yneOrigSrc,a.classList.remove("size-fit-editor"))}),e=h.handwriteArea.queryAll("",d),b.each(e,function(a){if(a.dataset&&"true"!==a.dataset.changed&&a.dataset.origResHandwrite){var b=i.createElement("img");b.src=a.dataset.origImgSrc,b.dataset.resHandwrite=a.dataset.origResHandwrite,b.dataset.mediaType="handwrite",a.parentNode.replaceChild(b,a)}}),b.each(h.handwriteInfo,function(a){var e=h.handwriteArea.queryByAreaId(a.areaId,d);c.log("areaId: "+a.areaId),e=b.toArray(e),b.each(e,function(b){var c;b&&b.getElementsByTagName&&b.getElementsByTagName("img").length>0?(c=i.createElement("img"),c.src=a.path,c.dataset.mediaType="handwrite",a.infoId&&(c.dataset.resHandwrite=a.infoId),b.parentNode.replaceChild(c,b)):b.parentNode.removeChild(b)})}),f=h.handwriteArea.queryAll("",d),b.each(f,function(a){try{a.parentNode.removeChild(a)}catch(b){}})}}}),define("iphone/filters/output/image",function(a){var b=a("core/underscore"),c=a("editor/str/uniqueSuffix");return{name:"image",action:function(a,d){var e=d.querySelectorAll("img");e=b.toArray(e),b.each(e,function(a){var b;null!=a.dataset.mediaType||null!=a.getAttribute("path")||a.classList.contains("editor-attachment")||(a.dataset.mediaType="image"),"true"===a.dataset.unknownMedia&&(delete a.dataset.unknownMedia,a.style.width="",a.style.height=""),a.dataset.yneOrigSrc?(b=a.dataset.yneOrigSrc,delete a.dataset.yneOrigSrc):b=a.getAttribute("src"),a.setAttribute("src",c.remove(b)),a.classList.remove("size-fit-editor")})}}}),define("iphone/filters/output/todo",function(a){var b=a("core/underscore"),c=a("web/dom/dataset");return{name:"todo",action:function(a,d){var e=this,f=e.editor,g="img[data-media-type=todogroup]",h=d.querySelectorAll(g);h=b.toArray(h),b.each(h,function(a){var d,e=c.get(a,"groupId"),g=f.todoGroupManager.get(e),h=a.parentNode;g&&(d=g.getTodoInfos()),b.each(d,function(b){var c,d=document.createElement("img");d.setAttribute("src","DEFAULTIMAGE"),d.setAttribute("data-media-type","todo"),d.setAttribute("data-res-todo",b.id),b.wrapped?(c=document.createElement("div"),c.appendChild(d)):c=d,h.insertBefore(c,a)}),h.removeChild(a)})}}}),define("iphone/filters/paste/br",function(a){var b=a("core/underscore"),c=a("web/dom/nodeType"),d=a("web/dom/isTag"),e=a("web/console");return{name:"br",action:function(){var a=this.editor,f=a.document,g=a.article,h=g.children;h&&h.length&&(h=b.toArray(h),b.each(h,function(a){var b,h,i;d(a,"br")?(h=f.createElement("div"),b=a.cloneNode(!0),h.appendChild(b),g.replaceChild(h,a)):d(a,"div")&&(i=a.childNodes.length,0===i?(b=f.createElement("br"),a.appendChild(b)):1===i&&(h=a.childNodes[0],c.isText(h)&&1===h.nodeValue.length&&e.log(h.nodeValue.charCodeAt(0)),!c.isText(h)||h.nodeValue&&"\r"!==h.nodeValue&&"\n"!==h.nodeValue||(b=f.createElement("br"),a.replaceChild(b,h))))}))}}}),define("iphone/history/DataDelegate",function(a){var b=a("core/underscore"),c=a("core/Base"),d=a("editor/str/base64"),e=a("web/console"),f=/^http/i.test(window.location.href),g=c.extend({initialize:function(){var a=this,b=a.options;a.editor=b.editor,a.editor.on("data-arrive",function(b){a.trigger("data-arrive",b)})},get:function(a,b){var c,g,h,i,j=this,k=j.editor;if(k.bridge.callNativeApi("RequestUndoOperation",[a,b]),e.DEBUG&&f&&window.localStorage){for(c=[],g=window.localStorage,i=a;b>=i&&(h=g.getItem("undo_"+i),h);i++)h=window.JSON.parse(d.decode(h)),c.push(h);c.length&&j.trigger("data-arrive",c)}},save:function(a){var c,g=this,h=g.editor,i=b.map(a,function(a){return{index:a.index,operation:a.operation.toJSONString()}});i&&i.length&&h.bridge.callNativeApi("SaveUndoOperation",[i]),e.DEBUG&&f&&window.localStorage&&(c=window.localStorage,b.each(i,function(a){var b=a.index,f=window.JSON.stringify(a);f=d.encode(f),e.log(">>>>>>>>>> save undo_"+b+" ------------>"),c.setItem("undo_"+b,f)}))}});return g}),define("iphone/history/Operation",function(a){var b=a("core/underscore"),c=a("core/Class"),d=a("iphone/history/noteImage"),e=c.extend({initialize:function(a){var b=this;b.editor=a.editor,a.data?b._initWithJSONData(a.data,a.isStored):b._initFromEditor()},_initFromEditor:function(){var a=this;a.updateBeforeFromEditor(),a.updateAfterFromEditor()},_initWithJSONData:function(a,c){var d,e=this;d=b.isString(a)?window.JSON.parse(a):a,e._time=d.time,e._imageBefore=d.imageBefore,e._imageAfter=d.imageAfter,c&&(e._isStored=!0)},updateBeforeFromEditor:function(){var a=this;a._imageBefore=d.getFromEditor(a.editor),a._time=(new Date).getTime()},updateAfterFromEditor:function(){var a=this;b.defer(function(){a._imageAfter=d.getFromEditor(a.editor),a._time=(new Date).getTime()})},setImageBefore:function(a){this._imageBefore=a},beforeEqualsAfter:function(){var a=this;return d.isEqualContent(a._imageBefore,a._imageAfter)},getImage:function(a){var b=this;return a?b._imageBefore:b._imageAfter},getTime:function(){return this._time},isStored:function(){return this._isStored===!0},toJSON:function(){var a=this;return{time:a._time,imageBefore:a._imageBefore,imageAfter:a._imageAfter}},toJSONString:function(){var a=this,b=a.toJSON();return window.JSON.stringify(b)}},{create:function(a,b,c){return a?new e({editor:a,data:b,isStored:c}):void 0}});return e}),define("iphone/history/UndoManager",function(a){var b,c=a("core/underscore"),d=a("core/Base"),e=a("iphone/history/noteImage"),f=a("iphone/history/Operation"),g=a("iphone/history/DataDelegate");return b=d.extend({initialize:function(a){var b=this;b.editor=a.editor,b.on("indexchanged",b.onIndexChanged,b),b.dataDelegate=new g({editor:a.editor}),b.dataDelegate.on("data-arrive",b.onDataArrive,b),b.reset()},reset:function(){var a=this,b=a.options;a.maxCacheStep=b.maxCacheStep||10,a.operations=[],a.status="none",a.disabled=!1,delete a.currentIndex,delete a.before,a.indexBase=0,a.operationCounter=0},onIndexChanged:function(){var a=this,b=a.editor.bridge,c=a.canUndo(),d=a.canRedo(),e=!1;a._lastCanUndo!==c&&(a._lastCanUndo=c,e=!0),a._lastCanRedo!==d&&(a._lastCanRedo=d,e=!0),e&&b.callNativeApi("OnUndoStatusChanged",[c,d])},onDataArrive:function(a){var b,d,e=this,g=e.operations,h=[],i=[],j=[];a&&a.length&&g&&(b=e.indexBase,d=b+g.length-1,c.each(a,function(a){var c=a.index;b-1>=c?h.push(a):c>=d+1&&i.push(a)}),h.length&&c.last(h).index===b-1&&(h.reverse(),c.some(h,function(a){var b,c,d=e.indexBase;if(a.index===d-1){if(e.currentIndex>=g.length-1)return!0;g.length>=e.maxCacheStep&&(c=e.indexBase+g.length-1,b=g.pop(),b.isStored()||j.push({index:c,operation:b})),b=f.create(e.editor,a.operation,!0),g.unshift(b),e.indexBase--,e.currentIndex++}})),i.length&&c.first(i).index===d+1&&c.some(i,function(a){var b,c,d=e.indexBase+g.length-1;if(a.index===d+1){if(e.currentIndex<=0)return!0;g.length>=e.maxCacheStep&&(c=e.indexBase,b=g.shift(),e.indexBase++,e.currentIndex--,b.isStored()||j.push({index:c,operation:b})),b=f.create(e.editor,a.operation,!0),g.push(b)}}),j.length&&e.dataDelegate.save(j),e.trigger("indexchanged"))},getStoredDataIfNeeded:function(a){var b,c,d=this,e=d.operations,f=3,g=3;if(d.currentIndex-0<f&&a){if(c=d.indexBase-1,b=c-g+1,0>c)return;b=0>b?0:b}else if(e.length-1-d.currentIndex<f&&!a){if(b=d.indexBase+e.length,c=b+g-1,b>=d.operationCounter)return;c=c>=d.operationCounter?d.operationCounter-1:c}null!=b&&null!=c&&d.dataDelegate.get(b,c)},disable:function(){var a=this;a.disabled||(a.reset(),a.disabled=!0)},enable:function(){var a=this;a.disabled&&(a.disabled=!1)},prepareComposition:function(){var a=this;a._isComposition=!0,a._imageBeforeComposition=e.getFromEditor(a.editor)},canUndo:function(){var a=this;return a.disabled?!1:void 0===a.currentIndex||void 0===a.before?!1:a.currentIndex>0||a.before===!1},canRedo:function(){var a=this;return a.disabled?!1:void 0===a.currentIndex||void 0===a.before?!1:0===a.operations.length?!1:a.before===!0||a.currentIndex>=0&&a.currentIndex<a.operations.length-1},save:function(a){var b,c,d,g,h,i,j,k=this,l=f.create(k.editor),m=k.maxCacheStep,n=k.operations,o=k.status,p=["textInput","delete","forwardDelete"],q=[],r=1e3;if(a=a||{},b=a.status,c=a.forced,k._isComposition&&(k._isComposition=!1,l.setImageBefore(k._imageBeforeComposition)),void 0===k.currentIndex||0===n.length)return k.currentIndex=0,k.before=!1,k.status=b||"none",n.push(l),k.operationCounter++,void k.trigger("indexchanged");if(d=n[k.currentIndex],!c&&b===o&&p.indexOf(b)>-1){if(i=(new Date).getTime()-d.getTime()>r,!i)return d.updateAfterFromEditor(),void(k.before=!1);if(g=e.getFromEditor(k.editor),j=d.getImage(!1),e.isEqualRange(g,j))return d.updateAfterFromEditor(),void(k.before=!1)}for(k.status=b||"none",k.before===!0||d.beforeEqualsAfter()?n[k.currentIndex]=l:(k.currentIndex++,n[k.currentIndex]=l,k.operationCounter++),k.before=!1,n.length=k.currentIndex+1,h=k.indexBase+n.length,h<k.operationCounter&&(k.operationCounter=h);n.length>m;)h=n.shift(),h.isStored()||q.push({index:k.indexBase,operation:h}),k.indexBase++,k.currentIndex--,k.currentIndex<0&&(k.currentIndex=0);q.length&&k.dataDelegate.save(q),k.trigger("indexchanged")},undo:function(){var a,b,c=this,d=c.operations;return c.getStoredDataIfNeeded(!0),c.canUndo()?(c.before&&c.currentIndex--,b=d[c.currentIndex],a=b.getImage(!0),c.before=!0,c.restoreImage(a),c.status="none",c.trigger("indexchanged"),!0):!1},redo:function(){var a,b,c=this,d=c.operations;return c.getStoredDataIfNeeded(!1),c.canRedo()?(c.before||c.currentIndex++,b=d[c.currentIndex],a=b.getImage(!1),c.before=!1,c.restoreImage(a),c.status="none",c.trigger("indexchanged"),!0):!1},updateCurrentOperationAfter:function(){var a,b=this;0!==b.operations.length&&(a=b.operations[b.currentIndex],a.updateAfterFromEditor())},restoreImage:function(a){e.restoreToEditor(this.editor,a)}})}),define("iphone/history/jsonEditStatus",function(a){var b=a("iphone/edit/editingModes"),c=a("iphone/history/jsonRange");return{get:function(a){return a.editingMode===b.HANDWRITE?{isHandwrite:!0}:{isHandwrite:!1,range:c.get(a.article,a.getRange())}},parse:function(a,b){var d;return b.isHandwrite?{isHandwrite:!0}:(d={isHandwrite:!1},b.range?(d.range=c.parse(a.article,b.range),d):d)}}}),define("iphone/history/jsonRange",function(a){var b=a("core/underscore"),c=a("web/dom/nodeType"),d=a("web/console");return{get:function(a,e){if(a&&e){var f=function(d){var e,f={};return c.isText(d)?(e=d.parentNode,f.childIndex=b.indexOf(e.childNodes,d)):e=d,f.isRoot=e===a,f.isRoot?f:(f.tagName=e.tagName,f.tagIndex=b.indexOf(a.querySelectorAll(f.tagName),e),f)},g={collapsed:e.collapsed,startContainer:f(e.startContainer),startOffset:e.startOffset};return d.log(g),g.collapsed?g:(g.endContainer=f(e.endContainer),g.endOffset=e.endOffset,g)}},parse:function(a,b){if(a&&b){var c,d=function(b){var c,d;return b.isRoot?null!=b.childIndex?a.childNodes[b.childIndex]:a:(d=a.querySelectorAll(b.tagName),c=d[b.tagIndex],null!=b.childIndex?c.childNodes[b.childIndex]:c)},e=a.ownerDocument,f=e.createRange(),g=d(b.startContainer);return f.setStart(g,b.startOffset),b.collapsed?f.setEnd(g,b.startOffset):(c=d(b.endContainer),f.setEnd(c,b.endOffset)),f}}}}),define("iphone/history/noteImage",function(a){var b=a("core/underscore"),c=a("iphone/history/jsonEditStatus"),d=a("iphone/edit/editingModes"),e=a("web/dom/dataset"),f=a("editor/str/uniqueSuffix");return{getFromEditor:function(a){return{content:a.getRawContent(),status:c.get(a)}},restoreToEditor:function(a,g){a&&g&&a.silentDo(function(){var h,i,j,k,l,m,n=a.todoGroupManager,o="img[data-media-type=todogroup]",p=document.implementation.createHTMLDocument(),q=function(b){b&&a.relocateHandwriteCaret(),a.scrollCaretIntoView()},r=function(a){var c="img[data-media-type=image]",d=a.querySelectorAll(c);return b.some(d,function(a){return/^http/i.test(a.src)})},s=50,t=!1;return p.body.innerHTML=g.content,m=b.toArray(p.querySelectorAll(o)),b.each(m,function(a){var b,c,d=e.get(a,"groupId"),g=n.get(d);if(!g)return a.parentNode.removeChild(a),void(t=!0);if(g.isChanged()){if(b=a.getAttribute("src"),c=f.add(b,!0),c===b)return;a.setAttribute("src",c),t=!0}}),l=p.body.innerHTML,a.lastSelection=null,a.setRawContent(l),h=g.status,h.isHandwrite&&(j=a.handwriteNeedle.queryOne())?(k=e.get(j.parentNode,"areaId"),a.setEditingMode({mode:d.HANDWRITE,force:!0,dataId:k}),t=!0,void(t&&window.setTimeout(function(){q(!0)},s))):(h.range&&(i=c.parse(a,h),i.range&&(a.lastSelection=i.range)),a.setEditingMode({mode:d.NORMAL,force:!0}),t||(t=r(a.article)),void(t&&window.setTimeout(function(){q(!1)},s)))})},isEqualContent:function(a,b){return a&&b?a.content===b.content:void 0},isEqualRange:function(a,c){return a&&c&&a.status&&c.status?b.isEqual(a.status.range,c.status.range):void 0}}}),define("iphone/io/bridge",function(a){var b=a("core/underscore"),c=a("core/console"),d=a("editor/str/base64"),e=a("iphone/io/nativeApiInterface"),f=a("iphone/io/editorApi"),g=function(a,b){var c;try{c=window.JSON.stringify(a)}catch(e){}if(b!==!0)return c;try{c=d.encode(c)}catch(e){}return c},h=function(a,b){var c;if(b===!0)try{a=d.decode(a)}catch(e){}try{c=window.JSON.parse(a)}catch(e){}return c},i={_editor:null,_hasReadyRun:!1,_uidCounter:0,_cacheData:{},ready:function(a){var b=this;b._hasReadyRun||(b._editor=a,b._provideEditorApi(),b.callNativeApi("Ready"),b._hasReadyRun=!0)},_provideEditorApi:function(){var a=this;window.Editor&&c.error("window.Editor is already exist!"),window.Editor={execEditorApi:a.execEditorApi.bind(a)}},callNativeApi:function(a,d){var f=this,g=e,h="";return g[a]?(c.DEBUG&&"Log"!==a&&g[a].apply(null,d),d&&d.length&&(f._uidCounter++,h="uid"+f._uidCounter,f._cacheData[h]=d),void b.defer(function(){var b=document,d=b.body,e=b.createElement("iframe");e.style.display="none",e.src="async:"+a+":"+h,d.appendChild(e),d.removeChild(e),c.DEBUG&&"Log"!==a&&c.log("async:"+a+":"+h)})):void c.warn("no native api: "+a,"iphone/io/bridge")},_getDataByUID:function(a){var b=this._cacheData,c=b[a];return delete b[a],c},execEditorApi:function(a,d){if(!a||!f[a]||!b.isFunction(f[a]))return void c.error("no editor api: "+a);var e,i,j=this;if(d&&(e=h(d,!0)),e=e||[],c.DEBUG)i=f[a].apply(j._editor,e);else try{i=f[a].apply(j._editor,e)}catch(k){}return null!=i?g({result:i},!1):void 0},execEditorApiWithoutEncode:function(a,b){var c,d,e,f=this;return b&&(c=g(b,!0)),d=f.execEditorApi(a,c||null),d&&(e=h(d,!1),e&&e.result)?e.result:void 0}};return c.DEBUG&&0!==window.location.href.indexOf("http")&&(c.log=function(){if(arguments.length){var a=[];b.each(arguments,function(c){var d;if(b.isElement(c))a.push(c.outerHTML);else{try{d=window.JSON.stringify(c)}catch(e){d=c+""}a.push(d)}}),i.callNativeApi("Log",[3,a.join(";")])}}),i}),define("iphone/io/editorApi",function(a){var b,c=a("web/dom/nodeType"),d=a("core/underscore"),e=a("core/str/trim"),f=a("core/str/endsWith"),g=a("editor/str/uniqueSuffix"),h=a("web/dom/size"),i=a("web/dom/remove"),j=a("web/dom/dataset"),k=a("web/dom/parseHTML"),l=a("web/event/events"),m=a("core/fn/Until"),n=a("iphone/todo/todoHeights"),o=a("editor/cmd/CmdBall"),p=a("iphone/edit/editingModes"),q=a("iphone/edit/nextLine"),r=a("core/console"),s=a("templates/jst"),t=1e8,u={scrollPositionY:null,fontName:null,scrollTodoUntil:null,scrollTodoId:null,scrollImgOrAttachUntil:null,scrollImgOrAttach:null},v=function(a,b){return a=g.remove(a),b=g.remove(b),a=a.replace(/^https:/,"http:"),b=b.replace(/^https:/,"http:"),a===b},w=function(a,b){b.setEditorDefaultFont.call(a,u.fontName,null,!0),u.scrollPositionY?b.setCurrentPosition.call(a,u.scrollPositionY):u.scrollImgOrAttach?b.scroll2Attachment.call(a,u.scrollImgOrAttach):u.scrollTodoId&&b.scroll2Todo.call(a,u.scrollTodoId)},x=function(a,b,c){if(a&&b&&c){c+="";var e,f,g,h,i=a.article,j="img[data-media-type="+c+"]";if(d.isString(b))e=b;else{if(!d.isArray(b))return;e=d.last(b)}if(a.silentDo(function(){a.beforeInsert&&a.beforeInsert(),a.focusArticle(!0),a.commander.exec("insertImage",{src:b,attr:{"data-media-type":c}}),a.commander.exec("appendBlankLines",{lines:2})}),a.notifyNativeDocChange(),g=i.querySelectorAll(j),d.some(g,function(a){return a.getAttribute("src")===e?(f=a,!0):void 0}),!f)return void r.log("no lastImg");if(h=q(f,a),!h)return void r.log("no next line");a.selectNodeContents(h,{collapsed:!0,collapseToStart:!0}),a.scrollCaretIntoView()}};return b={getEditorHtmlContent:function(){return this.getContent()},getEditorTextContent:function(){var a=this,b=a.article.innerText;return e(b)},getEditorFirstLineTextContent:function(){var a,b,d,f=this,g=f.document,h=f.article.firstChild,i="",j=["block","list-item","table-row","table"],k=window.NodeFilter;if(!h)return"";for(a=g.createNodeIterator(f.article,k.SHOW_ELEMENT+k.SHOW_TEXT,null),b=f.area.window.getComputedStyle,d=a.nextNode();d&&!(i.length>0&&c.isElement(d)&&j.indexOf(b(d).display)>-1);)c.isText(d)&&(i+=e(d.nodeValue)),d=a.nextNode();return i},setEditorHtmlContent:function(a){r.log("setEditorHtmlContent: "+a);var c=this,d=100;c._isContentRendered=!1,c.setContent(a),window.setTimeout(function(){w(c,b)},d)},setEditorDefaultFont:function(a,b,c){var d=this,e=d.article;r.log("fontName: "+a+"\n fontSize: "+b+"\n overrideAll: "+c),a&&(e.style.fontFamily=String(a),c===!0&&(d._isContentRendered?(r.log("setEditorDefaultFont overrideAll"),u.fontName=null,d.silentDo(function(){var a=d.filters.input;a&&a.execOnly&&a.execOnly(["font"],{},e)})):u.fontName=a)),b&&(e.style.fontSize=b+"px")},setKeyboardMode:function(a){this._keyboardMode=a},focusEditor:function(a){this.focusArticle(a)},blurEditor:function(){this.blurArticle()},finalize:function(){var a=this,b=document,c=window.Editor;l.unbind(a.article).unbind(b.body).unbind(b),a.commander&&a.commander.finalize&&a.commander.finalize(),d.each(a.filters,function(a){a&&a.finalize&&a.finalize()}),d.each(a,function(b){delete a[b]}),d.each(c,function(a){delete c[a]}),window.Editor=c=null,document.body.innerHTML=""},setReadOnlyMode:function(a){a=a===!0;var b=this;b.setReadOnlyMode(a,!0)},setHtmlReadOnly:function(a){this.setHtmlReadOnly(a)},setEditorEditingMode:function(a){var b=this;b.setEditingMode({mode:a,fromApi:!0})},setHandwriteEditable:function(a){var b=this,c=function(){var c='<br data-handwrite-id="BR" class="ynote-handwrite-br ynote-handwrite-item" />',e=b.article,f="img[data-media-type=handwrite]",g=e.querySelectorAll(f);g.length&&d.each(a,function(a,e){if(a&&a.length){var f,h=[],i=d.find(g,function(a){return a.dataset.areaId===e});i&&(d.each(a,function(a){"BR"===a.id?h.push(c):h.push(s.render("iphone","handwrite_small_image",a))}),f=b.handwriteArea.createNew(e,!1),f.innerHTML=h.join(""),f.dataset.origImgSrc=i.getAttribute("src"),f.dataset.origResHandwrite=i.dataset.resHandwrite,i.parentNode.replaceChild(f,i))}})};b.silentDo(c)},showCaret:function(){var a=this;a.scrollCaretIntoView(!0)},setEditorInnerHeight:function(a){a>0&&(this._viewPortHeight=a)},setEditorFullHeight:function(a){var b=this;b._viewPortFullHeight=a||null,b._viewPortFullHeight&&(b.article.style.minHeight=b._viewPortFullHeight+"px")},getCurrentPosition:function(){var a,b=this;return b.silentDo(function(){var c=b.document,d=c.defaultView,e=h.outerHeight(c.body,!0);a=Math.round(d.scrollY/e*t)}),a},setCurrentPosition:function(a){if(null!=a){var b,c,d=this,e=d.document,f=e.defaultView;if(d._isContentRendered===!0){if(b=h.outerHeight(e.body,!0),c=b*a/t,!c)return;u.scrollPositionY=null,f.scrollTo(0,c)}else u.scrollPositionY=a}},doPaste:function(a){r.log("paste () @ iPhoneEditorApi.js");var b,c,e=this;a&&a.onlyText&&!a.isPlainText&&a.html&&(b=k(a.html,document,!0),c=b.querySelectorAll("img"),c=d.toArray(c),d.each(c,function(a){i(a)}),a.html=b.innerHTML),e.commander.exec(o.create("doPaste",a))},insertImageToEditor:function(a){var b=this;x(b,a,"image")},replaceImageByOrigSrc:function(a,b){var c=this,e=c.article.querySelectorAll("img"),f=g.add(b.url,!0);e=d.toArray(e),c.silentDo(function(){d.forEach(e,function(b){v(b.dataset.yneOrigSrc,a)&&(b.src=f)})})},replaceImageByPresentSrc:function(a,b,c){r.log("editorApi -> replaceImageByPresentSrc",a,b);var e=this,f=e.article.querySelectorAll("img"),h=g.add(b.url,!0),i=b.updateSize!==!1,j=new Image;j.src=a,a=j.src,j=null,e.silentDo(function(){d.forEach(f,function(b){v(b.src,a)&&(b.src=h,i&&b.classList.add("size-fit-editor"))})}),c&&e.notifyNativeDocChange()},updateImages:function(a,b){if(a&&a.length){b=b||0;var c,e,f=this,h=f.article,j="img[data-media-type=image], img[data-media-type=handwrite]:not([data-res-handwrite])",k=h.querySelectorAll(j),l=function(a){var b,c=h.querySelectorAll(j);return d.some(c,function(c){return v(c.dataset.yneOrigSrc||c.getAttribute("src"),a)?(b=c,!0):void 0}),b},m=function(a){if(a&&-1!==a.status)return l(a.src);if(c=f.getRange())return c.commonAncestorContainer},n=function(a){a&&(a.scrollIntoViewIfNeeded?a.scrollIntoViewIfNeeded(!0):a.scrollIntoView&&a.scrollIntoView(!0))},o=!1;k&&k.length&&(k=d.toArray(k),d.each(a,function(a){a&&a.status&&a.src&&(-1===a.status?d.each(k,function(b){v(b.dataset.yneOrigSrc||b.getAttribute("src"),a.src)&&(i(b),o=!0)}):d.isString(a.status)&&d.each(k,function(b){v(b.dataset.yneOrigSrc||b.getAttribute("src"),a.src)&&(b.setAttribute("src",g.add(a.status,!0)),delete b.dataset.yneOrigSrc,o=!0)}))}),o&&f.notifyNativeDocChange&&f.notifyNativeDocChange(),e=m(a[b]),n(e))}},removeTodoGroup:function(a){var b=this,c="img[data-group-id="+a+"]",e=b.article.querySelectorAll(c);e=d.toArray(e),d.each(e,function(a){a&&a.parentNode&&a.parentNode.removeChild(a)}),b.todoGroupManager.remove(a)},updateTodoGroupImg:function(a,b,c,e,f){var h=this,i="img[data-group-id="+a+"]",j=d.toArray(h.article.querySelectorAll(i)),k=h.todoGroupManager.get(a);b=g.add(b,!0),h.silentDo(function(){d.each(j,function(a){a.setAttribute("src",b),e&&n.set(a,e)})}),c&&(h.notifyNativeDocChange(),k&&k.setEdited()),f&&h.todoGroupCheckboxKey===f&&(h.todoGroupCheckboxKey=null)},removeTodoInGroup:function(a,b,c){var e=this,f="img[data-group-id="+a+"]",h=d.toArray(e.article.querySelectorAll(f));c=g.add(c,!0),d.each(h,function(a){a.setAttribute("src",c)}),e.todoGroupManager.removeAtIndexInGroup(a,b),e.notifyNativeDocChange()},appendTodoInGroup:function(a,b,c,d){var e=this;e.commander.exec("appendTodo",{groupId:a,todoId:b,imgSrc:c,notifyChange:d})},getAllTodos:function(){var a=this,b=a.article,c="img[data-media-type=todogroup]",e=d.toArray(b.querySelectorAll(c)),f=[],g=0;return d.each(e,function(b){var c=j.get(b,"groupId"),e=a.todoGroupManager.getTodoIds(c);d.each(e,function(a){f.push({todoId:a,pos:g}),g++})}),f},insertTodoGroup:function(a,b,c){var d=this;d.commander.exec(o.create("insertTodoGroup",{groupId:a,todoIds:b,imgSrc:c}))},scroll2Todo:function(a){if(r.log("scroll2Todo: "+a),a){var b=this,c=b.article;b._isContentRendered===!0?(u.scrollTodoUntil&&u.scrollTodoUntil.finalize(),u.scrollTodoUntil=m.create(function(){var e,g,h="img[data-media-type=todogroup]",i=d.toArray(c.querySelectorAll(h)),k=function(a,b){var c=-1;return d.some(a,function(a,d){return a===b||f(a,b)?(c=d,!0):void 0}),c},l=0;d.some(i,function(c){var f,g=j.get(c,"groupId"),h=b.todoGroupManager.getTodoIds(g),i=k(h,a),m=55;return h&&r.log("scroll2Todo groupImg: "+h.join(";")),-1===i?!1:(e=c,f=n.get(c),f&&f.length?(r.log("heights: "+f.join(";")),f=d.first(f,i),l=d.reduce(f,function(a,b){return a+b},0)):l=i*m,!0)}),r.log("scroll2Todo groupImg: "+e),e&&e.getBoundingClientRect&&(u.scrollTodoId=null,g=e.getBoundingClientRect(),r.log("scroll2Todo rect: "+g),r.log("scroll2Todo: "+l),l=g.top+window.pageYOffset+l-15,r.log("scroll2Todo y: "+l),window.scrollTo(0,l))},function(a){var b="img[data-media-type=todogroup]",e=d.toArray(c.querySelectorAll(b));return a>0&&d.every(e,function(a){return"DEFAULTIMAGE"!==a.getAttribute("src")})},50,5),u.scrollTodoUntil.startRun()):(u.scrollTodoUntil&&u.scrollTodoUntil.finalize(),u.scrollTodoId=a)}},setAttachmentState:function(a,b){if(a&&b){var c=this,e='img[data-media-type=attachment][data-res-id="'+a+'"]',f=d.toArray(c.article.querySelectorAll(e));d.each(f,function(a){a.src=g.add(b,!0)})}},insertAttachmentToEditor:function(a,b,c,e){var f,g,h,i=this,j="img[data-media-type=attachment]";i.silentDo(function(){i.beforeInsert&&i.beforeInsert(),i.focusArticle(),i.commander.exec("insertAttachment",{fileName:c,image:a,id:b,length:e},i.area),i.commander.exec("appendBlankLines",{lines:2})}),i.notifyNativeDocChange(),f=i.article.querySelectorAll(j),d.some(f,function(b){return b.getAttribute("src")===a?(g=b,!0):void 0}),g&&(h=q(g,i),h&&(i.selectNodeContents(h,{collapsed:!0,collapseToStart:!0}),i.scrollCaretIntoView()))},scroll2Attachment:function(a,b){if(r.log("scroll2Attachment: "+a),a){b=b===!0;var c,e=this,f=e.article,h=function(a){var b,c="img[data-media-type]",e=f.querySelectorAll(c);return a=g.remove(a),d.some(e,function(c){var d=c.dataset.mediaType,e=d&&("image"===d||"handwrite"===d&&!c.dataset.resHandwrite);if(e)return v(c.dataset.yneOrigSrc,a)||v(c.getAttribute("src"),a)||v(c.src,a)?(b=c,!0):void 0}),b},i=function(a){var b,c="div[data-orig-img-src], img[data-res-handwrite]";return d.some(f.querySelectorAll(c),function(c){return v(c.dataset.origImgSrc||c.getAttribute("src"),a)?(b=c,!0):void 0}),
b},j=function(a){return f.querySelector('[data-res-id="'+a+'"]')};e._isContentRendered===!0?(c=j(a),b||(c=c||h(a)||i(a)),c&&c.scrollIntoView&&(u.scrollImgOrAttachUntil&&u.scrollImgOrAttachUntil.finalize(),u.scrollImgOrAttachUntil=m.create(function(){c.scrollIntoView(!0)},function(){return!(!c.width||!c.height)},25,10),u.scrollImgOrAttachUntil.startRun())):(u.scrollImgOrAttachUntil&&u.scrollImgOrAttachUntil.finalize(),u.scrollImgOrAttach=a)}},getClientPosBelowLastHandwrite:function(){var a,b,d,f=this,g=f._lastHandwriteAreaId,h=f.handwriteArea.queryByAreaId(g);if(h&&h[0]){for(a=h[0],d=a.nextSibling;d;)c.isText(d)&&""===e(d)?d=d.nextSibling:f.handwriteArea.isMatched(d)?(a=d,d=d.nextSibling):d=null;if(a&&a.getBoundingClientRect&&(b=a.getBoundingClientRect(),b&&b.height>0))return{top:b.top+b.height}}},getAllHandwriteAreaInfo:function(){var a=this,b={},c=a.handwriteArea.queryAll(),e=a.document.createRange();return d.each(c,function(a){var c,f;r.log("changed: "+a.dataset.changed+" . "+typeof a.dataset.changed),"true"===a.dataset.changed&&(c=d.filter(a.children,function(a){return a.webkitMatchesSelector&&a.webkitMatchesSelector(".ynote-handwrite-item")}),c&&c.length&&(e.selectNode(a),f=e.getBoundingClientRect(),b[a.dataset.areaId]=d.map(c,function(a){var b,c={},d=a.dataset.handwriteId;return"BR"===d?{id:"BR"}:(e.selectNode(a),b=e.getBoundingClientRect(),c.width=b.width,c.height=b.height,c.left=b.left-f.left,c.right=b.right-f.left,c.top=b.top-f.top,c.bottom=b.bottom-f.top,{id:d,imgSrc:a.src,rect:c})})))}),e.detach(),b},setHandwriteAreaInfo:function(a){if(!d.isArray(a))throw new Error("INVALID handwriteInfo type");this.handwriteInfo=a},insertHandwriteCharacter:function(a,b){var c=this,d=function(){c.commander.exec("insertHandwriteCharacter",{path:a,id:b})};a&&b&&(c.freezeHandwriteCaretForInsert?c.freezeHandwriteCaretForInsert(d):d())},insertHandwriteBr:function(){var a=this,b=function(){a.commander.exec("insertHandwriteBr")};a.freezeHandwriteCaretForInsert?a.freezeHandwriteCaretForInsert(b):b()},insertHandwriteImage:function(a){var b=this;x(b,a,"handwrite")},insertHandwriteArea:function(a,b){var c=this,d=function(){c.beforeInsert&&c.beforeInsert(!0),c.commander.exec("insertHandwriteArea",a),c._lastHandwriteAreaId=a,c.setEditingMode&&c.setEditingMode({mode:p.HANDWRITE,fromApi:!0,force:!0})};b===!1?d():c.silentDo(d)},handwriteBackspace:function(){var a=this;a.focusArticle(),a.commander.exec("handwriteBackspace")},finishHandwrite:function(){var a,b=this,c=b.handwriteNeedle.queryOne(),d=c.parentNode;b.handwriteArea.isMatched(d)&&(b.commander.exec("insertBlankLinesAfterNode",{node:d,lines:1,silent:!0}),a=d.nextSibling,a&&b.selectNode(a,{collapsed:!0,collapseToStart:!0}))},insertOrderedList:function(){var a=this;a.onCommand(o.create("insertOrderedList",null,!0))},insertUnorderedList:function(){var a=this;a.onCommand(o.create("insertUnorderedList",null,!0))},passUndoOperation:function(a){var b=this;b.trigger("data-arrive",a)},canUndo:function(){return this.commander.exec(o.create("canUndo"))},canRedo:function(){return this.commander.exec(o.create("canRedo"))},undo:function(){this.undo()},redo:function(){this.redo()},getDataByUID:function(a){return this.bridge._getDataByUID(a)}}}),define("iphone/io/nativeApiInterface",function(a){var b,c=a("core/console");return b={LOG_DEBUG:3,LOG_INFO:2,LOG_WARN:1,LOG_FATAL:0,Log:function(a,b){c.log("debug",a,b)},Ready:function(){c.log("nativeApiInterface.Ready")},OnDocumentChange:function(){c.log("nativeApiInterface.OnDocumentChange")},OnAreaClick:function(){c.log("nativeApiInterface.OnAreaClick")},OpenImage:function(a){c.log("nativeApiInterface.OpenImage: "+a)},RequestPasting:function(){c.log("nativeApiInterface.RequestPasting");var a=window.testPaste,b=window.debugEditor;a&&b&&b.bridge.execEditorApiWithoutEncode("doPaste",[{html:a}])},SetHandwrite:function(a,b){c.log("nativeApiInterface.SetHandwrite",a,b)},RequestReplaceAttachment:function(a){c.log("nativeApiInterface.RequestReplaceAttachment",a)},RequestReplaceImage:function(a){c.log("nativeApiInterface.RequestReplaceImage",a)},RequestReplaceFakeUrlImage:function(a){c.log("nativeApiInterface.RequestReplaceFakeUrlImage",a)},RequestSaveImage:function(a,b){c.log("nativeApiInterface.RequestSaveImage",a)},OpenAttachment:function(a){c.log("nativeApiInterface.OpenAttachment",a)},OpenImageOrAttachment:function(a,b,d){c.log("nativeApiInterface.OpenImageOrAttachment",a,b,d)},RequestTodoGroupImg:function(a,b){c.log("<webViewApi>RequestTodoGroupImg groupId, todoIDs"),c.log(a),c.log(b)},ClickTodoGroup:function(a,b,d,e,f){c.log("<WebView>ClickTodoGroup groupId: "+a),c.log(b),c.log("x, y: "+d+", "+e)},RequestSetHandwriteEditable:function(a){c.log("nativeApiInterface.RequestSetHandwriteEditable",a)},EnterImageBrowser:function(a,b){c.log("nativeApiInterface.EnterImageBrowser",a,b)},ClickOnAttachment:function(a){c.log("nativeApiInterface.ClickOnAttachment",a)},DeleteAttachments:function(a){c.log("nativeApiInterface.DeleteAttachments",a)},OpenLink:function(a){c.log("nativeApiInterface.OpenLink",a)},OpenImageLink:function(a){c.log("nativeApiInterface.OpenImageLink",a)},RequestUndoOperation:function(a,b){c.log("nativeApiInterface.RequestUndoOperation: "+a+", "+b)},SaveUndoOperation:function(a){c.log("nativeApiInterface.SaveUndoOperation: "+a.length)},OnUndoStatusChanged:function(a,b){c.log("nativeApiInterface.OnUndoStatusChanged canUndo: "+a+" canRedo: "+b)},StoreLog:function(a){c.log("nativeApiInterface.StoreLog",a)}}}),define("iphone/parse/pasteRules",function(){return{defaultTag:"span",tags:{a:{attributes:{href:!0,hreflang:!0,target:!0,type:!0}},acronym:"span",abbr:{attributes:{title:!0}},applet:!1,area:!1,article:"div",aside:"div",audio:{attributes:{autoplay:!0,autobuffer:!0,controls:!0,src:!0,volume:!0}},b:!0,base:!1,basefont:!1,bdi:!0,bdo:!0,bgsound:!1,big:"span",blink:"span",blockquote:{attributes:{cite:!0}},body:"div",br:!0,button:!1,canvas:!1,caption:{styles:{"caption-side":!0}},center:"div",cite:!0,code:!0,col:{attributes:{span:!0}},colgroup:{attributes:{span:!0}},data:!1,datalist:!1,dd:!0,del:{attributes:{cite:!0,datetime:!0}},details:{attributes:{open:!0}},dfn:!0,dir:"div",div:!0,dl:!0,dt:!0,em:!0,embed:!1,fieldset:!0,figcaption:!0,figure:!0,font:{attributes:{color:!0,face:!0,size:!0}},footer:!0,form:"div",frame:!1,frameset:!1,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,head:!1,header:!0,hgroup:"div",hr:!0,html:"div",i:!0,iframe:!1,img:{attributes:{src:!0,alt:!0,title:!0,width:!0,height:!0},styles:{width:!0,height:!0}},input:!1,ins:{attributes:{cite:!0,datetime:!0}},isindex:!1,kbd:!0,keygen:!1,label:!0,legend:!0,li:{attributes:{value:!0}},link:!1,listing:!1,main:"div",map:!1,mark:!0,marquee:"div",menu:{attributes:{type:!0,label:!0}},menuitem:!1,meta:!1,meter:{attributes:{value:!0,min:!0,max:!0,low:!0,high:!0,optimum:!0}},nav:!0,nobr:"div",noframes:"div",noscript:"div",object:!1,ol:{attributes:{reversed:!0,start:!0,type:!0}},optgroup:{attributes:{disabled:!0,label:!0}},option:"li",output:{attributes:{name:!0}},p:!0,param:!1,plaintext:"pre",pre:!0,progress:{attributes:{max:!0,value:!0,orient:!0}},q:{attributes:{cite:!0}},rp:!0,rt:!0,ruby:!0,s:"del",samp:!0,script:!1,section:"div",select:"ol",small:!0,source:{attributes:{src:!0,type:!0,media:!0}},spacer:!1,span:!0,strike:"del",strong:!0,style:{attributes:{type:"true",media:"true",scoped:"true",title:"true",disabled:"true"}},sub:!0,summary:"div",sup:!0,table:{attributes:{border:{rename:"border",value:"1"},cellpadding:{rename:"cellpadding",value:"2"},cellspacing:{rename:"cellspacing",value:"0"},width:!0}},tbody:!0,td:{attributes:{valign:!0,colspan:!0,headers:!0,rowspan:!0},styles:{width:!0,height:!0}},textarea:!1,tfoot:!0,th:{attributes:{abbr:!0,axis:!0,colspan:!0,headers:!0,rowspan:!0,scope:!0},styles:{width:!0,height:!0}},thead:!0,time:{attributes:{datetime:!0,pubdate:!0}},title:!1,tr:!0,track:{attributes:{"default":!0,kind:!0,label:!0,src:!0,srclang:!0}},tt:"code",u:!0,ul:!0,"var":!0,video:{attributes:{autoplay:!0,buffered:!0,controls:!0,crossorigin:!0,height:!0,loop:!0,muted:!0,played:!0,preload:!0,poster:!0,src:!0,width:!0}},wbr:!0,xmp:"pre"},attributes:{dir:!0,lang:!0,title:!0,datasetFilter:function(a,b){return"mediaType"===b}},styles:{background:function(a,b,c,d){var e=window.getComputedStyle(d),f=e.backgroundColor;return{rename:"background-color",value:f}},"background-color":!0,color:!0,font:!0,"font-family":!0,"font-size":!0,"font-style":!0,"font-weight":!0},classes:!1}}),define("iphone/queryCmd/canRedo",function(){return{name:"canRedo",action:function(){var a=this,b=a.editor.undoManager;return b&&b.canRedo?b.canRedo():!1}}}),define("iphone/queryCmd/canUndo",function(){return{name:"canUndo",action:function(){var a=this,b=a.editor.undoManager;return b&&b.canUndo?b.canUndo():!1}}}),define("iphone/todo/todoHeights",function(a){var b=a("core/underscore"),c=a("editor/str/base64"),d=a("web/dom/dataset");return{encode:function(a){return a&&a.length?(a=a.join(";"),c.encode(a)):""},decode:function(a){if(a){var d=c.decode(a),e=d.split(";");return e&&e.length?b.map(e,function(a){return parseInt(a,10)}):void 0}},get:function(a){var b=this,c=d.get(a,"todoHeights");if(c)return b.decode(c)},set:function(a,b){var c,e=this;b&&b.length&&(c=e.encode(b),d.set(a,"todoHeights",c))}}}),define("iphone/util/blankLine",function(a){var b=a("web/dom/isTag"),c=a("web/dom/insert");return{is:function(a,c){var d;return c===!1||b(a,"div")||b(a,"p")?(d=a.childNodes.length,1===d&&b(a.children[0],"br")):!1},create:function(a){a=a||document;var b=a.createElement("div");return b.innerHTML="<br/>",b},insertAfter:function(a){var b=this;a&&c(b.create(a.ownerDocument)).after(a)},insertBefore:function(a){var b=this;a&&c(b.create(a.ownerDocument)).before(a)}}}),define("iphone/util/isRemoteImage",function(a){var b=a("core/str/startsWith"),c=a("core/str/trim");return function(a){if(a&&a.src){var d=c(a.src);return b(d,"http")&&-1===d.indexOf("note.youdao.com")&&-1===d.indexOf("note.corp.youdao.com")}}}),define("iphone/util/isRemoteYoudaoURL",function(a){var b=a("core/str/trim");return function(a){if(a=b(a+""),!a)return!1;var c=/^https?:\/\/note\.(corp\.)?youdao\.com/i;return c.test(a)}}),define("iphone/util/isValidSrc",function(a){var b=a("core/str/startsWith");return function(a){return a=String(a),b(a,"http://")||b(a,"https://")||b(a,"file:///")||b(a,"/")||!1}}),define("iphone/util/linkHref",function(a){var b=a("core/str/trim");return{isHttp:function(a){return a=b(a),/^https?:\/\//i.test(a)},isHttpPage:function(a){return a=b(a),/^https?:\/\//i.test(a)&&!/\.(mpe?g|avi|mov|swf|wmv|3gp|rm|rmvb|mkv|flv|mp4|mp3|wav|ogg|acc|wma|jpe?g|gif|bmp|png|tiff|bmp)$/i.test(a)},isInlineJS:function(a){return a=b(a),/^javascript:/i.test(a)}}}),define("iphone/view/IPhoneAreaView",function(a){var b=a("editor/view/AreaView"),c=a("web/event/events"),d=a("web/dom/className"),e=function(){var a="",b=window.screen.width;return 375===b?a="iphone_6":b>=414&&(a="iphone_6_plus"),a},f=b.extend({tagName:"article",className:"editor-area iphone-editor-area",initialize:function(){var a=this;a.window=window},getArticle:function(){return this.el},bindEvent:function(){var a=this,b=a.window.document;a.bindArticleEvent(),["selectionchange","contextmenu","keydown","click","touchstart","touchmove","touchend"].forEach(function(d){c.bind(b,d,a.trigger.bind(a,d))}),a.trigger("ready")},bindArticleEvent:function(){var a=this,b=a.getArticle();["DOMSubtreeModified","paste","cut","textInput","compositionstart"].forEach(function(d){c.bind(b,d,a.trigger.bind(a,d))})},render:function(){var a,b=this,c=b.window.document;b._hasRenderOnce||(b._hasRenderOnce=!0,b.el=c.body.querySelector("article"),a=e(),a&&d.add(b.el,a),b.bindEvent())}});return f}),define("iphone/view/IPhoneEditorView",function(a){var b,c=a("editor/view/EditorView"),d=a("core/underscore"),e=a("core/console"),f=a("web/dom/contains"),g=a("web/dom/dataset"),h=a("web/dom/parseHTML"),i=a("web/bom/userAgent"),j=a("web/dom/doc"),k=a("iphone/edit/editingModes"),l=a("iphone/util/isValidSrc"),m=a("editor/cmd/CmdBall"),n=a("iphone/edit/clickHandlers"),o=a("iphone/edit/touchHandlers"),p=a("editor/fn/checkAndRunOne"),q=a("iphone/util/blankLine"),r=a("iphone/edit/HandwriteNeedle"),s=a("iphone/edit/HandwriteCaret"),t=a("iphone/edit/HandwriteBr"),u=a("iphone/edit/HandwriteArea"),v=a("iphone/edit/TodoGroupManager"),w=a("editor/dom/mediaType"),x=a("iphone/edit/keyboardModes"),y=a("editor/dom/isZeroRect");return b=c.extend({editingMode:null,_viewPortHeight:null,_viewPortFullHeight:null,_currentTouch:null,handwriteInfo:null,handwriteCaret:null,handwriteNeedle:null,handwriteBr:null,handwriteArea:null,hwCaretFrozenTimeout:null,todoGroupManager:null,todoGroupCheckboxKey:null,initialize:function(){var a=this,b=document,d=b.body;a.el=d,a.editingMode=k.NO_EDIT,a.handwriteInfo=[],a._keyboardMode=x.HIDE,c.prototype.initialize.apply(a,arguments),a.commander.addCmd({name:"bridge.callNativeApi",action:function(b){a.bridge.callNativeApi(b[0],b[1])}}),a.todoGroupManager=new v},getFormatPainterManager:function(){return this.formatPainterManager},render:function(){var a=this,b=a.textarea;b&&b.parentNode&&b.parentNode.removeChild(b),a.area.render()},parseEvent:function(a){var b=this,c={isOnHandwriteArea:!1,isInHandwriteArea:!1,handwriteArea:null,isInEditableArea:!1},d=a.target;return d&&d.webkitMatchesSelector?b.handwriteArea.isMatched(d)?(c.isOnHandwriteArea=c.isInHandwriteArea=!0,c.handwriteArea=d,c):b.handwriteArea.isChild(d)?(c.isInHandwriteArea=!0,c.handwriteArea=b.handwriteArea.getByChild(d),c):(c.isInEditableArea=!0,c):(c.isInEditableArea=!0,c)},moveHandwriteCaretToItem:function(a,b){var c=this,d=".ynote-handwrite-item";a&&a.webkitMatchesSelector&&a.webkitMatchesSelector(d)&&(c.selectNode(a,{collapsed:!0,collapseToStart:b===!0}),c.moveHandwriteCaretToRange(c.getRange()))},moveHandwriteCaretToRange:function(a){var b,c=this;if(a&&a.commonAncestorContainer)return c.silentDo(function(){var d=a.commonAncestorContainer;d=3===d.nodeType?d.parentNode:d,(c.handwriteArea.isMatched(d)||c.handwriteArea.isChild(d))&&(b=c.handwriteNeedle.removeAndCreateNew(),a.collapse(!1),a.insertNode(b),c.relocateHandwriteCaret(),c.scrollCaretIntoView())}),b},relocateHandwriteCaret:function(){var a=this;a.handwriteCaret.showAtNeedle(a.handwriteNeedle)},scrollCaretIntoView:function(a){var b=this,c=50;b._scrollCaretIntoViewTimeout&&window.clearTimeout(b._scrollCaretIntoViewTimeout),b._scrollCaretIntoViewTimeout=window.setTimeout(function(){b._scrollCaretIntoViewTimeout=null,b._scrollCaretIntoView(a===!0)},c)},_scrollCaretIntoView:function(a){var b,c=this,d=c.editingMode===k.HANDWRITE,f=c._computeViewRect(),g=10,h=function(a){var b=window.screen.width-20;return b>a?0:a-30};if(d?(c.relocateHandwriteCaret(),b=c._computeHandwriteCaretRect(),g+=40):(b=c._computeRealCaretRect(),g+=20),e.log("_scrollCaretIntoView.....viewRect ... caretRect"),e.log(f),!y(b)){if(e.log("caretRect top-right-bottom-left: ",b.top,b.right,b.bottom,b.left),f.left<=b.left&&f.top<=b.top&&f.right>=b.right&&f.bottom>=b.bottom)return void e.log("caret is already in viewport");a=a===!0,f.bottom<b.bottom?c.scroll2Position(h(b.left),b.bottom+g-f.height,a):f.top>b.top&&c.scroll2Position(h(b.left),b.top-10,a)}},_computeViewRect:function(){var a=this,b=320,c=document.documentElement,d=a._viewPortHeight||216,e=Math.max(window.pageXOffset,c.scrollLeft),f=Math.max(window.pageYOffset,c.scrollTop);return{left:e,top:f,right:e+b,bottom:f+d,height:d,width:b}},_computeHandwriteCaretRect:function(){var a=this,b=0,c=40,d=a.handwriteCaret.getPosition();return{left:d.left,top:d.top,right:d.left+b,bottom:d.top+c,width:b,height:c}},_computeRealCaretRect:function(){var a,b=this,c=b.getRange(),d=function(a){var b,c,d=a.getClientRects();if(d&&d[0]&&(c=d[0],!y(c)))return i.IOS_7?c:(b=j.scroll(),{left:c.left+b.left,right:c.right+b.left,top:c.top+b.top,bottom:c.bottom+b.top,width:c.width,height:c.height})},f=function(a){var b,c,d,e;if(a.collapsed&&q.is(a.startContainer,!1)&&(c=a.startContainer.getClientRects(),c&&c[0]))return b=c[0],y(b)?null:(e={top:b.top,left:b.left,bottom:b.bottom,right:b.left,width:0,height:b.height},i.IOS_7?e:(d=j.scroll(),{left:e.left+d.left,right:e.right+d.left,top:e.top+d.top,bottom:e.bottom+d.top,width:e.width,height:e.height}))},g=function(a){if(a&&a.collapsed){var b,c,d,e,f=a.startContainer,g=a.startOffset;if(!(0>=g)&&(b=f.childNodes[g-1],b&&w.isImage(b)&&(c=b.getBoundingClientRect(),!y(c))))return e={top:c.top,bottom:c.bottom,left:c.right,right:c.right,width:0,height:c.height},d=j.scroll(),{left:e.left+d.left,right:e.right+d.left,top:e.top+d.top,bottom:e.bottom+d.top,width:e.width,height:e.height}}};return c&&c.getClientRects?(a=d(c)||f(c)||g(c),a&&null!=a.left&&null!=a.right&&null!=a.top&&null!=a.bottom?a:null):(e.log("no range @IPhoneEditorView - _computeRealCaretRect()"),null)},scroll2Position:function(a,b,c){var d,f=this,g=500;e.log("scroll2Position _lastY: "+f._lastY),e.log("window.scrollTo: "+a+","+b),f._lastYTimeStamp&&c!==!0&&(d=(new Date).getTime(),d-f._lastYTimeStamp>g&&(c=!0)),f._lastY&&c!==!0&&Math.abs(f._lastY-b)<20||(f._lastY=b,f._lastYTimeStamp=(new Date).getTime(),window.scrollTo(a,b))},_focusEditableArea:function(a){var b,c,e,f=this,g=d.toArray(f.article.children),h=function(a){return f.handwriteArea.isMatched(a)||f.handwriteArea.isChild(a)?!1:f.handwriteArea.queryOne("",a)?!1:!0};for(a=d.extend({first:!1},a),b=a.first?0:g.length-1,c=g[b];c;)h(c)?(e=c,c=null):(b=b+a.first?1:-1,c=g[b]);e||(e=f.document.createElement("div"),e.innerHTML="<br/>",a.first&&g.length?f.article.insertBefore(e,g[0]):f.article.appendChild(e)),f.selectNodeContents(e,{collapsed:!0})},onSelectionChange:function(){var a,b,c=this,d=c.getRange();if(d){if(a=c.handwriteArea.getByRange(d),!a)return void(c.lastSelection=d);if(d.collapsed&&c.editingMode===k.NORMAL&&c._keyboardMode===x.SHOW){if(b=g.get(a,"areaId"),!b)return;window.setTimeout(function(){c.handwriteNeedle.moveToRange(d),c.setEditingMode({mode:k.HANDWRITE,force:!0,fromApi:!1,dataId:b})},50)}}},onAreaChange:function(){var a=this;a.isReadOnlyMode||(a.scrollCaretIntoView(),a.notifyNativeDocChange())},notifyNativeDocChange:function(){e.log("notifyNativeDocChange....................."),this.bridge.callNativeApi("OnDocumentChange")},onAreaClick:function(a){var b=this,c=a._rawEvent||a;p(n,[c.target,c],b)},onAreaTouchStart:function(a){var b=this,c=a._rawEvent||a,d=c.touches[0];b._isTouchEndFired=!1,b._startPosition={clientX:d.clientX,clientY:d.clientY},b._currentTouch=d,b._touchStartTime=Date.now(),b._keyboardMode===x.HIDE&&b.setHtmlReadOnly(!0),e.log("====onAreaTouchStart===="+a.target.outerHTML)},onAreaTouchMove:function(a){var b=a._rawEvent||a;this._currentTouch=b.touches[0]},onAreaTouchEnd:function(a){e.log("onAreaTouchEnd");var b,c,f=this,g=a._rawEvent||a,h=g.touches[0]||f._currentTouch,i=f._startPosition,j=i.clientX-h.clientX,l=i.clientY-h.clientY,m=Math.pow(j,2)+Math.pow(l,2),n=g.target,q=f.parseEvent(g),r={},s=500,t=Date.now()-f._touchStartTime,u=t>=s;f._isTouchEndFired=!0,f._currentTouch=null,m>100||(f._selectContentOnViewMode===!0?(b=f.getRange(),f._selectContentOnViewMode=f._keyboardMode===x.HIDE&&b&&b.collapsed===!1):f._selectContentOnViewMode=f._keyboardMode===x.HIDE&&u,e.log("_selectContentOnViewMode: "+f._selectContentOnViewMode),f._selectContentOnViewMode||(c=p(o,[n,g,h],f),d.isObject(c.result)&&c.result.preventModeChange||f.isReadOnlyMode||(q.isInHandwriteArea?(a.preventDefault(),f.setHtmlReadOnly(!0),r.mode=k.HANDWRITE,r.dataId=q.handwriteArea.dataset.areaId):(f.setHtmlReadOnly(!1),r.mode=k.NORMAL,b=document.caretRangeFromPoint(h.clientX,h.clientY),b&&(f.lastSelection=b)),f.setEditingMode(r))))},onAreaPaste:function(a){var b=this;return a&&a.preventDefault?(a.preventDefault(),void b.bridge.callNativeApi("RequestPasting")):void d.defer(function(){var a=b.article.querySelectorAll("img");d.each(a,function(a){var c=a.src;l(c)||b.bridge.callNativeApi("RequestReplaceFakeUrlImage",[c])})},25)},onAreaCut:function(){var a=this,b=a.undoManager;e.log("on area cut..."),b&&b.save({forced:!0}),window.setTimeout(function(){a.scrollCaretIntoView(!0)},500)},freezeHandwriteCaretForInsert:function(a,b,c){var d=this,e=d.handwriteCaret;d.hwCaretFrozenTimeout&&window.clearTimeout(d.hwCaretFrozenTimeout),e.stopBlink(),window.setTimeout(function(){a&&a.apply(b||d,c||[]),d.hwCaretFrozenTimeout=window.setTimeout(function(){e.startBlink()},1e3)},0)},beforeInsert:function(a){var b,c,d=this;return a===!0?(d.setHtmlReadOnly(!0),void d.blurArticle()):(d.setHtmlReadOnly(!1),d.focusArticle(),b=d.getRange(),void(b&&(b.collapse(!1),c=d.handwriteArea.getByRange(b),c&&d.selectNode(c,{collapsed:!0}))))},setEditingMode:function(a){var b,c,e=this,f=e.handwriteCaret;a=d.extend({mode:null,force:!1,fromApi:!1,dataId:null},a),b=a.mode,b!==k.NO_EDIT&&b!==k.NORMAL&&b!==k.HANDWRITE&&(a.mode=b=k.NORMAL,a.force=!0),(b!==e.editingMode||a.force)&&(c=b===k.HANDWRITE,c||b===k.NO_EDIT?e.setHtmlReadOnly(!0):e.setHtmlReadOnly(!1),e.editingMode=b,c?(e.commander.exec("appendBlankLines",{lines:2}),e.relocateHandwriteCaret(),e._lastHandwriteAreaId=a.dataId||e._lastHandwriteAreaId):(f.hide(),e.silentDo(function(){e.handwriteNeedle.remove()})),b!==k.NO_EDIT&&(a.fromApi!==!0&&e.bridge.callNativeApi("SetHandwrite",[c,c?a.dataId:""]),b===k.NORMAL&&e.focusArticle(a.force),e.scrollCaretIntoView()))},onPressEnter:function(){var a=this;d.delay(d.bind(a._handleEnterWithDelay,a),50)},_handleEnterWithDelay:function(){var a=this;a.commander.exec(m.create("appendBlankLines",{lines:2,silent:!0}))},setContent:function(a,b){b=b||{};var c,e=this,f=window.document,g=!b.ignoreFilter&&e.filters.input;a=(a||"")+"",c=a.toLowerCase(),a&&"<br>"!==c&&"<br/>"!==c||(a="<div><br/></div>",g=!1),e.lastSelection=null,e.noteUniqueId=e.newNoteUniqueId(),e.todoGroupManager=new v,e.silentDo(function(){e.resetAllChangeTracers(),e.commander.resetCmds(),e.undoManager&&e.undoManager.reset();var b,c;if(g){if(b=h(a,f,!0),b||(b=f.createElement("div"),b.innerHTML=a),b){for(c={requests:{}},e.filters.input.exec(null,c,b),e.article.innerHTML="";b.firstChild;)e.article.appendChild(b.firstChild);b=null,d.each(c.requests,function(a,b){a&&a.length&&d.each(a,function(a){e.bridge.callNativeApi(b,a)})}),c=null,e.trigger("content_set")}}else e.article.innerHTML=a,e.trigger("content_set");window.setTimeout(function(){e._isContentRendered=!0,e.trigger("content_render")},0),e.setHtmlReadOnly(!0)})},onAreaReady:function(){var a=this;c.prototype.onAreaReady.apply(a,arguments),a.handwriteNeedle=new r({editor:a}),a.handwriteCaret=new s({editor:a,element:document.querySelector(".ynote-handwrite-caret")}),a.handwriteBr=new t({editor:a}),a.handwriteArea=new u({editor:a}),a.bridge.ready(a),c.prototype._onAreaReadyEnd.call(a)},_bindEventsOnReady:function(){var a=this;c.prototype._bindEventsOnReady.call(a),a.area.bind("keydown",function(b){13===b.keyCode&&a.onPressEnter()}).bind("touchstart",a.onAreaTouchStart,a).bind("touchmove",a.onAreaTouchMove,a).bind("touchend",a.onAreaTouchEnd,a).bind("cut",a.onAreaCut,a)},undo:function(){var a=this;a.commander.exec(m.create("undo",null,!1))},redo:function(){var a=this;a.commander.exec(m.create("redo",null,!1))},focusArticle:function(a){var b,c=this;if(c.lastSelection)c.selectRange(c.lastSelection);else if(a===!0){if(b=document.activeElement,!b||!f(c.article,b)){window.focus();try{c.article.focus()}catch(d){}}c._focusEditableArea()}},blurArticle:function(){var a=this;try{a.article.blur()}catch(b){}window.blur()}})}),define("parser/attr",function(){return{_isLengthReliable:null,isLengthReliable:function(){var a,b=this;return null==b._isLengthReliable&&(a=document.createElement("div"),a.setAttribute("title","test"),b._isLengthReliable=1===a.attributes.length),b._isLengthReliable},hasAttrs:function(a){var b,c,d=this;return d.isLengthReliable()?a&&a.attributes&&a.attributes.length>0:a&&a.cloneNode?(b=a.cloneNode(!1),c=b.outerHtml,/[a-z0-9\-_]+=["']/i.test(c)):void 0}}}),define("parser/getAsDom",function(a){var b=a("parser/support"),c=a("core/underscore"),d=["abbr","article","aside","audio","bdi","canvas","command","datalist","details","figcaption","figure","footer","header","hgroup","keygen","mark","meter","nav","output","progress","rp","rt","ruby","svg","section","source","summary","time","track","video","wbr"],e=function(a,b){var c=b.createElement("div");c.style.display="none",b.body.appendChild(c);try{c.innerHTML=a}catch(d){}return b.body.removeChild(c),c},f=function(a){a._supportsHTML5Tags||(c.each(d,function(b){a.createElement(b)}),a._supportsHTML5Tags=!0)};return function(a,c){c=c||document;var d;return a&&a.nodeType?(d=c.createElement("div"),d.appendChild(a)):b.html5Tags(c)?(d=c.createElement("div"),d.innerHTML=a):(f(c),d=e(a,c)),d}}),define("parser/getAttribute",function(a){var b=a("web/dom/attr"),c=a("parser/isLoadedImage");return function(a,d){d=d.toLowerCase();var e=a.nodeName;return"IMG"===e&&"src"===d&&c(a)===!0?a.src:b.get(a,d)}}),define("parser/getCorrectInnerHTML",function(a){var b=a("core/underscore"),c=a("web/bom/userAgent"),d="%7E";return function(a){var e=a.innerHTML,f='[href*="~"], [src*="~"]';return c.MOZ&&-1!==e.toUpperCase().indexOf(d)?(b.each(a.querySelectorAll(f),function(a){var b=a.getAttribute("href")||a.getAttribute("src"),c=b.replace(/~/g,d);e=e.replace(c,b)}),e):e}}),define("parser/handleAttributes",function(a){var b=a("core/underscore"),c=a("parser/getAttribute"),d=a("web/dom/attr"),e=a("parser/handleDataSet"),f={url:function(a){var b=/^https?:\/\//i;return a&&a.match(b)?a.replace(b,function(a){return a.toLowerCase()}):null},src:function(a){var b=/^(\/|https?:\/\/)/i;return a&&a.match(b)?a.replace(b,function(a){return a.toLowerCase()}):null},href:function(a){var b=/^(\/|https?:\/\/|mailto:)/i;return a&&a.match(b)?a.replace(b,function(a){return a.toLowerCase()}):null},alt:function(a){var b=/[^ a-z0-9_\-]/gi;return a?a.replace(b,""):""},numbers:function(a){var b=/\D/g;return a=(a||"").replace(b,""),a||null}};return function(a,g,h,i,j){if(i.attributes!==!1){var k=b.extend({},j.attributes,i.attributes),l=i.autoCheck,m={};delete k.style,delete k["class"],e(a,g,k.datasetFilter),delete k.datasetFilter,b.each(l,function(b,d){var e,g=f[d],h=k[d];b&&g&&h&&(e=g(c(a,d)),(null==e||""===e)&&(h===!0?h={value:e}:h&&!h.value&&(h.value=e),k[d]=h))}),b.each(k,function(e,f){var i,j,k;if(b.isFunction(e)&&(i=c(a,f),e=e(i,f,h,a)),e&&(b.isString(e)?j=e:e&&(e.rename||e.value)&&(j=e.rename||null,k=e.value||null),j=j||f,k=k||i||c(a,f),null!=k&&""!==k)){k=String(k);try{d.set(g,j,k)}catch(l){}m[j]=k}}),m.src&&(null!=m.width&&""!==m.width&&g.setAttribute("width",m.width),null!=m.height&&""!==m.height&&g.setAttribute("height",m.height))}}}),define("parser/handleClasses",function(a){var b=a("core/underscore"),c=a("web/bom/userAgent"),d=a("web/dom/className"),e=a("core/str/trim"),f=c.IE?"className":"class";return function(a,c,g,h,i){var j,k,l;if(h.classes!==!1&&(null!=h.classes||i.classes!==!1)&&(l=e(a.getAttribute(f)||""))){if(h.classes===!0||null==h.classes&&i.classes===!0)return void c.setAttribute(f,l);if(k=b.extend({},i.classes,h.classes),j=[],b.each(k,function(c,e){var f,h;b.isFunction(c)&&(f=d.has(a,e),c=c(f,e,g,a)),c&&(b.isString(c)&&(h=c),h=h||e,f=null==f?d.has(a,e):f,f&&j.push(h))}),j.length)try{c.setAttribute(f,j.join(" "))}catch(m){}}}}),define("parser/handleDataSet",function(a){var b=a("core/underscore");return function(a,c,d){if(d!==!1){var e,f,g,h,i,j,k,l=b.isFunction(d);if(a.dataset)b.each(a.dataset,function(b,e){var f=l?d(b,e,a):!0;f&&(c.dataset[e]=b)});else if(a.outerHTML)for(f=a.cloneNode(!1),g=f.outerHTML,h=/ (data\-[a-zA-Z0-9\-]+)=(["'])([^\2]+)\2/g,k=h.exec(g);k&&k[1];)i=k[1],j=k[3],e=l?d(j,i,a)!==!1:!0,e&&c.setAttribute(i,j),k=h.exec(g);else a.attributes&&a.attributes.length&&b.each(a.attributes,function(b){var e,f,g=b.name;/^data-[a-zA-Z0-9\-]+$/.test(g)&&(e=b.value,f=l?d(e,g,a):!0,f!==!1&&c.setAttribute(g,e))})}}}),define("parser/handleElement",function(a){var b=a("parser/support"),c=a("parser/handleStyles"),d=a("parser/handleClasses"),e=a("core/underscore"),f=a("parser/handleAttributes");return function(a,g){var h,i,j=a.nodeName.toLowerCase(),k=a.scopeName;if(a._htmlParsed)return null;if(a._htmlParsed=1,k&&"HTML"!==k&&(j=k+":"+j),"outerHTML"in a&&!b.autoCloseUnclosedTags()&&"P"===a.nodeName&&"</p>"!==a.outerHTML.slice(-4).toLowerCase()&&(j="div"),h=g.tags[j],e.isFunction(h)&&(h=h(j,a)),h===!1)return null;if(null==h){if(!a.firstChild)return null;h=g.defaultTag}return h=e.isString(h)?{rename:h}:h===!0?{}:e.extend({},h),i=a.ownerDocument.createElement(h.rename||j),f(a,i,j,h,g),c(a,i,j,h,g),d(a,i,j,h,g),a=null,i}}),define("parser/handleStyles",function(a){var b=a("core/underscore"),c=a("web/bom/userAgent"),d=a("web/console"),e=a("core/reg/encode"),f=a("core/str/trim");return function(a,g,h,i,j){var k,l,m,n;if(i.styles!==!1&&(null!=i.styles||j.styles!==!1)&&(m=(c.IE?a.style.cssText:a.getAttribute("style"))||"",m=f(m))){if(i.styles===!0||null==i.styles&&j.styles===!0)return void(c.IE?g.style.cssText=m:g.setAttribute("style",m));if(l=b.extend({},j.styles,i.styles),k=[],m=";"+m+";",n=function(a){var b=new RegExp(";\\s*"+e(a)+"\\s*:\\s*([^;]+);","i"),c=b.exec(m);return c&&c[1]?c[1]:void 0},b.each(l,function(c,d){var e,f,g;b.isFunction(c)&&(e=n(d),c=c(e,d,h,a)),c&&(b.isString(c)?f=c:c&&(c.rename||c.value)&&(f=c.rename||null,g=c.value||null),f=f||d,g=g||e||n(d),null!=g&&""!==g&&k.push(f+":"+g))}),k.length){k=k.join(";")+";",d.log("styles: "+k);try{c.IE?g.style.cssText=k:g.setAttribute("style",k)}catch(o){}}}}}),define("parser/handleText",function(a){var b=a("web/dom/nodeType"),c=/\uFEFF/g;return function(a,d,e){var f,g=a.nextSibling;return g&&b.isText(g)?void(g.data=a.data+g.data):(f=a.data.replace(c,""),e&&!f?null:a.ownerDocument.createTextNode(f))}}),define("parser/isLoadedImage",function(a){var b=a("web/bom/userAgent");return b.IE?function(a){return!(!a.complete||"complete"!==a.readyState)}:b.MOZ?function(a){var b=!1;try{b=a.complete&&!a.mozMatchesSelector(":-moz-broken")}catch(c){}return!!b}:function(a){return!!a.complete}}),define("parser/parse",function(a){var b=a("core/underscore"),c=a("parser/getCorrectInnerHTML"),d=a("parser/getAsDom"),e=a("parser/rules"),f=a("parser/attr"),g=a("web/bom/userAgent"),h={1:a("parser/handleElement"),3:a("parser/handleText")},i=g.IE?function(a){return a.replace(/[\r\n]/g,"")}:function(a){return a},j={audio:!0,area:!0,base:!0,br:!0,button:!0,canvas:!0,embed:!0,hr:!0,iframe:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,object:!0,param:!0,script:!0,source:!0,td:!0,textarea:!0,track:!0,video:!0,wbr:!0},k={article:"block",aside:"block",blockquote:"block",body:"block",center:"block",details:"block",dfn:"block",dl:"block",dt:"block",div:"block",figcaption:"block",figure:"block",footer:"block",p:"block",main:"block",nav:"block",span:"inline"},l=function(a,c,d,e){c=c||{};var g,i,m,n,o,p,q=a.nodeType,r=a.childNodes,s=r.length,t=h[q],u=0;if(t&&(i=t(a,c,d)),!i)return null;for(u=0;s>u;u++)m=l(r[u],c,d,e),m&&i.appendChild(m);if(1===i.nodeType){if(n=i.nodeName.toLowerCase(),d&&!j[n]&&(!i.childNodes||!i.childNodes.length))return;if(e&&k[n]&&i.childNodes.length&&!f.hasAttrs(i)&&(o=k[n],p=b.every(i.childNodes,function(a){return a&&1===a.nodeType&&k[a.tagName.toLowerCase()]===o}))){for(g=i.ownerDocument.createDocumentFragment();i.firstChild;)g.appendChild(i.firstChild);return g}}return i};return function(a,f,g,h,j){f=e(f),g=g||a.ownerDocument||document;var k,m,n,o=g.createDocumentFragment(),p=b.isString(a);for(k=p?d(a,g):a;k.firstChild;)n=k.firstChild,m=l(n,f,h,j),k.removeChild(n),m&&o.appendChild(m);return k.innerHTML="",k.appendChild(o),p?i(c(k)):k}}),define("parser/rules",function(a){var b=a("core/underscore");return function(a){return b.extend({defaultTag:"span",tags:{},attributes:{},styles:!0,classes:!0},a)}}),define("parser/support",function(){var a=document.createElement("div");return{autoCloseUnclosedTags:function(){var b,c,d,e=this;return null==e._autoCloseUnclosedTags&&(b=a.cloneNode(!1),b.innerHTML="<p><div></div>",d=b.innerHTML.toLowerCase(),c="<p></p><div></div>"===d||"<p><div></div></p>"===d,e._autoCloseUnclosedTags=c),
e._autoCloseUnclosedTags},getAttributeCorrectly:function(){var a,b=this;return null==b._getAttributeCorrectly&&(a=document.createElement("td"),b._getAttributeCorrectly="1"!==String(a.getAttribute("rowspan"))),b._getAttributeCorrectly},html5Tags:function(a){var b,c=this,d="<article>foo</article>";return null==c._html5Tags&&(a=a||document,b=a.createElement("div"),b.innerHTML=d,c._html5Tags=b.innerHTML.toLowerCase()===d),c._html5Tags}}}),define("templates/jst",function(a){var b=a("web/console"),c=this;return{getTemplate:function(a,b){var d="templates/"+a+"/"+b;return c.JST[d]},render:function(a,c,d){var e=this.getTemplate(a,c);return e?e(d):void b.error("no tempalte: templates/"+a+"/"+c+".jst","template/jst.js")}}}),define("web/bom/parseUA",function(a){var b=a("core/underscore"),c=function(a){var b=0;return parseFloat(a.replace(/\./g,function(){return b+=1,1===b?".":""}))};return function(a){a=(a+"").toLowerCase();var d={WEBKIT:function(){var b=a.match(/applewebkit\/([^\s]*)/);return b&&b[1]?c(b[1]):void 0},PRESTO:function(){var b=a.match(/presto\/([\d.]*)/);return b&&b[1]?c(b[1]):void 0},TRIDENT:function(){var b=a.match(/msie\s([^;]*)/);return b?(b=a.match(/trident\/([\d.]*)/),b&&b[1]?c(b[1]):1):void 0},GECKO:function(){if(/gecko/.test(a)){var b=a.match(/rv:([\d.]*)/);return b&&b[1]?c(b[1]):1}}},e={MOBILE:/mobile/.test(a),IPOD:/ipod/.test(a),IPAD:/ipad/.test(a),IPHONE:/iphone/.test(a),IOS:!1,IOS_5:!1,IOS_6:!1,IOS_7:!1,IOS_8:!1,WIN:/windows|win32/.test(a),MAC:/macintosh/.test(a),IE:/msie/.test(a),IE6:/msie 6/.test(a),IE7:/msie 7/.test(a),IE8:/msie 8/.test(a),IE9:/msie 9/.test(a),IE10:/msie 10/.test(a),OPERA:/opera/.test(a),MOZ:/gecko/.test(a)&&!/(compatible|webkit)/.test(a),SAFARI:!/chrome\/([\d.]*)/.test(a)&&/safari\/([\d.]*)/.test(a),CHROME:/chrome\/([\d.]*)/.test(a),WEBKIT:!1,PRESTO:!1,TRIDENT:!1,GECKO:!1};return(e.IPAD||e.IPHONE||e.IPOD)&&(e.IOS=!0,e.IOS_5=/ os 5/.test(a),e.IOS_6=/ os 6/.test(a),e.IOS_7=/ os 7/.test(a),e.IOS_8=/ os 8/.test(a)),b.some(d,function(a,b){var c;try{if(c=a())return e[b]=c,!0}catch(d){return!1}}),e}}),define("web/bom/userAgent",function(a){var b=a("web/bom/parseUA"),c=b(window.navigator.userAgent)||{};return c.RETINA=window.devicePixelRatio>=2,c.IPHONE_5=!1,(c.IPHONE||c.IPOD)&&(c.IPHONE_5=window.screen.height>481),c}),define("web/console",function(a){var b,c=a("core/console"),d=/msie/i.test(window.navigator.userAgent);return c.DEBUG&&window.console&&window.console.log&&(b=window.console,!d&&b.log.apply?c.log=function(){b.log.apply(b,arguments)}:c.log=function(){var a,c,d=arguments.length,e=[],f=window.JSON;for(a=0;d>a;a++){if(c=arguments[a],f)try{c=f.stringify(c)}catch(g){}e.push(String(c))}b.log(e.join(";"))}),c}),define("web/dom/Selector",function(a){function b(a){var d=this;d._options=c.extend({id:null,tag:null,className:null,attr:null,attrVal:null},c.isString(a)?b.parse(a):a),d._formatedSelector=b.stringify(d._options),d.isOptionsValid=!!d._formatedSelector,d.isOptionsValid||h.error("The options for Selector() is not valid","web/dom/Selector")}var c=a("core/underscore"),d=a("web/dom/isTag"),e=a("web/dom/className"),f=a("web/dom/attr"),g=a("core/str/trim"),h=a("web/console");return b.prototype.test=function(a){var b=this,c=b._options;return a&&a.nodeType&&b.isOptionsValid?(c.id?a.getAttribute("id")===c.id:!0)&&(c.tag?d(a,c.tag):!0)&&(c.className?e.has(a,c.className):!0)&&(c.attr?f.has(a,c.attr,c.attrVal):!0):!1},b.prototype.toString=function(){var a=this;return a.isOptionsValid?a._formatedSelector:void 0},b.parse=function(a){if(a=g(a)){var b={selector:a},d={tag:/^([a-zA-Z]+)/,id:/#([a-zA-Z_\-\d]+)/,className:/\.([a-zA-Z_\-\d]+)/,attr:/\[([a-zA-Z_\-\d]+)(?:=([^\]]+))?\]/};return c.each(["tag","attr","id","className"],function(a){var c=d[a],e=c.exec(b.selector);e&&e[1]&&(b[a]=e[1],b.selector=g(b.selector.replace(e[0],"")),"attr"===a&&(b.attrVal=e[2]||null),b.attrVal&&(b.attrVal=b.attrVal.replace(/^['"]/,"").replace(/['"]$/,"")))}),""!==b.selector?void h.error("selector can not to be parsed","web/dom/Selector"):b.id||b.tag||b.className||b.attr?(delete b.selector,b):void 0}},b.stringify=function(a){if(c.isString(a)||!a)return a||"";var b=a.tag||"",d={id:"#",className:"."};return c.each(["id","className"],function(c){a[c]&&(b+=d[c]+a[c])}),a.attr?b+"["+a.attr+(a.attrVal?'="'+a.attrVal+'"':"")+"]":b},b}),define("web/dom/attr",function(a){var b=a("web/bom/userAgent"),c=a("core/underscore"),d=b.IE,e=function(){if(null==e._isNeed){var a=document.createElement("div");a.setAttribute("class","hello"),e._isNeed=-1===a.className.indexOf("hello")}return e._isNeed},f={acceptcharset:"acceptCharset",accesskey:"accessKey",allowtransparency:"allowTransparency",bgcolor:"bgColor",cellpadding:"cellPadding",cellspacing:"cellSpacing","class":"className",colspan:"colSpan",checked:"defaultChecked",selected:"defaultSelected","for":"htmlFor",frameborder:"frameBorder",hspace:"hSpace",longdesc:"longDesc",maxlength:"maxLength",marginwidth:"marginWidth",marginheight:"marginHeight",noresize:"noResize",noshade:"noShade",readonly:"readOnly",rowspan:"rowSpan",tabindex:"tabIndex",valign:"vAlign",vspace:"vSpace"},g=e()?function(a){return f[a]||a}:function(a){return a};return{has:function(a,b,c){var d=this;return a&&null!=b?(b=g(b),null==c?a.hasAttribute&&a.hasAttribute(b)||null!=a[b]:d.get(a,b)===c):!1},get:function(a,b){return a&&null!=b?d&&"style"===b?a.style.cssText:(b=g(b),a.getAttribute?a.getAttribute(b):void 0):void 0},set:function(a,b,e){var f=this;return a&&null!=b?null==e&&c.isObject(b)?(c.each(b,function(b,c){f.set(a,c,b)}),f):d&&"style"===b?(a.style.cssText=e,f):(b=g(b),a.setAttribute&&a.setAttribute(b,e),f):f},remove:function(a,b){var c=this;return a&&null!=b?d&&"style"===b?(a.style.cssText="",c):(b=g(b),a.removeAttribute&&a.removeAttribute(b),c):c}}}),define("web/dom/className",function(a){var b=a("core/underscore"),c=a("core/str/trim"),d=a("core/reg/encode");return{has:function(a,b){return a&&b&&a.className?a.classList&&a.classList.contains?a.classList.contains(b):new RegExp("(^|\\s+)"+d(b)+"(\\s+|$)","").test(a.className):!1},add:function(a,d){var e,f=this;return a&&d&&b.isString(d)&&!f.has(a,d)?a.classList?(a.classList.add(d),f):(e=c(a.className),a.className=e?e+" "+d:d,f):f},remove:function(a,e){var f=this;return a&&e&&b.isString(e)?a.classList?(a.classList.remove(e),f):(e=String(a.className).replace(new RegExp("(^|\\s+)"+d(e)+"(\\s+|$)","g")," "),a.className=c(e),f):f},toggle:function(a,b){var c=this;return a.classList?(a.classList.toggle(b),c):c.has(b)?c.remove(a,b):c.add(a,b)}}}),define("web/dom/contains",function(a){var b=a("web/bom/userAgent"),c=a("web/dom/nodeType");return function(a,d){if(c.isText(d)){if(a===d)return!0;d=d.parentNode}if(!(a&&d&&c.isNode(a)&&c.isNode(d)))return!1;if(a.contains&&(!b.WEBKIT||b.WEBKIT>=522))return a.contains(d);if(a.compareDocumentPosition)return a===d||Boolean(16&a.compareDocumentPosition(d));for(;d&&d!==a;)d=d.parentNode;return d===a}}),define("web/dom/createElement",function(a){var b=a("core/underscore"),c=a("web/dom/style"),d=a("web/dom/attr"),e=a("web/dom/innerText"),f=null,g=function(){var a;if(null==f){try{a=document.createElement('<div title="test" />')}catch(b){}f=a&&"test"===a.getAttribute("title")?!0:!1}return f};return function(a,f){if(!a)return null;var h,i,j;return f?(f=b.extend({doc:null,attribute:null,style:null,innerHTML:null,innerText:null},f),j=f.doc||document,g()?(i=["<"+a],f.attribute&&b.each(f.attribute,function(a,b){i.push(" "+b+'="'+a+'"')}),f.style&&(i.push(' style="'),b.isString(f.style)?i.push(f.style):b.each(f.style,function(a,b){return"opacity"===String(b).toLowerCase()?void i.push("filter:alpha(opacity="+100*a+")"):void i.push(b+":"+a+";")}),i.push('"')),i.push(" />"),h=j.createElement(i.join("")),f.innerHTML?h.innerHTML=f.innerHTML:f.innerText&&e(h,f.innerText)):(h=j.createElement(a),delete f.doc,f.innerHTML&&delete f.innerText,b.each(f,function(a,f){switch(f){case"innerHTML":return void(b.isString(a)&&(h.innerHTML=a));case"innerText":return void e(h,a);case"attribute":return void b.each(a,function(a,b){d.set(h,b,a)});case"style":return void(b.isString(a)?d.set(h,"style",a):b.each(a,function(a,b){c.set(h,b,a)}))}})),h):document.createElement(a)}}),define("web/dom/dataset",function(a){var b=a("core/str/dasherize"),c=function(a){return"data-"+b(a)};return{get:function(a,b){return a&&b?a.dataset?a.dataset[b]:a.getAttribute?a.getAttribute(c(b)):void 0:void 0},set:function(a,b,d){a&&b&&(d=null==d?"":String(d),a.dataset?a.dataset[b]=d:a.setAttribute&&a.setAttribute(c(b),d))},remove:function(a,b){a&&b&&(a.dataset?delete a.dataset[b]:a.removeAttribute&&a.removeAttribute(c(b)))}}}),define("web/dom/doc",function(a){var b=a("web/dom/nodeType");return{getDoc:function(a){return b.isDocument(a)?a:(b.isText(a)&&(a=a.parentNode),a?a.ownerDocument||a.document||document:document)},getRoot:function(a){var b=this,c=b.getDoc(a);return"CSS1Compat"===c.compatMode?c.documentElement:c.body},activeElement:function(a){var b=this,c=b.getDoc(a);return c.activeElement||c.body},scroll:function(a){var b=this,c=b.getRoot(a),d=b.getDoc(a),e=d.defaultView;return{left:Math.max(e.pageXOffset||0,c.scrollLeft||0),top:Math.max(e.pageYOffset||0,c.scrollTop||0)}},size:function(a){var b=this,c=b.getDoc(a),d=c.documentElement,e=c.body;return{width:Math.max(d.clientWidth,e.scrollWidth,d.scrollWidth,e.offsetWidth,d.offsetWidth),height:Math.max(d.clientHeight,e.scrollHeight,d.scrollHeight,e.offsetHeight,d.offsetHeight)}}}}),define("web/dom/findParent",function(a){var b=a("core/underscore"),c=a("web/dom/Selector"),d=a("web/dom/nodeType");return function(a,e){var f;for(b.isString(e)&&(f=new c(e),e=function(a){return f.test(a)});a&&(a.nodeType===d.ELEMENT_NODE||a.nodeType===d.TEXT_NODE);){if(e(a)===!0)return a;a=a.parentNode}}}),define("web/dom/getBoundingClientRect",function(a){var b=a("web/dom/doc"),c=!1,d=function(){var a=b.scroll().top,d=document.body,e=document.createElement("div");e.style.cssText="position:absolute;left:0;top:0;",d.appendChild(e),c=-e.getBoundingClientRect().top-a,d.removeChild(e),e=null};return function(a){var b;if(a)return a.getBoundingClientRect?(c===!1&&(d(),d=null),b=a.getBoundingClientRect(),{top:b.top+c,right:b.right+c,bottom:b.bottom+c,left:b.left+c,width:b.right-b.left,height:b.bottom-b.top}):void 0}}),define("web/dom/hiddenContainer",function(a){var b,c=a("web/dom/nodeType"),d=function(){var a="position:absolute;top:-9999px;left:-9999px;";b||(b=document.createElement("div"),b.style.cssText=a,document.getElementsByTagName("head")[0].appendChild(b))};return{appendChild:function(a){d(),c.isNode(a)&&b.appendChild(a)},removeChild:function(a){if(b&&c.isNode(a))try{b.removeChild(a)}catch(d){}}}}),define("web/dom/innerText",function(a){var b=a("core/underscore");return function(a,c){return a?b.isString(c)?void(null!=a.innerText?a.innerText=c:null!=a.textContent&&(a.textContent=c)):a.innerText||a.textContent:void 0}}),define("web/dom/insert",function(){return function(a){return{before:function(b){var c;b&&b.parentNode&&(c=b.parentNode,c.insertBefore&&c.insertBefore(a,b))},after:function(b){var c;b&&b.parentNode&&(c=b.parentNode,b.nextSibling&&c.insertBefore?c.insertBefore(a,b.nextSibling):c.appendChild&&c.appendChild(a))}}}}),define("web/dom/isAncestor",function(a){var b=a("web/dom/contains");return function(a,c){return c===a?!1:b(c,a)}}),define("web/dom/isTag",function(){return function(a,b){return b=String(b).toLowerCase(),a&&a.nodeName&&b?String(a.nodeName).toLowerCase()===b:!1}}),define("web/dom/isVisible",function(){var a=function(a){return a.offsetHeight<=0&&a.offsetWidth<=0};return function(b){return b?!a(b):void 0}}),define("web/dom/nodeType",function(a){var b=a("core/underscore");return{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12,getType:function(a){return a&&a.nodeType?a.nodeType:void 0},isNode:function(a){var c=this,d=c.getType(a);return b.isNumber(d)&&d>=c.ELEMENT_NODE&&d<=c.NOTATION_NODE},isElement:function(a){return this.getType(a)===this.ELEMENT_NODE},isAttribute:function(a){return this.getType(a)===this.ATTRIBUTE_NODE},isText:function(a){return this.getType(a)===this.TEXT_NODE},isCDataSection:function(a){return this.getType(a)===this.CDATA_SECTION_NODE},isEntityReference:function(a){return this.getType(a)===this.ENTITY_REFERENCE_NODE},isEntity:function(a){return this.getType(a)===this.ENTITY_NODE},isProcessingInstruction:function(a){return this.getType(a)===this.PROCESSING_INSTRUCTION_NODE},isComment:function(a){return this.getType(a)===this.COMMENT_NODE},isDocument:function(a){return this.getType(a)===this.DOCUMENT_NODE},isDocumentType:function(a){return this.getType(a)===this.DOCUMENT_TYPE_NODE},isDocumentFragment:function(a){return this.getType(a)===this.DOCUMENT_TYPE_NODE},isNotation:function(a){return this.getType(a)===this.NOTATION_NODE}}}),define("web/dom/parseHTML",function(){var a=function(a,b){var c,d,e;if(b.implementation&&b.implementation.createHTMLDocument)return c=b.implementation.createHTMLDocument("title"),c.body.innerHTML=a,c;if(e=b.defaultView||window,e.DOMParser){d=new e.DOMParser;try{c=d.parseFromString("","text/html")}catch(f){}if(c)return c.body.innerHTML=a,c}};return function(b,c,d){if(b){c=c||document;var e,f,g,h,i=a(b,c);if(i){if(d!==!1)return i.body;for(g=i.body.childNodes,e=g.length,h=[],f=0;e>f;f++)h.push(g[f]);return h}}}}),define("web/dom/position",function(a){var b=a("web/dom/isVisible"),c=a("web/dom/isAncestor"),d=a("web/dom/style"),e=a("web/dom/doc"),f=a("web/dom/getBoundingClientRect");return{atDoc:function(a){if(a&&a.parentNode&&b(a)){var c,d,g,h=f(a);if(h)return c=e.scroll(a),{left:h.left+c.left,top:h.top+c.top};for(d={left:a.offsetLeft,top:a.offsetHeight},g=a.parentNode;g&&1===g.nodeType;)d.left+=g.offsetLeft,d.top+=g.offsetTop,g=g.parentNode;return d}},atWin:function(a){var b=this,c=b.atDoc(a),d=e.scroll(a);return c?{left:c.left-d.left,top:c.top-d.top}:void 0},atAncestor:function(a,b){var d=this;if(a&&b&&c(a,b))return a=d.atDoc(a),b=d.atDoc(b),a&&b?{left:a.left-b.left,top:a.top-b.top}:void 0},atOffsetParent:function(a){if(!a)return null;var b,c,e,f=parseFloat(d.get(a,"left"),10),g=parseFloat(d.get(a,"top"),10),h=isNaN(f),i=isNaN(g);if(h||i){if(f=h?0:f,g=i?0:g,b=a.offsetParent){if(b.getBoundingClientRect)return c=b.getBoundingClientRect(),e=a.getBoundingClientRect(),{left:e.left-c.left,top:e.top-c.top};c=a;do f+=h?c.offsetLeft:0,g+=i?c.offsetTop:0,c=c.parentNode;while(c&&c!==b)}f=isNaN(f)?0:f,g=isNaN(g)?0:g}return{left:f,top:g}}}}),define("web/dom/query",function(a){var b=a("core/underscore"),c=a("web/dom/Selector");return{one:function(a,d){var e,f;if(a=c.parse(a)){if(d=d||document,d.querySelector)return d.querySelector(c.stringify(a));if(a.id&&d.getElementById&&!a.tag&&!a.attr&&!a.className)return d.getElementById(a.id);if(e=d.getElementsByTagName(a.tag||"*"),e&&e.length)return!a.tag||a.id||a.attr||a.className?(a.tag&&delete a.tag,f=new c(a),f.isOptionsValid?b.find(e,function(a){return f.test(a)}):void 0):e[0]}},all:function(a,d){var e,f;return(a=c.parse(a))?(d=d||document,d.querySelector?b.toArray(d.querySelectorAll(c.stringify(a))):(e=d.getElementsByTagName(a.tag||"*"),e.length?!a.tag||a.id||a.attr||a.className?(delete a.tag,f=new c(a),f.isOptionsValid?b.filter(e,function(a){return f.test(a)}):[]):b.toArray(e):[])):[]}}}),define("web/dom/remove",function(a){var b=a("web/dom/nodeType"),c=a("web/dom/insert");return function(a,d){if(b.isNode(a)){if(d=d!==!1,a.removeNode&&d)return a.removeNode(a,d);if(a.parentNode&&a.parentNode.removeChild){if(!d)for(;a.firstChild;)c(a.firstChild).before(a);return a.parentNode.removeChild(a)}}}}),define("web/dom/sibling",function(a){var b=a("web/dom/nodeType");return{prevElement:function(a){if(a){if(a.previousElementSibling)return a.previousElementSibling;for(var c=a.previousSibling;c;){if(b.isElement(c))return c;c=c.previousSibling}}},prevAllElements:function(a){for(var b=this,c=[],d=b.prevElement(a);d;)c.unshift(d),d=b.prevElement(d);return c},nextElement:function(a){var c;if(a){if(a.nextElementSibling)return a.nextElementSibling;for(c=a.nextSibling;c;){if(b.isElement(c))return c;c=c.nextSibling}}},nextAllElements:function(a){for(var b=this,c=[],d=b.nextElement(a);d;)c.push(d),d=b.nextElement(d);return c},allElements:function(a){var b=this;return b.prevAllElements(a).concat(b.nextAllElements(a))}}}),define("web/dom/size",function(a){var b=a("core/underscore"),c=a("web/dom/hiddenContainer"),d=a("web/dom/isVisible"),e=a("web/dom/style"),f=a("web/dom/getBoundingClientRect"),g={getHidden:function(a){var b=[];if(!d(a))do"none"===e.get(a,"display")&&b.push(a),a=a.parentNode;while(a);return b},parseFloat:function(a){return parseFloat(a)||0},calWithCompare:function(a,c,d){var f=this,g=0,h="width"===c?{padding:["padding-left","padding-right"],border:["border-left-width","border-right-width"],margin:["margin-left","margin-right"]}:{padding:["padding-top","padding-bottom"],border:["border-top-width","border-bottom-width"],margin:["margin-top","margin-bottom"]};return b.each(d,function(c,d){c&&("margin"===d?b.each(h[d],function(b){g+=f.parseFloat(e.get(a,b))}):b.each(h[d],function(b){g-=f.parseFloat(e.get(a,b))}))}),g},cal:function(a,b,c){var d,e=this,g=f(a);return"width"===b?(d=g?g.width:a.offsetWidth,{width:d+e.calWithCompare(a,b,c)}):"height"===b?(d=g?g.height:a.offsetHeight,{height:d+e.calWithCompare(a,b,c)}):(d=g?g:{width:a.offsetWidth,height:a.offsetHeight},d={width:d.width+e.calWithCompare(a,"width",c),height:d.height+e.calWithCompare(a,"height",c)})},blank:function(a){var b,c,d=a.length,f=[];for(b=0;d>b;b++)c=a[b],f.push(e.get(c,"visibility")||""),c.style.visibility="hidden",c.style.display="";return f},unBlank:function(a,b){var c,d,e=a.length;for(c=0;e>c;c++)d=a[c],d.style.display="none",d.style.visibility=b[c]},size:function(a,b,c){var d,e,f=this,g=f.getHidden(a);return g.length?(e=f.blank(g),d=f.cal(a,b,c),f.unBlank(g,e)):d=f.cal(a,b,c),d}};return{getSize:function(a,d,e){var f;if(a)return d="height"===d?d:"width"===d?d:"both",e=b.extend({padding:!1,border:!1,margin:!1},e),a.parentNode?g.size(a):(c.appendChild(a),f=g.size(a,d,e),c.removeChild(a),f)},size:function(a){return this.getSize(a,"both")},innerSize:function(a){return this.getSize(a,"both",{padding:!0})},outerSize:function(a,b){return this.getSize(a,"both",{padding:!0,border:!0,margin:b===!0})},width:function(a){var b=this.getSize(a,"width");return b&&null!=b.width?b.width:void 0},innerWidth:function(a){var b=this.getSize(a,"width",{padding:!0});return b&&null!=b.width?b.width:void 0},outerWidth:function(a,b){var c=this.getSize(a,"width",{padding:!0,border:!0,margin:b===!0});return c&&null!=c.width?c.width:void 0},height:function(a){var b=this.getSize(a,"height");return b&&null!=b.height?b.height:void 0},innerHeight:function(a){var b=this.getSize(a,"height",{padding:!0});return b&&null!=b.height?b.height:void 0},outerHeight:function(a,b){var c=this.getSize(a,"height",{padding:!0,border:!0,margin:b===!0});return c&&null!=c.height?c.height:void 0}}}),define("web/dom/style",function(a){var b=a("core/underscore"),c=a("core/str/camelize"),d=a("web/dom/doc"),e="DXImageTransform.Microsoft.Alpha",f=!1,g="float",h=function(){var a,b=document.createElement("div");b.innerHTML='<a href="/a" style="top:1px;float:left;opacity:.55;">a</a>',a=b.getElementsByTagName("a")[0],f=/^0\.55$/.test(a.style.opacity),"left"===a.style.cssFloat?g="cssFloat":"left"===a.style.styleFloat&&(g="styleFloat")};return{get:function(a,b,i){if(a&&b){i=i===!0,h&&(h(),h=null);var j,k,l=d.getDoc(a),m=l.defaultView;switch(b=c(b)){case"opacity":if(!f){j=100;try{j=a.filters.item(e).opacity}catch(n){try{j=a.filters.alpha.opacity}catch(o){}}return(parseInt(j,10)||0)/100}break;case"float":b=g}if(k=a.style[b]||null,i)return k;if(m&&m.getComputedStyle){try{j=m.getComputedStyle(a,"")}catch(p){}return(j||{})[b]||k}return a.currentStyle?a.currentStyle[b]||k:k}},set:function(a,d,e){var i,j=this;return a&&d?(h&&(h(),h=null),i=function(b,d){return"opacity"!==d||f?(d="float"===d?g:c(d),void(a.style[d]=b)):(a.style.filter="progid:DXImageTransform.Microsoft.Alpha(opacity="+Math.floor(100*parseFloat(b))+")",void(a.currentStyle&&a.currentStyle.hasLayout||(a.style.zoom=1)))},b.isString(d)?i(e,d):b.each(d,i),j):j}}}),define("web/dom/win",function(a){var b=a("web/dom/doc");return{getWin:function(a){var c=b.getDoc(a);return c&&c.defaultView?c.defaultView:window},isWin:function(a){return a&&a.setTimeout&&a.open?!0:!1},size:function(a){var c=b.getDoc(a),d=c.documentElement,e=c.body,f="CSS1Compat"===c.compatMode;return{width:f&&d.clientWidth||e.clientWidth||d.clientWidth,height:f&&d.clientHeight||e.clientHeight||d.clientHeight}}}}),define("web/event/Event",function(a){function b(a){this._init(a)}var c=a("core/underscore"),d=["type","altKey","attrChange","attrName","bubbles","button","cancelable","charCode","clientX","clientY","ctrlKey","currentTarget","data","detail","eventPhase","fromElement","handler","keyCode","layerX","layerY","metaKey","newValue","offsetX","offsetY","pageX","pageY","prevValue","relatedNode","relatedTarget","screenX","screenY","shiftKey","srcElement","target","toElement","view","wheelDelta","which","timeStamp"],e={target:function(a){var b=a.target||a.srcElement||document;return 3===b.nodeType?b.parentNode:b},relatedTarget:function(a,b){return a.relatedTarget?a.relatedTarget:a.fromElement?a.fromElement===b?a.toElement:a.fromElement:void 0},pageXY:function(a,b){var c,d,e;return null!=a.pageX?{x:a.pageX,y:a.pageY}:null!=a.clientX?(c=b.ownerDocument||document,d=c.documentElement,e=c.body,{x:a.clientX+(d&&d.scrollLeft||e&&e.scrollLeft||0)-(d&&d.clientLeft||e&&e.clientLeft||0),y:a.clientY+(d&&d.scrollTop||e&&e.scrollTop||0)-(d&&d.clientTop||e&&e.clientTop||0)}):void 0},which:function(a){var b,c;return null!=a.which?b=a.which:(null!=a.charCode||null!=a.keyCode)&&(b=a.charCode||a.keyCode),b?b:null!=a.button?(c=document.implementation.hasFeature("MouseEvents","2.0")?a.button:[0,0,2,0,1,0,2,0][a.button],[1,2,3][c]):void 0},timeStamp:function(){return(new Date).getTime()}};return b.prototype._isFixedEvent=!0,b.prototype._init=function(a){var b,f=this;f._rawEvent=a,f.hasPrevented=!1,f.hasStopped=!1,c.each(d,function(b){f[b]=a[b]}),f.target=e.target(a),f.relatedTarget=e.relatedTarget(a,f.target),b=e.pageXY(a,f.target),b&&(f.pageX=b.x,f.pageY=b.y),f.which=e.which(a),f.timeStamp=e.timeStamp()},b.prototype.preventDefault=function(){var a=this,b=a._rawEvent;a.hasPrevented||(b.preventDefault?b.preventDefault():b.returnValue=!1,a.hasPrevented=!0)},b.prototype.stopPropagation=function(){var a=this,b=a._rawEvent;a.hasStopped||(b.stopPropagation?b.stopPropagation():b.cancelBubble=!0,a.hasStopped=!0)},b.prototype.stop=function(){var a=this;a.preventDefault(),a.stopPropagation()},b.prototype.getRawEvent=function(){return this._rawEvent},b}),define("web/event/events",function(a){var b,c=a("core/underscore"),d=a("core/str/trim"),e=a("core/str/endsWith"),f=a("core/obj/guid"),g=a("web/dom/Selector"),h=a("web/event/util"),i=a("web/event/Event"),j=function(a){var b=/^([a-z]+)?(?:\.([a-z_\-\d]+))?$/i.exec(a);return b&&(b[1]||b[2])?{type:b[1],namespace:b[2]}:void 0},k=function(a,d){var e,f=a.indexOf("delegate")>-1?2:1;return d[f]?(e=d[f].split(/\s+/),1===e.length?!1:(c.each(e,function(e){var g=c.toArray(d);g[f]=e,b[a].apply(b,g)}),!0)):!0};return b={on:function(a,b,e){var g,l,m,n=this;return h.isBindable(a)&&c.isFunction(e)?(b=d(b),!b||k("on",arguments)?n:(g=f.auto(e),l=j(b),g&&l&&l.type?(m=function(b){var d=c.rest(arguments);e.apply(a,[new i(b)].concat(d))},f.set(m,g,!0),h.addEventListener(a,l.type,m),a._eventHandlers||(a._eventHandlers={}),a._eventHandlers[b]||(a._eventHandlers[b]={}),a._eventHandlers[b][g]||(a._eventHandlers[b][g]=[]),a._eventHandlers[b][g].push(m),n):n)):n},off:function(a,b,e){var g,i,k,l,m,n=this,o=function(a,b,c){return!("*"!==m&&c!==m||"*"!==k&&a!==k||"*"!==l&&b!==l)};if(!h.isBindable(a)||!a._eventHandlers)return n;if(b){if(b=d(b),!b)return n;if(i=j(b),!i)return n;if(e){if(g=f.get(e),!g)return n;m=g}else m="*";i.namespace?(k=i.namespace,l=i.type||"*"):(k="*",l=i.type)}else{if(e)return n;k=l=m="*"}return c.each(a._eventHandlers,function(b,d){var e=j(d);e&&(c.each(b,function(d,f){o(e.namespace,e.type,f)&&(c.each(d,function(b){h.removeEventListener(a,e.type,b)}),delete b[f])}),c.size(b)||delete a._eventHandlers[d])}),n},once:function(a,b,d){var e,g,i=this;return h.isBindable(a)&&c.isFunction(d)?(e=f.auto(d),g=function(){i.off(a,b,g),d.apply(a,arguments)},f.set(g,e,!0),i.on(a,b,g)):i},trigger:function(a,b){var e,f,g,i,l,m,n=this;return h.isBindable(a)&&a._eventHandlers?(b=d(b),!b||k("trigger",arguments)?n:(e=j(b),g=c.rest(arguments,2),l=function(a,b){return!("*"!==f&&f!==a||"*"!==i&&i!==b)},m=function(b,d){c.each(b,function(b){b.apply(a,[{type:d,target:a}].concat(g))})},e?(e.namespace&&e.type?c.each(a._eventHandlers[b],function(a){m(a,e.type)}):(f=e.namespace||"*",i=e.type||"*",c.each(a._eventHandlers,function(a,b){var d=j(b);d&&l(d.namespace,d.type)&&c.each(a,function(a){m(a,d.type)})})),n):n)):n},delegate:function(a,b,d,e){var i,j,l=this;return h.isBindable(a)&&c.isFunction(e)&&!k("delegate",arguments)?(i=new g(b),i.isOptionsValid?(d=d+(d.indexOf(".")>-1?".":"_")+b.replace(/\./,"_dot_"),j=function(b){i.test(b.target)&&e.apply(a,arguments)},f.set(j,f.auto(e),!0),l.on(a,d,j),l._eventsDelegateTypes||(l._eventsDelegateTypes={}),l._eventsDelegateTypes[d]=!0,l):l):l},undelegate:function(a,b,d,f){var g,i,j=this,l=j._eventsDelegateTypes;if(!h.isBindable(a)||!l||k("undelegate",arguments))return j;if(b)i=(d.indexOf(".")>-1?".":"_")+b.replace(/\./,"_dot_"),d?(d+=i,l[d]===!0&&(j.off(a,d,f),f||delete l[d])):c.each(l,function(b,c){b===!0&&e(c,i)&&(j.off(a,c,f),f||delete l[d])});else{if(g=!d&&!f,!g)return j;c.each(l,function(b,c){b===!0&&j.off(a,c)}),j._eventsDelegateTypes={}}return j}},b.bind=b.on,b.unbind=b.off,b}),define("web/event/keyMouseMap",function(a){var b=a("core/underscore"),c=a("web/bom/userAgent"),d={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",18:"ALT",19:"PAUSE",20:"CAPS_LOCK",27:"ESC",32:"SPACE",33:"PAGE_UP",34:"PAGE_DOWN",35:"END",36:"HOME",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN",44:"PRINT_SCREEN",45:"INSERT",46:"DELETE",48:"ZERO",49:"ONE",50:"TWO",51:"THREE",52:"FOUR",53:"FIVE",54:"SIX",55:"SEVEN",56:"EIGHT",57:"NINE",63:"QUESTION_MARK",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",96:"NUM_ZERO",97:"NUM_ONE",98:"NUM_TWO",99:"NUM_THREE",100:"NUM_FOUR",101:"NUM_FIVE",102:"NUM_SIX",103:"NUM_SEVEN",104:"NUM_EIGHT",105:"NUM_NINE",106:"NUM_MULTIPLY",107:"NUM_PLUS",109:"NUM_MINUS",110:"NUM_PERIOD",111:"NUM_DIVISION",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NUMLOCK",186:"SEMICOLON",189:"DASH",187:"EQUALS",188:"COMMA",190:"PERIOD",191:"SLASH",192:"APOSTROPHE",222:"SINGLE_QUOTE",219:"OPEN_SQUARE_BRACKET",220:"BACKSLASH",221:"CLOSE_SQUARE_BRACKET"},e={3:"ENTER",91:"META",93:"META",224:"META"},f={91:"WIN_KEY_LEFT",92:"WIN_KEY_RIGHT",93:"CONTEXT_MENU",224:"WIN_KEY",229:"WIN_IME"},g={1:"MOUSE_LEFT",2:"MOUSE_MIDDLE",3:"MOUSE_RIGHT"},h=b.extend({},d,c.MAC?e:f,g),i={};return b.each([d,c.MAC?e:f,g],function(a){b.each(a,function(a){i[a]=a})}),i.get=i.getKey=function(a){return a?(a=a.which||a,h[a]):void 0},i.getKeyCode=function(a){if(a&&b.isString(a)){a=a.toUpperCase();var c;return b.some(h,function(b,d){return b===a?(c=parseInt(d,10),!0):void 0}),c}},i.match=function(a,b){var c=this;return c.get(a)===b},i}),define("web/event/util",function(a){var b=a("web/dom/nodeType");return{isBindable:function(a){return!(!a||!a.addEventListener&&!a.attachEvent||b.isText(a))},addEventListener:function(a,b,c,d){a.addEventListener?a.addEventListener(b,c,d||!1):a.attachEvent&&a.attachEvent("on"+b,c),a=null},removeEventListener:function(a,b,c,d){a.removeEventListener?a.removeEventListener(b,c,d||!1):a.detachEvent&&a.detachEvent("on"+b,c),a=null},fire:function(a,b){if(a&&a.fireEvent)a.fireEvent("on"+b);else if(a&&a.dispatchEvent&&document.createEvent){var c=document.createEvent("HTMLEvents");c.initEvent(b,!0,!0),a.dispatchEvent(c)}a=null}}}),define("web/util/View",function(a){function b(a){var b=this;b.cid=c.uniqueId("view"),b._configure(a||{}),b._ensureElement(),b.initialize.apply(b,arguments),b.delegateEvents()}var c=a("core/underscore"),d=a("core/Events"),e=a("core/Class"),f=a("web/dom/query"),g=a("web/dom/remove"),h=a("web/dom/createElement"),i=a("web/event/events"),j=/^(\S+)\s*(.*)$/,k=["el","id","attributes","className","tagName","events"];return c.extend(b.prototype,d,{tagName:"div",query:function(a){return f.all(a,this.el)},initialize:function(){},render:function(){return this},remove:function(){var a=this;return g(a.el),a.stopListening(),a},setElement:function(a,b){var c=this;return c.el&&c.undelegateEvents(),c.el=a,b!==!1&&c.delegateEvents(),c},delegateEvents:function(a){var b,d,e,f,g,h=this;if(!a&&!(a=c.result(h,"events")))return h;h.undelegateEvents();for(b in a)d=a[b],c.isFunction(d)||(d=h[a[b]]),d&&(e=b.match(j),f=e[1],g=e[2],d=c.bind(d,h),f+=".delegateEvents"+h.cid,""===g?i.on(h.el,f,d):i.delegate(h.el,g,f,d));return h},undelegateEvents:function(){var a=this,b=".delegateEvents"+a.cid;return i.undelegate(a.el,b),i.off(a.el,b),a},_configure:function(a){var b=this;b.options&&(a=c.extend({},c.result(b,"options"),a)),c.extend(b,c.pick(a,k)),b.options=a},_ensureElement:function(){var a,b,d=this;d.el?d.setElement(c.result(d,"el"),!1):(a=c.extend({},c.result(d,"attributes")),d.id&&(a.id=c.result(d,"id")),d.className&&(a["class"]=c.result(d,"className")),b=h(c.result(d,"tagName"),{attribute:a}),d.setElement(b,!1))}}),b.extend=e.extend,b}),define("init/iphone",function(a){var b,c=a("iphone/view/IPhoneEditorView"),d=a("web/console");return b=new c({container:".iphone-editor-area",AreaView:a("iphone/view/IPhoneAreaView"),Commander:a("editor/cmd/Commander"),FilterManager:a("editor/filters/FilterManager"),bridge:a("iphone/io/bridge"),UndoManager:a("iphone/history/UndoManager"),filters:{input:[a("iphone/filters/input/script"),a("iphone/filters/input/br"),a("iphone/filters/input/image"),a("iphone/filters/input/handwrite"),a("iphone/filters/input/attachment"),a("iphone/filters/input/todo")],output:[a("iphone/filters/output/handwrite"),a("iphone/filters/output/attachment"),a("iphone/filters/output/todo"),a("iphone/filters/output/image"),a("iphone/filters/output/font"),a("iphone/filters/output/format")],key:[a("iphone/filters/key/backspace"),a("iphone/filters/key/tab"),a("iphone/filters/key/autoLink"),a("iphone/filters/key/linkUpdate"),a("iphone/filters/key/editKeys")],beforePaste:[a("iphone/filters/beforePaste/media"),a("iphone/filters/beforePaste/image"),a("iphone/filters/beforePaste/format")],paste:[a("iphone/filters/paste/br")],runtime:[]},commands:[a("iphone/cmd/insertAttachment"),a("iphone/cmd/insertImage"),a("iphone/cmd/insertTodoGroup"),a("iphone/cmd/appendTodo"),a("iphone/cmd/insertHandwriteArea"),a("iphone/cmd/insertHandwriteBr"),a("iphone/cmd/insertHandwriteCharacter"),a("iphone/cmd/handwriteBackspace"),a("iphone/cmd/doPaste"),a("iphone/cmd/doPasteHtml"),a("iphone/cmd/doPasteAsText"),a("iphone/cmd/appendBlankLines"),a("iphone/cmd/insertBlankLinesAfterNode"),a("iphone/cmd/undo"),a("iphone/cmd/redo"),a("editor/queryCmd/getRange"),a("editor/queryCmd/queryStyle"),a("iphone/queryCmd/canUndo"),a("iphone/queryCmd/canRedo")]}),b.render(),d.DEBUG&&(window.debugEditor=b),window.onerror=function(a,c,e,f){var g,h=[];h.push("message: "+a),h.push("source file: "+c),h.push("line number: "+e),h.push("column number: "+f),g="[window.onerror]"+h.join(", "),d.DEBUG?d.error(g,"init/iphone.js"):b.bridge.callNativeApi("StoreLog",[g])},b});