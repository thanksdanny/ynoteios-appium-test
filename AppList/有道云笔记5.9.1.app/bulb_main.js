!function(){this.JST=this.JST||{},this.JST["common/attachment-view-attachment-container"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="attachment-container"><img src="'+(null==(__t=src)?"":__t)+'" /><div class="menu-wrapper"><div class="yne-button-group"><div class="yne-button-item" title="查看"><span class="yne-button" data-button-name="view">查看</span></div><div class="yne-button-item yne-last" title="快捷菜单"><span class="yne-button" data-button-name="menu">快捷菜单</span><span class="yne-arrow-down"></span></div><div class="yne-clear"></div></div><ul class="yne-popup-menu"><li class="yne-popup-item" data-cm-name="float-left"><span>左浮动</span></li><li class="yne-popup-item" data-cm-name="float-right"><span>右浮动</span></li><li class="yne-popup-item" data-cm-name="clear-float"><span>清除浮动</span></li><li class="yne-popup-item yne-popup-split"></li><li class="yne-popup-item" data-cm-name="upload"><span>上传附件</span></li><li class="yne-popup-item" data-cm-name="delete"><span>删除附件</span></li><li class="yne-popup-item" data-cm-name="download"><span>另存为</span></li></ul></div></div>';return __p},this.JST["common/image-view-image-container"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="image-container"><img src="'+(null==(__t=src)?"":__t)+'" /><div class="resize-handle" data-corner="0"></div><div class="resize-handle" data-corner="1"></div><div class="resize-handle" data-corner="2"></div><div class="resize-handle" data-corner="3"></div><div class="menu-wrapper"><div class="yne-button-group"><div class="yne-button-item yne-last" title="快捷菜单"><span class="yne-button" data-button-name="menu">快捷菜单</span><span class="yne-arrow-down"></span></div><div class="yne-clear"></div></div><ul class="yne-popup-menu"><li class="yne-popup-item" data-cm-name="float-left"><span>左浮动</span></li><li class="yne-popup-item" data-cm-name="float-right"><span>右浮动</span></li><li class="yne-popup-item" data-cm-name="clear-float"><span>清除浮动</span></li><li class="yne-popup-item" data-cm-name="clear-resize"><span>清除缩放</span></li><li class="yne-popup-item yne-popup-split"></li><li class="yne-popup-item" data-cm-name="upload"><span>上传图片</span></li><li class="yne-popup-item" data-cm-name="delete"><span>删除图片</span></li></ul></div></div>';return __p},this.JST["common/list_item_view"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+=isOrdered?'<ol class="li-box"><li><div class="para-text"></div></li></ol>':'<ul class="li-box"><li><div class="para-text"></div></li></ul>';return __p},this.JST["common/paragraph_view"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="para-text"></div>';return __p},this.JST["iphone/attachment-view-attachment-container"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="attachment-container"><img src="'+(null==(__t=src)?"":__t)+'"></div>';return __p},this.JST["iphone/image-view-image-container"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="image-container"><img src="'+(null==(__t=src)?"":__t)+'"></div>';return __p};var yne_underscore,yne_backbone,yne_jtk_core_Class,yne_jtk_core_Base,yne_jtk_core_L,yne_common_constants,yne_iphone_utils_eventHandlers,yne_jquery,yne_iphone_io_nativeApiInterface,yne_common_data_blockTypes,yne_common_selection_NoteRange,yne_common_selection_BlockRange,yne_common_selection_ImageRange,yne_common_util_setTimeoutTimes,yne_iphone_io_editorApi,yne_jtk_core_str_base64,yne_iphone_io_Bridge,yne_common_key_keyCodeMap,yne_common_key_KeyMonitor,yne_common_selection_AttachmentRange,yne_osTableRange,yne_common_selection_HrRange,yne_common_selection_UnknownRange,yne_common_data_supportedBlockStyles,yne_collaboration_guidsGenerator,yne_common_util_platform,yne_common_data_Block,yne_jtk_core_assert,yne_common_util_schemaVersion,yne_common_data_supportedInlineStyles,yne_common_util_unknownInlineStyles,yne_common_util_codePointAt,yne_common_util_clearString,yne_common_util_toCharArrayByCodePoint,yne_common_data_RichText,yne_common_data_inlineStyleRules,yne_common_data_Rich2HtmlConvertor,yne_common_util_unknownTree,yne_common_util_blockStyles,yne_common_util_countText,yne_tinycolor,yne_common_util_highlight,yne_common_data_Paragraph,yne_common_views_BlockView,yne_common_selection_ParagraphRange,yne_jtk_web_dom_nodeType,yne_common_jst,yne_common_data_blankLine,yne_common_views_ParagraphView,yne_iphone_utils_FixClickable,yne_osImageView,yne_osAttachmentView,yne_common_data_supportedListItemStyles,yne_common_views_ListItemView,yne_ytable_tools_core_console,yne_ytable_tools_core_underscore,yne_ytable_tools_web_dom_isTag,yne_ytable_tools_core_str_trim,yne_ytable_tools_core_reg_encode,yne_ytable_tools_web_dom_className,yne_ytable_tools_web_bom_userAgent,yne_ytable_tools_web_dom_attr,yne_ytable_tools_web_console,yne_ytable_tools_web_dom_Selector,yne_ytable_tools_web_dom_nodeType,yne_ytable_tools_web_dom_findParent,yne_ytable_tools_jq_jquery,yne_ytable_client_shared_const,yne_ytable_editor_config_defaults,yne_ytable_tools_web_dom_insert,yne_ytable_tools_web_dom_remove,yne_ytable_editor_utils_TableUtils,yne_osTableView,yne_common_views_HrView,yne_common_views_UnknownView,yne_common_views_BlockViewMapper,yne_common_selection_nativeSelection,yne_mobile_views_NoteView,yne_mobile_util_keyboardMode,yne_osNoteView,yne_underscorestring,yne_common_util_createDom,yne_osImage,yne_osAttachment,yne_common_data_ListItem,yne_common_data_tableDataCheck_createBlankCell,yne_common_data_tableDataCheck_createBlankTable,yne_common_data_tableDataCheck_size,yne_common_data_tableDataCheck_cellValue,yne_common_data_tableDataCheck_mergeDefaults,yne_common_data_tableDataCheck_mergeCells,yne_common_data_tableDataCheck_checkAndFix,yne_osTable,yne_common_data_Hr,yne_common_data_Unknown,yne_common_data_blockMap,yne_parser_html_handlers_tagHandlers,yne_parser_html_utils_convertColor,yne_parser_html_handlers_styleHandlers,yne_parser_html_handlers_BaseHandler,yne_parser_html_utils_handleParagraphSpaces,yne_parser_html_handlers_ParagraphHandler,yne_parser_html_handlers_DocumentHandler,yne_parser_html_handlers_UnknownHandler,yne_jtk_web_dom_parseHTML,yne_parser_html_Parser,yne_parser_html_handlers_InlineHandler,yne_parser_html_handlers_AnchorHandler,yne_parser_html_handlers_BreakHandler,yne_parser_html_handlers_HrHandler,yne_parser_html_handlers_ImageHandler,yne_parser_html_handlers_TableHandler,yne_common_data_List,yne_parser_html_handlers_ListHandler,yne_parser_html_handlers_ListItemHandler,yne_parser_html_handlers_handlerMap,yne_parser_html_tagConfig,yne_parser_html_mso_ListHandler,yne_parser_html_convert,yne_parser_plain_createRichText,yne_common_commands_link_LinkMatch,yne_parser_plain_parseLine,yne_parser_plain_convert,yne_parser_json_createBlock,yne_parser_json_convert,yne_parser_Parser,yne_common_util_ListItemNode,yne_common_data_Note,yne_common_selection_SelectionChangeEvent,yne_common_selection_NoteSelection,yne_common_commands_Command,yne_common_commands_SimpleCommand,yne_common_commands_ManagerAdapter,yne_common_commands_CommandManager,yne_common_commands_CompositeCommand,yne_common_commands_paragraph_DeleteRange,yne_common_commands_paragraph_SetStyle,yne_common_commands_link_DeleteLink,yne_common_commands_paragraph_DeleteBackward,yne_common_commands_paragraph_Merge,yne_common_commands_paragraph_DeleteAtStart,yne_common_commands_block_SetBlockStyle,yne_common_commands_note_TextIndent,yne_common_commands_note_ReplaceBlock,yne_common_commands_note_ReplaceListItemWithParagraph,yne_common_commands_list_SetLevel,yne_common_commands_list_DeleteAtStart,yne_common_commands_note_DeleteBlock,yne_common_selection_ListItemRange,yne_common_selection_rangeUtil,yne_common_commands_utils_CmdUtils,yne_common_commands_image_Delete,yne_common_commands_attachment_Delete,yne_common_commands_table_Delete,yne_common_commands_note_DeleteRange,yne_common_commands_key_Backspace,yne_osBackspaceCmd,yne_common_commands_paragraph_SplitParagraph,yne_common_commands_paragraph_InsertText,yne_common_commands_key_InsertLink,yne_common_commands_link_RecognitionLink,yne_common_commands_key_Enter,yne_common_commands_note_InsertText,yne_common_commands_key_TextInput,yne_common_commands_key_Space,yne_common_commands_note_IndentOutdent,yne_common_commands_key_Tab,yne_common_commands_key_Indent,yne_common_commands_key_Outdent,yne_common_commands_paragraph_ForwardDelete,yne_common_commands_paragraph_ForwardDeleteAtStart,yne_common_commands_key_Delete,yne_osDeleteCmd,yne_common_commands_block_InsertBlock,yne_common_commands_block_InsertBlocks,yne_common_commands_note_InsertBlocks,yne_common_commands_key_InsertHorizontalRule,yne_osInsertImageCmd,yne_common_commands_key_InsertAttachment,yne_common_commands_key_InsertTable,yne_common_commands_note_ApplyInlineStyle,yne_common_commands_note_ApplyBlockStyle,yne_common_commands_note_ReplaceParagraphWithListItem,yne_common_commands_list_ToggleType,yne_common_commands_note_InsertList,yne_common_commands_note_InsertOrderedList,yne_common_commands_note_InsertUnorderedList,yne_common_commands_key_RemoveFormat,yne_common_commands_key_FormatPainter,yne_common_commands_image_ReplaceSrc,yne_common_commands_image_Replace,yne_common_commands_attachment_ReplaceSource,yne_common_commands_attachment_Replace,yne_common_commands_note_DragBlocks,yne_common_commands_key_InsertDate,yne_common_commands_note_SetCellValue,yne_common_commands_table_SetCellValue,yne_common_commands_CommandFactory,yne_mobile_core_Controller,yne_iphone_utils_getPointByChar,yne_osController,yne_common_core_Editor,yne_mobile_core_Editor,yne_iphone_core_Editor,yne_iphone_BulbEditor,yne_iphone_init_iphone;yne_underscore=function(){var a=window._;if(!a&&window.require&&(a=window.require("underscore")),!a)throw"no `underscore` library";return a}(),yne_backbone=function(){var a=window.Backbone;if(!a&&window.require&&(a=window.require("Backbone")||window.require("backbone")),!a)throw"no `backbone` library";return a}(),yne_jtk_core_Class=function(a){function b(a){var b=this;b.options=c.extend({},a),b.initialize.apply(b,arguments)}var c=yne_underscore,d=function(a,b){var d,e,f=this;return d=a&&c.has(a,"constructor")?a.constructor:function(){return f.apply(this,arguments)},c.extend(d,f,b),e=function(){this.constructor=d},e.prototype=f.prototype,d.prototype=new e,a&&c.extend(d.prototype,a),d.__super__=f.prototype,d};return b.prototype.initialize=function(){},b.extend=d,b}({}),yne_jtk_core_Base=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jtk_core_Class,e=c.extend({},b.Events),f=d.extend(e);return f}({}),yne_jtk_core_L=function(){for(var a,b=this,c=b.DEBUG,d=b.console,e={},f=function(){},g="log warn error time timeEnd".split(" "),h=g.length,i=function(a){var b,c=[],d=a.length;for(b=0;b<d;b++)c.push(a[b]);return c},j=function(a){var b,c,d,e=a.length,f=new Date,g="["+f.toString()+"|"+f.getTime()+"]",h=[g];for(b=0;b<e;b++){d=a[b];try{c=JSON.stringify(d)}catch(a){c=d+""}h.push(c)}return h.join(", ")},k=[],l={};--h>=0;)a=g[h],c&&d[a]?e[a]=d[a].bind(d):e[a]=f;return e.DEBUG=c,"iphone"===c?(e.log=function(){var a=i(arguments),b=j(a),c=window.debugEditor;c&&c.bridge&&c.bridge.hasReadyRun===!0?(k&&(b=k.join("\n")+"\n"+b,k=null),c.bridge.callNativeApi("Log",[b])):k&&k.push(b),d&&d.log&&("[WARN]"===arguments[0]?d.warn.apply(d,arguments):"[ERROR]"===arguments[0]?d.error.apply(d,arguments):d.log.apply(d,arguments))},e.warn=function(){var a=i(arguments);a.unshift("[WARN]"),e.log.apply(e,a)},e.error=function(){var a=i(arguments);a.unshift("[ERROR]"),e.log.apply(e,a)},e.time=function(a){a="uid-"+a,l[a]||(l[a]=Date.now())},e.timeEnd=function(a){a="uid-"+a,l[a]&&(e.log.apply(e,["[TIME]"+a+": "+(Date.now()-l[a])]),delete l[a])}):"jsconsole"===c&&window.remote&&(e.log=function(){var a=i(arguments),b=j(a);window.remote.log(b)},e.warn=function(){var a=i(arguments),b=j(a);window.remote.log(b)},e.error=function(){var a=i(arguments),b=j(a);window.remote.log(b)},e.time=window.remote.time,e.timeEnd=window.remote.timeEnd),e}(),yne_common_constants=function(){var a=window.navigator.userAgent,b=/Windows/.test(a),c=/Android|iPhone|iPad|iPod/i.test(a),d=/Android/i.test(a),e=/iPhone|iPad|iPod/i.test(a),f=e&&/OS 7/i.test(a),g=e&&/OS 8/i.test(a);return{COMPAT:"compat",INTERM:"interm",INDENT_WIDTH:40,LINE_BREAK:b?"\r\n":"\n",IS_MAC:/Mac|iPod|iPhone|iPad/.test(window.navigator.platform),IS_MOBILE:c,IS_ANDROID:d,IS_IPHONE:e,IS_IOS7:f,IS_IOS8:g,RENDERED_INDENT_WIDTH:c?27:40}}(),yne_iphone_utils_eventHandlers=function(a){var b=yne_underscore,c=yne_jtk_core_L,d=yne_common_constants,e=["bold","italic","underline","strike","back-color","color","font-size","font-family"],f=["align"],g=function(a){b.each(a,function(b,c){b===d.INTERM&&(a[c]=!1)})};return{"command-exec":function(){var a=this,b=a._editor,c=a.bridge,d=b.canUndo(),e=b.canRedo();c.callNativeApi("OnDocumentChange"),c.callNativeApi("OnEditorStateChange",[{undo:d,redo:e}])},"yne-selection-change":function(){var a,c=this,d=c._editor,h=c.bridge,i=d.querySelectionInlineStyles(),j=d.querySelectionBlockStyles(),k=d.isSameList("ordered"),l=d.isSameList("unordered");a=b.extend({},b.pick(i||{},e),b.pick(j||{},f)),a.ordered=k,a.unordered=l,g(a),b.isEmpty(a)||h.callNativeApi("OnEditorStateChange",[a])},"yne-editing-state-change":function(a,b){var c=this,d=c.bridge,e={};e[a]=b,g(e),d.callNativeApi("OnEditorStateChange",[e])},"yne-open-link":function(a){this.bridge.callNativeApi("OpenLink",[a])},"request-image-rendered-src":function(a){c.log("request-image-rendered-src",a),this.bridge.callNativeApi("RequestReplaceImage",[a])},"request-attachment-rendered-src":function(a){c.log("request-attachment-rendered-src",a),this.bridge.callNativeApi("RequestReplaceAttachment",[a])},"click-image":function(a){c.log("click-image",a);var d=this._editor.getImages(),e=[],f=-1;b.each(d,function(b,c){b===a&&(f=c),e.push(b.getSource())}),this.bridge.callNativeApi("EnterImageBrowser",[e,f])},"click-attachment":function(a){c.log("click-attachment",a),this.bridge.callNativeApi("ClickOnAttachment",[{resId:a.getResource()}])},"set-clipboard":function(a){c.log("set-clipboard",a),this.bridge.callNativeApi("SetClipboard",[a])},"get-clipboard":function(){c.log("get-clipboard"),this.bridge.callNativeApi("RequestPasting")},"notify-native-touchstart":function(){this.bridge.callNativeApi("OnEditorTouchStart")},"enter-table-cell":function(a){var b=this;c.log("enter-table-cell:",a),b.bridge.callNativeApi("onCellSelected",[a])},"leave-table":function(){c.log("leave-table"),this.bridge.callNativeApi("onLeaveTable")}}}({}),yne_jquery=function(){var a=window.jQuery||window.$;if(!a&&window.require&&(a=window.require("jQuery")||window.require("jquery")),!a)throw"no `jQuery` library";return a}(),yne_iphone_io_nativeApiInterface=function(a){var b,c=yne_jquery,d=yne_underscore,e=yne_jtk_core_L,f={},g=0,h=e.DEBUG&&/^http:/i.test(window.location.href),i=function(){};return b={Ready:function(){window.console.log("nativeApiInterface.Ready"),c.ajax({url:"./sample.xml",dataType:"text"}).done(function(a){var b=window.debugEditor.bridge;b.execEditorApiWithoutEncode("setEditorContent",[a,!1]),b.execEditorApiWithoutEncode("highlight",[["Inc","crazy","slogan","slo","ga","👿"]]),window.setTimeout(function(){var a=window.confirm("To remove highlight?");a&&b.execEditorApiWithoutEncode("removeHighlight")},1e4),b.execEditorApiWithoutEncode("focusEditor"),b.execEditorApiWithoutEncode("setCurrentPosition",["2333333"]),b.execEditorApiWithoutEncode("setCellValue",[{stringValue:"insert1",tableId:23222,uid:"cellId_128",moveToNext:!0}]),b.execEditorApiWithoutEncode("setEditorInnerHeight",[200])})},OnDocumentChange:function(){window.console.log("nativeApiInterface.OnDocumentChange")},OnEditorStateChange:function(a){window.console.log("nativeApiInterface.OnEditorStateChange",a)},OpenLink:function(a){window.console.log("nativeApiInterface.OpenLink",a),window.open(a)},RequestReplaceImage:function(a){window.console.log("nativeApiInterface.RequestReplaceImage",a);var b="http://shared.ydstatic.com/images/myth/images/logo.png";g++,b=b+"?"+g,window.debugEditor.bridge.execEditorApiWithoutEncode("replaceImageByOrigSrc",[a,{url:b}])},RequestReplaceAttachment:function(a){window.console.log("nativeApiInterface.RequestReplaceAttachment",a);var b="http://cidian.youdao.com/pics/all-1.png";g++,b=b+"?"+g,window.debugEditor.bridge.execEditorApiWithoutEncode("setAttachmentState",[a.path,"http://cidian.youdao.com/pics/all-1.png"])},EnterImageBrowser:function(a,b){window.console.log("nativeApiInterface.EnterImageBrowser",a,b),window.open(a[b])},ClickOnAttachment:function(a){window.console.log("nativeApiInterface.ClickOnAttachment",a),window.open(a.resId)},SetClipboard:function(a){window.console.log("nativeApiInterface.SetClipboard",a),f.clipboard=a},RequestPasting:function(){window.console.log("nativeApiInterface.RequestPasting"),window.debugEditor.bridge.execEditorApiWithoutEncode("doPaste",[{type:"private.ynote-bulb-json",data:f.clipboard["private.ynote-bulb-json"]}])},OnEditorTouchStart:function(){window.console.log("nativeApiInterface.OnEditorTouchStart")},onCellSelected:function(a){window.console.log("nativeApiInterface.onCellSelected",a)},onLeaveTable:function(){window.console.log("nativeApiInterface.onLeaveTable")},StoreLog:function(a){window.console.log("nativeApiInterface.StoreLog",a)},Log:function(a){window.console.log(a)}},h||d.each(d.keys(b),function(a){b[a]=i}),b}({}),yne_common_data_blockTypes={BLOCK:"block",PARAGRAPH:"paragraph",IMAGE:"image",ATTACHMENT:"attachment",LIST_ITEM:"list-item",TABLE:"table",HR:"horizontal-line",UNKNOWN:"unknown",getType:function(a){if(a)return a._type},isParagraph:function(a){var b=this,c=b.getType(a);return c===b.PARAGRAPH||c===b.LIST_ITEM},isListItem:function(a){var b=this;return b.getType(a)===b.LIST_ITEM},isAttachment:function(a){var b=this;return b.getType(a)===b.ATTACHMENT},isTable:function(a){var b=this;return b.getType(a)===b.TABLE},isImage:function(a){var b=this;return b.getType(a)===b.IMAGE},isHr:function(a){var b=this;return b.getType(a)===b.HR},isUnknown:function(a){return this.getType(a)===this.UNKNOWN}},yne_common_selection_NoteRange=function(a){var b=yne_jtk_core_Class,c=yne_jtk_core_L,d=yne_underscore,e=yne_common_data_blockTypes,f=yne_common_constants,g={JSON:1,HTML:2,PLAIN:3,isValidType:function(a){var b=this;return a===b.JSON||a===b.HTML||a===b.PLAIN},_getMethodName:function(a){var b=this,c="";switch(a){case b.JSON:c="JSON";break;case b.HTML:c="Html";break;case b.PLAIN:c="Plain"}return c},getBlockMethodName:function(a){var b=this,c=b._getMethodName(a);if(c)return"to"+c},getBlockRangeMethodName:function(a){var b=this,c=b._getMethodName(a);if(c)return"getDataAs"+c}},h=b.extend({_type:"note",_startRange:null,_endRange:null,initialize:function(a){var b=this;a=a||{},b._startRange=a.startRange,b._endRange=a.endRange,delete b.options,a.startRange||a.endRange||!a.blockRanges?b._checkValid():b.setBlockRanges(a.blockRanges)},_checkValid:function(){if(c.DEBUG){var a=this,b=a._startRange,d=a._endRange;if(!b||!d)throw"starRange or endRange is not valid!";if(!b.block||!d.block)throw"starRange.block or endRange.block is not valid!";if(b.block===d.block&&b!==d)throw"startRange and endRange should be the same objectwhen startRange.block === endRange.block"}},isInSingleBlock:function(){var a=this;return a._checkValid(),a._startRange&&a._startRange===a._endRange},isInMultiBlock:function(){var a=this;return!a.isInSingleBlock()},isMatchBlockTypes:function(a,b){if(!a)return c.warn("The param note does not exist!"),!1;var d,f,g,h=this,i=h._startRange.block,j=h._endRange.block,k=a.getBlockIndex(i),l=a.getBlockIndex(j);if(k===-1||l===-1)return c.warn("startIndex or endIndex is -1!"),!1;for(d=a.getAllBlocks(),f=k;f<=l;f++)if(g=e.getType(d[f]),b.indexOf(g)===-1)return!1;return!0},canDrawedByNative:function(){var a,b=this;return!b.isInSingleBlock()||(a=b.getStartBlockRange(),a.canDrawedByNative())},isCollapsed:function(){var a=this;return!!a.isInSingleBlock()&&a._startRange.isCollapsed()},getStartBlockRange:function(){var a=this;return a._startRange},getEndBlockRange:function(){var a=this;return a._endRange},setBlockRanges:function(a){var b=this;b._startRange=d.first(a),b._endRange=d.last(a),b._checkValid()},clone:function(a){var b,c,d=this;return a===!1?(b=d._startRange,c=d._endRange):(b=d._startRange.clone(),c=d.isInSingleBlock()?b:d._endRange.clone()),h.create({startRange:b,endRange:c})},collapse:function(a){var b=this,d=a===!1?b.getEndBlockRange():b.getStartBlockRange();d&&d.collapse?(d.collapse(a),b._startRange=d,b._endRange=d):c.warn("There is no blockRange or blockRange has no `collapse` method")},toNativeRange:function(a){var b,d,e,f,g,h=this;if(h.canDrawedByNative())return c.log("to native range",h),b=h.getStartBlockRange(),(e=b.toNativeRange(a))?h.isInSingleBlock()?(c.log("native range",e),e):(d=h.getEndBlockRange(),(f=d.toNativeRange(a))?(g=document.createRange(),g.setStart(e.startContainer,e.startOffset),g.setEnd(f.endContainer,f.endOffset),c.log("native range",g),g):void c.warn("no native range for end block!")):void c.warn("no native range for start block!")},_getDataWithType:function(a,b,d){if(!a||!a.getBlockAt)return void c.warn("note is unvalid!");if(!g.isValidType(b))return void c.warn("type is unvalid!");var e,f,h,i,j=this,k=[],l=j._startRange,m=j._endRange,n=a.getBlockIndex(l.block),o=a.getBlockIndex(m.block),p=g.getBlockRangeMethodName(b),q=g.getBlockMethodName(b);for(e=n;e<=o;e++){if(f=null,e===n||e===o){if(h=e===n?l:m,d&&d(h.block))continue;h[p]&&(f=h[p]())}else{if(i=a.getBlockAt(e),d&&d(i))continue;i&&i[q]&&(f=i[q]())}null!=f?k.push(f):c.warn("data is null!")}return k},getDataAsJSON:function(a,b){var c,d=this,e=d._getDataWithType(a,g.JSON,b);return e=e||[],c=window.JSON.stringify(e)},getDataAsHtml:function(a,b){var c,d=this,e=d._startRange,f=d._endRange,g=a.getBlockIndex(e.block),h=a.getBlockIndex(f.block);return c=a.toHtml({startIndex:g,endIndex:h,startRangeStart:e.start,startRangeEnd:e.end,endRangeStart:f.start,endRangeEnd:f.end},b)},getDataAsPlain:function(a,b){var c=this,d=c._getDataWithType(a,g.PLAIN,b),e="";return d&&d.length&&(e=d.join(f.LINE_BREAK)),e},isEqual:function(a){if(!(a instanceof h))return!1;var b=this,c=b.getStartBlockRange(),d=b.getEndBlockRange(),e=a.getStartBlockRange(),f=a.getEndBlockRange();return c.isEqual(e)&&d.isEqual(f)}},{create:function(a){return a&&a.startRange&&a.endRange?new h(a):void c.warn("options is unvalid!")},fromNativeRange:function(a,b){if(!a)return void c.warn("no range");if(a instanceof h)return a;c.log("NoteRange.fromNativeRange()",a);var e,f=b.parseNativeRange(a);return f&&f.length?(e=new h({startRange:d.first(f),endRange:d.last(f)}),c.log("noteRange fromNativeRange",e),e):void c.warn("Failed to parse native range to note range!")}});return h}({}),yne_common_selection_BlockRange=function(a){var b=yne_jtk_core_Class,c=yne_jtk_core_L,d=b.extend({_type:"block",block:null,isCollapsed:function(){c.error("isCollapsed () should be implemented by subclass")},getType:function(){var a=this;return a._type},clone:function(){c.error("Every subclass of BlockRange should implement the `clone` method")},collapse:function(){c.error("Every subclass of BlockRange should implement the `collapse` method")},getDataAsJSON:function(){c.error("toJSON() should be implemented by subclass!")},getDataAsHtml:function(){c.error("toHtml() should be implemented by subclass!")},getDataAsPlain:function(){c.error("toPlain() should be implemented by subclass!")},canDrawedByNative:function(){c.error("canDrawedByNative() should be implemented by subclass!")},toNativeRange:function(a){if(!a||!a.getBlockViewByBlock)return void c.error("note view is unvalid!");var b=this,d=a.getBlockViewByBlock(b.block);return d?d.convertToNativeRange(b):void c.warn("No blockView")},isEqual:function(){c.error("isEqual() should be implemented by subclass!")}});return d}({}),yne_common_selection_ImageRange=function(a){var b=yne_common_selection_BlockRange,c=b.extend({_type:"image",initialize:function(a){var b=this;a=a||{},b.block=a.block},isCollapsed:function(){return!1},collapse:function(){},getDataAsJSON:function(){var a=this,b=a.block.toJSON();return b},getDataAsHtml:function(){var a=this,b=a.block.toHtml();return b},getDataAsPlain:function(){var a=this,b=a.block.toPlain();return b},canDrawedByNative:function(){return!1}});return c}({}),yne_common_util_setTimeoutTimes=function(a,b,c){var d=function(){window.setTimeout(function(){c-- >0&&!a()&&d()},b)};d()},yne_iphone_io_editorApi=function(a){var b,c=yne_underscore,d=yne_jquery,e=yne_jtk_core_L,f=yne_common_selection_NoteRange,g=yne_common_selection_ImageRange,h=yne_common_util_setTimeoutTimes,i=100,j=10,k=300,l=1e8,m=function(a,b){return a=d.trim(a+"").replace(/^https:/,"http:"),b=d.trim(b+"").replace(/^https:/,"http:"),a===b},n=function(a){var b,c,d=this,f=d._editor,g=f.note,l=f.noteView,m=g.getBlockBySrc(a);m&&(b=l.getBlockViewByBlock(m),b&&b.triggerImageRendered&&(d._lastInsertedImgView=b,h(function(){if(c||(c=document.querySelector('img[src="'+a.replace("file://","")+'"]')),c&&c.height&&c.width)return window.setTimeout(function(){d._lastInsertedImgView.triggerImageRendered(),e.log("插入图片后调整编辑位置成功")},k),!0},i,j)))};return b={setEditorContent:function(a,b){var c=this;b===!0?c._editor.setHtmlContent(a):c._editor.setXmlContent(a)},setEditorText:function(a){this._editor.setTextContent(a)},getEditorContent:function(a){var b=this,c=b._editor;return a===!0?c.getHtmlContent():c.getXmlContent()},focusEditor:function(){this._editor.focusEditor()},exeCmd:function(a){var b=this,c=b._editor;switch(a.name){case"undo":case"redo":c[a.name]();break;default:c.execCommand(a.name,a.args),"insertImage"===a.name&&n.bind(b)(a.args.src)}},replaceImageByOrigSrc:function(a,b){e.log("orgSrc: "+a);var d=this._editor,f=d.getImages();c.each(f,function(c){var e;m(c.getSource(),a)&&(e=d.noteView.getBlockViewByBlock(c),e&&e.updateRenderedSource(b.url))})},setAttachmentState:function(a,b){var d=this._editor,e=d.getAttachments();c.each(e,function(c){var e;m(c.getResource(),a)&&(e=d.noteView.getBlockViewByBlock(c),e&&e.updateRenderedSource(b))})},doPaste:function(a){a&&this._editor.doPaste(a.type,a.data)},getDataByUID:function(a){return this.bridge.getDataByUID(a)},getEditorFirstLineTextContent:function(){return this._editor.getFirstParagraphContent()},getEditorTextContent:function(a){var b;return a?(a=a.toString().toLowerCase(),a="true"===a):a=!1,b=this._editor.getPlainContent({ignoreMarker:!0,ignoreTable:a}),e.log("callFromNative getEditorTextContent()",b),b},setEditorInnerHeight:function(a){this._editor.setViewportHeight(a)},setEditorFullHeight:function(a){this._editor.setEditorContainerMinHeight(a)},setTextEditMenuState:function(a){var b=this,c=b._editor.controller;c.setTextEditMenuState(a)},setReadOnlyMode:function(a){this._editor.setReadOnly(!!a)},updateImages:function(a){var b=this._editor,d=b.getImages(),e=!1;c.each(a,function(a){a.status===-1?c.find(d,function(c){var d=c.getSource();if(m(d,a.src))return b.execCommand("deleteRange",{range:new f({blockRanges:[new g({block:c})]})}),e=!0,!0}):a.status&&c.isString(a.status)&&(e===!0&&(d=b.getImages(),e=!1),c.find(d,function(c){var d=c.getSource();if(m(d,a.src))return b.execCommand("replaceImage",{src:a.status,image:c}),!0}))})},setCellValue:function(a){this._editor.setCellValue(a)},highlight:function(a){this._editor.highlight(a)},removeHighlight:function(){this._editor.removeHighlight()},countWords:function(){var a=this,b=a._editor;return b.countWords()},setPaddingLeftAndRight:function(a){var b=this,c=b._editor.parentEl,d=c.style;a=parseInt(a,10)+"px",d.paddingLeft=d.paddingRight=a},getCurrentPosition:function(){var a,b=document,c=b.defaultView,e=d(b.body).outerHeight(!0);return a=Math.round(c.scrollY/e*l)},setCurrentPosition:function(a){if(null!=a&&(a=parseInt(a,10),!isNaN(a))){var b,c,e=document,f=e.defaultView;b=d(e.body).outerHeight(!0),c=b*a/l,c&&f.scrollTo(0,c)}},setKeyboardMode:function(a){var b=this,c=b._editor.controller;c.setKeyboardMode(a)}}}({}),yne_jtk_core_str_base64={encode:function(a){return window.btoa(window.unescape(encodeURIComponent(a)))},decode:function(a){return decodeURIComponent(window.escape(window.atob(a)))}},yne_iphone_io_Bridge=function(a){var b=yne_jtk_core_Class,c=yne_jtk_core_L,d=yne_underscore,e=yne_iphone_io_nativeApiInterface,f=yne_iphone_io_editorApi,g=yne_jtk_core_str_base64,h=function(a,b){var c;try{c=window.JSON.stringify(a)}catch(a){}if(b!==!0)return c;try{c=g.encode(c)}catch(a){}return c},i=function(a,b){var c;if(b===!0)try{a=g.decode(a)}catch(a){}try{c=window.JSON.parse(a)}catch(a){}return c};return b.extend({initialize:function(a){var b=this;if(b._uidCounter=0,b._cacheData={},b.hasReadyRun=!1,b._bulbEditor=a.editor,!b._bulbEditor)throw"options.editor is not valid!"},ready:function(){var a=this;a.hasReadyRun||(a.hasReadyRun=!0,a._provideEditorApi(),a.callNativeApi("Ready"))},_provideEditorApi:function(){var a=this;window.Editor&&c.error("window.Editor is already exist!"),window.Editor={execEditorApi:a.execEditorApi.bind(a)}},getDataByUID:function(a){var b=this._cacheData[a];return delete this._cacheData[a],b},callNativeApi:function(a,b){var d=this,f=e,g="";return f[a]?(c.DEBUG&&"Log"!==a&&f[a].apply(null,b),b&&b.length&&(d._uidCounter++,g="uid"+d._uidCounter,d._cacheData[g]=b),void d._sendData(a,g)):void c.warn("no native api: "+a,"iphone/io/bridge")},_sendData:function(a,b){d.defer(function(){var d=document,e=d.body,f=d.createElement("iframe");f.style.display="none",f.src="async:"+a+":"+b,e.appendChild(f),e.removeChild(f),c.DEBUG&&"Log"!==a&&c.log("async:"+a+":"+b)})},execEditorApi:function(a,b){if(!a||!f[a]||!d.isFunction(f[a]))return void c.error("no editor api: "+a);var e,g,j=this;if(b&&(e=i(b,!0)),e=e||[],c.DEBUG)c.time(a),g=f[a].apply(j._bulbEditor,e),c.timeEnd(a);else try{g=f[a].apply(j._bulbEditor,e)}catch(a){}return null!=g?h({result:g},!1):void 0},execEditorApiWithoutEncode:function(a,b){var c,d,e,f=this;if(b&&(c=h(b,!0)),d=f.execEditorApi(a,c||null),d&&(e=i(d,!1),e&&e.result))return e.result}})}({}),yne_common_key_keyCodeMap=function(a){var b=yne_underscore,c=yne_common_constants,d={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",44:"printscreen",45:"ins",46:"del",106:"*",107:"+",109:"-",110:".",111:"/",144:"numlock",186:";",189:"-",187:"=",188:",",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},e=c.IS_MAC?{3:"enter",91:"meta",93:"meta",224:"meta"}:{91:"win",92:"win",93:"menu",224:"win",229:"ime"},f=function(a,c,d){return b.some(a,function(a,b){return a===c&&parseInt(b,10)===d})},g={},h="A".charCodeAt(0),i="Z".charCodeAt(0);for(h;h<=i;h++)d[h]=String.fromCharCode(h).toLowerCase();for(h=1;h<20;++h)d[111+h]="f"+h;for(h=0;h<=9;h++)d[48+h]=h+"";for(h=0;h<=9;++h)d[h+96]=h+"";return{isMatch:function(a,b){var c=a+"-"+b,h=g[c];return null==h&&(h=f(e,a,b)||f(d,a,b),g[c]=h),h}}}({}),yne_common_key_KeyMonitor=function(a){var b,c=yne_jtk_core_Class,d=yne_jquery,e=yne_underscore,f=yne_common_constants,g=yne_common_key_keyCodeMap,h=["shift","alt","ctrl","meta"],i={return:"enter",escape:"esc",plus:"+"},j={mod:f.IS_MAC?"meta":"ctrl",option:"alt",command:"meta"};return b=c.extend({initialize:function(a){var b=this;a=a||{},a.el&&(e.bindAll(b,"_onKeyDown"),b.el=a.el,b._hasBindEvents=!1)},_bindEvents:function(){var a=this;a._hasBindEvents||(d(a.el).on("keydown",a._onKeyDown),a._hasBindEvents=!0)},_unbindEvents:function(){var a=this;a._hasBindEvents&&(d(a.el).off("keydown",a._onKeyDown),a._hasBindEvents=!1)},_prepareForBindKey:function(){var a=this;a._hasBindEvents||a._bindEvents(),a._keyMap||(a._keyMap={}),a._matchCache||(a._matchCache={})},_formatKey:function(a){a=d.trim(a),a=a.toLowerCase(),a=a.replace(/\s+/g,""),e.each(j,function(b,c){a=a.replace(c+"+",b+"+")});var b={},c=a.split(/\+/),f=e.last(c),g=[];
return f=i[f]||f,b.key=f,e.each(h,function(c){a.indexOf(c)>-1&&(b[c]=!0,g.push(c))}),g.push(f),b.mark=g.join("-"),b},_extractEventInfo:function(a){var b={},c=[];return e.each(h,function(d){a[d+"Key"]&&(b[d]=!0,c.push(d))}),c.push(a.keyCode),b.keyCode=a.keyCode,b.mark=c.join("-"),b},_isMatch:function(a,b){return!(!b||!event)&&(e.every(h,function(c){return b[c]===a[c]})&&g.isMatch(b.key,a.keyCode))},_onKeyDown:function(a){var b,c,d=this,f=d._keyMap,g=d._extractEventInfo(a),h=g.mark,i=d._matchCache,j=i[h];j||(j=i[h]={eventInfo:g},b={},c=!1,e.each(f,function(a,e){d._isMatch(g,a.keyInfo)&&(b[e]=a,c=!0)}),c&&(j.handlers=b)),e.each(j.handlers,function(b){b.callback.apply(null,[a])})},bind:function(a,b){var c,d,f=this,g=f._formatKey(a);g&&(f._prepareForBindKey(),d=f._keyMap["key-"+a]={keyInfo:g,callback:b},c=f._matchCache,e.each(c,function(a){if(a&&a.eventInfo){var b,c=a.handlers;c?b=!0:(c={},b=!1),f._isMatch(a.eventInfo,g)&&(c[g.mark]=d,b=!0),b&&(a.handlers=c)}}))},unbind:function(a){var b=this,c=b._keyMap,d=b._matchCache,f="key-"+a;c&&c[f]&&delete c[f],e.each(d,function(a){var b=a.handlers;b&&b[f]&&delete b[f]})},unbindAll:function(){var a=this;a._unbindEvents(),a._keyMap={},a._matchCache={}},clearCache:function(){var a=this;a._matchCache={}}})}({}),yne_common_selection_AttachmentRange=function(a){var b=yne_common_selection_BlockRange,c=b.extend({_type:"attachment",initialize:function(a){var b=this;a=a||{},b.block=a.block},isCollapsed:function(){return!1},collapse:function(){},getDataAsJSON:function(){var a=this,b=a.block.toJSON();return b},getDataAsHtml:function(){var a=this,b=a.block.toHtml();return b},getDataAsPlain:function(){var a=this,b=a.block.toPlain();return b},canDrawedByNative:function(){return!1}});return c}({}),yne_osTableRange=function(a){var b=yne_common_selection_BlockRange,c=yne_common_data_blockTypes,d=b.extend({_type:c.TABLE,uid:"",isAll:!1,initialize:function(a){var b=this;a=a||{},b.block=a.block,b.uid=a.uid,b.isAll=a.isAll,delete b.options},isCollapsed:function(){return!1},clone:function(){},collapse:function(){},getDataAsJSON:function(){var a=this,b=a.block.toJSON();return b},getDataAsHtml:function(){var a=this,b=a.block.toHtml();return b},getDataAsPlain:function(){var a=this,b=a.block.toPlain();return b},canDrawedByNative:function(){return!1}},{TYPES:{EXISTING:1,FIRST_ROW:2,LAST_ROW:3}});return d}({}),yne_common_selection_HrRange=function(a){var b=yne_common_selection_BlockRange,c=yne_common_data_blockTypes;return b.extend({_type:c.HR,initialize:function(a){var b=this;b.block=a.block},isCollapsed:function(){return!1},getDataAsHtml:function(){return this.block.toHtml()},getDataAsJSON:function(){return this.block.toJSON()},getDataAsPlain:function(){var a=this,b=a.block.toPlain();return b},canDrawedByNative:function(){return!0}})}({}),yne_common_selection_UnknownRange=function(a){var b=yne_common_selection_BlockRange,c=yne_common_data_blockTypes;return b.extend({_type:c.UNKNOWN,initialize:function(a){this.block=a.block},isCollapsed:function(){return!1},getDataAsHtml:function(){return this.block.toHtml()},getDataAsJSON:function(){return this.block.toJSON()},getDataAsPlain:function(){return this.block.toPlain()},canDrawedByNative:function(){return!1}})}({}),yne_common_data_supportedBlockStyles=function(a){var b,c=yne_underscore,d={align:{type:"Enum",possible:{left:!0,right:!0,center:!0,justify:!0},default:"left"},"line-height":{type:"Number",default:1.5},indent:{type:"Number",default:0},"text-indent":{type:"Number",default:0},width:{type:"Number",default:null},float:{type:"Enum",possible:{none:!0,left:!0,right:!0},default:"none"},height:{type:"Number",default:1},color:{type:"String",default:"#999999"}},e={block:[],paragraph:"align|indent|text-indent|line-height".split("|"),"list-item":"align|indent|text-indent|line-height".split("|"),image:"align|width|float".split("|"),attachment:"align|float".split("|"),"horizontal-line":"align|width|height|color".split("|"),table:[]},f={"horizontal-line":{width:{type:"Number",default:100}}},g={};return{getBlockStyles:function(a){if(a&&e[a]){if(!g[a]){var b,h=c.pick(d,e[a]);h&&(b=f[a],b&&c.each(b,function(a,b){h[b]=a})),g[a]=h}return g[a]}},getAllKeys:function(){return b||(b=c.keys(d),Object.freeze&&Object.freeze(b)),b},getDefault:function(a){var b=d[a];if(b&&null!=b.default)return b.default}}}({}),yne_collaboration_guidsGenerator=function(){var a=64,b={_possible:"abcdefghijklmnopqrstuvwxyz",lastGUID:"",newGUID:function(){var a="";this.date=new Date,a+=Math.floor(100*Math.random());for(var b=0;b<4;b++)a+=this._possible[Math.floor(26*Math.random())];return a+=this.date.getTime(),a!==this.lastGUID?(this.lastGUID=a,a):this.newGUID()}};return{newGUID:function(){return b.newGUID()},isValid:function(b){var c=["null","undefined"];return!(!b||c.indexOf(b+"")>-1)&&!(b.length>a)}}}(),yne_common_util_platform=function(a){var b=yne_underscore,c=yne_jtk_core_L,d=new RegExp(/^\/yws\/res\/|^https?:\/\/note.youdao.com\/yws\/res/),e=new RegExp(/^\/yws\/api\/group|^https?:\/\/note.youdao.com\/yws\/api\/group/),f={UNKNOWN:-1,WEB_NOTE:1,WEB_GROUP:2,PC:3,IPHONE:4,ANDROID:5,MAC:6},g=window.YNE_PLATFORM||f.UNKNOWN,h=b.keys(f),i={};return b.each(h,function(a){var b=a.toLowerCase(),c=g[a];f["IS_"+a]=g===c||g===b}),g.IS_UNKNOWN&&c.error("The platform is unknown!"),i.isFromWebNote=function(a){return d.test(a)},i.isFromWebGroup=function(a){return e.test(a)},b.extend(f,i),f}({}),yne_common_data_Block=function(a){var b,c,d,e=yne_underscore,f=yne_backbone,g=yne_jtk_core_Class,h=yne_common_data_blockTypes,i=yne_common_data_supportedBlockStyles,j=yne_jtk_core_L,k=yne_collaboration_guidsGenerator,l=yne_common_util_platform,m=yne_jquery;return b={_type:h.BLOCK,_styles:null,_supportedBlockStyles:null,_locked:!1,unknownTree:null,_blockId:null,_xmlNodeName:null,initialize:function(){var a=this;a.initSupportedBlockStyles(),a._styles={},a.unknownTree={},k.isValid(a._blockId)||(a._blockId=k.newGUID())},initSupportedBlockStyles:function(){this._supportedBlockStyles=i.getBlockStyles(this._type)},isSupportedBlockStyle:function(a){var b=this;return null!=(b._supportedBlockStyles||{})[a]},setBlockStyle:function(a,b){var c=this._supportedBlockStyles||{},d=c[a];d&&("Enum"===d.type?d.possible[b]||(b=d.default):"Number"!==d.type||e.isNumber(b)?"Boolean"!==d.type||e.isBoolean(b)?e["is"+d.type]&&(e["is"+d.type](b)||(b=b.default)):b="true"===b:(b=null===b||""===b?NaN:Number(b),!isNaN(b)&&b||(b=d.default)),b=b||c[a].default,this._styles[a]=b,j.log("style-change "+a+": "+b),this.trigger("style-change",a,b))},setBlockStyles:function(a){var b=this;a&&e.each(a,function(a,c){b.setBlockStyle(c,a)})},getBlockStyles:function(){return e.clone(this._styles)},getBlockStyle:function(a){var b=this._supportedBlockStyles[a];return b?this._styles[a]||b.default:null},getDefaultBlockStyles:function(){var a=this,b={};return e.each(a._supportedBlockStyles,function(a,c){b[c]=a.default}),b},toXml:function(a){var b,c,e,f=this,g=f.getBlockId();return k.isValid(g)?(b=a.createElement(f._xmlNodeName),c=a.createElement(d.TAG_ID_NAME),e=a.createTextNode(g),c.appendChild(e),b.appendChild(c),b):void j.error("The block has no id",f)},getType:function(){var a=this;return a._type},toJSON:function(){j.error("toJSON() should be implemented by subclass!")},toHtml:function(){j.error("toHtml() should be implemented by subclass!")},toPlain:function(){j.error("toPlain() should be implemented by subclass!")},countWords:function(){return 0},setLocked:function(a){var b=this;a=!!a,b.isLocked()!==a&&(b._locked=a,b.trigger("locked-change",a))},isLocked:function(){return this._locked},highlight:function(a){var b=this;b.trigger("high-light",a)},getBlockId:function(){var a=this,b=a._blockId;return k.isValid(b)||j.error("The blockId is not valid: "+b),b},parseIdFromXml:function(a){var b,c,e=this,f=m(a);b=f.children(d.TAG_ID_NAME).first(),b&&(c=b.text()),c||l.IS_ANDROID||(b=f.children(d.LEGACY_TAG_ID_NAME).first(),b&&(c=b.text())),c&&k.isValid(c)&&(e._blockId=c)},setBlockId:function(a){var b=this;return k.isValid(a)?void(b._blockId=a):void j.error("The param blockId is not valid: "+a)}},c={TAG_ID_NAME:"coId",LEGACY_TAG_ID_NAME:"id",fromXml:function(){var a=new d;return a}},e.extend(b,f.Events),d=g.extend(b,c)}({}),yne_jtk_core_assert=function(){var a=this,b=a.DEBUG,c=a.console,d=function(){};return b&&c.assert?c.assert.bind(c):d}(),yne_common_util_schemaVersion=function(a){var b=yne_underscore,c={major:1,minor:0,revision:1},d=function(a){a=a||"";var b=parseInt(a+"",10);return isNaN(b)?0:b},e={GRETER:1,EQUAL:0,LESS:-1},f=function(a,b){return a===b?e.EQUAL:a>b?e.GRETER:e.LESS};return{getDefaultAsString:function(){return c.major+"."+c.minor+"."+c.revision},parse:function(a){if(a){var b=(a+"").split(".");return{major:d(b[0]),minor:d(b[1]),revision:d(b[2])}}},_compare:function(a,c){var d=e.EQUAL;return b.some(["major","minor","revision"],function(b){var g=f(a[b]||0,c[b]||0);if(g!==e.EQUAL)return d=g,!0}),d},isCompatible:function(a){if(a=a||"",!a||"true"===a)return!0;var b=this,d=b.parse(a);return b._compare(c,d)!==e.LESS}}}({}),yne_common_data_supportedInlineStyles=function(a){var b=yne_underscore,c={bold:{key:"b",default:!1,type:"Boolean"},italic:{key:"i",default:!1,type:"Boolean"},underline:{key:"u",default:!1,type:"Boolean"},strike:{key:"s",default:!1,type:"Boolean"},"font-family":{key:"ff",default:"Microsoft YaHei",type:"String"},"font-size":{key:"fs",default:14,type:"Number"},color:{key:"cl",default:"#000000",type:"String"},"back-color":{key:"bc",default:"transparent",type:"String"},href:{key:"href",default:"",type:"String"}},d={};return{getConfig:function(a){var e=c[a],f=d[a];return e&&f&&(e=b.clone(e),e.default=f),e},isSupport:function(a){return null!=c[a]},getAllConfig:function(a){var c=this,d=c.getKeys(a),e={};return b.each(d,function(a){e[a]=c.getConfig(a)}),e},getKeys:function(a){var d=b.keys(c);return a&&a.length?b.difference(d,a):d},getDefault:function(a){var b;return b=d[a],null!=b?b:(b=c[a],b?b.default:void 0)},setDefault:function(a,b){var c=this,e=c.getDefault(a);null!=b&&b!==e&&(d[a]=b)},reset:function(){d={}}}}({}),yne_common_util_unknownInlineStyles=function(a){var b=yne_underscore,c=yne_common_data_supportedInlineStyles,d=[];return{add:function(a){a&&!c.isSupport(a)&&(b.contains(d,a)||d.push(a))},get:function(){return d},reset:function(){d=[]}}}({}),yne_common_util_codePointAt=function(a,b){if(String.prototype.codePointAt)return String.prototype.codePointAt.call(a,b);if(null===a||void 0===a)throw new TypeError("codePointAt第一个参数必须为String");a=String(a);var c,d,e=a.length,f=isNaN(b)?0:Number(b);if(!(f<0||f>=e))return c=a.charCodeAt(f),c>=55296&&c<=56319&&e>f+1&&(d=a.charCodeAt(f+1),d>=56320&&d<=57343)?1024*(c-55296)+d-56320+65536:c},yne_common_util_clearString=function(a){var b=yne_underscore;return function(a){var c,d,e="";if(!b.isString(a))return a;for(c=0;c<a.length;c++)d=a[c].charCodeAt(),(d>31&&d<127||d>159||"\t"===a[c]||"\n"===a[c]||"\r"===a[c])&&(e+=a[c]);return e}}({}),yne_common_util_toCharArrayByCodePoint=function(a){var b=yne_common_util_codePointAt;return function(a){var c,d=[];for(c=0;c<a.length;c++)b(a,c)>65535?(d.push(a.slice(c,c+2)),c++):d.push(a[c]);return d}}({}),yne_common_data_RichText=function(a){var b,c=yne_underscore,d=yne_jquery,e=yne_jtk_core_Class,f=yne_jtk_core_assert,g=yne_jtk_core_L,h=yne_common_constants,i=yne_common_util_schemaVersion,j=yne_common_data_supportedInlineStyles,k=yne_common_util_unknownInlineStyles,l=yne_common_util_codePointAt,m=function(a){f(c.isString(a)&&(1===a.length||2===a.length&&l(a)>65535)),this.char=a,this.length=a.length,this.styles={}},n=function(a){var b,c=a.length,d=new Array(c);for(b=0;b<c;++b)d[b]=a[b].clone();return d},o=yne_common_util_clearString,p=yne_common_util_toCharArrayByCodePoint,q=function(a){var b=a.indexOf("|");return b===-1?{value:a}:{compat:a.substring(0,b),value:a.substring(b+1)}};return m.prototype.toString=function(){return this.char},m.prototype.setStyle=function(a,b){var d=this.styles,e=j.getConfig(a);if(!e)return void g.warn("The RichText does not support `"+a+"` style!");if(b&&!c["is"+e.type](b))switch(e.type){case"Number":b=Number(b),b=isNaN(b)?e.default:b;break;case"Boolean":b=b+""=="true";break;default:g.warn("The value `"+b+"` of `"+a+"` is not valid type!"),b=null}b&&b!==e.default?d[a]=b:delete d[a]},m.prototype.setUnknownStyle=function(a,b){var c=this,d=j.isSupport(a);return d?void g.warn("The RichText supports `"+a+"` style!"):(c.unknownStyles||(c.unknownStyles={}),void(c.unknownStyles[a]=b))},m.prototype.getStyle=function(a,b){var d,e=j.getConfig(a);return e?(d=this.styles[a],b=b!==!1,null==d?b?e.default:null:(c["is"+e.type](d)||(g.warn("The value `"+d+"` of `"+a+"` is not valid type!"),d=null),b?null==d?e.default:d:d===e.default?null:d)):null},m.prototype.getUnknownStyle=function(a){var b=this,c=b.unknownStyles;if(c)return c[a]},m.prototype.getStyles=function(){var a=this,b={},d=j.getAllConfig();return c.each(d,function(c,d){b[d]=a.getStyle(d)}),b},m.prototype.clone=function(){var a=this,b=new m(a.char);return b.styles=c.clone(a.styles),a.unknownStyles&&(b.unknownStyles=c.clone(a.unknownStyles)),b},m.prototype.toJSON=function(){var a=this,b={char:a.char},d={},e=!1,f=j.getAllConfig();return c.each(f,function(b,c){var f=a.getStyle(c,!1);f&&(d[c]=f,e=!0)}),e&&(b.styles=d),b},m.fromJSON=function(a){if(a&&a.char){var b=new m(a.char);return c.each(a.styles,function(a,c){b.setStyle(c,a)}),b}},b=e.extend({_data:null,initialize:function(a){a=a||{};var b=this,d=a.text||"",e=b._data=[];d=o(d),c.each(p(d),function(a){e.push(new m(a))})},indexOf:function(a,b){var c,d,e,f,g=a._data,h=g.length,i=this._data,j=i.length;if(h>j)return-1;for(d=b;d<j;d++){for(c=!0,e=0;e<h;e++)if(f=i[d+e],!f||f.char!==g[e].char){c=!1;break}if(c)return d}return-1},getLength:function(){return this._data.length},isEmpty:function(){return this.getLength()<=0},getClonedData:function(){return n(this._data)},getReadOnlyData:function(){return this._data},toString:function(){return this._data.join("")},setStyle:function(a,b,d,e){var f,g=this,h=g._data,i=c.isArray(e);for(b=Math.min(b,h.length),f=a;f<b;++f)h[f].setStyle(d,i?e[f-a]:e)},setUnknownStyle:function(a,b,d,e){var f,g=this,h=g._data,i=c.isArray(e);for(b=Math.min(b,h.length),f=a;f<b;++f)h[f].setUnknownStyle(d,i?e[f-a]:e)},getStyle:function(a,b,c){var d,e,g,h=this,i=h._data;for(f(a>=0),f(a<=b),f(b<=i.length),g=new Array(b-a),d=a;d<b;++d)e=i[d].getStyle(c),g[d-a]=e;return g},setStyles:function(a,b,d){var e=this;d&&c.each(d,function(c,d){e.setStyle(a,b,d,c)})},getStylesAtIndex:function(a,b){var c,d=this._data,e=d.length;return f(a>=0&&a<e),c=d[a],c?b?c.getStyle(b):c.getStyles():b?null:{}},getCommonStyle:function(a,b,c){var d,e,g=this,i=g._data,k=null;if(g.isEmpty())return j.getDefault(c);if(f(a>=0),f(a<=b),f(b<=i.length),a===b)k=0===a?i[0].getStyle(c):i[a-1].getStyle(c);else for(d=a;d<b;++d)if(e=i[d].getStyle(c),null===k)k=e;else if(k!==e)return h.INTERM;return k},getCommonStyles:function(a,b){var d=this,e={},f=j.getAllConfig();return c.each(f,function(c,f){e[f]=d.getCommonStyle(a,b,f)}),e},slice:function(a,c,d){var e=this,f=e._data.slice(a,c),g=new b;return g._data=d!==!1?n(f):f,g},append:function(a){if(a&&a.getClonedData){var b=this,c=a.getClonedData();b._data=b._data.concat(c)}},insert:function(a,b){if(a&&a.getClonedData){var c=this,d=c._data,e=d.splice(b),f=a.getClonedData();g.log("insert ...",a,b),c._data=d.concat(f,e)}},getReadOnlyStylesList:function(a){var b=this,d=b._data,e=[],f=j.getAllConfig();return a=a!==!1,c.each(d,function(b){var d={};c.each(f,function(c,e){var f=b.getStyle(e,a);(a||!a&&null!=f)&&(d[e]=f)}),e.push(d)}),e},_getStyleRanges:function(a,b){if(a){if(b=b===!0,j.isSupport(a))b=!1;else if(!b)return;var d,e,f,g,h=this,i=h._data,k=i.length,l=[],m=!1;for(d=0;d<k;d++)e=i[d],f=b?e.getUnknownStyle(a):e.getStyle(a,!1),f?(g=c.last(l),!m&&g&&g.value===f?g.to=d+1:l.push({from:d,to:d+1,value:f}),m=!1):m=!0;return l}},_handleStyleRanges:function(a,b,d,e,f){e&&e.length&&c.each(e,function(c){if(c&&c.value){var e,g,i,j=a.createElement(d),k=a.createElement("from"),l=a.createElement("to"),m=a.createElement("value");k.appendChild(a.createTextNode(c.from)),j.appendChild(k),l.appendChild(a.createTextNode(c.to)),j.appendChild(l),f?(e=q(c.value),i=e.compat,i&&j.setAttribute(h.COMPAT,i),g=e.value):g=c.value,m.appendChild(a.createTextNode(g)),j.appendChild(m),b.appendChild(j)}})},toXml:function(a){var b,d=this,e=a.createElement("inline-styles"),f=j.getAllConfig();return c.each(f,function(b,c){var f=d._getStyleRanges(c,!1);d._handleStyleRanges(a,e,c,f,!1)}),b=k.get(),c.each(b,function(b){var c=d._getStyleRanges(b,!0);d._handleStyleRanges(a,e,b,c,!0)}),e},toJSON:function(){var a=this,b=c.map(a._data,function(a){return a.toJSON()});return{isRichText:!0,data:b}}},{fromXml:function(a){var c=d(a),e=new b({text:c.find("text").text()});return c.find("inline-styles").children().each(function(a,b){var c,f,g=b.nodeName,l=d(b),m=parseInt(l.find("from").text()),n=parseInt(l.find("to").text()),o=l.find("value");0!==o.length&&(c=o.text(),j.isSupport(g)?e.setStyle(m,n,g,c):(f=l.attr(h.COMPAT),i.isCompatible(f)&&(k.add(g),c=f+"|"+c,e.setUnknownStyle(m,n,g,c))))}),e},fromJSON:function(a){if(a&&a.isRichText&&a.data){var d,e=[];return c.each(a.data,function(a){var b=m.fromJSON(a);b&&e.push(b)}),d=new b,d._data=e,d}}})}({}),yne_common_data_inlineStyleRules=function(a){var b=yne_underscore,c={"font-size":function(a){var b=a["font-size"];if(null!=b)return b+"px"},"font-family":function(a){return a["font-family"]},color:function(a){return a.color},"background-color":function(a){return a["back-color"]},"font-weight":function(a){var b={true:"bold",false:"normal"};return b[a.bold+""]},"font-style":function(a){var b={true:"italic",false:"normal"};return b[a.italic+""]},"text-decoration":function(a){if(a.underline===!1&&a.strike===!1)return"none";var b=[];return a.underline&&b.push("underline"),a.strike&&b.push("line-through"),b=b.join(" "),b||""}};return{getRules:function(a){var d=a?b.clone(a):{};return b.defaults(d,c),d},stylesToCssStyles:function(a,c,d){var e=this,f={},g=e.getRules(d);return b.isArray(c)&&(g=b.pick(g,c)),b.isObject(a)&&b.each(g,function(b,c){f[c]=b(a)}),f}}}({}),yne_common_data_Rich2HtmlConvertor=function(a){var b,c=yne_underscore,d=yne_jquery,e=yne_common_data_RichText,f=yne_common_data_supportedInlineStyles,g=yne_common_data_inlineStyleRules,h=yne_common_constants,i=function(a,b){var d,e=document.createElement("span");return c.each(b,function(b,c){var d=b(a);(d||0===d)&&(e.style[c]=d)}),d=e.outerHTML,d=d.replace(/<\/span>$/i,"")},j=function(){return"</span>"},k=function(a){a+="";var b=c.escape(a);return'<a href="'+b+'">'},l=function(){return"</a>"},m=function(a,b,d){c.isEmpty(b)||a.push(i(b,d))},n=function(a,b){b&&a.push(k(b))},o=function(a,b){c.isEmpty(b)||a.push(j(b))},p=function(a,b){b&&a.push(l(b))},q=f.getKeys(),r=function(a,b){if(!a||!b)return!1;var c,d=q.length;for(c=0;c<d;c++)if(a[q[c]]!==b[q[c]])return!1;return!0},s={},t={};return h.IS_MOBILE&&(s["font-size"]=function(a){var b=a["font-size"];if(null!=b)return a["font-size"]/6*5+"pt"}),b={setCssRules:function(a){var b=this;c.each(a,function(a,d){c.isFunction(a)&&(s[d]=a,b.resetInlineStyleDefaultForHtml(d))})},getCssRule:function(a){var b=s[a];return b},resetCssRules:function(){var a=this;s={},a.resetInlineStyleDefaultForHtml()},getDefaultForHtml:function(a){var b,c,d,e=this,g=t[a];return null==g&&(b=e.getCssRule(a),c=f.getDefault(a),b?(d={},d[a]=c,g=b(d)):g=c,t[a]=g),g},resetInlineStyleDefaultForHtml:function(a){a?(a+="",delete t[a]):t={}},rich2html:function(a,b){var d,e,f,h,i,j,k=this,l=a.getReadOnlyData(),q=l.length,t=[],u="";if(b=c.defaults(b||{},{withDefault:!0,convertSpace:!1,styleRules:null}),0===q)return"<br>";for(d=a.getReadOnlyStylesList(b.withDefault),b.styleRules?(j=c.clone(b.styleRules),c.defaults(j,s)):j=s,j=g.getRules(j),k._mergeStyles(b.styles,d),e=0;e<q;++e)f=l[e],i=d[e],r(h,i)||(o(t,h),u!==i.href&&(p(t,u),n(t,i.href)),m(t,i,j)),t.push(c.escape(f.toString())),h=i,u=i.href;return o(t,h),p(t,u),t=t.join("")},_mergeStyles:function(a,b){if(a)for(var d,e,f=0,g=a.length;f<g;f++)e=a[f],d=b[f],e&&c.extend(d,e)},html2rich:function(a){return new e(d(a).text())}}}({}),yne_common_util_unknownTree=function(a){var b=yne_underscore,c=yne_jquery,d=yne_jtk_core_L,e=yne_common_constants,f=yne_common_util_schemaVersion;return{appendToTree:function(a,b){if(!a||!b)return void d.error("arguments are not valid!");var g=c(b).attr(e.COMPAT);f.isCompatible(g)&&(a.unknown||(a.unknown=[]),a.unknown.push(b.cloneNode(!0)))},appendToXml:function(a,c){return a&&c?void(a.unknown&&a.unknown.length&&b.each(a.unknown,function(a){a&&a.cloneNode&&c.appendChild(a.cloneNode(!0))})):void d.error("arguments are not valid!")}}}({}),yne_common_util_blockStyles=function(a){var b=yne_common_util_unknownTree,c=yne_jquery,d=yne_underscore;return{toXml:function(a,c,e){var f=a.getBlockStyles();d.each(f,function(a,b){var d=e.createElement(b),f=e.createTextNode(a);d.appendChild(f),c.appendChild(d)}),a.unknownTree&&a.unknownTree.styles&&b.appendToXml(a.unknownTree.styles,c)},fromXml:function(a,d){var e=a.unknownTree;c(d).children().each(function(d,f){var g,h=f.nodeName;a.isSupportedBlockStyle(h)?(g=c(f).text(),a.setBlockStyle(h,g)):(e.styles||(e.styles={}),b.appendToTree(e.styles,f))})}}}({}),yne_common_util_countText=function(a){var b,c=0;return a?("string"==typeof a?c=a.replace(/(\s)/g,"").length:(b=a.toString(),c=b.replace(/(\s)/g,"").length),c):c},yne_tinycolor=function(){var a=window.tinycolor;if(!a&&window.require&&(a=window.require("tinycolor")),!a)throw"no `tinycolor` library";return a}(),yne_common_util_highlight=function(a){var b=yne_tinycolor,c=yne_underscore,d=b("#FFFD38"),e=d.toRgb(),f=function(a,d){var e=null!=a.r?a:b(a).toRgb(),f=null!=d.r?d:b(d).toRgb(),g=0;return c.each(["r","g","b"],function(a){var b=e[a]-f[a];g+=b*b}),g=Math.sqrt(g)},g=70,h=function(a,b){var c=f(a,b);return c>g?1:0};return{TEXT_COLOR:"#333",BACK_COLOR:d.toHexString(),isDiffFromHighlightColor:function(a){return!a||"transparent"===a||h(e,a)}}}({}),yne_common_data_Paragraph=function(a){var b,c,d,e=yne_underscore,f=yne_jquery,g=yne_common_data_Block,h=yne_common_data_Rich2HtmlConvertor,i=yne_common_data_blockTypes,j=yne_common_constants,k=yne_common_data_RichText,l=yne_jtk_core_L,m=yne_common_util_unknownTree,n=yne_common_util_blockStyles,o=yne_common_data_supportedBlockStyles,p=yne_common_util_countText,q=yne_common_util_highlight;return b={_type:i.PARAGRAPH,_richText:null,_styles:null,_defaultInlineStyles:null,initialize:function(){var a=this;a.setText(""),g.prototype.initialize.apply(a,arguments)},setText:function(a){a instanceof k||(e.isString(a)||(a=String(a)),a=new k({text:a}));var b=this;b._richText=a,b.trigger("content-change",b)},getText:function(){return this._richText.slice(0)},getReadOnlyText:function(){return this._richText},getStartOffset:function(){return 0},getEndOffset:function(){return this.getLength()},getLength:function(){var a=this;return a._richText.getLength()},isEmpty:function(){var a=this;return a._richText.isEmpty()},getRangeText:function(a){if(a&&null!=a.start){var b=this;return b.sliceText(a.start,a.end)}},sliceText:function(a,b,c){var d=this;return d._richText.slice(a,b,c)},append:function(a){var b=this;b._richText.append(a)},insertText:function(a,b){var c=this;return l.log("insert Text",a,b),c._richText.insert(b,a),l.log(c._richText),c.trigger("content-change"),!0},deleteText:function(a,b){e.isObject(a)&&!e.isUndefined(a.start)&&(b=a.end,a=a.start);var c=this,d=c._richText,f=d.slice(0,a),g=new k,h=new k;b>=0&&(g=d.slice(b)),h.append(f),h.append(g),c.setText(h)},setTextStyle:function(a,b,c,d){var f=this,g=f._richText;e.isObject(c)&&null!=c.start&&(d=c.end,c=c.start),g.setStyle(c,d,a,b),f.trigger("content-change")},getTextStyle:function(a,b,c){var d=this,f=d._richText;return e.isObject(b)&&null!=b.start&&(c=b.end,b=b.start),f.getStyle(b,c,a)},getTextStylesAtIndex:function(a){var b=this._richText;return b.getStylesAtIndex(a)},getCommonStyle:function(a,b){var c,d,e=this;return b?(c=b.start,d=b.end):(c=e.getStartOffset(),d=e.getEndOffset()),e._richText.getCommonStyle(c,d,a)},getCommonStyles:function(a){var b,c,d=this,e=d._richText;return a?(b=a.start,c=a.end):(b=d.getStartOffset(),c=d.getEndOffset()),e.getCommonStyles(b,c)},setDefaultInlineStyles:function(a){this._defaultInlineStyles=e.clone(a)},getDefaultInlineStyles:function(){return e.clone(this._defaultInlineStyles||null)},getDefaultInlineStyle:function(a){return this._defaultInlineStyles&&this._defaultInlineStyles[a]},toXml:function(a){var b,c,e=this,f=d.__super__.toXml.apply(e,[a]),g=a.createElement("text"),h=e._richText.toString(),i=a.createTextNode(h);return g.appendChild(i),f.appendChild(g),c=e._richText.toXml(a),c&&f.appendChild(c),b=a.createElement("styles"),n.toXml(e,b,a),f.appendChild(b),m.appendToXml(e.unknownTree,f),f},toJSON:function(a,b){a=a||0;var c=this,d=c.sliceText(a,b,!1),e={blockType:c._type,richText:d.toJSON(),styles:c.getBlockStyles()};return e},toHtml:function(a,b){var c,d,e,g=this,i=document.createElement("div"),j=f(i);return j.attr("yne-bulb-block","paragraph").css("white-space","pre-wrap"),g._applyBlockStylesOnElement(j),a=a||0,c=g.sliceText(a,b,!1),d=h.rich2html(c,{withDefault:!1}),j.html(d),e=i.outerHTML,i=j=null,e},_applyBlockStylesOnElement:function(a){var b,c=this.getBlockStyles(),d={};e.each(c,function(b,c){switch(l.log("toHtml key",c," value ",b),c){case"align":d["text-align"]=b;break;case"indent":b=b>0?b:0,b=b<9?b:9,a.css("margin-left",b*j.RENDERED_INDENT_WIDTH||"");break;case"text-indent":b=b>0?b:0,b=b<9?b:9,a.css("text-indent",b*j.RENDERED_INDENT_WIDTH||"");break;case"line-height":b>0?a.css("line-height",String(b)):a.css("line-height","normal");break;default:l.warn("unknown block style: "+c)}}),d["line-height"]||(b=o.getDefault("line-height"),d["line-height"]=b),b=h.getDefaultForHtml("font-size"),d["font-size"]=b,a.css(d)},toPlain:function(a,b){var c,d,e=this;return a=a||0,c=e.sliceText(a,b,!1),d=c.toString()},countWords:function(a){var b,c=this,d=0,e=c._richText;return j.IS_MOBILE||!a?d=p(e):(b=c.getRangeText(a),b&&(d=p(b))),d},getHighlightStyle:function(a){if(a&&a.length){var b,c,d=this,f=[],g=d._richText,h=g.getLength(),i={"back-color":"transparent"},j={color:q.TEXT_COLOR,"back-color":q.BACK_COLOR},k=function(a,b){var c;for(c=a;c<b;c++)f[c]=j};for(e.each(a,function(a){for(var b=a.length,c=0,e=d._getIndex(g,a,c);e!==-1;)k(e,e+b),e=d._getIndex(g,a,e+1)}),b=0;b<h;b++)c=g.getStylesAtIndex(b,"back-color"),f[b]||q.isDiffFromHighlightColor(c)||(f[b]=i);return f&&f.length?f:null}},_getIndex:function(a,b,c){var d=new k({text:b});return a.indexOf(d,c)}},c={fromXml:function(a){var b=new d;return b.setText(k.fromXml(a)),b.parseIdFromXml(a),f(a).children().each(function(a,c){switch(c.nodeName){case g.TAG_ID_NAME:case g.LEGACY_TAG_ID_NAME:case"text":case"inline-styles":break;case"styles":n.fromXml(b,c);break;default:m.appendToTree(b.unknownTree,c)}}),b},fromJSON:function(a){if(!a||!a.blockType||a.blockType!==i.PARAGRAPH||!a.richText)return void l.warn("jsonObj is not valid!");var b=new d,c=k.fromJSON(a.richText);return b.setText(c),e.each(a.styles,function(a,c){b.setBlockStyle(c,a)}),b}},d=g.extend(b,c)}({}),yne_common_views_BlockView=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jtk_core_L;return b.View.extend({className:"block-view unknown-block-view",attributes:{},block:null,_getSelector:function(){var a=this,b=a.tagName,d=a.className.split(/\s+/),e=a.id,f=a.cid,g=".note-view ";return g+=b,e&&(g+="#"+e),c.each(d,function(a){a&&(g+="."+a)}),g+='[data-yne-cid="'+f+'"]'},initialize:function(a){var b=this;b.block=a.block,c.bindAll(b,"_onLockedChange"),b.block.on("locked-change",b._onLockedChange),b._highlightOn=!1},render:function(){this.$el.attr("data-yne-cid",this.cid),this._renderLockStatus()},convertToNativeRange:function(){d.error("convertToNativeRange() should be implemented by subclass!")},parseNativeRange:function(){d.error("parseNativeRange() should be implemented by subclass!")},bindSelectionEvents:function(){var a=this;c.bindAll(a,"onDrawRange"),a.on("draw-range",a.onDrawRange)},onDrawRange:function(){throw"Method not implemented."},isLocked:function(){var a=this,b=a.block;if(b)return b.isLocked()},_onLockedChange:function(){var a=this;a._renderLockStatus()},_renderLockStatus:function(){var a=this,b=a.isLocked();b?a.$el.addClass("locked"):a.$el.removeClass("locked")}})}({}),yne_common_selection_ParagraphRange=function(a){var b=yne_common_selection_BlockRange,c=yne_underscore,d=b.extend({_type:"paragraph",start:0,end:0,initialize:function(a){var b=this;a=a||{},b.start=a.start||0,b.end=a.end||0,b.block=a.block},isCollapsed:function(){var a=this;return a.start===a.end},clone:function(){var a=this;return d.create({start:a.start,end:a.end,block:a.block})},collapse:function(a){var b=this;a===!1?b.start=b.end:b.end=b.start},getDataAsJSON:function(){var a=this,b=a.block.toJSON(a.start,a.end);return b},getDataAsHtml:function(){var a=this,b=a.block.toHtml(a.start,a.end);return b},getDataAsPlain:function(){var a=this,b=a.block,c=b.toPlain(a.start,a.end);return c},getContent:function(){var a=this;return a.block.sliceText(a.start,a.end)},canDrawedByNative:function(){return!0},_handleStartOrEnd:function(a){var b=this,d=b.block,e=d.getStartOffset(),f=d.getEndOffset();return a=parseInt(a),a=c.isNaN(a)||a<e?0:a,a=a>f?f:a},setStart:function(a){var b=this;a=b._handleStartOrEnd(a),b.end<a?(b.start=b.end,b.end=a):b.start=a},setEnd:function(a){var b=this;a=b._handleStartOrEnd(a),b.start>a?(b.end=b.start,b.start=a):b.end=a},setStartAndEnd:function(a,b){var c=this;c.setStart(a),c.setEnd(b)},isEqual:function(a){return a instanceof d&&(this.block===a.block&&(this.start===a.start&&this.end===a.end))}},{create:function(a){return new d(a)}});return d}({}),yne_jtk_web_dom_nodeType=function(a){var b=yne_underscore;return{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12,getType:function(a){if(a&&a.nodeType)return a.nodeType},isNode:function(a){var c=this,d=c.getType(a);return b.isNumber(d)&&d>=c.ELEMENT_NODE&&d<=c.NOTATION_NODE},isElement:function(a){return this.getType(a)===this.ELEMENT_NODE},isAttribute:function(a){return this.getType(a)===this.ATTRIBUTE_NODE},isText:function(a){return this.getType(a)===this.TEXT_NODE},isCDataSection:function(a){return this.getType(a)===this.CDATA_SECTION_NODE},isEntityReference:function(a){return this.getType(a)===this.ENTITY_REFERENCE_NODE},isEntity:function(a){return this.getType(a)===this.ENTITY_NODE},isProcessingInstruction:function(a){return this.getType(a)===this.PROCESSING_INSTRUCTION_NODE},isComment:function(a){return this.getType(a)===this.COMMENT_NODE},isDocument:function(a){return this.getType(a)===this.DOCUMENT_NODE},isDocumentType:function(a){return this.getType(a)===this.DOCUMENT_TYPE_NODE},isDocumentFragment:function(a){return this.getType(a)===this.DOCUMENT_TYPE_NODE},isNotation:function(a){return this.getType(a)===this.NOTATION_NODE}}}({}),yne_common_jst=function(a){var b=yne_jtk_core_L,c=this;return{getTemplate:function(a,d){var e=a+"/"+d,f=c.JST[e];return f||b.error("JST has no template: "+e),f},render:function(a,c,d){var e=this.getTemplate(a,c);return e?e(d):void b.error("no tempalte: "+a+"/"+c+".jst","template/jst.js")}}}({}),yne_common_data_blankLine=function(a){var b=yne_common_data_supportedBlockStyles,c=yne_common_data_Rich2HtmlConvertor,d=null;return{_computeMinHeight:function(){var a,d=b.getDefault("line-height"),e=c.getDefaultForHtml("font-size");return e=parseInt(e,10),a=Math.ceil(e*d)},getMinHeight:function(){return d||(d=this._computeMinHeight()),d},reset:function(){d=null}}}({}),yne_common_views_ParagraphView=function(a){var b=yne_underscore,c=yne_jquery,d=yne_common_views_BlockView,e=yne_common_selection_ParagraphRange,f=yne_common_data_Rich2HtmlConvertor,g=yne_jtk_web_dom_nodeType,h=yne_common_constants,i=yne_jtk_core_L,j=yne_common_jst,k=yne_common_data_Rich2HtmlConvertor,l=yne_common_util_toCharArrayByCodePoint,m=yne_common_data_blankLine;
return d.extend({className:"block-view paragraph-view",_template:j.getTemplate("common","paragraph_view"),initialize:function(){d.prototype.initialize.apply(this,arguments);var a=this,c=a.block;b.bindAll(a,"_onContentChange","_onStyleChange","_onHighlight"),a._onContentChange=a._onContentChange.bind(a),c.on("content-change",a._onContentChange),c.on("style-change",a._onStyleChange),c.on("high-light",a._onHighlight)},render:function(a){var b=this;b._renderTemplate(),d.prototype.render.apply(b,arguments),b._renderText(a),b._renderStyles()},_renderTemplate:function(){var a=this;a.$el.html(a._template())},convertToNativeRange:function(a){if(!a)return void i.warn("block range is unvalid!");var b,c,d=this;return(c=d._getCharacterInfo(a.start))?(b=document.createRange(),b.setStart(c.node,c.offset),(c=d._getCharacterInfo(a.end))?(b.setEnd(c.node,c.offset),b):void i.error("_getCharacterInfo blockRange.end error!")):void i.error("_getCharacterInfo blockRange.start error!")},parseNativeRange:function(a,b,c){var d,f,g,h,i,j,k=this;return c?j=new e({start:0,end:b.getEndOffset(),block:b}):(d=a.startContainer,f=a.startOffset,g=a.endContainer,h=k._getCharacterIndex(a.startContainer,a.startOffset,!0),i=k._getCharacterIndex(a.endContainer,a.endOffset,!1),i===-1&&(i=b.getEndOffset()),j=new e({start:h,end:i,block:b}))},_getCharacterInfo:function(a){var b,c=this,d=c.$el.find(".para-text").get(0),e=document.createNodeIterator(d,NodeFilter.SHOW_TEXT),f=e.nextNode(),g=0;if(0===a||!f)return{node:f||d,offset:0};for(;f;){if(b=l(f.nodeValue),b.length>0&&g<a&&g+b.length>=a)return{node:f,offset:b.slice(0,a-g).reduce(function(a,b){return a+b.length},0)};g+=b.length,f=e.nextNode()}},_getTextOfNode:function(a){if(g.isText(a))return a.nodeValue;var b,c=document.createNodeIterator(a,NodeFilter.SHOW_TEXT),d="";if(!c)return"";for(b=c.nextNode();b;)d+=b.nodeValue,b=c.nextNode();return d},_charArrayLengthOfNode:function(a){var b=this,c=b._getTextOfNode(a);return l(c).length},_charArrayOffset:function(a,b){var c,d=l(a);for(c=0;c<d.length&&b>0;c++)b-=d[c].length;return c},_getCharacterIndex:function(a,b,d){var e,f,h=this,i=h.$el.find(".para-text").get(0),j=0;if(!c.contains(i,a)&&a!==i)return d?0:-1;for(g.isText(a)&&(j+=h._charArrayOffset(a.nodeValue,b)),e=a;e!==i;){for(f=e.previousSibling;f;)j+=h._charArrayLengthOfNode(f),f=f.previousSibling;e=e.parentNode}return j},_renderText:function(a){var b,c=this,d=c.block,e=d.getReadOnlyText(),g={styles:a},h=f.rich2html(e,g),i=c.$el.find(".para-text");b=e.isEmpty()?m.getMinHeight():"",i.css("minHeight",b).html(h)},_renderStyles:function(){var a=this,c=a.block,d=c.getBlockStyles();b.each(d,function(b,c){a._setStyle(c,b)}),a._renderStylesFix()},_renderStylesFix:function(){var a=this.$el,b=a.find(".para-text");b.css("fontSize",k.getDefaultForHtml("font-size"))},_setStyle:function(a,b){var c=this.$el,d=c.find(".para-text");switch(a){case"align":d.css("text-align",b);break;case"line-height":b>0?d.css("line-height",String(b)):d.css("line-height","normal");break;case"indent":c.css("margin-left",this._computeIndentWidth(b)||"");break;case"text-indent":d.css("text-indent",this._computeIndentWidth(b)||"");break;default:i.warn("unknown block style: "+a)}},_computeIndentWidth:function(a){return a=a>0?a:0,a<=9||!h.IS_MOBILE?a*h.RENDERED_INDENT_WIDTH:2*Math.min(a-9,10)+9*h.RENDERED_INDENT_WIDTH},_onContentChange:function(){var a=this;a._renderText()},_onStyleChange:function(a,b){this._setStyle(a,b)},_onHighlight:function(a){var b=this,c=b.block,d=c.getHighlightStyle(a);d?(b._highlightOn=!0,b.render(d)):b._highlightOn&&(b._highlightOn=!1,b.render(d))}})}({}),yne_iphone_utils_FixClickable=function(a){var b,c=yne_jtk_core_Class,d=yne_underscore,e=yne_backbone;return b={touchBoundary:10,tapTimeout:500,events:{touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",touchcacel:"onTouchCancel"},initialize:function(a){this._el=a.el,this.initEvents()},initEvents:function(){var a=this,b=a._el;d.each(a.events,function(c,d){b.addEventListener(d,a[c].bind(a))})},onTouchStart:function(a){var b,c;return a.targetTouches.length>1||(b=this.getTargetElementFromEventTarget(a.target),c=a.targetTouches[0],this.trackingClick=!0,this.trackingClickStart=a.timeStamp,this.targetElement=b,this.touchStartX=c.pageX,this.touchStartY=c.pageY,!0)},onTouchMove:function(a){var b;return!this.trackingClick||(b=this.getTargetElementFromEventTarget(a.target),(this.targetElement!==b||this.touchHasMoved(a))&&this.resetStates(),!0)},onTouchEnd:function(a){return!this.trackingClick||(a.timeStamp-this.trackingClickStart<this.tapTimeout&&this.trigger("fix-click",a,this.targetElement),void this.resetStates())},onTouchCancel:function(){this.resetStates()},resetStates:function(){this.trackingClick=!1,this.trackingClickStart=0,this.targetElement=null,this.touchStartX=0,this.touchStartY=0},getTargetElementFromEventTarget:function(a){return a.nodeType===Node.TEXT_NODE?a.parentNode:a},touchHasMoved:function(a){var b=a.changedTouches[0],c=this.touchBoundary;return Math.abs(b.pageX-this.touchStartX)>c||Math.abs(b.pageY-this.touchStartY)>c}},d.extend(b,e.Events),c.extend(b)}({}),yne_osImageView=function(a){var b=yne_common_views_BlockView,c=yne_jquery,d=yne_underscore,e=yne_common_jst,f=yne_iphone_utils_FixClickable,g=yne_common_selection_ImageRange,h=yne_jtk_core_L;return b.extend({className:"block-view image-view",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments),d.bindAll(a,"_onStyleChange","_onContentChange","_onFixClick"),a.block.on("style-change",a._onStyleChange),a.block.on("content-change",a._onContentChange),a._fixClickable=new f({el:a.el}),a._fixClickable.on("fix-click",a._onFixClick),a.bindSelectionEvents()},_onFixClick:function(){h.log("ImageView trigger click-image"),this.trigger("click-image",this.block)},render:function(){var a=this,c=e.render("iphone","image-view-image-container",{src:a._getRenderedSource()});b.prototype.render.apply(a,arguments),a.$el.html(c),a._renderStyles(),a._requestRenderSrc()},_renderStyles:function(){var a=this,b=a.block.getBlockStyles();d.each(b,function(b,c){a._setStyle(c,b)})},_setStyle:function(a,b){var d,e=this,f=e.$el;switch(a){case"align":f.css("text-align",b);break;case"width":d=e.getImgElement(),h.log("set image width: "+b),null==b?c(d).css("width",""):c(d).css("width",b);break;case"float":f.css("float",b)}},_onStyleChange:function(a,b){this._setStyle(a,b)},_onContentChange:function(){var a=this,b=a.$el;b.find("img").attr("src",a._getRenderedSource()),a._requestRenderSrc()},getImgElement:function(){return this.$el.find("img").get(0)},convertToNativeRange:function(){var a=this,b=document.createRange(),c=a.$el.get(0);return b.setStart(c,0),b.setEnd(c,c.childNodes.length),b},parseNativeRange:function(a,b,c){var d=this;if(c||d._isImageInNativeRange(a)||d._isNativeRangeInImageView(a))return new g({block:b})},_isImageInNativeRange:function(a){var b,c=this,d=c.getImgElement();return b=d.ownerDocument.createRange(),b.selectNode(d),a.compareBoundaryPoints(Range.START_TO_START,b)<1&&a.compareBoundaryPoints(Range.END_TO_END,b)>-1},_isNativeRangeInImageView:function(a){var b,d=this,e=d.el;return b=a.commonAncestorContainer,3===b.nodeType&&(b=b.parentNode),!(b!==e&&!c.contains(e,b))},_getRenderedSource:function(){return""},_requestRenderSrc:function(){this.trigger("request-image-rendered-src",this.block.getSource())},updateRenderedSource:function(a){var b=this,c=b.$el.find("img")[0];c&&(c.onload=function(){c.onload=c.onerror=c.abort=null,b.trigger("image-rendered")},c.onerror=c.onabort=function(){c.onload=c.onerror=c.abort=null},c.setAttribute("src",a))},triggerImageRendered:function(){this.trigger("image-rendered")},_removeFocusedClass:function(){var a=this;a.$el.removeClass("focused")},_addFocusedClass:function(){var a=this;a.$el.addClass("focused")},onDrawRange:function(a){var b=this;a?b._addFocusedClass():b._removeFocusedClass()}})}({}),yne_osAttachmentView=function(a){var b=yne_common_views_BlockView,c=yne_jquery,d=yne_underscore,e=yne_common_jst,f=yne_iphone_utils_FixClickable,g=yne_common_selection_AttachmentRange;return b.extend({className:"block-view attachment-view",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments),d.bindAll(a,"_onStyleChange","_onContentChange","_onFixClick"),a.block.on("style-change",a._onStyleChange),a.block.on("content-change",d.debounce(a._onContentChange,100)),a._fixClickable=new f({el:a.el}),a._fixClickable.on("fix-click",a._onFixClick),a.bindSelectionEvents()},_onFixClick:function(){this.trigger("click-attachment",this.block)},render:function(){var a=this,c="attachment-view-attachment-container",d=e.render("iphone",c,{src:a._getRenderedSource()});b.prototype.render.apply(a,arguments),a.$el.html(d),a._renderStyles(),a._requestRenderSrc()},_renderStyles:function(){var a=this,b=a.block.getBlockStyles();d.each(b,function(b,c){a._setStyle(c,b)})},_setStyle:function(a,b){var c=this,d=c.$el;switch(a){case"align":d.css("text-align",b);break;case"float":d.css("float",b)}},_onStyleChange:function(a,b){this._setStyle(a,b)},_onContentChange:function(){var a=this,b=a.$el;b.find("img").attr("src",a._getRenderedSource()),a._requestRenderSrc()},getImgElement:function(){return this.$el.find("img").get(0)},convertToNativeRange:function(){var a=this,b=document.createRange(),c=a.$el.get(0);return b.setStart(c,0),b.setStart(c,c.childNodes.length),b},parseNativeRange:function(a,b,c){var d=this;if(c||d._isAttachmentInNativeRange(a)||d._isNativeRangeInAttachmentView(a))return new g({block:b})},_isAttachmentInNativeRange:function(a){var b,c=this,d=c.getImgElement(),e=window.Range;return b=d.ownerDocument.createRange(),b.selectNode(d),a.compareBoundaryPoints(e.START_TO_START,b)<1&&a.compareBoundaryPoints(e.END_TO_END,b)>-1},_isNativeRangeInAttachmentView:function(a){var b,d=this,e=d.el;return b=a.commonAncestorContainer,3===b.nodeType&&(b=b.parentNode),!(b!==e&&!c.contains(e,b))},_removeFocusedClass:function(){var a=this;a.$el.removeClass("focused")},_addFocusedClass:function(){var a=this;a.$el.addClass("focused")},onDrawRange:function(a){var b=this;a?b._addFocusedClass():b._removeFocusedClass()},_getRenderedSource:function(){return""},_requestRenderSrc:function(){var a=this,b=a.block;a.trigger("request-attachment-rendered-src",{path:b.getResource(),title:b.getFileName(),length:b.getFileLength()})},updateRenderedSource:function(a){this.$el.find("img").attr("src",a)}})}({}),yne_common_data_supportedListItemStyles=function(){function a(a){if(isNaN(a))return"";for(var b=[["","i","ii","iii","iv","v","vi","vii","viii","ix"],["","x","xx","xxx","xl","l","lx","lxx","lxxx","xcc"],["","c","cc","ccc","cd","d","dc","dcc","dcc","cm"]],c="",d=0,e=0,f=1e3;e<3;e++,f/=10)d=Math.floor(a%f/(f/10)),c+=b[2-e][d];return c}function b(a){if(isNaN(a))return"";var b="a".charCodeAt(0),c="z".charCodeAt(0),d=c-b+1,e="";for(a--;a>=0;)e=String.fromCharCode(a%d+b)+e,a=Math.floor(a/d)-1;return e}var c=["lower-roman","decimal","lower-alpha"],d=["square","disc","circle"];return{getStyle:function(a){var b=a.getLevel();return a.isOrdered()?c[b%3]:d[b%3]},getPlainStyle:function(c,d){var e="";switch(c%3){case 0:e=a(d);break;case 2:e=b(d);break;default:case 1:e=d}return e}}}(),yne_common_views_ListItemView=function(a){var b=yne_underscore,c=yne_common_views_ParagraphView,d=yne_common_jst,e=yne_common_data_supportedListItemStyles.getStyle,f=yne_common_data_inlineStyleRules,g=function(a){return f.stylesToCssStyles(a,["font-size","font-family","color","font-weight","font-style"])};return c.extend({className:"block-view list-item-view paragraph-view",_template:d.getTemplate("common","list_item_view"),_styleSheet:null,initialize:function(){var a=this;c.prototype.initialize.apply(a,arguments),a._initEvents()},_initEvents:function(){var a=this,c=a.block,d=c.getOwnerList();b.bindAll(a,"_onLevelChange","_onIndexChange","_onTypeChange"),c.on("level-change",a._onLevelChange),c.on("index-change",a._onIndexChange),d.on("type-change",a._onTypeChange)},_renderLevel:function(){var a=this,b=a.block,c=b.getLevel(),d=a.$el.find(".li-box");d.attr("data-level",c),d.attr("data-style-type",e(b))},_renderText:function(){var a=this;c.prototype._renderText.apply(a,arguments),a._renderMarkerText()},_renderMarkerText:function(){var a=this,b=a.block.getText(),c=a.$el.find("li");c.attr("style",""),b.getLength()?c.css(g(b.getStylesAtIndex(0))):a.trigger("get-editing-styles",function(a){c.css(g(a))})},_renderIndex:function(){var a=this,b=a.block;a.$el.find(".li-box").attr("start",b.getIndex())},render:function(){var a=this;c.prototype.render.apply(a,arguments),a._renderLevel(),a._renderIndex()},_renderTemplate:function(){var a=this,b=a.block;a.$el.html(a._template({isOrdered:b.isOrdered()}))},_onLevelChange:function(){var a=this;a._renderLevel(),a._renderIndex()},_onIndexChange:function(){var a=this;a._renderIndex()},_onTypeChange:function(){this.render()}})}({}),yne_ytable_tools_core_console=function(){var a,b=window||global,c=function(){},d={DEBUG:!1,EXPORTS:b.JTK_EXPORTS||{},log:c,warn:c,error:c};return b.DEBUG!==!0?d:b.console&&b.console.log?(a=b.console,d.DEBUG=!0,a.log&&a.log.bind?(d.log=a.log.bind(a),d.warn=a.warn.bind(a),d.error=a.error.bind(a),d):(d.log=function(){var b,c=arguments.length;for(b=0;b<c;b++)a.log(arguments[b])},d.warn=function(){var b,c=arguments.length;for(b=0;b<c;b++)a.warn(arguments[b])},d.error=function(){var b,c=arguments.length;for(b=0;b<c;b++)a.error(arguments[b])},d)):d}(),yne_ytable_tools_core_underscore=function(a){var b=yne_ytable_tools_core_console,c=this._||this.underscore;return c?(b.EXPORTS.underscore===!1&&c.noConflict&&(c=c.noConflict()),c):void b.error("no underscore library","core/underscore.js")}({}),yne_ytable_tools_web_dom_isTag=function(a,b){return b=String(b).toLowerCase(),!!(a&&a.nodeName&&b)&&String(a.nodeName).toLowerCase()===b},yne_ytable_tools_core_str_trim=function(a){return null==a||""===a?"":String(a).replace(/^[\s\t\xA0\u3000]+/,"").replace(/[\s\t\xA0\u3000]+$/,"")},yne_ytable_tools_core_reg_encode=function(a){return String(a).replace(/([.*?\^$=!:{}()|\[\]\/\\+])/g,"\\$1")},yne_ytable_tools_web_dom_className=function(a){var b=yne_ytable_tools_core_underscore,c=yne_ytable_tools_core_str_trim,d=yne_ytable_tools_core_reg_encode;return{has:function(a,b){return!!(a&&b&&a.className)&&(a.classList&&a.classList.contains?a.classList.contains(b):new RegExp("(^|\\s+)"+d(b)+"(\\s+|$)","").test(a.className))},add:function(a,d){var e,f=this;return a&&d&&b.isString(d)&&!f.has(a,d)?a.classList?(a.classList.add(d),f):(e=c(a.className),a.className=e?e+" "+d:d,f):f},remove:function(a,e){var f=this;return a&&e&&b.isString(e)?a.classList?(a.classList.remove(e),f):(e=String(a.className).replace(new RegExp("(^|\\s+)"+d(e)+"(\\s+|$)","g")," "),a.className=c(e),f):f},toggle:function(a,b){var c=this;return a.classList?(a.classList.toggle(b),c):c.has(b)?c.remove(a,b):c.add(a,b)}}}({}),yne_ytable_tools_web_bom_userAgent=function(a){var b=yne_ytable_tools_core_underscore,c=window.navigator.userAgent.toLowerCase(),d=function(a){var b=0;return parseFloat(a.replace(/\./g,function(){return b+=1,1===b?".":""}))},e={WEBKIT:function(){var a=c.match(/applewebkit\/([^\s]*)/);if(a&&a[1])return d(a[1])},PRESTO:function(){var a=c.match(/presto\/([\d.]*)/);if(a&&a[1])return d(a[1])},TRIDENT:function(){var a=c.match(/msie\s([^;]*)/);if(a)return a=c.match(/trident\/([\d.]*)/),a&&a[1]?d(a[1]):1},GECKO:function(){if(/gecko/.test(c)){var a=c.match(/rv:([\d.]*)/);return a&&a[1]?d(a[1]):1}}},f={RETINA:window.devicePixelRatio>=2,MOBILE:/mobile/.test(c),IPOD:/ipod/.test(c),IPAD:/ipad/.test(c),IPHONE:/iphone/.test(c),IPHONE_5:!1,IOS:!1,IOS_5:!1,IOS_6:!1,WIN:/windows|win32/.test(c),MAC:/macintosh/.test(c),IE:/msie/.test(c),IE6:/msie 6/.test(c),IE7:/msie 7/.test(c),IE8:/msie 8/.test(c),IE9:/msie 9/.test(c),IE10:/msie 10/.test(c),OPERA:/opera/.test(c),MOZ:/gecko/.test(c)&&!/(compatible|webkit)/.test(c),SAFARI:!/chrome\/([\d.]*)/.test(c)&&/\/([\d.]*) safari/.test(c),CHROME:/chrome\/([\d.]*)/.test(c),WEBKIT:!1,PRESTO:!1,TRIDENT:!1,GECKO:!1};return(f.IPHONE||f.IPOD)&&(f.IPHONE_5=window.screen.height>481),(f.IPAD||f.IPHONE||f.IPOD)&&(f.IOS=!0,f.IOS_5=/ os 5/.test(c),f.IOS_6=/ os 6/.test(c)),b.some(e,function(a,b){var c;try{if(c=a())return f[b]=c,!0}catch(a){return!1}}),f}({}),yne_ytable_tools_web_dom_attr=function(a){var b=yne_ytable_tools_web_bom_userAgent,c=yne_ytable_tools_core_underscore,d=b.IE,e=function(){if(null==e._isNeed){var a=document.createElement("div");a.setAttribute("class","hello"),e._isNeed=a.className.indexOf("hello")===-1}return e._isNeed},f={acceptcharset:"acceptCharset",accesskey:"accessKey",allowtransparency:"allowTransparency",bgcolor:"bgColor",cellpadding:"cellPadding",cellspacing:"cellSpacing",class:"className",colspan:"colSpan",checked:"defaultChecked",selected:"defaultSelected",for:"htmlFor",frameborder:"frameBorder",hspace:"hSpace",longdesc:"longDesc",maxlength:"maxLength",marginwidth:"marginWidth",marginheight:"marginHeight",noresize:"noResize",noshade:"noShade",readonly:"readOnly",rowspan:"rowSpan",tabindex:"tabIndex",valign:"vAlign",vspace:"vSpace"},g=e()?function(a){return f[a]||a}:function(a){return a};return{has:function(a,b,c){var d=this;return!(!a||null==b)&&(b=g(b),null==c?a.hasAttribute&&a.hasAttribute(b)||null!=a[b]:d.get(a,b)===c)},get:function(a,b){if(a&&null!=b)return d&&"style"===b?a.style.cssText:(b=g(b),a.getAttribute?a.getAttribute(b):void 0)},set:function(a,b,e){var f=this;return a&&null!=b?null==e&&c.isObject(b)?(c.each(b,function(b,c){f.set(a,c,b)}),f):d&&"style"===b?(a.style.cssText=e,f):(b=g(b),a.setAttribute&&a.setAttribute(b,e),f):f},remove:function(a,b){var c=this;return a&&null!=b?d&&"style"===b?(a.style.cssText="",c):(b=g(b),a.removeAttribute&&a.removeAttribute(b),c):c}}}({}),yne_ytable_tools_web_console=function(a){var b=yne_ytable_tools_core_console,c=window.console,d=/msie/i.test(window.navigator.userAgent);return b.DEBUG&&c&&c.log&&(!d&&c.log.apply||(b.log=function(){var a,b,d=arguments.length,e=[],f=window.JSON;for(a=0;a<d;a++){if(b=arguments[a],f)try{b=f.stringify(b)}catch(a){}e.push(String(b))}c.log(e.join(";"))})),b}({}),yne_ytable_tools_web_dom_Selector=function(a){function b(a){var d=this;d._options=c.extend({id:null,tag:null,className:null,attr:null,attrVal:null},c.isString(a)?b.parse(a):a),d._formatedSelector=b.stringify(d._options),d.isOptionsValid=!!d._formatedSelector,d.isOptionsValid||h.error("The options for Selector() is not valid","web/dom/Selector")}var c=yne_ytable_tools_core_underscore,d=yne_ytable_tools_web_dom_isTag,e=yne_ytable_tools_web_dom_className,f=yne_ytable_tools_web_dom_attr,g=yne_ytable_tools_core_str_trim,h=yne_ytable_tools_web_console;return b.prototype.test=function(a){var b=this,c=b._options;return!!(a&&a.nodeType&&b.isOptionsValid)&&((!c.id||a.getAttribute("id")===c.id)&&(!c.tag||d(a,c.tag))&&(!c.className||e.has(a,c.className))&&(!c.attr||f.has(a,c.attr,c.attrVal)))},b.prototype.toString=function(){var a=this;if(a.isOptionsValid)return a._formatedSelector},b.parse=function(a){if(a=g(a)){var b={selector:a},d={tag:/^([a-zA-Z]+)/,id:/#([a-zA-Z_\-\d]+)/,className:/\.([a-zA-Z_\-\d]+)/,attr:/\[([a-zA-Z_\-\d]+)(?:=([^\]]+))?\]/};return c.each(["tag","attr","id","className"],function(a){var c=d[a],e=c.exec(b.selector);e&&e[1]&&(b[a]=e[1],b.selector=g(b.selector.replace(e[0],"")),"attr"===a&&(b.attrVal=e[2]||null),b.attrVal&&(b.attrVal=b.attrVal.replace(/^['"]/,"").replace(/['"]$/,"")))}),""!==b.selector?void h.error("selector can not to be parsed","web/dom/Selector"):b.id||b.tag||b.className||b.attr?(delete b.selector,b):void 0}},b.stringify=function(a){if(c.isString(a)||!a)return a||"";var b=a.tag||"",d={id:"#",className:"."};return c.each(["id","className"],function(c){a[c]&&(b+=d[c]+a[c])}),a.attr?b+"["+a.attr+(a.attrVal?'="'+a.attrVal+'"':"")+"]":b},b}({}),yne_ytable_tools_web_dom_nodeType=function(a){var b=yne_ytable_tools_core_underscore;return{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12,getType:function(a){if(a&&a.nodeType)return a.nodeType},isNode:function(a){var c=this,d=c.getType(a);return b.isNumber(d)&&d>=c.ELEMENT_NODE&&d<=c.NOTATION_NODE},isElement:function(a){return this.getType(a)===this.ELEMENT_NODE},isAttribute:function(a){return this.getType(a)===this.ATTRIBUTE_NODE},isText:function(a){return this.getType(a)===this.TEXT_NODE},isCDataSection:function(a){return this.getType(a)===this.CDATA_SECTION_NODE},isEntityReference:function(a){return this.getType(a)===this.ENTITY_REFERENCE_NODE},isEntity:function(a){return this.getType(a)===this.ENTITY_NODE},isProcessingInstruction:function(a){return this.getType(a)===this.PROCESSING_INSTRUCTION_NODE},isComment:function(a){return this.getType(a)===this.COMMENT_NODE},isDocument:function(a){return this.getType(a)===this.DOCUMENT_NODE},isDocumentType:function(a){return this.getType(a)===this.DOCUMENT_TYPE_NODE},isDocumentFragment:function(a){return this.getType(a)===this.DOCUMENT_TYPE_NODE},isNotation:function(a){return this.getType(a)===this.NOTATION_NODE}}}({}),yne_ytable_tools_web_dom_findParent=function(a){var b=yne_ytable_tools_core_underscore,c=yne_ytable_tools_web_dom_Selector,d=yne_ytable_tools_web_dom_nodeType;return function(a,e){var f;for(b.isString(e)&&(f=new c(e),e=function(a){return f.test(a)});a&&(a.nodeType===d.ELEMENT_NODE||a.nodeType===d.TEXT_NODE);){if(e(a)===!0)return a;a=a.parentNode}}}({}),yne_ytable_tools_jq_jquery=function(a){var b=yne_ytable_tools_core_console,c=window.jQuery||window.$;return c?(b.EXPORTS.jquery===!1&&c.noConflict&&(c=c.noConflict(!0)),c):void b.error("no jQuery library","jq/jquery.js")}({}),yne_ytable_client_shared_const={OP:{CODE:"code",CLIENT_ID:"clientId",CLIENT_VERSION:"clientVersion",OTHER_VERSION:"otherVersion",SERVER_VERSION:"serverVersion"},SINGLE_CELL:{X:"x",Y:"y"},MULTIPLE_CELLS:{X1:"x1",Y1:"y1",X2:"x2",Y2:"y2"},CELL_OP:{PROP_KEY:"key",PROP_VALUE:"value"},LINE_OP:{INDEX:"index",COUNT:"count"},SET_ROWS_HEIGHT_OP:{HEIGHT:"height"},SET_COLUMNS_WIDTH_OP:{WIDTH:"width"},COMPOSITE_OP:{OPLIST:"opList"},OPS:{REQID:"reqId",CLIENT_ID:"clientId",CLIENT_VERSION:"clientVersion",OTHER_VERSION:"otherVersion",SERVER_VERSION:"serverVersion",OP_LIST:"opList"},REQUEST:{ID:"id",TYPE:"type"},COLLABORATE_REQUEST:{OPS:"ops"},SAVE_REQUEST:{FILEID:"saveId"},CLIENT_ID_TO_USER_REQUEST:{CLIENT_ID:"clientId"},FOCUS_CELL_REQUEST:{X:"x",Y:"y"},RESPONSE:{ID:"id",TYPE:"type",CLIENT_VERSION:"clientVersion",OTHER_VERSION:"otherVersion",SERVER_VERSION:"serverVersion"},GET_ID_RESPONSE:{CLIENT_ID:"clientId"},SYNC_RESPONSE:{CLIENT_ID:"clientId",FILE_ID:"fileId",CONTENT:"content",CONNECTED_CLIENTS:"clients"},COLLABORATE_RESPONSE:{OP_LIST:"opList"},CLIENT_ID_TO_USER_RESPONSE:{CLIENT_ID:"clientId",USER_ID:"userId",NAME:"name",PHOTO:"photo",DESCRIPTION:"description",LOCATION:"location",PHONE:"phone",EMAIL:"email",SEX:"sex"},NEW_TABLE_RESPONSE:{FILE_ID:"fileId"},SAVE_RESPONSE:{RESULT:"result",USER_ID:"saveUserId",CLIENT_ID:"saveClientId",FILE_ID:"saveId"},SAVE_RESPONSE_SUCCESS:0,SAVE_RESPONSE_FAILED:1,TABLE:{ROW_HEIGHTS:"heights",COLUMN_WIDTHS:"widths",CELLS:"cells",CLIENT_VERSION_MAP:"clientVersionMap",OTHER_VERSION_MAP:"otherVersionMap",SERVER_VERSION_MAP:"serverVersionMap",LAST_REQ_ID_MAP:"lastReqIdMap",CLIENT_INFO_MAP:"clientInfoMap",CURRENT_VERSION:"currentVersion",LAST_MODIFIED_USER_ID:"lastModifiedUserId",LAST_MODIFIED_TIME:"lastModifiedTime",NEXT_CLIENT_ID:"nextClientId"},TABLE_CELL:{VALUE:"value",MERGE_WIDTH:"mergeWidth",MERGE_HEIGHT:"mergeHeight",MERGE_POINT_DIST_X:"mergePointDX",MERGE_POINT_DIST_Y:"mergePointDY"},CLIENT_INFO:{CLIENT_ID:"clientId",USER_ID:"userId",LAST_UPDATE_TIME:"lastUpdate"},CLIENT_CONNECT_RESPONSE:{CLIENT_ID:"clientId"},CLIENT_DISCONNECT_RESPONSE:{CLIENT_ID:"clientId"},FOCUS_CELL_RESPONSE:{X:"x",Y:"y",CLIENT_ID:"clientId"},DEFAULT_ROW_HEIGHT:23,DEFAULT_COLUMN_WIDTH:70,CLIENT_CONNECT_REQUEST_ID:-1,CLIENT_DISCONNECT_REQUEST_ID:-2,FOCUS_CELL_REQUEST_ID:-3,OTHER_CLIENT_CHANGED_REQUEST_ID:-4,ERROR_MESSAGE_SOCKET_REQUEST_ID:-5,OTHER_CLIENT_SAVE_REQUEST_ID:-6,ACCESS:{GROUP_ID:"groupId",CLIENT_ID:"clientId",USER_ID:"userId",FILE_ID:"fileId",TOKEN:"token"},ERROR:{CODE:"errCode",MESSAGE:"errMsg"},WEB_SOCKET_MAX_TEXT_MESSAGE_SIZE:262144,WEB_SOCKET_MAX_BINARY_MESSAGE_SIZE:524288,DEFAULT_TABLE_COLUMN_NUM:20,DEFAULT_TABLE_ROW_NUM:40,COLLABORATE_USER_LIMIT:20,HISTORY:{TABLE_KEY:"histTbKey",TABLE_VER_NO:"histTbVerNO",TABLE_CONTENT:"histTbContent",TABLE_REVISORS:"histTbRevisors",TABLE_OPS:"histTbOpsInfo",TABLE_OPS_USR:"histTbOpsInfoUsr",TABLE_OPS_OPS:"histTbOpsInfoOps",TABLE_OPS_TIME:"histTbOpsInfoTime",TABLE_LAST_VERSION:"histTbLastVersion",TABLE_START_OPS_TIME:"histTbStartOpsTime",TABLE_LAST_OPS_TIME:"histTbLastOpsTime",TABLE_OLD_TITLE:"histTbOldTitle",TABLE_NEW_TITLE:"histTbNewTitle",TABLE_TITLE_MODIFIER:"histTbTitleModifier"}},yne_ytable_editor_config_defaults=function(a){var b,c=yne_ytable_client_shared_const;return b={fontSize:12,fontName:"Microsoft YaHei",rowHeight:c.DEFAULT_ROW_HEIGHT,columnWidth:c.DEFAULT_COLUMN_WIDTH,rowPageLength:30}}({}),yne_ytable_tools_web_dom_insert=function(a){return{before:function(b){var c;b&&b.parentNode&&(c=b.parentNode,c.insertBefore&&c.insertBefore(a,b))},after:function(b){var c;b&&b.parentNode&&(c=b.parentNode,b.nextSibling&&c.insertBefore?c.insertBefore(a,b.nextSibling):c.appendChild&&c.appendChild(a))}}},yne_ytable_tools_web_dom_remove=function(a){var b=yne_ytable_tools_web_dom_nodeType,c=yne_ytable_tools_web_dom_insert;return function(a,d){if(b.isNode(a)){if(d=d!==!1,a.removeNode&&d)return a.removeNode(a,d);if(a.parentNode&&a.parentNode.removeChild){if(!d)for(;a.firstChild;)c(a.firstChild).before(a);return a.parentNode.removeChild(a)}}}}({}),yne_ytable_editor_utils_TableUtils=function(a){var b=yne_ytable_tools_web_dom_findParent,c=yne_ytable_tools_core_underscore,d=yne_ytable_tools_jq_jquery,e=yne_ytable_editor_config_defaults.rowPageLength,f=yne_ytable_tools_web_dom_remove;return{WIDTH_DIFF:3,HEIGHT_DIFF:3,findParent:b,getPageInfo:function(a){var b=Math.floor(a/e);return{page:b,pageRow:a-b*e}},chunkRange:function(a,b,e,f){if(f=f||1,!c.isFunction(f)){var g=f;f=function(){return g}}var h=d.Deferred();if(!e||a>=b)return h.resolve().promise();var i=a,j=!0,k=function(){j=e(i++)!==!1,j&&i<b?window.setTimeout(k,f()):h.resolve()};return window.setTimeout(k,f()),h.promise()},forRange:function(a,b,c){var e=d.Deferred();if(!c||a>=b)return e.resolve().promise();var f;for(f=a;f<b&&c(f)!==!1;++f);return e.resolve().promise()},isRowHeader:function(a){return!!b(a,"td")&&!!b(a,".row-header")},isColHeader:function(a){return!!b(a,"th")&&!!b(a,".column-header")},isRowResizer:function(a){return a.classList.contains("row-resizer")},isColResizer:function(a){return a.classList.contains("col-resizer")},isTableCell:function(a){return"TD"===a.tagName&&!!b(a,".table-wrapper")},setElementStyles:function(a,b,d,e){var g,h,i;"true"===b.bold?a.style.fontWeight="bold":a.style.fontWeight="","true"===b.italic?a.style.fontStyle="italic":a.style.fontStyle="",h="true"===b.underline,i="true"===b.lineThrough,h&&i?a.style.textDecoration="underline line-through":h?a.style.textDecoration="underline":i?a.style.textDecoration="line-through":a.style.textDecoration="",g=b.fontName,c.isString(g)&&"default"!==g?a.style.fontFamily=g:a.style.fontFamily="",g=parseInt(b.fontSize),isNaN(g)?a.style.fontSize="":a.style.fontSize=b.fontSize,g=b.textAlign,"center"===g||"right"===g||"left"===g?a.style.textAlign=g:a.style.textAlign="",g=b.verticalAlign,"top"===g||"middle"===g||"bottom"===g?a.style.verticalAlign=g:a.style.verticalAlign="","true"===b.wrap?a.style.whiteSpace="normal":a.style.whiteSpace="",g=b.textColor,g?a.style.color=g:a.style.color="",g=b.backColor,g&&"inherit"!==g&&"transparent"!==g?a.style.backgroundColor=g:a.style.backgroundColor="",!d||e&&e!==b["diff|user"]||(g=b.diff,"mod"===g?(a.style.backgroundColor="rgb(225, 246, 209)",a.style.color="black"):"delete"===g&&(a.style.backgroundColor="rgb(245, 219, 216)",a.style.color="black",a.style.textDecoration.indexOf("underline")!==-1?a.style.textDecoration="underline line-through":a.style.textDecoration="line-through")),b.link?this.setElementText(a,a.innerText,b,e):(g=a.querySelector("a"),g&&(g.firstChild&&a.appendChild(g.firstChild),f(g)))},setElementText:function(a,b,c,d){if("delete"===c.diff&&d&&d!==c["diff|user"])return void(a.innerText="");if(a.innerHTML="",c.link){var e=document.createElement("a");e.setAttribute("target","_blank"),e.setAttribute("href",c.link),c.textColor&&(e.style.color="inherit"),a.appendChild(e),a=e}a.innerText=b},getCellElFromTableEl:function(a,b,c){var d=a.rows[b];return d?d.cells[c]:null},setBorder:function(a,b,c,d){var e,f,g=a.editor.getTable(),h=d["border|vertical"],i=d["border|horizontal"];g.isMergedCell(b,c)||(h||(f=d.backColor,h=f&&"inherit"!==f&&"transparent"!==f?"1px solid "+f:""),i||(f=d.backColor,i=f&&"inherit"!==f&&"transparent"!==f?"1px solid "+f:""),0===b||g.isMergePoint(b,c)||g.isMergedCell(b-1,c)||g.isMergePoint(b-1,c)?(e=a.getCellElementAt(b,c),e&&(e.style.borderTop=i)):(e=a.getCellElementAt(b-1,c),e&&(e.style.borderBottom=i)),0===c||g.isMergePoint(b,c)||g.isMergedCell(b,c-1)||g.isMergePoint(b,c-1)?(e=a.getCellElementAt(b,c),e&&(e.style.borderLeft=h)):(e=a.getCellElementAt(b,c-1),e&&(e.style.borderRight=h)))},getStylesFromElement:function(a){var b,c={},d=a.style;return d.fontWeight.indexOf("bold")!==-1&&(c.bold="true"),d.fontStyle.indexOf("italic")!==-1&&(c.italic="true"),b=d.textDecoration,b.indexOf("underline")!==-1&&(c.underline="true"),b.indexOf("line-through")!==-1&&(c.lineThrough="true"),b=d.fontFamily,b&&(c.fontName=b),b=parseInt(d.fontSize),isNaN(b)||(c.fontSize=d.fontSize),b=d.textAlign,"center"!==b&&"right"!==b||(c.textAlign=b),b=d.verticalAlign,"top"!==b&&"middle"!==b||(c.verticalAlign=b),b=d.whiteSpace,"normal"===b&&(c.wrap="true"),b=d.color,b&&(c.textColor=b),b=d.backgroundColor,b&&"inherit"!==b&&("transparent"===b&&(b="white"),c.backColor=b),b=a.querySelector("a"),b&&b.href&&(c.link=b.href),c},getRowName:function(a){return String(a+1)},getColumnName:function(a){for(var b="";a>=0;a=a/26-1)b=String.fromCharCode(a%26+"A".charCodeAt(0))+b;return b},measureText:function(a,b){var d=window.document,e=b.fontSize,f=b.fontName,g=b.isBold?"bold ":"",h=b.isItalic?"italic ":"",i=d.createElement("canvas"),j=i.getContext("2d");return c.isNumber(e)&&(e+="px"),j.font=g+h+e+" "+f,j.measureText(a)}}}({}),yne_osTableView=function(a){var b=yne_common_views_BlockView,c=yne_jquery,d=yne_underscore,e=yne_ytable_editor_utils_TableUtils;return b.extend({className:"block-view table-view",_$activeCellSelection:null,initialize:function(){b.prototype.initialize.apply(this,arguments);var a=this,c=a.block;a.bindSelectionEvents(),d.bindAll(a,"_onSetCellValue","_onCellHighlight"),c.on("set-cell-value",a._onSetCellValue),c.on("cell-highlight",a._onCellHighlight)},_setActiveStyle:function(a){var b=this;a?b._$activeCellSelection.css({display:"block",border:"2px solid #7ba3dc",left:a.offsetLeft-1,top:a.offsetTop-2,width:a.offsetWidth,height:a.offsetHeight}):b._$activeCellSelection.css({display:"none"})},_onSetCellValue:function(a){var b=this,c=a.uid,d=b.$el.find("td[data-cell-id="+c+"]").get(0),f=b.block.getCellByUID(c);e.setElementText(d,a.value,f)},_onCellHighlight:function(a){var b=this.$el;d.each(a,function(a){b.find("td[data-cell-id="+a.uid+"]").html(a.html).css("background-color",a.backColor)})},render:function(){var a,b,d=this,e=d.block;c('<div class="ytable-app-root" />').appendTo(d.$el),a=d.$el.find(".ytable-app-root").get(0),c(a).html(e.toHtml()),b=c(a).find("div").get(0),c('<div class="selection-active-cell" />').appendTo(b),d._$activeCellSelection=c(a).find(".selection-active-cell")},parseNativeRange:function(){},convertToNativeRange:function(){return null},onDrawRange:function(a){var b,c,d=this,e=d.$el;a?a.uid&&!a.isAll?(b=a.uid,c=e.find("td[data-cell-id="+b+"]")[0],d._setActiveStyle(c)):a.isAll&&this.$el.addClass("selected"):(this.$el.removeClass("selected"),
d._setActiveStyle())},getActiveCellSelection:function(){return this._$activeCellSelection}})}({}),yne_common_views_HrView=function(a){var b=yne_common_views_BlockView,c=yne_common_selection_HrRange;return b.extend({className:"block-view hr-view",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments)},render:function(){var a=this,b=a.block,c=b.getBlockStyle("width"),d=b.getBlockStyle("height");a.$el.html('<div class="hr-container"></div>').css({"text-align":b.getBlockStyle("align")}).find(".hr-container").css({width:c+"%",height:d,backgroundColor:b.getBlockStyle("color")})},convertToNativeRange:function(){var a=this,b=document.createRange(),c=a.$el.get(0);return b.setStart(c,0),b.setEnd(c,c.childNodes.length),b},parseNativeRange:function(a,b,d){var e=this;if(d||e._isHrInNativeRange(a))return new c({block:b})},_isHrInNativeRange:function(a){var b,c=this,d=c.$el.find(".hr-container").get(0);return b=d.ownerDocument.createRange(),b.selectNode(d),a.compareBoundaryPoints(Range.START_TO_START,b)<1&&a.compareBoundaryPoints(Range.END_TO_END,b)>-1}})}({}),yne_common_views_UnknownView=function(a){var b=yne_common_views_BlockView,c=yne_common_selection_UnknownRange;return b.extend({className:"block-view unknown-view",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments)},render:function(){this.$el.html("<div>当前版本不支持的内容</div>")},convertToNativeRange:function(){},parseNativeRange:function(a,b,d){if(d)return new c({block:b})}})}({}),yne_common_views_BlockViewMapper=function(a){var b=yne_common_data_blockTypes,c=yne_common_views_BlockView,d={};return d[b.PARAGRAPH]=yne_common_views_ParagraphView,d[b.IMAGE]=yne_osImageView,d[b.ATTACHMENT]=yne_osAttachmentView,d[b.LIST_ITEM]=yne_common_views_ListItemView,d[b.TABLE]=yne_osTableView,d[b.HR]=yne_common_views_HrView,d[b.UNKNOWN]=yne_common_views_UnknownView,function(a){var b=d[a];return b?b:c}}({}),yne_common_selection_nativeSelection=function(a){var b=yne_jtk_core_L;return{getSelection:function(a){return a=a||window,a.getSelection()},setRange:function(a,c){var d=this,e=d.getSelection(c);e&&a?(e.removeAllRanges(),e.addRange(a)):b.warn("The selection or range is null!")},getRange:function(a){var c,d=this,e=d.getSelection(a);return e?e.rangeCount>0?c=e.getRangeAt(0):b.warn("The selection has no range!"):b.warn("The selection is null!"),c},removeAllRanges:function(a){var b=this,c=b.getSelection(a);c&&c.removeAllRanges()},isRangeInNode:function(a){if(!a)return b.warn("The param node is unvalid!"),!1;var c,d=this,e=a.ownerDocument||document,f=e.defaultView,g=d.getRange(f);if(!g)return b.warn("The native range is null!"),!1;for(c=g.commonAncestorContainer;c;){if(c===a)return!0;c=c.parentNode}return!1}}}({}),yne_mobile_views_NoteView=function(a){var b,c=yne_underscore,d=yne_jquery,e=yne_backbone,f=yne_common_key_KeyMonitor,g=yne_common_selection_ImageRange,h=yne_common_selection_AttachmentRange,i=yne_osTableRange,j=yne_common_selection_HrRange,k=yne_common_selection_NoteRange,l=yne_common_selection_UnknownRange,m=yne_common_data_blockTypes,n=yne_common_data_Paragraph,o=yne_common_views_BlockViewMapper,p=yne_jtk_core_assert,q=yne_common_selection_nativeSelection,r=yne_jtk_core_L;return b=e.View.extend({className:"note-view",attributes:{spellcheck:!1,contenteditable:"true"},events:{keydown:"_onKeyDown",keyup:"_onKeyUp",input:"_onInput",textInput:"_onTextInput",compositionstart:"_onCompositionStart",compositionend:"_onCompositionEnd",mousedown:"_onMouseDown",selectstart:"_onSelectStart",contextmenu:"_onContextMenu",copy:"_onCopy",cut:"_onCut",paste:"_onPaste","click a[href]":"_onAnchorClick",touchstart:"_onTouchStart",blur:"_onBlur"},note:null,blockViews:null,_isOnComposition:!1,_isSilent:!1,_noteEvents:{"insert-block":"_onInsertBlock","remove-block":"_onRemoveBlock","replace-block":"_onReplaceBlock","read-only-change":"_onReadOnlyChange"},_docEvents:{selectionchange:"_onSelectionChange"},initialize:function(a){var b=this;b._bindEventHandlers(),b.setOptions(a),b._bindEventsForDoc(),b._bindEventsForThis(),b.bindKeys()},_bindEventHandlers:function(){var a=this,b=function(b){r.log("bindHandlers: "+b),c.bindAll(a,b)};c.each(a._noteEvents,b),c.each(a._docEvents,b)},_setNote:function(a){var b=this;b._removeNote(),b.note=a,b._bindEventsForNote()},_removeNote:function(){var a=this;a.note&&a._unbindEventsForNote(),a.note=null},reset:function(){var a=this;a._removeNote(),a.$el.html(""),a.options&&a.options.note&&(a.options.note=null),a._keyMonitor&&a._keyMonitor.clearCache(),a._isSilent=!1},setOptions:function(a){var b=this;b.reset(),b._setNote(a.note),b.options=a},render:function(){var a=this,b=a.$el,d=a.note,e=a.blockViews=[];r.log(d.blocks),b.html(""),c.each(d.blocks,function(c){var d=a._createBlockView(c);d||r.warn("Failed to create block view!"),e.push(d),b.append(d.$el),a._bindEventsForBlockView(c,d,!0),d.render()})},_unbindEventsForBlockView:function(a,b){b.off("command"),m.isImage(a)&&(b.off("yne-replace-image"),b.off("click-image")),m.isAttachment(a)&&b.off("yne-replace-attachment").off("yne-download-attachment").off("click-attachment"),m.isListItem(a)&&b.off("get-editing-styles")},_bindEventsForBlockView:function(a,b,c){var d=this;c=c!==!1,c&&d._unbindEventsForBlockView(a,b),b.on("command",d.onCommand.bind(d)),m.isImage(a)&&(b.on("yne-replace-image",d.trigger.bind(d,"yne-replace-image")),b.on("click-image",d.trigger.bind(d,"click-image"))),m.isAttachment(a)&&b.on("yne-replace-attachment",d.trigger.bind(d,"yne-replace-attachment")).on("yne-download-attachment",d.trigger.bind(d,"yne-download-attachment")).on("click-attachment",d.trigger.bind(d,"click-attachment")),m.isListItem(a)&&b.on("get-editing-styles",d.trigger.bind(d,"get-editing-styles"))},setHtmlContentEditable:function(a){var b=this;b.$el.attr("contenteditable",!!a)},isHtmlContentEditable:function(){var a=this,b=a.$el.attr("contenteditable");return["true","contenteditable",!0].indexOf(b)>-1},updateFormatPainterCursorUI:function(a){a?this.$el.addClass("format-painter-active"):this.$el.removeClass("format-painter-active")},_handleNoteEvents:function(a){var b=this,d=b.note;return d&&d.on&&d.off?void c.each(b._noteEvents,function(c,e){a?d.on(e,b[c]):d.off(e,b[c])}):void r.warn("Failed to bind note events!")},_bindEventsForNote:function(){var a=this;a._handleNoteEvents(!0)},_unbindEventsForNote:function(){var a=this;a._handleNoteEvents(!1)},_bindEventsForDoc:function(){var a=this,b=d(document);c.each(a._docEvents,function(c,d){r.log("bind document event: "+d+" -> "+c),r.log(a[c]),b.on(d,a[c])})},_bindEventsForThis:function(){var a=this;a.on("draw-range",a._onDrawRange.bind(a)),a.on("resize",a._onResize.bind(a))},bindKeys:function(){var a=this,b=new f({el:a.el}),d=["backspace","del","enter","tab","space","mod+z","mod+y","mod+shift+z","mod+shift+r","mod+b","mod+i","mod+u","left","up","right","down","esc","mod+s"];c.each(d,function(c){b.bind(c,function(b){a.trigger("key-pressed",c,b)})}),a._keyMonitor=b},_onDrawRange:function(a){var b=this;b._silentDo(function(){b._drawRange(a)})},_isValidRange:function(a){var b=document.body;return a&&d.contains(b,a.startContainer)&&d.contains(b,a.endContainer)},_reRender:function(){var a=this,b=a.el;r.log("NoteView _reRender()"),c.each(a.blockViews,function(a){try{b.removeChild(a.el)}catch(a){}}),c.each(a.blockViews,function(a){a.render(),b.appendChild(a.el)})},_drawRange:function(a){if(!a||!a.canDrawedByNative)return void r.log("note range is not valid!");r.log("on draw range",a);var b,c,e,f,g,h,i=this;if(i._clearCustomSelectionUI(),a.canDrawedByNative())i.setHtmlContentEditable(!0),b=a.toNativeRange(i),i._isValidRange(b)||(i._reRender(),b=a.toNativeRange(i)),q.setRange(b,window),i._scrollNativeSelectionIntoWrapper(b);else{if(i.setHtmlContentEditable(!1),q.removeAllRanges(),a.isInMultiBlock())return void r.warn("The note range is note valid!");c=a.getStartBlockRange(),e=i.note.getBlockIndex(c.block),f=i.getBlockViewAt(e),f.trigger("draw-range",c),h="table"===f.block.getType()?d(f.el).find(".selection-active-cell")[0]:f.el,g=h.getBoundingClientRect(),i._scrollRectIntoWrapper(g)}},_printRect:function(a){if(!a)return void r.log("rect is null");var b=["top","left","right","bottom","width","height"],d=c.map(b,function(b){return b+":"+a[b]});d="rect is > "+d.join(", "),r.log(d)},_computeRangeRect:function(a){if(!a)return void r.warn("range not found");var b,c,d;return a.collapsed?(c=a.getClientRects(),c&&c[0]&&(d=c[0],r.log("compute rect use range.getClientRects()"))):(d=a.getBoundingClientRect(),r.log("compute rect use range.getBoundingClientRect()")),d||(b=a.commonAncestorContainer,1!==b.nodeType&&(b=b.parentNode),b.getClientRects?(c=b.getClientRects(),c&&c[0]&&(d=c[0],r.log("compute rect use commonEl.getClientRects()"))):b.getBoundingClientRect&&(d=b.getBoundingClientRect(),r.log("compute rect use commonEl.getBoundingClientRect()"))),d},_scrollNativeSelectionIntoWrapper:function(a){var b=this,c=b._computeRangeRect(a);c&&b._scrollRectIntoWrapper(c)},_scrollRectIntoWrapper:function(a){if(a){var b=this,c=b.el.parentNode,d=c.getBoundingClientRect(),e=d.top,f=d.bottom,g=d.height;return a.height>g?void((a.bottom<0||a.top>g)&&b._scrollWrapperBy(0,a.bottom-g)):a.top<e?void b._scrollWrapperBy(0,a.top-e):a.bottom>f?void b._scrollWrapperBy(0,a.bottom-f):void 0}},_scrollWrapperBy:function(a,b){var c=this.el.parentNode;a>0?a+=20:a<0&&(a-=20),b>0?b+=20:b<0&&(b-=20),c.scrollLeft+=a,c.scrollTop+=b},parseNativeRange:function(a){if(!a||!a.startContainer)return void r.warn("no native range!");var b,c,d,e,f=this,g=a.startContainer,h=a.endContainer,i=f.getBlockViewContainer(g),j=f.getBlockViewContainer(h),k=f.getBlockViewIndex(i),l=f.getBlockViewIndex(j),m=[];if(k===-1||l===-1)return void r.error("start/end block index is -1 !");for(r.log("start/end block index "+k+"/"+l),b=k;b<=l;b++)d=f.blockViews[b],c=f.note.getBlockAt(b),r.log("blockView.parseNativeRange "+b),e=d.parseNativeRange(a,c,b!==k&&b!==l),e?m.push(e):r.warn("Failed to parse native range to block range!");return m},_onSelectionChange:function(a){var b,c=this,d=!q.isRangeInNode(c.el);return d||c._isSilent||c._isOnComposition?(b=d?"The native range is not in note view!":c._isSilent?"The _isSilent flag is true!":"The _isOnComposition flag is true!",r.log("XXXXXXXdocument selection change deprecated!XXXXXXXX"),void r.log(b)):(r.log("-------------document selection change--------"),void c.trigger("selectionchange",a))},_silentDo:function(a){var b=this;if(b._isSilent=!0,r.DEBUG)a();else try{a()}catch(a){r.warn("silent do error")}window.setTimeout(function(){b._isSilent=!1},0)},clearNativeSelectionUI:function(){var a=q.getSelection(window);a.removeAllRanges()},_clearCustomSelectionUI:function(){var a=this,b=a.blockViews;c.each(b,function(a){a.trigger("draw-range",null)})},_appendBlankLineIfNeed:function(){var a,b=this,c=b.note;c&&!c.lastBlockIsEasyInput()&&(a=new n,c.append(a))},focusLastBlankLine:function(){var a=this;a._appendBlankLineIfNeed(),window.setTimeout(function(){var b=a.getLastBlockView();d(b.el).trigger("mousedown")},50)},isReadOnly:function(){var a=this,b=a.note;return b&&b.isReadOnly()},_onMouseDown:function(a){var b,c,d,e,f=this,n=f.getBlock(a.target),o=a.target,p=o.getAttribute("data-cell-id");if(!f.isReadOnly()){if(!n)return r.warn("_onMouseDown(): block is null!"),void f.focusLastBlankLine();switch(b=m.getType(n)){case m.IMAGE:case m.ATTACHMENT:e=b===m.IMAGE?g:h,c=new e({block:n}),d=new k({startRange:c,endRange:c}),f.setHtmlContentEditable(!1),f.trigger("set-range",d,!0,!0);break;case m.PARAGRAPH:case m.LIST_ITEM:f.setHtmlContentEditable(!0),f._clearCustomSelectionUI();break;case m.TABLE:c=new i({block:n,uid:p}),d=new k({startRange:c,endRange:c}),f.setHtmlContentEditable(!1),f.trigger("set-range",d,!0,!0);break;case m.HR:c=new j({block:n}),d=new k({startRange:c,endRange:c}),f.setHtmlContentEditable(!1),f.trigger("set-range",d,!0,!0);break;case m.UNKNOWN:c=new l({block:n}),d=new k({startRange:c,endRange:c}),f.setHtmlContentEditable(!1),f.trigger("set-range",d,!0,!0);break;default:r.warn("_onMouseDown is not handled, block type is "+b)}}},_onAnchorClick:function(a){var b,c=a.currentTarget,d=this;a.preventDefault(),b=c&&c.getAttribute("href"),b&&d.trigger("open-link",b)},_onTouchStart:function(a){this.trigger("touchstart",a)},_onSelectStart:function(a){this.trigger("selectstart",a)},_onBlur:function(a){this.trigger("blur",a)},_onKeyDown:function(){r.error("_onKeyDown() should be implemented by sub-class")},_onKeyUp:function(){r.error("_onKeyUp() should be implemented by sub-class")},_onInput:function(){r.error("_onInput() should be implemented by sub-class")},_onTextInput:function(){r.error("_onTextInput() should be implemented by sub-class")},_onCompositionStart:function(){var a=this;return a.isReadOnly()?void event.preventDefault():(r.log("note view compositionstart ---------->>>>>>"),window.clearTimeout(a._compositionEndTimer),a._setCompositionState(!0),void a.trigger("delete-selection"))},_onCompositionEnd:function(a){var b=this,c=a.originalEvent||a;return b.isReadOnly()?void a.preventDefault():(r.log("note view compositionend ---------->>>>>>"),c.data||b.trigger("delete-selection"),void(b._compositionEndTimer=window.setTimeout(function(){b._setCompositionState(!1)},0)))},_setCompositionState:function(a){var b,c=this;a&&(b=q.getRange(),c.trigger("set-range",b,!1,!1)),c._isOnComposition=a},_onInsertBlock:function(a,b){var c=this,d=c._createBlockView(b);p(d),c._bindEventsForBlockView(b,d),c._insertBlockView(a,d)},_onRemoveBlock:function(a){var b=this;b._removeBlockView(a)},_onReplaceBlock:function(a,b){var c=this,d=c._createBlockView(b);p(d),c._replaceBlockView(a,d)},_createBlockView:function(a){var b=m.getType(a),c=o(b);return p(!!c),new c({block:a})},_insertBlockView:function(a,b){var c=this,d=c.blockViews,e=c.$el,f=e.children(),g=f.length;d.splice(a,0,b),a===g?e.append(b.$el):e.children().eq(a).before(b.$el),b.render()},_removeBlockView:function(a){var b=this,c=b.blockViews,d=b.$el;c.splice(a,1),d.children().eq(a).remove()},_replaceBlockView:function(a,b){var c=this,d=c.blockViews,e=c.$el;d.splice(a,1,b),e.children().eq(a).replaceWith(b.$el),b.render()},getBlockViewAt:function(a){var b=this;return b.blockViews[a]},getLastBlockView:function(){var a=this,b=a.blockViews;return b[b.length-1]},getBlockViewContainer:function(a){var b=".block-view",c=d(a).closest(b)[0];return c},getBlockViewIndex:function(a){if(!a)return-1;var b=this,c=">.block-view";return b.$el.find(c).index(a)},getBlock:function(a){var b=this,c=b.note,d=b.getBlockViewContainer(a),e=b.getBlockViewIndex(d);return c.getBlockAt(e)},getBlockViewByBlock:function(a){var b=this,c=b.note.getBlockIndex(a);return b.getBlockViewAt(c)},onCommand:function(a,b){var c,d,e,f=this;null==b.range&&(b.imageBlockView?(c=b.imageBlockView,b.imageBlockView=null,e=new g({block:c.block}),d=new k({blockRanges:[e]}),b.range=d):b.attachmentBlockView&&(c=b.attachmentBlockView,b.attachmentBlockView=null,e=new h({block:c.block}),d=new k({blockRanges:[e]}),b.range=d)),f.trigger("command",a,b)},_onCopy:function(a){var b=this;b.trigger("copy",a)},_onCut:function(a){var b=this;return b.isReadOnly()?void a.preventDefault():void b.trigger("cut",a)},_onPaste:function(a){var b=this;return b.isReadOnly()?void a.preventDefault():void b.trigger("paste",a)},_onContextMenu:function(a){var b=this;b.isReadOnly()||b.trigger("contextmenu",a)},onSelectAll:function(){var a=this,b=document.createRange();b.setStart(a.el.firstChild,0),b.setEnd(a.el.lastChild,1),q.setRange(b,window),a.parseNativeRange(b)},_onResize:function(a){var b=this;a?a.canDrawedByNative()?b._scrollNativeSelectionIntoWrapper(q.getRange()):b._scrollCustomIntoWrapper(a):b._scrollNativeSelectionIntoWrapper(q.getRange())},_scrollCustomIntoWrapper:function(a){var b,c,d=this,e=d.note,f=a.getStartBlockRange(),g=f.block,h=g.getType(),i=e.getBlockIndex(g),j=d.getBlockViewAt(i);b="table"===h?j.getActiveCellSelection()[0]:j.el,c=b.getBoundingClientRect(),d._scrollRectIntoWrapper(c)},_onReadOnlyChange:function(){var a=this,b=a.isReadOnly();a.setHtmlContentEditable(!b),b?a.$el.addClass("read-only"):a.$el.removeClass("read-only")},setViewportHeight:function(a){this._viewportHeight=a},setBackground:function(a){var b,c=window.devicePixelRatio,e=document.createElement("img");e.src=a,d("body").css("background-image","url("+a+")"),e.onload=function(){b=e.width/c,d("body").css("background-size",b+"px")}}})}({}),yne_mobile_util_keyboardMode={HIDE:1,SHOW:2},yne_osNoteView=function(a){var b=yne_mobile_views_NoteView,c=yne_common_data_blockTypes,d=yne_common_selection_ImageRange,e=yne_common_selection_AttachmentRange,f=yne_osTableRange,g=yne_common_selection_HrRange,h=yne_common_selection_UnknownRange,i=yne_common_selection_NoteRange,j=yne_jtk_core_L,k=yne_underscore,l=yne_common_constants,m=yne_common_selection_nativeSelection,n=yne_mobile_util_keyboardMode,o=500,p=50,q=50,r=50;return b.extend({_lastDelTime:null,_isKeyDownFired:!1,_isInputFired:!1,_isTextInputFired:!1,_isTextInputFiredOnlyTimes:0,_selectContentOnViewMode:null,events:{textInput:"_onTextInput",input:"_onInput",compositionstart:"_onCompositionStart",compositionupdate:"_onCompositionUpdate",compositionend:"_onCompositionEnd",selectstart:"_onSelectStart",contextmenu:"_onContextMenu",copy:"_onCopy",cut:"_onCut",paste:"_onPaste","click a[href]":"_onAnchorClick",touchstart:"_onTouchStart",touchend:"_onTouchEnd",keydown:"_onKeyDown",keypress:"_onKeyPress",keyup:"_onKeyUp"},initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),l.IS_IOS7&&this._addShimForIOS7()},_addShimForIOS7:function(){var a=document.createElement("div");a.style.height=r+"px",document.body.appendChild(a)},_onCompositionUpdate:k.debounce(function(){this._scrollNativeSelectionIntoWrapper(m.getRange())},150),_getKeyboardMode:function(){var a,b=this;return b.trigger("get-keyboard-mode",function(b){a=b}),a},_getTextEditMenuState:function(){var a,b=this;return b.trigger("get-text-edit-menu-state",function(b){a=b}),a},_onTouchStart:function(a){j.log("touch start",a);var b=this,c=a.originalEvent||a,d=c.touches[0],e=b._getTextEditMenuState();return e?(a.preventDefault(),void b.trigger("notify-native-touchstart",a)):(b._touchStartTime=Date.now(),b._touchStartPosition={clientX:d.clientX,clientY:d.clientY},b._editableWhenTouchStart=null,void(b._getKeyboardMode()===n.HIDE&&(b._editableWhenTouchStart=b.isHtmlContentEditable(),b.setHtmlContentEditable(!1))))},_isTap:function(a,b){if(!a||!b)return j.warn("_isTap(): arguments are not valid!"),!1;var c=a.clientX-b.clientX,d=a.clientY-b.clientY,e=Math.pow(c,2)+Math.pow(d,2);return e<=100},_onTouchEnd:function(a){j.log("touch end",a);var b,c,d,e,f=this,g=a.originalEvent||a,h=g.changedTouches[0],i=f._isTap(h,f._touchStartPosition);i&&(b=Date.now()-f._touchStartTime,c=b>=o,d=f._getKeyboardMode(),f._selectContentOnViewMode===!0?(e=m.getRange(),f._selectContentOnViewMode=d===n.HIDE&&e&&e.collapsed===!1):f._selectContentOnViewMode=d===n.HIDE&&c,f._selectContentOnViewMode||(null!=f._editableWhenTouchStart&&(f.setHtmlContentEditable(f._editableWhenTouchStart),f._editableWhenTouchStart=null),f._onTap(a)))},_onTap:function(a){var b,k,l,m,n=this,o=n.getBlock(a.target),p=a.target,q=p.getAttribute("data-cell-id");if(n.note.removeHighlight(),!n.isReadOnly()){if(!o)return j.warn("_onTap(): block is null!"),n._clearCustomSelectionUI(),n.setHtmlContentEditable(!0),void n.focusLastBlankLine();switch(b=c.getType(o)){case c.IMAGE:case c.ATTACHMENT:m=b===c.IMAGE?d:e,k=new m({block:o}),l=new i({startRange:k,endRange:k}),n.setHtmlContentEditable(!1),n.trigger("set-range",l,!0,!0);break;case c.PARAGRAPH:case c.LIST_ITEM:n._clearCustomSelectionUI(),n.setHtmlContentEditable(!0);break;case c.TABLE:k=new f({block:o,uid:q}),l=new i({startRange:k,endRange:k}),a.preventDefault(),n.setHtmlContentEditable(!1),n.trigger("set-range",l,!0,!0);break;case c.HR:k=new g({block:o}),l=new i({startRange:k,endRange:k}),n.setHtmlContentEditable(!1),n.trigger("set-range",l,!0,!0);break;case c.UNKNOWN:k=new h({block:o}),l=new i({startRange:k,endRange:k}),n.setHtmlContentEditable(!1),n.trigger("set-range",l,!0,!0);break;default:j.warn("_onTap is not handled, block type is "+b)}}},_unbindEventsForBlockView:function(a,b,d){d=d!==!1,d&&this.constructor.__super__._unbindEventsForBlockView.apply(this,arguments),c.isImage(a)&&(b.off("request-image-rendered-src"),b.off("image-rendered")),c.isAttachment(a)&&(b.off("request-attachment-rendered-src"),b.off("click-attachment"))},_bindEventsForBlockView:function(a,b){var d=this.constructor.__super__;d._unbindEventsForBlockView.apply(this,arguments),d._bindEventsForBlockView.apply(this,[a,b,!1]),this._unbindEventsForBlockView(a,b,!1),c.isImage(a)&&(b.on("request-image-rendered-src",this.trigger.bind(this,"request-image-rendered-src")),b.on("image-rendered",this._onImageRendered.bind(this))),c.isAttachment(a)&&(b.on("request-attachment-rendered-src",this.trigger.bind(this,"request-attachment-rendered-src")),b.on("click-attachment",this.trigger.bind(this,"click-attachment")))},_onImageRendered:function(){this._scrollNativeSelectionIntoWrapper(m.getRange())},_transRectRelative2ViewPort:function(a){var b=document.documentElement,c=Math.max(window.pageXOffset||0,b.scrollLeft||0),d=Math.max(window.pageYOffset||0,b.scrollTop||0),e="2147483647";if(c+""!==e&&d+""!==e)return j.log("scrollLeft/Top: "+c+", "+d),{top:a.top-d,left:a.left-c,right:a.right-c,bottom:a.bottom-d,width:a.width,height:a.height}},_computeRangeRect:function(){var a=this,c=b.prototype._computeRangeRect.apply(a,arguments);return a._printRect(c),c&&l.IS_IOS7&&(c=a._transRectRelative2ViewPort(c),j.log("IOS 7"),a._printRect(c)),c},_scrollRectIntoWrapper:function(a){if(a){var b=this,c=a.bottom,d=a.height,e=a.top,f=b._viewportHeight||window.innerHeight;j.log("元素底部距离上边距: "+c+"; 可视区域高度: "+f),d>f&&e>f?b._scrollWrapperBy(0,e):c>f&&b._scrollWrapperBy(0,c-f/2-d/2)}},_scrollCustomIntoWrapper:function(a){var b,c,d=this,e=d.note,f=a.getStartBlockRange(),g=f.block,h=g.getType(),i=e.getBlockIndex(g),j=d.getBlockViewAt(i);b="table"===h?j.getActiveCellSelection()[0]:j.el,c=b.getBoundingClientRect(),d._scrollRectIntoWrapper(c)},_scrollWrapperBy:function(a,b){j.log("scroll by x: "+a+","+b),window.scrollBy(a,b)},_trickyBackspace:function(a){var b,c=this,d=a||c._isTextInputFiredOnlyTimes,e=function(){c.trigger("get-note-range",function(a){c.trigger("tricky-backspace",a)})};for(b=0;b<d;b++)e(),c._isTextInputFiredOnlyTimes--},_onInput:function(a){var b=this;b._isKeyDownFired||(a&&j.log(a),b._isTextInputFired=!1,b.trigger("get-note-range",function(a){b._noteRangeAtInputTime=a}),l.IS_IOS8&&!b._isOnComposition&&setTimeout(function(){b._isTextInputFired||b.trigger("tricky-backspace",b._noteRangeAtInputTime)},50),j.log("input"),b._isInputFired=!0)},_onTextInput:function(a){var b,c,d,e,f,g=this,h=g._lastDelTime;if(a=a.originalEvent||a,f=a.data+"",a.preventDefault(),!g.isReadOnly()&&f){if(l.IS_IOS8&&(!/^[a-z]$/i.test(f)||g._isInputFired||g._isKeyDownFired||(g._isTextInputFiredOnlyTimes+=1),/^[a-z]{2,}$/i.test(f)&&g._isInputFired&&(g._trickyBackspace(),g._isTextInputFiredOnlyTimes=0)),g.lastTrickedKeyPressRange&&g._isRangeChangedAfterKeypress()?g.trigger("extend-select-character-backward"):(b=window.getSelection(),b&&!b.isCollapsed&&g._onSelectionChange()),g.lastTrickedKeyPressRange=null,g._fixForHangulInputMethod(a),g._isEnterKey(a))return g._lastDelTime=null,a.preventDefault(),e={preventDefault:function(){}},void g.trigger("key-pressed","enter",e);if(g._fixForBrackets(a))return void(g._lastDelTime=null);c=(new Date).getTime(),d=h&&c-h<p,g.trigger("text-input",f,d),g._lastDelTime=null,g._resetStates(),g._isTextInputFired=!0}},_fixForBrackets:function(a){var b,c,d=a&&a.originalEvent&&a.originalEvent.data,e={"（）":!0,"［］":!0,"‘’":!0,"“”":!0,"「」":!0,"《》":!0,"<>":!0,"【】":!0,"｛｝":!0,"()":!0,"[]":!0,"＜＞":!0,"{}":!0};if(this.isReadOnly()||!k.isString(d)||1!==d.length)return!1;if(b=d.charCodeAt(),this._lastKeyPressCode===b){if(b===this._stopBracketCode&&new Date-this._stopBracketDate<q)return j.log("补全左括号"),this.trigger("text-input",this._stopBrackets),a.preventDefault(),!0}else if(c=String.fromCharCode(this._lastKeyPressCode,b),c&&e[c])return this._stopBracketCode=this._lastKeyPressCode,this._stopBracketDate=new Date,this._stopBrackets=c,j.log("阻止右括号"),a.preventDefault(),!0;return!1},_isHangulCode:function(a){return k.isNumber(a)&&(a>=4352&&a<=4607||a>=12592&&a<=12687||a>=44032&&a<=55215||a>=43360&&a<=43391||a>=55216&&a<=55295)},_fixForHangulInputMethod:function(a){var b,c=a&&a.originalEvent&&a.originalEvent.data;k.isString(c)&&1===c.length&&(b=c.charCodeAt(),b!==this._lastKeyPressCode&&this._isHangulCode(b)&&this._isHangulCode(this._lastKeyPressCode)&&this.trigger("extend-select-character-backward"))},_isRangeChangedAfterKeypress:function(){var a=this.lastTrickedKeyPressRange,b=m.getRange();if(a&&b&&b.collapsed&&(a.startContainer!==b.startContainer||a.startOffset!==b.startOffset))return!0},_resetStates:function(){var a=this;a._isKeyDownFired=!1,a._isInputFired=!1,a._isTextInputFired=!1},_onKeyDown:function(){j.log("_onKeyDown");var a=this;a._resetStates(),a._isTextInputFiredOnlyTimes=0,a._isKeyDownFired=!0,a.lastTrickedKeyPressRange=null},_onKeyPress:function(a){j.log("_onKeyPress",a);var b,c;return this._lastKeyPressCode=a.which||a.keyCode,this._isOnComposition||a.altKey||a.metaKey||a.ctrlKey||a.shiftKey?void(this.lastTrickedKeyPressRange=null):(c=a.which||a.keyCode,b=m.getRange(),void(b&&b.collapsed&&this._isTrickedKeyIn10Key(c)?this.lastTrickedKeyPressRange={startContainer:b.startContainer,startOffset:b.startOffset}:this.lastTrickedKeyPressRange=null))},_isTrickedKeyIn10Key:function(a){if(a>=97&&a<=122||a>=65&&a<=90||k.contains([35,44,46,47,58,64,95,65292,12290,65311,65281,12289,165,36,8364,163,65509,65284,8364,65505,65312,65283,65295,65343,65307,38,45,94,59,65286,65293,65342,183,42,37,61,65290,65285,65309,8226,124,92,65372,65340],a))return!0},_onKeyUp:function(a){j.log("_onKeyUp",a),this.lastTrickedKeyPressRange=null,8===a.which&&(this._lastDelTime=(new Date).getTime())},_isEnterKey:function(a){var b,c,d=this;return!d._isKeyDownFired&&(b=a.originalEvent||event,c=b.data+"",/^\n$/.test(c))},_onAnchorClick:function(a){var b,c=a.currentTarget,d=this;a.preventDefault(),b=c&&c.getAttribute("href"),b&&(d.setHtmlContentEditable(!1),d.trigger("open-link",b))}})}({}),yne_underscorestring=function(){var a,b=window._;if(!b&&window.require&&(b=window.require("underscore")),!b)throw"no `underscore` library";if(a=b.string||b.str||window.s,!a&&window.require&&(a=window.require("underscore.string")),!a)throw"no `underscore.string` library";return a}(),yne_common_util_createDom=function(a){var b,c,d;if(a=a||document,a.implementation&&a.implementation.createHTMLDocument)return b=a.implementation.createHTMLDocument("title"),b.body.innerHTML="",{doc:b,root:b.body};if(d=a.defaultView||window,d.DOMParser){c=new d.DOMParser;try{b=c.parseFromString("","text/html")}catch(a){}if(b)return b.body.innerHTML="",{doc:b,root:b.body}}return{doc:a,root:a.createElement("div")}},yne_osImage=function(a){var b,c,d,e=yne_jquery,f=yne_underscore,g=yne_common_data_Block,h=yne_common_data_blockTypes,i=yne_jtk_core_L,j=yne_common_util_unknownTree,k=yne_common_util_blockStyles,l=yne_common_util_createDom;return b={_type:h.IMAGE,_source:null,initialize:function(a){var b=this;g.prototype.initialize.apply(b,arguments),b._source=a.source},setSource:function(a){var b=this;return!(!a||a===b._source)&&(b._source=a+"",b.trigger("content-change"),!0)},getSource:function(){return this._source},getStyles:function(a){var b=this;return a?b.getBlockStyle(a):b.getBlockStyles()},setStyles:function(a,b){var c=this;return f.isString(a)?c.setBlockStyle(a,b):f.isObject(a)&&c.setBlockStyles(a),!0},toXml:function(a){var b,c,e,f,g=this,h=g.getSource();if(h)return b=d.__super__.toXml.apply(g,[a]),c=a.createElement("source"),e=a.createTextNode(h),c.appendChild(e),b.appendChild(c),f=a.createElement("styles"),k.toXml(g,f,a),b.appendChild(f),j.appendToXml(g.unknownTree,b),b},toJSON:function(){var a=this,b={blockType:a._type,source:a.getSource(),styles:a.getStyles()};return b},toHtml:function(){var a,b=this,c=b.getStyles(),d=l(),g=d.doc,h=g.createElement("div"),i=e(h),j=e(g.createElement("img"));return i.attr("yne-bulb-block","image"),f.each(c,function(a,b){switch(b){case"align":i.css("text-align",a);break;case"width":null==a?j.css("width",""):j.css("width",a);break;case"float":i.css("float",a)}}),j.attr({"data-media-type":"image",src:b._source}),i.append(j),d.root.appendChild(h),a=d.root.innerHTML,h=i=j=null,a},toPlain:function(){return""},countWords:function(){return 0}},c={fromXml:function(a){var b=e(a),c=e.trim(b.find("source").text()),f=new d({source:c});return f.parseIdFromXml(a),b.children().each(function(a,b){switch(b.nodeName){case g.TAG_ID_NAME:case g.LEGACY_TAG_ID_NAME:case"source":break;case"styles":k.fromXml(f,b);break;default:j.appendToTree(f.unknownTree,b)}}),f},fromJSON:function(a){if(!a||!a.blockType||a.blockType!==h.IMAGE||!a.source)return void i.warn("jsonObj or jsonObj.source does NOT exist!");var b=new d({source:a.source});return a.styles&&b.setStyles(a.styles),b}},d=g.extend(b,c)}({}),yne_osAttachment=function(a){var b,c,d,e=yne_jquery,f=yne_underscore,g=yne_common_data_Block,h=yne_common_data_blockTypes,i=yne_jtk_core_L,j=yne_common_util_unknownTree,k=yne_common_util_blockStyles,l=yne_common_util_createDom;return b={_type:h.ATTACHMENT,_source:null,_resource:null,_fileName:null,_fileLength:null,initialize:function(a){var b=this;g.prototype.initialize.apply(b,arguments),b._source=a.source,b._resource=a.resource,b._fileName=a.fileName,b._fileLength=a.fileLength},setSource:function(a){var b=this;return a=(a||"")+"",!(!a||a===b._source)&&(b._source=a,b.trigger("content-change"),!0)},getSource:function(){return this._source},getResource:function(){return this._resource},setResource:function(a){var b=this;return a=(a||"")+"",!(!a||a===b._resource)&&(b._resource=a,b.trigger("content-change"),!0)},getFileName:function(){var a=this;return a._fileName},setFileName:function(a){var b=this;return a=String(a||""),!(!a||a===b._fileName)&&(b._fileName=a,b.trigger("content-change"),!0)},getFileLength:function(){var a=this;return a._fileLength},setFileLength:function(a){var b=this;return a=parseInt(a||0),!(!a||a===b._fileName)&&(b._fileLength=a,b.trigger("content-change"),!0)},getStyles:function(a){var b=this;return a?b.getBlockStyle(a):b.getBlockStyles()},setStyles:function(a,b){var c=this;return f.isString(a)?c.setBlockStyle(a,b):f.isObject(a)&&f.each(a,function(a,b){c.setBlockStyle(b,a)}),!0},toXml:function(a){var b,c,e=this,g=e.getSource(),h=["Source","Resource","FileName","FileLength"];if(g)return b=d.__super__.toXml.apply(e,[a]),f.each(h,function(c){var d=a.createElement(c.toLowerCase()),f=e["get"+c](),g=a.createTextNode(f);d.appendChild(g),b.appendChild(d)}),c=a.createElement("styles"),k.toXml(e,c,a),b.appendChild(c),j.appendToXml(e.unknownTree,b),b},toJSON:function(){var a=this,b={blockType:a._type,source:a.getSource(),resource:a.getResource(),fileName:a.getFileName(),fileLength:a.getFileLength(),styles:a.getStyles()};return b},toHtml:function(){var a,b=this,c=b.getStyles(),d=l(),g=d.doc,h=g.createElement("div"),i=e(h),j=e(g.createElement("img"));return i.attr("yne-bulb-block","attachment"),f.each(c,function(a,b){switch(b){case"align":i.css("text-align",a);break;case"float":i.css("float",a)}}),j.attr({"data-media-type":"attachment",src:b._source,path:b._resource,filelength:b._fileLength,title:b._fileName,alt:b._fileName,filename:b._fileName}),i.append(j),d.root.appendChild(h),a=d.root.innerHTML,h=i=j=null,a},toPlain:function(){return""},countWords:function(){return 0}},c={fromXml:function(a){var b,c="无文件名",f=e(a),h=e.trim(f.find("source").text()),i=e.trim(f.find("resource").text()),l=e.trim(f.find("filename").text())||c,m=e.trim(f.find("filelength").text());return m=parseInt(m,10),isNaN(m)&&(m=0),b=new d({source:h,resource:i,fileName:l,fileLength:m}),b.parseIdFromXml(a),f.children().each(function(a,c){
switch(c.nodeName){case g.TAG_ID_NAME:case g.LEGACY_TAG_ID_NAME:case"source":case"resource":case"filename":case"filelength":break;case"styles":k.fromXml(b,c);break;default:j.appendToTree(b.unknownTree,c)}}),b},fromJSON:function(a){if(!(a&&a.blockType&&a.blockType===h.ATTACHMENT&&a.source&&a.resource))return void i.warn("jsonObj or jsonObj.source/resource does NOT exist!");var b=new d({source:a.source,resource:a.resource,fileName:a.fileName,fileLength:a.fileLength});return a.styles&&b.setStyles(a.styles),b}},d=g.extend(b,c)}({}),yne_common_data_ListItem=function(a){var b,c=yne_common_data_Paragraph,d=yne_common_data_RichText,e=yne_common_data_blockTypes,f=yne_common_data_Rich2HtmlConvertor,g=yne_jquery,h=yne_underscore,i=yne_underscorestring,j=yne_jtk_core_L,k=yne_common_util_unknownTree,l=yne_common_util_blockStyles,m=yne_jtk_core_assert,n=yne_common_data_supportedListItemStyles,o=yne_common_data_Block,p=n.getStyle,q=n.getPlainStyle;return b=c.extend({_type:e.LIST_ITEM,_level:null,_ownerList:null,_index:null,initialize:function(a){var b=this,d=a.level||1;c.prototype.initialize.call(b,a),b.setLevel(d),b.setIndex(1),b._ownerList=a.list,b.on("attached",b._onAttached.bind(b)),b.on("detached",b._onDetached.bind(b))},setLevel:function(a){h.isNumber(a)&&(a=Math.max(a,1),a=Math.min(a,9),this._level=a,this._ownerList&&this._ownerList.updateIndexes(),this.trigger("level-change",a))},getLevel:function(){return this._level},setIndex:function(a){h.isNumber(a)&&a>0&&(this._index=a,this.trigger("index-change",a))},getIndex:function(){return this._index},setOwnerList:function(a){this._ownerList=a},getOwnerList:function(){return this._ownerList},isOrdered:function(){return this._ownerList.isOrdered()},_onAttached:function(a){var b,c,d=this,f=d.getOwnerList(),g=a.getAllBlocks(),h=a.getBlockIndex(d),i=null;if(m(h>=0,"Block not attached yet.",h,d),0===f.getLength())f.insertAfter(d,null);else{for(b=h-1;b>=0;--b)if(c=g[b],e.isListItem(c)&&c.getOwnerList()===f){i=c;break}f.insertAfter(d,i)}},_onDetached:function(){this.getOwnerList().removeItem(this)},toXml:function(a){var c,d,e=this,f=e.getOwnerList();return f?(c=b.__super__.toXml.apply(e,[a]),c.setAttribute("level",e.getLevel()),d=f.getId(),c.setAttribute("list-id",d),{listId:d,listType:f.getType(),ownerList:f,listItem:c}):void j.error("The list item has no owner list!")},toJSON:function(a,b){var c,d=this,e=d.sliceText(a,b,!1),f={blockType:d._type,richText:e.toJSON(),styles:d.getBlockStyles(),level:d.getLevel(),index:d.getIndex()},g=d.getOwnerList();return g&&g.getId&&(c=g.getId()),c&&(f.listId=c),g&&g.getType&&g.getType()&&(f.listType=g.getType()),f},_getLabel:function(){var a=this,b="",c=a.getLevel();if(a.isOrdered())b=q(c,a.getIndex())+".";else switch(c%3){case 0:b="■";break;case 2:b="○";break;default:case 1:b="●"}return b},toHtml:function(a,b){var c,d,e,h=this,i=document.createElement("li"),j=g(i);return j.css("list-style-type",p(h)).css("list-style-position","inside").css("white-space","pre-wrap"),h._applyBlockStylesOnElement(j),a=a||0,c=h.sliceText(a,b,!1),d=f.rich2html(c,{withDefault:!1}),i.innerHTML=d,e=i.outerHTML,i=j=null,e},toPlain:function(a,b,c){var d,e,f=this,g=f.getLevel()||1;return a=a||0,c=c||{},d=f.sliceText(a,b,!1),e=d.toString(),c.ignoreMarker||(e=f._getLabel()+" "+e,e=i.repeat(" ",4*g-2)+e),e},getListType:function(){var a=this;return a._ownerList?a._ownerList.getType():a.listType}},{fromXml:function(a){var c,e=g(a),f=parseInt(e.attr("level"))||1;return c=new b({level:f}),c.setText(d.fromXml(a)),c.parseIdFromXml(a),g(a).children().each(function(a,b){switch(b.nodeName){case o.TAG_ID_NAME:case o.LEGACY_TAG_ID_NAME:case"text":case"inline-styles":break;case"styles":l.fromXml(c,b);break;default:k.appendToTree(c.unknownTree,b)}}),c},fromJSON:function(a){if(!a||!a.blockType||a.blockType!==e.LIST_ITEM)return void j.warn("jsonObj is not valid!");var c=new b({level:a.level});return c.setText(d.fromJSON(a.richText)),h.each(a.styles,function(a,b){c.setBlockStyle(b,a)}),a.listType&&(c.listType=a.listType),a.listId&&(c.listId=a.listId),c}})}({}),yne_common_data_tableDataCheck_createBlankCell=function(){return{value:""}},yne_common_data_tableDataCheck_createBlankTable=function(a){var b=yne_ytable_editor_config_defaults,c=yne_common_data_tableDataCheck_createBlankCell;return function(a,d){a=a||1,d=d||1;var e,f=[],g=[],h=[],i=a*d;for(e=0;e<a;e++)g.push(b.rowHeight);for(e=0;e<d;e++)f.push(b.columnWidth);for(e=0;e<i;e++)h.push(c());return{widths:f,heights:g,cells:h}}}({}),yne_common_data_tableDataCheck_size=function(a){var b=yne_common_data_tableDataCheck_createBlankTable,c=yne_common_data_tableDataCheck_createBlankCell,d=yne_underscore,e=yne_ytable_editor_config_defaults;return{name:"size",checkAndFix:function(a){if(!a.cells||!d.isArray(a.cells))return{errors:["The `cells` property is not Array type!"],fixedData:b(),stopCheck:!0};var f,g,h=a.cells,i=a.widths,j=a.heights,k=!0,l=!0,m=[];for(i&&d.isArray(i)||(k=!1,m.push("The `widths` property is not Array type!")),j&&d.isArray(j)||(l=!1,m.push("The `heights` property is not Array type!")),k||l?k?l||(j=[],j.length=Math.ceil(h.length/i.length)):(i=[],i.length=Math.ceil(h.length/j.length)):(i=[],i.length=5,j=[],j.length=Math.ceil(h.length/i.length)),f=i.length*j.length,g=!1;f<h.length;)j.push(e.rowHeight),f=i.length*j.length,g=!0;for(g&&m.push("The widths.length * heights.length is less than cells.length"),f=i.length*j.length,g=!1;f>h.length;)h.push(c()),g=!0;return g&&m.push("The widths.length * heights.length is greater than cells.length"),g=!1,i=d.map(i,function(a){return a&&d.isNumber(a)?a:(g=!0,e.columnWidth)}),g&&m.push("The `widths` has unvalid value"),g=!1,j=d.map(j,function(a){return a&&d.isNumber(a)?a:(g=!0,e.rowHeight)}),g&&m.push("The `heights` has unvalid value"),{errors:m,fixedData:{widths:i,heights:j,cells:h},stopCheck:!1}}}}({}),yne_common_data_tableDataCheck_cellValue=function(a){var b=yne_common_data_tableDataCheck_createBlankCell,c=yne_underscore;return{name:"cellValue",checkAndFix:function(a){var d,e,f,g=a.cells,h=g.length,i=!1,j=!1,k=[];for(d=0;d<h;d++)e=g[d],c.isObject(e)?(f=e.value,null==f||c.isString(f)||(j=!0,e.value=f+"")):(i=!0,g[d]=b());return i&&k.push("Some cell is NOT Object type"),j&&k.push("The value of some cell is not String type"),{errors:k,fixedData:a,stopCheck:!1}}}}({}),yne_common_data_tableDataCheck_mergeDefaults=function(a){var b=yne_underscore;return{name:"mergeDefaults",checkAndFix:function(a){var c=a.cells,d=!1,e=[];return b.each(c,function(a){a.mergeWidth&&!a.mergeHeight?(a.mergeHeight=1,d=!0):a.mergeHeight&&!a.mergeWidth&&(a.mergeWidth=1,d=!0)}),d&&e.push("Some cell has no default value for mergeHeight or mergeWidth"),{errors:e,fixedData:a,stopCheck:!1}}}}({}),yne_common_data_tableDataCheck_mergeCells=function(a){var b=yne_underscore,c=function(a,c,d){var e={},f="";return b.some(a,function(c,g){if(!e[g+""]){var h,i,j,k,l,m,n,o,p,q,r,s;if(c.mergeWidth||c.mergeHeight){if(c.mergeWidth&&!b.isNumber(c.mergeWidth))return f="The mergeWidth is not Number type",!0;if(c.mergeHeight&&!b.isNumber(c.mergeHeight))return f="The mergeHeight is not Number type",!0;if(null!=c.mergePointDX||null!=c.mergePointDY)return f="The cell data is not valid, index: "+g,!0;for(h=c.mergeWidth||1,i=c.mergeHeight||1,j=Math.floor(g/d),k=g%d,p=0;p<i;p++)for(l=j+p,o=0;o<h;o++)if(p>0||o>0){if(m=k+o,n=l*d+m,q=a[n],q.mergeWidth||q.mergeHeight)return f="The merged cell should not have `mergeWidth` or `mergeHeight`, merge point cell index: "+g+", merged cell index: "+n,!0;if(q.value)return f="The `value` of merged cell should be empty string,merge point cell index: "+g+", index: "+n,!0;if(r=q.mergePointDX||0,s=q.mergePointDY||0,r!==o||s!==p)return f="The `mergePointDX` or `mergePointDY` of mergedCell is not valid, merge point cell index: "+g+",  merged cell index: "+n,!0;e[n+""]=!0}}e[g+""]=!0}}),!f||f};return{name:"mergeCells",checkAndFix:function(a){var d=a.cells,e=a.heights,f=a.widths,g=c(d,e.length,f.length),h=[];return g!==!0&&(h.push(g),b.each(d,function(a){delete a.mergeWidth,delete a.mergeHeight,delete a.mergePointDX,delete a.mergePointDY})),{errors:h,fixedData:a,stopCheck:!1}}}}({}),yne_common_data_tableDataCheck_checkAndFix=function(a){var b=yne_underscore,c=[yne_common_data_tableDataCheck_size,yne_common_data_tableDataCheck_cellValue,yne_common_data_tableDataCheck_mergeDefaults,yne_common_data_tableDataCheck_mergeCells];return function(a){a=a||{};var d,e,f,g=window.JSON.parse(window.JSON.stringify(a)),h=c.length,i=g,j=[],k=function(a){j.push(e.name+".js: "+a)};for(d=0;d<h;d++){if(e=c[d],f=e.checkAndFix(i),b.each(f.errors,k),f.stopCheck===!0)return{errors:j,fixedData:f.fixedData};i=f.fixedData}return{errors:j,fixedData:i}}}({}),yne_osTable=function(a){var b=yne_common_data_Block,c=yne_common_data_blockTypes,d=yne_jquery,e=yne_underscore,f=yne_jtk_core_L,g=yne_common_util_unknownTree,h=yne_common_util_blockStyles,i=yne_ytable_editor_utils_TableUtils,j=yne_common_data_tableDataCheck_checkAndFix,k=yne_ytable_editor_config_defaults,l=yne_common_util_highlight,m=yne_common_util_countText,n=b.extend({_type:c.TABLE,data:null,_cellIndexUIDMap:null,_highlightTdUIDList:null,initialize:function(a){var c,d=this,e=a.data;b.prototype.initialize.apply(d,arguments),c=j(e),c.errors.length&&(window.console.warn("Table data fix errors:  \n"+c.errors.join("\n")),f.log(a.data)),d.data=c.fixedData,d._cellIndexUIDMap=n.buildCellIndexUIDMap(d.data.cells),delete d.options},toXml:function(a){var b,c,d=this,e=n.__super__.toXml.apply(d,arguments),f=a.createElement("content"),i=d.data;if(i)return c=window.JSON.stringify(i),f.appendChild(a.createTextNode(c)),e.appendChild(f),b=a.createElement("styles"),h.toXml(d,b,a),e.appendChild(b),g.appendToXml(d.unknownTree,e),e},toJSON:function(){var a=this,b=a.data;if(b)return{blockType:a._type,data:b}},toHtml:function(){var a,b,c,d,f,g,h,j,l,m,n,o,p,q,r,s=this,t=s.data,u=function(a){return a.mergePointDX>=1||a.mergePointDY>=1},v=0;if(!t)return"";for(b=document.createElement("table"),c=t.heights.length,d=t.widths.length,b.setAttribute("cellspacing","0"),b.setAttribute("cellpadding","0"),b.setAttribute("border","1"),b.setAttribute("style","table-layout:fixed;border-collapse:collapse;border:1px solid #ccc;"),f=0;f<c;f++)h=b.insertRow(f);for(j=b.querySelectorAll("tr"),l=j.length,f=0;f<c;f++)for(o=j[f],g=0;g<d;g++)m=f*d+g,n=t.cells[m],u(n)||(p=document.createElement("td"),p.style.wordWrap="break-word",h=n.mergeWidth,h&&h>1?p.setAttribute("colspan",h):p.style.width=(t.widths[g]||k.columnWidth)+"px",h=n.mergeHeight,h&&h>1?p.setAttribute("rowspan",h):p.style.height=(t.heights[f]||k.rowHeight)+"px",i.setElementStyles(p,n),i.setElementText(p,n.value||"",n),p.setAttribute("data-cell-id",s._cellIndexUIDMap[m]),o.appendChild(p));return a=document.createElement("div"),a.appendChild(b),a.style.fontSize="12px",e.each(t.widths,function(a){v+=a}),v+=d,e.isNumber(v)&&v>0?(a.style.width=v+1+"px",b.style.width=v+"px"):b.style.width="100%",r=["Microsoft YaHei","微软雅黑","华文黑体","STHeiti","Microsoft JhengHei","sans-serif"],r='"'+r.join('","')+'"',a.style.fontFamily=r,a.style.position="relative",q=a.outerHTML},toPlain:function(a,b,c){var d=this,f=d.data;return!f||c&&c.ignoreTable?"":e.pluck(f.cells,"value").join("")},countWords:function(){var a=this,b=a.data,c=0;return b?(e.each(b.cells,function(a){var b=a.value||"";c+=m(b)}),c):c},getCellByUID:function(a){var b=this,c=b._cellIndexUIDMap[a];if(null!=c)return b.data.cells[c]},getNextDownCellByUID:function(a){var b,c,d=this,e=d.data.cells,f=d.data.widths.length;if(b=d._cellIndexUIDMap[a],null!=b&&(c=b+f,c<e.length))return d._cellIndexUIDMap[c]},setCellValue:function(a){var b=this,c=a.uid,d=a.stringValue,e=b.getCellByUID(c),f={};e.value=d,f={uid:c,value:d},b.trigger("set-cell-value",f)},_searchWords:function(a){var b=this,c=b.data.cells,d={};return e.each(c,function(b,c){var f=b.value||"",g=[];f&&(e.each(a,function(a){var b,c=0,d=a.length;do b=f.indexOf(a,c),b>-1&&g.push({start:b,end:b+d-1,word:a,len:d}),c=b+d;while(b>-1)}),g.length&&(d[c]=g))}),d},_createHighlightSpan:function(a){var b=document.createElement("span");return b.innerText=a,b.style.color=l.TEXT_COLOR,b.style.backgroundColor=l.BACK_COLOR,b},_cellToHtml:function(a,b,c){a=null==a?"":a;var d,f,g,h,i,j,k,l=this,m=document.createElement("div"),n=a.length,o=[];if(b.link&&(f=document.createElement("a"),f.setAttribute("target","_blank"),f.setAttribute("href",b.link),b.textColor&&(f.style.color="inherit")),!c||!c.length)return f?(f.innerText=a,m.appendChild(f)):m.innerText=a,m.innerHTML;for(e.each(c,function(a){var b;for(b=a.start;b<=a.end;b++)o[b]=!0}),g=0,h=0,i=!1,d=0;d<n;d++)o[d]===!0?i||(k=document.createTextNode(a.substring(h,d)),m.appendChild(k),g=d,i=!0):i&&(i=!1,j=l._createHighlightSpan(a.substring(g,d)),m.appendChild(j),h=d);return i?(j=l._createHighlightSpan(a.substr(g)),m.appendChild(j)):(k=document.createTextNode(a.substr(h)),m.appendChild(k)),m.innerHTML},highlight:function(a){var b,c=this,d=c.data.cells,f=[],g=[],h=function(a){var b,e=c._cellIndexUIDMap[a],g=d[e];g&&(b=c._cellToHtml(g.value,g,null),f.push({uid:a,html:b,backColor:g.backColor,highlight:!1}))};a&&a.length?(b=c._searchWords(a),e.each(b,function(a,b){var e,h=c._cellIndexUIDMap[b],i=d[b],j=i.backColor;e=c._cellToHtml(i.value,i,a),l.isDiffFromHighlightColor(j)||(j=""),g.push(h),f.push({uid:h,html:e,backColor:j,highlight:!0})}),e.each(c._highlightTdUIDList,function(a){g.indexOf(a)>-1||h(a)}),c._highlightTdUIDList=g):c._highlightTdUIDList&&(e.each(c._highlightTdUIDList,h),c._highlightTdUIDList=null),c.trigger("cell-highlight",f)},removeHighlight:function(){this.highlight()}},{fromXml:function(a){var c,e,i=d(a),j=i.find("content").eq(0),k=d.trim(j.text());try{c=window.JSON.parse(k)}catch(a){return void f.error(a)}return e=new n({data:c}),e.parseIdFromXml(a),i.children().each(function(a,c){switch(c.nodeName){case b.TAG_ID_NAME:case b.LEGACY_TAG_ID_NAME:case"content":break;case"styles":h.fromXml(e,c);break;default:g.appendToTree(e.unknownTree,c)}}),e},fromJSON:function(a){return a&&a.blockType&&a.blockType===c.TABLE?new n({data:a.data}):void f.warn("jsonObj is not valid!")},buildCellIndexUIDMap:function(a){var b,c={};return a&&a.length>0&&e.each(a,function(a,d){b=e.uniqueId("cellId_"),c[b]=d,c[d]=b}),c}});return n}({}),yne_common_data_Hr=function(a){var b,c,d,e=yne_common_data_Block,f=yne_common_data_blockTypes,g=yne_jtk_core_L,h=yne_underscore,i=yne_jquery,j=yne_common_util_unknownTree,k=yne_common_util_blockStyles;return c={_type:f.HR,_styles:null,initialize:function(){var a=this;e.prototype.initialize.apply(a,arguments)},toXml:function(a){var c=this,d=b.__super__.toXml.apply(c,[a]),e=a.createElement("styles");return k.toXml(c,e,a),d.appendChild(e),j.appendToXml(c.unknownTree,d),d},toHtml:function(){var a,b=this,c=document.createElement("hr"),d=i(c),e=b.getBlockStyles();return d.attr("yne-bulb-block","hr"),h.each(e,function(a,b){d.attr("yne-style-"+b,a)}),d.css("clear","both"),a=c.outerHTML},toJSON:function(){var a=this;return{blockType:f.HR,styles:a.getBlockStyles()}},toPlain:function(){var a=new Array(81);return a.join("-")},countWords:function(){return 0}},d={fromXml:function(a){var c=new b,d=i(a);return c.parseIdFromXml(a),d.children().each(function(a,b){switch(b.nodeName){case e.TAG_ID_NAME:case e.LEGACY_TAG_ID_NAME:break;case"styles":k.fromXml(c,b);break;default:j.appendToTree(c.unknownTree,b)}}),c},fromJSON:function(a){if(!a||a.blockType!==f.HR)return void g.error("invalid jsonObj");var c=new b;return h.each(a.styles,function(a,b){c.setBlockStyle(b,a)}),c}},b=e.extend(c,d)}({}),yne_common_data_Unknown=function(a){var b,c,d,e=yne_common_data_blockTypes,f=yne_common_data_Block;return c={_type:e.UNKNOWN,_styles:null,_supportedBlockStyles:null,_xmlNode:null,initialize:function(a){var c=this;c._xmlNode=a.xmlNode,b.__super__.initialize.apply(c,arguments)},setBlockStyle:function(){},setBlockStyles:function(){},getBlockStyles:function(){},getBlockStyle:function(){},getDefaultBlockStyles:function(){},toXml:function(){return this._xmlNode},getType:function(){return this._type},toJSON:function(){},toHtml:function(){return""},toPlain:function(){return""},countWords:function(){return 0}},d={fromXml:function(a){return new b({xmlNode:a})},fromJSON:function(){}},b=f.extend(c,d)}({}),yne_common_data_blockMap=function(a){var b,c=yne_underscore;return b={para:yne_common_data_Paragraph,image:yne_osImage,attach:yne_osAttachment,"list-item":yne_common_data_ListItem,table:yne_osTable,"horizontal-line":yne_common_data_Hr,unknown:yne_common_data_Unknown},c.each(b,function(a,b){a.prototype._xmlNodeName=b}),b}({}),yne_parser_html_handlers_tagHandlers=function(a){var b=yne_underscore,c=yne_jtk_core_L,d={h1:32,h2:24,h3:18,h4:16,h5:13,h6:12},e={b:function(a){a.bold=!0},i:function(a){a.italic=!0},u:function(a){a.underline=!0},strike:function(a){a.strike=!0},code:function(a){a["font-family"]="monospace"},mark:function(a){a["back-color"]="#ffff00",a.color="#000000"},font:function(a,b){var c=b.getAttribute("color"),d=b.getAttribute("face");c&&(a.color=c),d&&(a["font-family"]=d)},pre:function(a){a["white-space"]="pre"},a:function(a,b){b&&b.href&&(a.color="#0000ff",a.underline=!0)}},f=function(a,d){var f=e[a];return f?void b.each(d,function(a){e[a]||(e[a]=f)}):void c.error("The tag handler for `"+a+"` does not exist!")};return b.each(d,function(a,b){e[b]=function(b){b.bold=!0,b["font-size"]=a}}),f("b",["strong"]),f("i",["em","cite","var","address","dfn"]),f("strike",["s","del"]),f("u",["ins"]),f("code",["tt","kbd","samp","pre","xmp","plaintext","listing"]),e}({}),yne_parser_html_utils_convertColor=function(a){var b=yne_tinycolor,c=yne_underscorestring,d={};return function(a){var e,f;if(a=c(a).trim().toLowerCase().value(),a&&"inherit"!==a)return"transparent"===a?a:(e=d[a])?e:(f=b(a),f.isValid()?(e=f.toHexString(),d[a]=e,e):void 0)}}({}),yne_parser_html_handlers_styleHandlers=function(a){var b=yne_underscorestring,c=yne_common_constants,d=yne_underscore,e=yne_parser_html_utils_convertColor,f=["bold","bolder","700","800","900"],g={"xx-small":12,"x-small":12,small:13,medium:16,large:18,"x-large":24,"xx-large":32},h={bold:{inheritable:!0,action:function(a){var c=a.style.fontWeight;return c=c&&b.trim(c).toLowerCase(),c&&"inherit"!==c?d.indexOf(f,c)!==-1:null}},italic:{inheritable:!0,action:function(a){var b=a.style.fontStyle;return b?"italic"===b:null}},underline:{inheritable:!0,action:function(a,b,c){var d=a.style.textDecoration;return!!/(^|\s)underline($|\s)/i.test(d)||!(d&&!c)&&c}},strike:{inheritable:!0,action:function(a,b,c){var d=a.style.textDecoration;return!!/(^|\s)line-through($|\s)/i.test(d)||!(d&&!c)&&c}},"font-family":{inheritable:!0,action:function(a){var b,c=a.style.fontFamily;if(c&&"inherit"!==c)return b=c.split(",")[0],b=b.replace(/^[ '"]+|[ '"]+$/g,""),b||null}},"font-size":{inheritable:!0,action:function(a,c,d){var e=a.style.fontSize;if(e=b.trim(e+""),/^[\d.]+px$/.test(e)?e=parseInt(e,10):/^[\d.]+pt$/.test(e)?e=Math.round(6*parseFloat(e,10)/5):/^[\d.]+em$/.test(e)?(e=parseFloat(e,10),e*=d||14,e=Math.floor(e)):/^[\d.]+rem$/.test(e)?(e=parseFloat(e,10),e*=10,e=Math.floor(e)):e=g[e],e&&!isNaN(e))return e}},color:{inheritable:!0,action:function(a){var b=a.style.color;return e(b)}},"back-color":{inheritable:!0,action:function(a){var b=a.style.backgroundColor;return e(b)}},align:{inheritable:!0,action:function(a){var c=a.style.textAlign||a.align;if(c=c&&b.trim(c).toLowerCase(),c&&"inherit"!==c)return c}},"line-height":{inheritable:!0,requireValues:["font-size"],action:function(a,c){var d=b.trim(a.style.lineHeight+""),e=c["font-size"]||14;if(/^[\d.]+$/.test(d)?d=parseFloat(d,10):/^[\d.]+px$/.test(d)?(d=parseFloat(d,10),d/=e):d=0,d&&!isNaN(d)&&d>1)return d}},indent:{inheritable:!0,action:function(a,b,c){var d=0;return"BLOCKQUOTE"===a.tagName&&(d=1),d+=c||0}},"text-indent":{inheritable:!0,action:function(a){var d=a.style.textIndent;if(d=b.trim(d+""),d=/^[\d.]+px$/.test(d)?parseFloat(d,10):/^[\d.]+pt$/.test(d)?4*parseFloat(d,10)/3:null)return d=Math.floor(d/c.INDENT_WIDTH),d||1}},width:{inheritable:!1,action:function(a){var c=a.style.width||a.width;if(c=b.trim(c+""),/^[\d.]+(px)?$/.test(c)&&(c=parseInt(c,10)),c&&!isNaN(c))return c}},float:{inheritable:!1,action:function(a){var b=a.style.float;return b}},"white-space":{inheritable:!0,action:function(a){var b=a.style.whiteSpace;if(b&&"inherit"!==b)return b}}};return h}({}),yne_parser_html_handlers_BaseHandler=function(a){var b,c=yne_jtk_core_Class,d=yne_underscore,e=yne_jtk_core_L,f=yne_parser_html_handlers_tagHandlers,g=yne_parser_html_handlers_styleHandlers;return b=c.extend({inheritStyleHandlers:null,uninheritStyleHandlers:null,tagHandler:null,el:null,parent:null,children:null,styles:null,constructor:function(a,b){var c=this;c.el=a,c.children=[],c.parent=b,c.parent&&c.parent.children&&c.parent.children.push(c),c._computeStyles(),c.computeBulbStyles()},computeBulbStyles:function(){},_findStyleHandler:function(a,c){var f,g=this,h=a?g.inheritStyleHandlers:g.uninheritStyleHandlers,i=h[c];if(d.isFunction(i))return{action:i};if(d.isObject(i)&&i.action)return i;if(i===!0&&(f=b.styleHandlers[c],f&&f.action))return f.inheritable!==a?void e.error("The inheritable value of "+c+" is unvalid!"):f},_computeStyles:function(){var a=this,c=a.el,d={},e=a.tagHandler||b.tagHandlers[c.tagName.toLowerCase()];e&&e(d,c),a.styles={},a._computeInheritStyles(d),a._computeUninheritStyles(d)},_computeStyle:function(a,b){var c,e,f,g=this,h=null!=g.inheritStyleHandlers[b],i=g.parent,j=g.el;null==g.styles[b]&&(h&&!i||(c=g._findStyleHandler(h,b),c&&c.action&&(c.requireValues&&c.requireValues.length&&d.each(c.requireValues,function(b){g._computeStyle(a,b)}),h?(e=(i.styles||{})[b],f=c.action(j,g.styles,e),f||f===!1||(f=a[b]),f||f===!1||(f=e)):(f=c.action(j,g.styles),f||f===!1||(f=a[b])),(f||f===!1)&&(g.styles[b]=f))))},_computeInheritStyles:function(a){var b=this;b.inheritStyleHandlers&&d.each(b.inheritStyleHandlers,function(c,d){c&&b._computeStyle(a,d)})},_computeUninheritStyles:function(a){var b=this;b.uninheritStyleHandlers&&d.each(b.uninheritStyleHandlers,function(c,d){c&&b._computeStyle(a,d)})},setup:function(){},capture:function(){},finish:function(){},emit:function(a){var b=this;b.parent&&b.parent.capture(a)},getRoot:function(){var a=this;if(a.parent)return a.parent.getRoot()}},{tagHandlers:f,styleHandlers:g})}({}),yne_parser_html_utils_handleParagraphSpaces=function(a){var b=yne_underscore,c=yne_underscorestring,d=["normal","nowrap","pre-line"],e=function(a,b){return b&&"normal"!==b&&"nowrap"!==b?"pre-line"===b?a.replace(/[ \t]+/g," "):a:a.replace(/[ \t\r\n]+/g," ")},f=function(a,b){return b&&"normal"!==b&&"nowrap"!==b?"pre-line"===b?a.replace(/^[ \t]+/g,""):a:a.replace(/^[ \t\r\n]+/g,"")},g=function(a,b){return b&&"normal"!==b&&"nowrap"!==b?"pre-line"===b?a.replace(/[ \t]+$/g,""):a:a.replace(/[ \t\r\n]+$/g,"")},h=function(a){var c=a.styles["white-space"];return!c||b.contains(d,c)};return function(a){var d,i,j,k,l,m;for(b.each(a,function(a){a.text=e(a.text,a.styles["white-space"])}),j=a.length,d=0;d<j&&(k=a[d],k.text=f(k.text,k.styles["white-space"]),!k.text);d++);for(d=0,i=1;i<j;i++)l=a[d],m=a[i],h(l)&&h(m)&&(c.endsWith(l.text," ")&&c.startsWith(m.text," ")&&(m.text=m.text.slice(1)),""===m.text)||(d=i);for(d=j-1;d>=0&&(k=a[d],k.text=g(k.text,k.styles["white-space"]),!k.text);d--);return a}}({}),yne_parser_html_handlers_ParagraphHandler=function(a){var b=yne_parser_html_handlers_BaseHandler,c=yne_common_data_Paragraph,d=yne_common_data_RichText,e=yne_parser_html_utils_handleParagraphSpaces,f=yne_common_constants,g=yne_underscore;return b.extend({inheritStyleHandlers:{bold:!0,italic:!0,underline:!0,strike:!0,"font-family":!0,"font-size":!0,color:!0,"back-color":!0,"white-space":!0,align:!0,"line-height":!0,indent:!0,"text-indent":!0},computeBulbStyles:function(){var a,b=this,c=b.el,d=c.getAttribute("yne-bulb-block");"paragraph"===d&&(a=c.style.marginLeft,a=parseInt(a,10),isNaN(a)||(a=Math.ceil(a/f.INDENT_WIDTH),b.styles.indent=(b.styles.indent||0)+a))},setup:function(){var a=this;a.block=null},capture:function(a){var b=this;a&&a.isBr===!0?b.emitBlock(!0):a&&a.isText===!0?b._appendText(a):a&&a.isEmptyPara===!0?b.emitBlock():b.captureBlock(a),b._hasChild=!0},captureBlock:function(a){this.emitBlock(),this.emit(a)},finish:function(){this.emitBlock(),this._hasChild||this.emit({isEmptyPara:!0})},_getBlock:function(){var a=this;return a.block||(a.block=a.createBlock()),a.block},createBlock:function(){return new c},_appendText:function(a){var b=this;b.txtList=b.txtList||[],b.txtList.push(a)},emitBlock:function(a){var b,c,f,h=this,i=h.txtList;c=h._getBlock(),i&&(i=e(i),g.each(i,function(a){a.text&&(f=new d({text:a.text}),b=f.getLength(),g.each(a.styles,function(a,c){f.setStyle(0,b,c,a)}),c.append(f))})),(a||c.getLength()>0)&&(c.setBlockStyles(h.styles),h.emit(c)),h.block=null,h.txtList=null}})}({}),yne_parser_html_handlers_DocumentHandler=function(a){var b,c=yne_parser_html_handlers_ParagraphHandler,d=yne_common_data_Block;return b=c.extend({constructor:function(a){var b=this;c.call(this,a,null),b.blocks=[]},setup:function(){var a=this;c.prototype.setup.apply(a),a.blocks=[]},emit:function(a){var b=this;a&&a instanceof d&&b.blocks.push(a)},finish:function(){this.emitBlock()},getRoot:function(){return this}})}({}),yne_parser_html_handlers_UnknownHandler=function(a){var b=yne_parser_html_handlers_BaseHandler;return b.extend({_computeStyles:function(){var a=this,b=a.parent;b&&(a.styles=b.styles)},capture:function(a){var b=this;b.emit(a)}})}({}),yne_jtk_web_dom_parseHTML=function(){var a=function(a,b){var c,d,e;if(b.implementation&&b.implementation.createHTMLDocument)return c=b.implementation.createHTMLDocument("title"),c.body.innerHTML=a,c;if(e=b.defaultView||window,e.DOMParser){d=new e.DOMParser;try{c=d.parseFromString("","text/html")}catch(a){}if(c)return c.body.innerHTML=a,c}};return function(b,c,d){if(b){c=c||document;var e,f,g,h,i=a(b,c);if(i){if(d!==!1)return i.body;for(g=i.body.childNodes,e=g.length,h=[],f=0;f<e;f++)h.push(g[f]);return h}}}}(),yne_parser_html_Parser=function(a){var b,c=yne_underscore,d=yne_jtk_core_Class,e=yne_parser_html_handlers_DocumentHandler,f=yne_parser_html_handlers_UnknownHandler,g=yne_jtk_web_dom_parseHTML;return b=d.extend({_mapper:{},_blackTagList:{},constructor:function(a){var b=this;b._mapper={},b._blackTagList={},c.each(a,function(a,d){a===!1?b._blackTagList[d]=!0:a&&c.isObject(a)&&b.define(d,a)})},parse:function(a,b){var c,d,f=this,h=/<html[\S\s]*<\/html>/i;return h.test(a)&&(a=a.match(h)[0]),c=g(a,document,!0),c?d=new e(c):(c=document.createElement("div"),c.innerHTML=a,d=new e(c)),f._parseRecursively(d,b),d.blocks},_shouldBreak:function(a){return"none"===a.style.display||"hidden"===a.style.visibility},_shouldWalkChild:function(a){return"TABLE"!==a.tagName},_parseRecursively:function(a,b){var d,e,g,h,i,j=this,k=a.el;if(j._shouldBreak(k)!==!0){if(a.setup(),j._shouldWalkChild(k))for(d=k.firstChild;d;)1===d.nodeType?(i=d.tagName.toLowerCase(),j._blackTagList[i]||(g=j._findHandlers(d),g=c.isFunction(g)?g:f,h=new g(d,a),j._parseRecursively(h,b))):3===d.nodeType&&(e=d.textContent,e&&a.capture({text:e,styles:a.styles,isText:!0})),d=d.nextSibling;a.finish(b)}},define:function(a,c,d){var e=this;e._mapper[a]={Class:c,priority:d||b.PRIORITY.DEFAULT}},_findHandlers:function(a){var b=[],d=function(a,b){if(a)return a.matches?a.matches(b):a.webkitMatchesSelector?a.webkitMatchesSelector(b):void 0};if(c.each(this._mapper,function(c,e){d(a,e)&&b.push(c)}),0!==b.length)return b.sort(function(a,b){return b.priority-a.priority}),b[0].Class}},{PRIORITY:{HIGH:1,DEFAULT:0,LOW:-1}})}({}),yne_parser_html_handlers_InlineHandler=function(a){var b=yne_underscore,c=yne_parser_html_handlers_BaseHandler;return c.extend({inheritStyleHandlers:{bold:!0,italic:!0,underline:!0,strike:!0,"font-family":!0,"font-size":!0,color:!0,"back-color":!0,"white-space":!0},inheritBlockStyles:{align:!0,"line-height":!0,indent:!0,"text-indent":!0},_computeInheritStyles:function(){var a=this;c.prototype._computeInheritStyles.apply(a,arguments),a._computeInheritBlockStyles()},_computeInheritBlockStyles:function(){var a,c=this,d=c.parent,e=c.inheritBlockStyles;d&&d.styles&&(a=d.styles,b.each(e,function(b,d){if(b===!0){var e=a[d];e&&(c.styles[d]=e)}}))},capture:function(a){this.emit(a)}})}({}),yne_parser_html_handlers_AnchorHandler=function(a){var b=yne_parser_html_handlers_BaseHandler;return b.extend({inheritStyleHandlers:{bold:!0,italic:!0,underline:!0,strike:!0,"font-family":!0,"font-size":!0,color:!0,"back-color":!0,"white-space":!0},constructor:function(a,c){b.call(this,a,c)},capture:function(a){var b=this,c=b.el.getAttribute("href");return c&&"#"!==c&&0!==c.indexOf("javascript")?void(a&&a.isText===!0?(a.styles.href=a.styles.href||c,b.emit(a)):b.emit(a)):void b.emit(a)}})}({}),yne_parser_html_handlers_BreakHandler=function(a){var b,c=yne_parser_html_handlers_InlineHandler;return b=c.extend({inheritStyleHandlers:!1,inheritBlockStyles:{"line-height":!0,indent:!0,"text-indent":!0},finish:function(){var a=this;a.emit({isBr:!0,styles:a.styles})}})}({}),yne_parser_html_handlers_HrHandler=function(a){var b=yne_parser_html_handlers_BaseHandler,c=yne_common_data_Hr,d=yne_underscore,e=yne_common_data_supportedBlockStyles,f=e.getBlockStyles("horizontal-line");return b.extend({computeBulbStyles:function(){var a=this,b=a.el,c=b.getAttribute("yne-bulb-block");"hr"===c&&d.each(f,function(c,d){var e=b.getAttribute("yne-style-"+d);e&&(a.styles[d]=e)})},finish:function(){var a=this,b=new c;a.styles&&b.setBlockStyles(a.styles),a.emit(b)}})}({}),yne_parser_html_handlers_ImageHandler=function(a){var b,c=yne_parser_html_handlers_InlineHandler,d=yne_osImage,e=yne_osAttachment,f=yne_underscore,g=yne_common_constants;return b=c.extend({inheritStyleHandlers:!1,uninheritStyleHandlers:{width:!0,float:!0},inheritBlockStyles:{align:!0},_handleNoteLink:function(){var a,b,c,d=this,e=d.el;a=e.getAttribute("data-attr-noteid"),b=e.getAttribute("alt"),a&&b&&(c=d.parent&&d.parent.styles?f.clone(d.parent.styles):{},c.href="note://"+a,c.color="#0000ff",c.underline=!0,d.emit({text:b,styles:c,isText:!0}))},finish:function(a){var c,h,i,j,k,l,m=this,n=m.el,o=n.getAttribute("src"),p=function(a,b){f.each(a,function(a,c){var d=b.style[a];d&&(m.styles[c]=d)})};return b.isNoteLink(n)?void m._handleNoteLink():void(o&&(a&&/^file:\/\/\//i.test(o)||(k=n.parentNode,k&&(l=k.getAttribute("yne-bulb-block")),b.isAttachment(n)?(j=n.getAttribute("path"),c={resource:j,fileName:b.getAttachmentFileName(n),fileLength:b.getAttachmentFileLength(n)},g.IS_ANDROID?(c.id=b.getImageId(n),c.src=o,c.source=b.getImageBakSrc(n)):c.source=o,i=new e(c),"attachment"===l&&p({align:"textAlign",float:"float"},k)):b.isImage(n)&&("image"===l&&p({align:"textAlign",width:"width",float:"float"},k),h={source:o},g.IS_ANDROID&&(h.id=b.getImageId(n)),i=new d(h)),i&&(i.setStyles(m.styles),m.emit(i)))))}},{isAttachment:function(a){var b=a.getAttribute("path"),c=a.dataset.mediaType;return b&&("attachment"===c||!c)},isImage:function(a){var b=a.dataset.mediaType,c=a.getAttribute("path"),d=["image","handwrite"];return!c&&(!b||d.indexOf(b)>-1)},isNoteLink:function(a){var b=a.dataset.mediaType;return"notelink"===b},getAttachmentFileName:function(a){var b=a.getAttribute("filename")||a.getAttribute("alt")||a.getAttribute("title");return b||""},getAttachmentFileLength:function(a){var b=a.getAttribute("filelength");return b||""},getImageId:function(a){return a.dataset.id||""},getImageBakSrc:function(a){return a.getAttribute("bak-src")||""}})}({}),yne_parser_html_handlers_TableHandler=function(a){var b=yne_parser_html_handlers_BaseHandler,c=yne_osTable,d=yne_osImage,e=yne_osAttachment,f=yne_parser_html_handlers_ImageHandler,g=yne_jtk_core_L,h=yne_jquery,i=yne_underscore,j=yne_parser_html_handlers_styleHandlers,k=function(a,b){var c;if(a&&a.tagName){if(c=(a.tagName+"").toLowerCase(),c===b+"")return!0;if(i.contains(b,c))return!0}},l=function(a,b,c){if(!a)return c;var d=a.getAttribute(b);return d=parseInt(d||c,10),isNaN(d)&&(d=c),d},m=function(a,b,c){if(!a)return c;
var d=a.style[b];return d=parseInt(d||c,10),isNaN(d)&&(d=c),d},n=function(a){if(!a)return!1;var b=["white","#fff","#ffffff","rgb(255,255,255)"];return a=(a+"").toLowerCase(),a=h.trim(a),a=a.replace(/ /g,""),i.contains(b,a)};return b.extend({DEFAULT_HEIGHT:32,DEFAULT_WIDTH:72,_styleHandlers:{bold:{tagList:["b","strong"],styleHandler:function(a){return j.bold.action(a,{},null)}},lineThrough:{tagList:["strike","s","del"],styleHandler:function(a){return j.strike.action(a,{},null)}},underline:{tagList:["u","ins"],styleHandler:function(a){return j.underline.action(a,{},null)}},italic:{tagList:["i","em","cite","var","address","dfn"],styleHandler:function(a){return j.italic.action(a,{},null)}},fontName:function(a){var b=j["font-family"].action(a,{},null);return b?b:"FONT"===a.tagName?(b=a.getAttribute("face"),b||null):void 0},fontSize:function(a){var b=j["font-size"].action(a,{},null);if(b)return b+"px"},textColor:function(a){var b=j.color.action(a,{},null);return b?b:"FONT"===a.tagName?(b=a.getAttribute("color"),b||null):void 0},backColor:function(a){var b=j["back-color"].action(a,{},null);return b},textAlign:function(a){var b=j.align.action(a,{},null);return b}},_tableStyleHandlers:{verticalAlign:function(a){var b,c=["THEAD","TBODY","TFOOT"];if(a)return b=a.style.verticalAlign||a.getAttribute("valign"),b?b:a.tagName&&i.contains(c,a.tagName)?"middle":void 0},textAlign:function(a){if(a)return a.style&&a.style.textAlign?a.style.textAlign:a.getAttribute("align")},textColor:function(a){var b=j.color.action(a,{},null);return b},backColor:function(a){var b=a.style.backgroundColor;return b||null},bold:function(a){if(a&&a.tagName&&"TH"===a.tagName)return"true";var b=j.bold.action(a,{},null);return b?"true":void 0},italic:function(a){var b=j.italic.action(a,{},null);if(b)return"true"},underline:function(a){var b=j.underline.action(a,{},null);if(b)return"true"},lineThrough:function(a){var b=j.strike.action(a,{},null);if(b)return"true"},fontName:function(a){var b=j["font-family"].action(a,{},null);return b},fontSize:function(a){var b=j["font-size"].action(a,{},null);if(b)return b+"px"}},constructor:function(a,b){var c=this;c.el=a,c.parent=b},_inheritStyles:function(a,b,c){var d=this,e={};return c=c||{},i.each(d._styleHandlers,function(d,f){var g;a[f]!==!1&&(i.isFunction(d)?g=d(b):(d.styleHandler&&(g=d.styleHandler(b)),!g&&d.tagList&&(g=k(b,d.tagList))),g&&"inherit"!==g||(g=c[f]),e[f]=g)}),e},_mergeStyles:function(a,b){var c=this,d=h.trim(a.value),e=d.length;i.each(c._styleHandlers,function(c,d){0===e?b[d]?a[d]=b[d]:a[d]=!1:a[d]&&b[d]!==a[d]&&(a[d]=!1)})},_inheritTableStyles:function(a,b){var c=this,d={},e=["TABLE","THEAD","TBODY","TFOOT","TR","TD","TH"];return i.contains(e,a.tagName+"")?(b=b||{},i.each(c._tableStyleHandlers,function(c,e){var f=c(a);null!=f&&"inherit"!==f||(f=b[e]),null!=f&&(d[e]=f)}),d):{}},_parseImage:function(a,b){var c,g,h,i=this,j=a.getAttribute("src");return f.isNoteLink(a)?(h=a.getAttribute("alt")||"",void(b.value+=h)):void(j&&(f.isAttachment(a)?(g=a.getAttribute("path"),c=new e({id:f.getImageId(a),src:j,source:j,resource:g,fileName:f.getAttachmentFileName(a),fileLength:f.getAttachmentFileLength(a)})):f.isImage(a)&&(c=new d({id:f.getImageId(a),source:j})),c&&i._blockList.push(c)))},_shouldAddLineBreak:function(a){a=(a+"").toLowerCase();var b=["article","aside","blockquote","br","button","caption","col","colgroup","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","map","ol","output","p","pre","progress","section","textarea","tfoot","ul","video"],c=i.contains(b,a);return c},_parseContent:function(a,b,c){var d,e,f,g,i=this,j=a.firstChild;for(c=c||{};j;)1===j.nodeType?(d=j.tagName,"TABLE"===d?i._parseTable(j):"IMG"===d?i._parseImage(j,b):"BR"===d?b.value+="\n":(f=i._inheritStyles(b,j,c),i._parseContent(j,b,f),i._shouldAddLineBreak(d)&&(b.value+="\n"))):3===j.nodeType&&(e=j.nodeValue,g=h.trim(e),g&&g.length?(i._mergeStyles(b,c),b.value+=e.replace(/[\r\n]/g," ").replace(/\s+/g," ")):b.value+=" "),j=j.nextSibling},_isLinkCell:function(a){if(!a)return!1;var b,c,d,e,f,g,i,j=a.querySelectorAll("a"),k=function(a){return!a||(1===a.nodeType?""===h.trim(a.textContent||""):3!==a.nodeType||""===h.trim(a.nodeValue||""))};if(!j||!j.length||1!==j.length)return!1;for(b=j[0],d=b,c=d.parentNode;c&&c!==a;){for(e=c.childNodes,f=e.length,g=0;g<f;g++)if(i=e[g],i!==d&&!k(i))return!1;d=c,c=d.parentNode}return!0},_parseCellContent:function(a,b,c){var d,e=this;e._isLinkCell(a)&&(d=a.querySelector("a"),b.link=d.getAttribute("href")),e._parseContent(a,b,c)},_parseCell:function(a,b,c){var d,e,f,g=this,j={value:""};return g._parseCellContent(a,j,{}),e=h.trim(j.value),e=e.replace(/\n+/g,"\n"),d={value:e},d.value&&j.link&&(d.link=j.link),c===g.DEFAULT_HEIGHT&&(d.wrap="true"),i.each(g._styleHandlers,function(a,b){j[b]===!0?d[b]="true":j[b]&&(d[b]=j[b])}),e=l(a,"colspan",1),e>1&&(d.mergeWidth=e),e=l(a,"rowspan",1),e>1&&(d.mergeHeight=e),f=g._inheritTableStyles(a,b),i.each(f,function(a,b){null==d[b]&&a&&(d[b]=a)}),n(d.backColor)&&delete d.backColor,d},_isArrayFull:function(a,b){var c;if(0===b)return!1;for(c=0;c<b;c++)if(null==a[c])return!1;return!0},_parseTbodyCells:function(a,b,c){var d,e=this,f=i.filter(b.children,e._isTableRow),g=[],h=a.widths.length,j=a.heights.length,k=0;return d=e._inheritTableStyles(b,c),i.each(f,function(b){var c=i.filter(b.children,e._isTableCell),f=e._inheritTableStyles(b,d),m=k,n=g[m];if(0!==c.length){for(;n&&e._isArrayFull(n,h);)k++,m++,n=g[m];for(n||(n=g[m]=[]),i.each(c,function(b){for(var c,d,h,i,k,o,p,q,r,s=0,t=n[s];t;)s++,t=n[s];for(c=s,i=e._parseCell(b,f,a.heights[m]),n[c]=i,d=l(b,"rowspan",1),h=l(b,"colspan",1),d>j-m&&(d=j-m,i.mergeHeight=d),k=0;k<d;k++)for(p=m+k,r=g[p],r||(r=g[p]=[]),o=0;o<h;o++)q=c+o,r[q]||(r[q]={mergePointDX:o,mergePointDY:k})});n.length<h;)n.push({value:""});k++}}),g},_isTableCell:function(a){if(!a||!a.tagName)return!1;var b=a.tagName||"",c=["TD","TH"];return i.contains(c,b)},_isTableRow:function(a){return!(!a||!a.tagName)&&"TR"===a.tagName},_getTbodySize:function(a){var b,c,d,e,f,g,h=this,j=[],k=0,n=0,o=[];for(i.each(a,function(b){var c,d,e=n,f=j[e];if(c=i.filter(b.children,h._isTableCell),0!==c.length){for(;f&&h._isArrayFull(f,k);)e++,f=j[e];n=e,f||(f=j[e]=[],o[e]=a[e]),i.each(c,function(b,c){var g,i,k,n,p,q,r=l(b,"colspan",1),s=l(b,"rowspan",1),t=m(b,"width",0)||l(b,"width",0);for(d+=r,t=Math.max(Math.round(t/r),h.DEFAULT_WIDTH),n=c;null!=f[n];)n++;for(k=0;k<r;k++)p=n+k,f[p]=t;for(g=1;g<s;g++)for(i=e+g,q=j[i],q||(q=j[i]=[],o[i]=a[i]),k=0;k<r;k++)p=n+k,q[p]=t}),d=f.length,k<d&&(k=d)}}),b=j.length,g=[],c=0;c<k;c++){for(e=(j[0]||[])[c]||h.DEFAULT_WIDTH,d=1;d<b;d++)f=(j[d]||[])[c],f&&f>e&&(e=f);g.push(e)}return{rows:b,columns:k,columnWidthList:g,compactTrList:i.compact(o)}},_createBlankRow:function(a){for(var b=[];a>0;)b.push({value:""}),a--;return b},_parseTbody:function(a,b,c){var d,e,f,g,h=this,j=i.filter(a.children,h._isTableRow),k=0,n={},o=[],p=0;for(g=h._getTbodySize(j),j=g.compactTrList,n.heights=i.map(j,function(a){var b=i.filter(a.children,h._isTableCell),c=0;return i.some(b,function(a){if(!a.getAttribute("rowspan")){var b=m(a,"height",0)||l(a,"height",0);if(b)return c=b,!0}}),c=Math.max(c,h.DEFAULT_HEIGHT)});n.heights.length<g.rows;)n.heights.push(h.DEFAULT_HEIGHT);if(p=0,i.each(g.columnWidthList,function(a){p+=a}),p<c?(e=Math.ceil((c-p)/g.columns),o=i.map(g.columnWidthList,function(a){return a+e})):o=g.columnWidthList,n.widths=o,d=h._parseTbodyCells(n,a,b),f=d.length,k=n.heights.length,k>f)for(;f<k;)d.push(h._createBlankRow(g.columns)),f++;else if(k<f)for(;k<f;)n.heights.push(h.DEFAULT_HEIGHT),k++;return n.cells=d,n},_extendBodyInfo:function(a,b){var c,d,e,f=a.cells,g=a.heights.length,h=a.widths.length;if(!(h>=b))for(c=0;c<g;c++)for(d=f[c],e=d.length;e<b;e++)d.push({value:""})},_convertToTableCells:function(a,b){var c,d,e,f,h,i=a.length,j=[];for(c=0;c<i;c++)for(d=a[c],e=0;e<b;e++)f=d[e],f?(h=c*b+e,j[h]=f):g.error("No tdInfo  at row, col: "+c+", "+e);return j},_mergeTbody:function(a){if(a&&a.length){var b,c=this,d=0,e=[],f=[],g={};return i.each(a,function(a){var c=a.widths.length;c>d&&(d=c,b=a.widths)}),i.each(a,function(a){c._extendBodyInfo(a,d)}),i.each(a,function(a){e=e.concat(a.heights),f=f.concat(a.cells)}),f=c._convertToTableCells(f,d),g.widths=b,g.heights=e,g.cells=f,g}},_parseTable:function(a){var b,c=this,d=i.toArray(a.children),e=["thead","tbody","tfoot"],f={thead:[],tbody:[],tfoot:[]},g=[],h=c._blockList.length,j=c._inheritTableStyles(a,{}),k=m(a,"width",0)||l(a,"width",0);c._blockList.push(0),i.each(d,function(a){var b,d=(a.tagName||"").toLowerCase();i.contains(e,d)&&(b=c._parseTbody(a,j,k),f[d].push(b))}),i.each(e,function(a){var b=f[a];b&&b.length&&(g=g.concat(b))}),b=c._mergeTbody(g),b&&(c._blockList[h]=b)},setup:function(){var a=this;a._blockList=[]},finish:function(){var a=this;a._parseTable(a.el),i.each(a._blockList,function(b){var d;b&&b.heights?d=new c({data:{heights:b.heights,widths:b.widths,cells:b.cells}}):b&&(d=b),d&&a.emit(d)})}})}({}),yne_common_data_List=function(a){var b,c=yne_jtk_core_Class,d=yne_backbone.Events,e=yne_underscore,f=yne_jquery,g=yne_jtk_core_assert;return b=c.extend(e.extend({_id:null,_type:null,_items:null,unknownAttrs:null,initialize:function(a){var b=this;b._id=e.uniqueId("list"),b._type=a.type,b._items=[],b.unknownAttrs=[]},getId:function(){return this._id},isOrdered:function(){return this._type===b.ORDERED},isUnordered:function(){return this._type===b.UNORDERED},getType:function(){return this._type},setType:function(a){g(a===b.ORDERED||a===b.UNORDERED),a!==this._type&&(this._type=a,this.updateIndexes(),this.trigger("type-change"))},getLength:function(){return this._items.length},getItems:function(){return this._items},updateIndexes:function(){if(this._type===b.ORDERED){var a,c,d,e=this,f=e._items,g=f.length,h=0,i={};for(a=0;a<g;++a)c=f[a],d=c.getLevel(),d>h?i[d]=1:i[d]?i[d]++:i[d]=1,h=d,c.setIndex(i[d])}},insertItem:function(a,b){var c=this,d=c._items;return g(a>0||a<=d.length),g(!(b in d)),d.splice(a,0,b),c.updateIndexes(),a},insertAfter:function(a,b){var c=this,d=c._items,e=b?d.indexOf(b):-1;c.insertItem(e+1,a)},removeItem:function(a){var b=this,c=b._items,d=c.indexOf(a);return d>=0&&(c.splice(d,1),b.updateIndexes()),d}},d),{ORDERED:"ordered",UNORDERED:"unordered",fromXml:function(a){var c=f(a),d=c.attr("type"),g=new b({type:d});return e.each(a.attributes,function(a){switch(a.nodeName){case"id":case"type":break;default:g.unknownAttrs.push(a.cloneNode(!0))}}),g}})}({}),yne_parser_html_handlers_ListHandler=function(a){var b,c=yne_parser_html_handlers_BaseHandler,d=yne_common_data_List,e=yne_common_data_ListItem,f=yne_underscore;return b=c.extend({list:null,level:null,type:null,_itemCounter:null,prevSimilar:null,inheritStyleHandlers:{bold:!0,italic:!0,underline:!0,strike:!0,"font-family":!0,"font-size":!0,color:!0,"back-color":!0,"white-space":!0,align:!0,"line-height":!0,indent:!0,"text-indent":!0},_parseTypeFromElement:function(){var a=this;return"ul"===a.el.tagName.toLowerCase()?d.UNORDERED:d.ORDERED},_getStartIndexFromElement:function(){var a=this,b=a.type,c=a.el,e=-1;return b!==d.ORDERED?e:("list"===c.getAttribute("yne-block-type")&&(e=parseInt(c.getAttribute("start"),10),isNaN(e)&&(e=-1)),e)},increaseItemCounter:function(){var a,b=this,c=b.prevSimilar;c&&c.increaseItemCounter?c.increaseItemCounter():(a=b._itemCounter||0,a+=1,b._itemCounter=a)},getItemCounter:function(){var a=this,b=a.prevSimilar;return b?b.getItemCounter():a._itemCounter||0},setup:function(){var a,b,c,e=this,f=e._findParentListHandler();e.list=null,e.level=1,f&&(e.level=f.level+1),c=e._parseTypeFromElement(),e.type=c,b=e._getStartIndexFromElement(),b>1&&(a=e._getPreviousSimilar(),a&&a.getItemCounter()===b-1&&(e.prevSimilar=a,e.list=a.list)),e.list||(e.list=new d({type:c}))},capture:function(a){var b=this,c=b.level;a instanceof e&&a.getLevel()<c&&a.setLevel(c),b.emit(a)},_findParentListHandler:function(){for(var a=this.parent;a;){if(a instanceof b)return a;a=a.parent}},_getPreviousSimilar:function(){var a,c=this,d=c.level,e=c.type,g=c.parent,h=g.children;return f.some(h,function(c){if(c instanceof b&&c.level===d&&c.type===e)return a=c,!0}),a}})}({}),yne_parser_html_handlers_ListItemHandler=function(a){var b=yne_parser_html_handlers_ParagraphHandler,c=yne_common_data_ListItem,d=yne_parser_html_handlers_ListHandler;return b.extend({setup:function(){var a=this;a.ownerListHandler=a._findOwnerListHandler()},captureBlock:function(a){var b=this,c=null;b.emitBlock(),!b._listed&&a.getType&&"paragraph"===a.getType()?(c=b.createBlock(),c.append(a.getText()),b.emit(c)):b.emit(a)},emit:function(a){var d=this;a instanceof c&&(d._listed=!0),b.prototype.emit.call(d,a)},createBlock:function(){var a=this,d=a.ownerListHandler;return!a._listed&&d&&d.list?(d.increaseItemCounter(),new c({list:d.list})):b.prototype.createBlock.call(a)},_findOwnerListHandler:function(){for(var a=this.parent;a;){if(a instanceof d)return a;a=a.parent}}})}({}),yne_parser_html_handlers_handlerMap={ParagraphHandler:yne_parser_html_handlers_ParagraphHandler,InlineHandler:yne_parser_html_handlers_InlineHandler,AnchorHandler:yne_parser_html_handlers_AnchorHandler,BreakHandler:yne_parser_html_handlers_BreakHandler,HrHandler:yne_parser_html_handlers_HrHandler,TableHandler:yne_parser_html_handlers_TableHandler,ImageHandler:yne_parser_html_handlers_ImageHandler,ListHandler:yne_parser_html_handlers_ListHandler,ListItemHandler:yne_parser_html_handlers_ListItemHandler},yne_parser_html_tagConfig=function(a){var b=!1,c=yne_parser_html_handlers_handlerMap;return{a:c.AnchorHandler,abbr:c.InlineHandler,acronym:c.InlineHandler,address:c.ParagraphHandler,applet:b,area:b,article:c.ParagraphHandler,aside:c.ParagraphHandler,audio:b,b:c.InlineHandler,base:b,basefont:b,bdi:c.InlineHandler,bdo:c.InlineHandler,bgsound:b,big:c.InlineHandler,blink:c.InlineHandler,blockquote:c.ParagraphHandler,body:c.ParagraphHandler,br:c.BreakHandler,button:b,canvas:b,center:c.ParagraphHandler,cite:c.InlineHandler,code:c.InlineHandler,command:b,content:b,data:b,datalist:b,dd:c.ParagraphHandler,del:c.InlineHandler,details:c.ParagraphHandler,dfn:c.InlineHandler,dialog:b,dir:c.InlineHandler,div:c.ParagraphHandler,dl:c.ParagraphHandler,dt:c.ParagraphHandler,element:b,em:c.InlineHandler,embed:b,fieldset:c.ParagraphHandler,figcaption:c.ParagraphHandler,figure:c.ParagraphHandler,font:c.InlineHandler,footer:c.ParagraphHandler,form:c.ParagraphHandler,frame:b,frameset:b,h1:c.ParagraphHandler,h2:c.ParagraphHandler,h3:c.ParagraphHandler,h4:c.ParagraphHandler,h5:c.ParagraphHandler,h6:c.ParagraphHandler,header:c.ParagraphHandler,hgroup:c.ParagraphHandler,hr:c.HrHandler,html:c.ParagraphHandler,i:c.InlineHandler,iframe:b,image:b,img:c.ImageHandler,input:b,ins:c.InlineHandler,isindex:b,kbd:c.InlineHandler,keygen:b,label:c.InlineHandler,legend:c.ParagraphHandler,li:c.ListItemHandler,link:b,listing:b,main:c.ParagraphHandler,map:b,mark:c.InlineHandler,marquee:c.ParagraphHandler,menu:b,menuitem:b,meta:b,meter:c.InlineHandler,multicol:c.ParagraphHandler,nav:c.ParagraphHandler,nobr:c.InlineHandler,noembed:b,noframes:b,noscript:b,object:b,ol:c.ListHandler,optgroup:b,option:b,output:c.InlineHandler,p:c.ParagraphHandler,param:b,picture:b,plaintext:c.ParagraphHandler,pre:c.ParagraphHandler,progress:b,q:c.InlineHandler,rp:c.InlineHandler,rt:c.InlineHandler,rtc:c.InlineHandler,ruby:c.ParagraphHandler,s:c.InlineHandler,samp:c.InlineHandler,script:b,section:c.ParagraphHandler,select:b,shadow:b,small:c.InlineHandler,source:b,spacer:b,span:c.InlineHandler,strike:c.InlineHandler,strong:c.InlineHandler,style:b,sub:c.InlineHandler,summary:c.ParagraphHandler,sup:c.InlineHandler,table:c.TableHandler,template:b,textarea:c.ParagraphHandler,time:c.InlineHandler,title:b,track:b,tt:c.InlineHandler,u:c.InlineHandler,ul:c.ListHandler,var:c.InlineHandler,video:b,wbr:b,xmp:b}}({}),yne_parser_html_mso_ListHandler=function(a){function b(a,b){var c=a.match(/(@[\w_\-:\s]+)\n\s*\{(.|\n)*?\}/gm);null!==c&&c.forEach(function(a){var c=/@([\w_\-:\s]+)/.exec(a)[1].trim(),d=a.substring(a.indexOf("{")+1,a.indexOf("}")).trim(),e={};d.split(";").forEach(function(a){var b;a.indexOf(":")!==-1&&(b=a.split(":"),e[b[0].trim()]=b[1].trim())}),b[c]||(b[c]={}),g.extend(b[c],e)})}var c=yne_parser_html_handlers_ParagraphHandler,d=yne_common_data_List,e=yne_common_data_ListItem,f=yne_jtk_core_L,g=yne_underscore;return c.extend({setup:function(){var a,b,e,f,g,h,i,j=this.getRoot();c.prototype.setup.call(this),a=this.el.getAttribute("style"),a&&(b=/mso-list:(l\d+) (level\d+)/.exec(a),b&&(g=b[1],h=b[2],e=this._getStyles(),f=e["list "+g+":"+h],f&&(i=j["mso-"+g],i||(i=j["mso-"+g]=new d({type:"bullet"===f["mso-level-number-format"]?d.UNORDERED:d.ORDERED})),this.list=i,this.level=Number(h.replace("level","")),this.el.querySelector('[style="mso-list:Ignore"]').remove())))},createBlock:function(){return this.list?new e({list:this.list,level:this.level}):c.prototype.createBlock.call(this)},_getStyles:function(){var a,c=this.getRoot(),d=this.el.ownerDocument,e={};return c.msoStyles?c.msoStyles:(a=d.querySelectorAll("style"),g.each(a,function(a){1===a.childNodes.length&&3===a.firstChild.nodeType&&b(a.firstChild.textContent,e)}),f.log(e),c.msoStyles=e,e)}})}({}),yne_parser_html_convert=function(a){var b,c=yne_parser_html_Parser,d=yne_parser_html_tagConfig,e=yne_parser_html_mso_ListHandler;return function(a,f){return b||(b=new c(d),b.define(".MsoListParagraph",e,c.PRIORITY.HIGH)),b.parse(a,f)}}({}),yne_parser_plain_createRichText=function(a){var b=yne_common_data_RichText;return function(a,c){var d;return a+="",a=a.replace(/[\r\n]/g,""),d=new b({text:a}),c&&d.setStyles(0,d.getLength(),c),d}}({}),yne_common_commands_link_LinkMatch={matchEnd:function(a){var b,c,d=/(https?:\/\/|www\.|ssh:\/\/|ftp:\/\/)[a-z0-9&_+\-\?\/\.=\#,:,@]+$/i,e=/[a-z0-9_+\-\.]+@[a-z0-9_+\-\.]+$/i;return a=String(a),(b=d.exec(a))?(c=b[0],{mail:!1,fullURI:0===c.toLowerCase().indexOf("www.")?"http://"+c:c,result:b}):(b=e.exec(a),b?(c=b[0],{mail:!0,fullURI:"mailto:"+c,result:b}):void 0)}},yne_parser_plain_parseLine=function(a){var b=yne_parser_plain_createRichText,c=yne_common_data_Paragraph,d=yne_common_commands_link_LinkMatch,e=yne_underscore;return function(a,f,g){if(null!=a){var h,i,j=new c;return h=d.matchEnd(a),h&&0===h.result.index&&e.extend(f?f:f={},{href:h.fullURI,underline:!0,color:"#0000ff"}),i=b(a,f),j.setText(i),g&&e.each(g,function(a,b){j.setBlockStyle(b,a)}),j}}}({}),yne_parser_plain_convert=function(a){var b=yne_jtk_core_L,c=yne_underscore,d=yne_parser_plain_parseLine;return function(a,e,f){var g,h=[];return a?(g=a.split(/\r?\n/),g&&g.length?(c.each(g,function(a){var b=d(a,e,f);b&&h.push(b)}),b.log("to paste text",h),h):void b.warn("lines do not exist or lines.length is 0!")):void b.warn("no text when paste plain text!")}}({}),yne_parser_json_createBlock=function(a){var b=yne_common_data_Paragraph,c=yne_common_data_ListItem,d=yne_osImage,e=yne_osAttachment,f=yne_osTable,g=yne_common_data_Hr,h=yne_common_data_blockTypes,i=yne_jtk_core_L;return function(a){if(!a||!a.blockType)return void i.warn("jsonObj is null or jsonObj has no `blockType` property!");var j,k=a.blockType;switch(k){case h.PARAGRAPH:j=b.fromJSON(a);break;case h.LIST_ITEM:j=c.fromJSON(a);break;case h.IMAGE:j=d.fromJSON(a);break;case h.ATTACHMENT:j=e.fromJSON(a);break;case h.TABLE:j=f.fromJSON(a);break;case h.HR:j=g.fromJSON(a);break;default:i.warn("jsonObj.blockType = "+k)}return j}}({}),yne_parser_json_convert=function(a){var b=yne_jtk_core_L,c=yne_underscore,d=yne_common_data_List,e=yne_common_data_blockTypes,f=yne_parser_json_createBlock;return function(a,g){var h,i,j,k=[],l={};if(c.isString(a))try{h=window.JSON.parse(a)}catch(c){b.error("parse json string error: ",a)}else c.isArray(a)&&(h=a);if(h&&h.length)return b.log("createBlocksFromJSON array: ",h),c.each(h,function(a){var b;g&&a.source&&/^file:\/\/\//i.test(a.source)||(b=f(a),b&&(a.listId&&a.listType&&e.isListItem(b)&&(i=a.listId,j=l[i],j||(j=new d({type:a.listType}),l[i]=j),b.setOwnerList(j)),k.push(b)))}),k}}({}),yne_parser_Parser=function(a){var b=yne_parser_html_convert,c=yne_parser_plain_convert,d=yne_parser_json_convert,e=yne_jtk_core_L;return{parseHtml:function(a,c){var d=b(a,c);return e.log("parseHtml OK",d),d},parsePlain:function(a){var b=c(a);return b},parseJSON:function(a,b){var c=d(a,b);return c}}}({}),yne_common_util_ListItemNode=function(a){var b,c=yne_jtk_core_Class,d=yne_underscore,e=yne_jtk_core_L;return b=c.extend({constructor:function(a,b,c){var f=this;e.DEBUG&&(f._debugId=d.uniqueId()),f.level=a||0,f.block=b,f.addChildNodes(c)},addChildNodes:function(a){var b=this;a&&(d.isArray(a)||(a=[a]),d.each(a,function(a){a.parentNode=b,b.childNodes||(b.childNodes=[]),b.childNodes.push(a)}))},childrenCount:function(){var a=this,b=a.childNodes;return b?b.length:0},hasChildren:function(){var a=this.childrenCount();return a>0},isOrdered:function(){var a=this;return a.block?a.block.isOrdered():!!a.parentNode&&a.parentNode.isOrdered()},getStartIndex:function(){var a=this;return a.block?a.block.getIndex():1},isChildOrdered:function(){var a=this,b=a.childNodes||[],c=b[0];return!!c&&c.isOrdered()},getChildStartIndex:function(){var a=this,b=a.childNodes||[],c=b[0];return c?c.getStartIndex():1},toHtml:function(){var a,b,c,e,f,g,h=this,i=h.block,j=[];return h.hasChildren()?(f=i?i.toHtml():"",j.push(f),a=h.isChildOrdered()?"ol":"ul",c="<"+a+' yne-block-type="list"',b=h.getChildStartIndex(),b>1&&(c+=' start="'+b+'"'),c+=">",j.push(c),g=h.childNodes,d.each(g,function(a){var b=a.toHtml();j.push(b)}),e="</"+a+">",j.push(e)):(f=i?i.toHtml(i._toHtmlStart,i._toHtmlEnd):"<li></li>",j.push(f)),j=j.join("")}})}({}),yne_common_data_Note=function(a){var b,c,d,e=yne_underscore,f=yne_backbone,g=yne_jtk_core_Class,h=yne_jquery,i=yne_underscorestring,j=yne_common_data_blockMap,k=yne_common_data_Unknown,l=yne_parser_Parser,m=yne_common_data_Paragraph,n=yne_jtk_core_L,o=yne_common_data_List,p=yne_common_data_ListItem,q=yne_common_data_blockTypes,r=yne_common_constants,s=yne_common_data_supportedInlineStyles,t=yne_common_util_ListItemNode,u=yne_common_util_schemaVersion,v=function(a){return a instanceof m&&!a.isEmpty()},w=u.getDefaultAsString(),x=yne_common_util_clearString;return b={blocks:null,_isReadOnly:!1,headUnknownNodeList:null,fileVersion:null,initialize:function(){var a=this;a.blocks=[],a.headUnknownNodeList=[],a.schemaVersion=w,a.fileVersion=0,a._highlightOn=!1},getBlockAt:function(a){var b=this;return b.blocks[a]},getBlockBySrc:function(a){var b;return this.blocks.some(function(c){if(c.getSource&&c.getSource()===a)return b=c,!0}),b},getBlockIndex:function(a){var b=this;return e.indexOf(b.blocks,a)},getPreBlock:function(a){var b=this,c=b.getBlockIndex(a);if(c>0)return b.getBlockAt(c-1)},getNextBlock:function(a){var b=this,c=b.getBlockIndex(a);if(c>=0)return b.getBlockAt(c+1)},getLastBlock:function(){var a=this,b=e.last(a.blocks);return b},getBlockById:function(a){var b,c,d=this,e=d.blocks;for(a+="",b=0,c=e.length;b<c;b++)if(e[b].getBlockId()===a)return e[b]},lastBlockIsEasyInput:function(){var a=this,b=a.getLastBlock();return q.isParagraph(b)||q.isListItem(b)},getInterBlocks:function(a,b,c){var d=this,e=d.blocks,f=d.getBlockIndex(a),g=d.getBlockIndex(b);return c?e.slice(f,g+1):e.slice(f+1,g)},getAllBlocks:function(){var a=this;return a.blocks},getCommonInlineStyle:function(a,b){if(a&&b){var c,d=a.getStartBlockRange(),f=a.getEndBlockRange(),g=d.block,h=f.block,i=null,j=[],k=!0;return v(g)&&(j.push(g.getCommonStyle(b,d)),k=!1),g!==h&&(c=this.getInterBlocks(g,h),e.each(c,function(a){v(a)&&(j.push(a.getCommonStyle(b)),k=!1)}),v(h)&&(j.push(h.getCommonStyle(b,f)),k=!1)),k?(q.isParagraph(g)&&(i=g.getDefaultInlineStyle(b)),i||s.getDefault(b)):(e.each(j,function(a){null===i?i=a:null!=a&&i!==a&&(i=r.INTERM)}),i)}},getRangeBlockStyle:function(a,b){if(a&&b){var c=a.getStartBlockRange(),d=a.getEndBlockRange(),f=c.block,g=d.block,h=this.getInterBlocks(f,g,!0),i=null;return e.each(h,function(a){var c=a.getBlockStyle(b);i=null===i?c:i===c?i:r.INTERM}),i}},isSameList:function(a,b){var c,d,e,f,g=a.getStartBlockRange(),h=a.getEndBlockRange(),i=g.block,j=h.block,k=this.getInterBlocks(i,j,!0),l=k.length;for(c=0;c<l;c++)if(d=k[c],d instanceof m){if(!(d instanceof p))return!1;if(e=d.getOwnerList(),e.getType()!==b)return!1;if(f){if(f!==d.getOwnerList())return!1}else f=e}return!!f},insert:function(a,b){var c=this;c.blocks.splice(a,0,b),c._bindEventsForBlock(b),b.trigger("attached",c),c.trigger("insert-block",a,b)},append:function(a){var b=this,c=b.blocks;b.insert(c.length,a)},replace:function(a,b){var c=this,d=c.blocks.splice(a,1,b)[0];return d.trigger("detached",c),c._unbindEventsForBlock(d),c._bindEventsForBlock(b),b.trigger("attached",c),c.trigger("replace-block",a,b,d),d},remove:function(a){var b=this,c=b.blocks.splice(a,1)[0];c&&(c.trigger("detached",b),b._unbindEventsForBlock(c),b.trigger("remove-block",a,c))},removeBlock:function(a){var b=this;b.remove(b.getBlockIndex(a))},toXml:function(){var a,b,c=this,d="<?xml",f='<?xml version="1.0"?>\n',g="http://note.youdao.com",h=c._createXMLDocument(g,"note",null),j=h.createElement("head"),k=h.createElement("body"),l={},m=c.getSchemaVersion(),o=c.getFileVersion()||0,p=h.documentElement;return p.appendChild(j),p.appendChild(k),m&&p.setAttribute("schema-version",m),p.setAttribute("file-version",o),e.each(c.blocks,function(a){var b,c,d,f,g;a&&a.toXml&&(b=a.toXml(h)),b?b.listItem?(c=b,k.appendChild(c.listItem),f=c.listId,l[f]||(l[f]=!0,d=h.createElement("list"),g=c.ownerList.unknownAttrs,e.each(g,function(a){var b=a.cloneNode(!0);d.setAttributeNode(b)}),d.setAttribute("id",f),d.setAttribute("type",c.listType),j.appendChild(d))):k.appendChild(b):n.warn("block.toXml() failed!")}),e.each(c.headUnknownNodeList,function(a){if(a&&a.cloneNode){var b=a.cloneNode(!0);j.appendChild(b)}}),a=new window.XMLSerializer,b=a.serializeToString(h),i.startsWith(b,d)||(b=f+b),b},_createXMLDocument:function(a,b){var c=document.implementation.createDocument(a,b,null);return c.createElement=function(a){return this.createElementNS(this.documentElement.namespaceURI,a)},c.setAttribute=function(a,b){return this.setAttributeNS(this.documentElement.namespaceURI,a,b)},c},_parseToTree:function(a){var b,c,d,e,f,g,h,i=new t(0),j=a.length;for(d=i,b=0;b<j;b++){if(c=a[b],g=c.getLevel(),f=new t(g,c),h=g-d.level,h>1)for(;g-d.level>1;)e=new t(d.level+1),d.addChildNodes(e),d=e;else if(h<1)for(;g-d.level<1;)d=d.parentNode;d.addChildNodes(f),d=f}return i},_toHtmlWithSameOwnerList:function(a){var b,c=this,d=c._parseToTree(a);return d&&(b=d.toHtml()),b||""},toHtml:function(a,b){var c,d,e,f,g,h,i=this,j=i.blocks,k=j.length,l=[],m=[];for(a?(g=a.startIndex,h=a.endIndex,j[g]._toHtmlStart=a.startRangeStart,j[g]._toHtmlEnd=a.startRangeEnd,j[h]._toHtmlStart=a.endRangeStart,j[h]._toHtmlEnd=a.endRangeEnd,h++):(g=0,h=k),c=g;c<h;c++)b&&b(j[c])||(q.isListItem(j[c])?(f=j[c].getOwnerList(),e&&e!==f&&m.length&&(d=i._toHtmlWithSameOwnerList(m),l.push(d),m=[]),m.push(j[c]),e=f):(e=null,m.length&&(d=i._toHtmlWithSameOwnerList(m),l.push(d),m=[]),d=j[c].toHtml(j[c]._toHtmlStart,j[c]._toHtmlEnd),l.push(d)));return m.length&&(d=i._toHtmlWithSameOwnerList(m),l.push(d)),a&&(delete j[g]._toHtmlStart,delete j[g]._toHtmlEnd,delete j[h-1]._toHtmlStart,delete j[h-1]._toHtmlEnd),l=l.join("")},toPlain:function(a){var b=this,c=e.map(b.blocks,function(b){return b.toPlain(void 0,void 0,a)});return c=c.join("\n")},countWords:function(){var a=this,b=0,c=0,d=a.blocks;return e.each(d,function(a){c=a.countWords()||0,b+=c}),b},highlight:function(a){var b=this;a=e.uniq(a),a&&a.length?(b._highlightOn=!0,e.each(b.blocks,function(b){b.highlight(a)})):b._highlightOn&&(b._highlightOn=!1,e.each(b.blocks,function(a){a.highlight()}))},removeHighlight:function(){this.highlight()},destroy:function(){var a=this;e.each(a.blocks,function(b){a._unbindEventsForBlock(b)}),a.blocks=null},_bindEventsForBlock:function(a){var b=this;a&&(b._unbindEventsForBlock(a),q.isTable(a)&&(a.on("ytable-register",b.trigger.bind(b,"ytable-register")),a.on("ytable-unregister",b.trigger.bind(b,"ytable-unregister")),a.on("ytable-contextmenu",b.trigger.bind(b,"ytable-contextmenu")),a.on("ytable-delete",function(){b.trigger("ytable-delete",a)})))},_unbindEventsForBlock:function(a){a&&q.isTable(a)&&(a.off("ytable-register"),a.off("ytable-unregister"),a.off("ytable-contextmenu"),a.off("ytable-delete"))},getFileVersion:function(){return this.fileVersion},setFileVersion:function(a){this.fileVersion=a},setSchemaVersion:function(a){this.schemaVersion=a||w},getSchemaVersion:function(){return this.schemaVersion||w},setReadOnly:function(a){var b=this;a=!!a,e.each(b.blocks,function(b){b.setLocked(a)}),b._isReadOnly=a,b.trigger("read-only-change",a)},isReadOnly:function(){return this._isReadOnly}},c={fromXml:function(a){var b,c,f,g,i=new d,l={};if(e.isString(a)?(a=x(a),b=h.parseXML(a)):b=a,n.log(b),c=h(b).find("note:first"),f=c.attr("schema-version"),f&&i.setSchemaVersion(f),g=c.attr("file-version")||0,i.setFileVersion(g),c&&c.get(0))return c.find("head").children().each(function(a,b){var c,d=b.nodeName;switch(d){case"list":c=o.fromXml(b),l[h(b).attr("id")]=c;break;default:c=h(b).attr(r.COMPAT),u.isCompatible(c)&&(c=b.cloneNode(!0),i.headUnknownNodeList.push(c))}}),c.find("body").children().each(function(a,b){var c,d=b.nodeName,e=j[d],f=h(b).attr(r.COMPAT);if((!e&&u.isCompatible(f)||e&&f&&!u.isCompatible(f))&&(e=k),e&&e.fromXml){if(c=e.fromXml(b),!c)return void n.error("Failed to parse block from xml node!",b);q.isListItem(c)&&c.setOwnerList(l[h(b).attr("list-id")]),i.append(c)}}),i},fromHtml:function(a){var b=l.parseHtml(a),c=new d,f=0;return e.each(b,function(a){a&&(c.append(a),f++)}),f?c:null},fromPlain:function(a){var b=l.parsePlain(a),c=new d,f=0;return e.each(b,function(a){a&&(c.append(a),f++)}),f?c:null},createBlank:function(){var a=new d,b=new m;return a.append(b),a}},e.extend(b,f.Events),d=g.extend(b,c)}({}),yne_common_selection_SelectionChangeEvent=function(a){var b,c=yne_jtk_core_Class,d={COMMAND:1,USER:2};return b=c.extend({_type:null,_data:null,initialize:function(a){this._type=a.type,this._data=a.data,delete this.options},getType:function(){return this._type},getData:function(){return this._data},isCommandType:function(){return this._type===d.COMMAND},isUserType:function(){return this._type===d.USER}},{EVENT_TYPES:d,createCommandTypeEvent:function(a){return new b({type:d.COMMAND,data:a})},createUserTypeEvent:function(a){return new b({type:d.USER,data:a})}})}({}),yne_common_selection_NoteSelection=function(a){var b,c,d=yne_jtk_core_Class,e=yne_backbone,f=yne_underscore,g=yne_common_selection_NoteRange,h=yne_jtk_core_L,i=yne_common_selection_nativeSelection,j=yne_common_selection_SelectionChangeEvent;return c={noteView:null,_noteRange:null,initialize:function(a){var b=this;b.noteView=a.noteView,b._bindEvents()},_bindEvents:function(){var a=this,b=a.noteView;f.bindAll(a,"_onDocSelectionChange","_onSetRange"),b.on("selectionchange",a._onDocSelectionChange),b.on("set-range",a._onSetRange)},_onDocSelectionChange:function(){h.log("on doc selection change!");var a=this,b=i.getRange(),c=a._convertToNoteRange(b);return a._noteRange=c,h.log("NoteSelection -> contentchange"),c&&!c.canDrawedByNative()?void a.setRange(c):void a._triggerSelectionChange()},_triggerSelectionChange:function(a){var b=this;a||(a=j.createUserTypeEvent()),h.log("---------note-selection-change---------"),b.trigger("selection-change",a)},_onSetRange:function(a,b,c,d){var e=this;e._setRange(a,b,c,d)},_setRange:function(a,b,c,d){var e=this,f=e._convertToNoteRange(a);return f?(e._noteRange=f,b&&e._drawRange(),void(c&&e._triggerSelectionChange(d))):void h.warn("Failed convert native range to note range!")},_drawRange:function(){var a=this,b=a._noteRange;a.noteView.trigger("draw-range",b)},_convertToNoteRange:function(a){var b=this,c=b.noteView,d=g.fromNativeRange(a,c);return d},setRange:function(a,b){var c=this;c._setRange(a,!0,!0,b)},getRange:function(){var a=this;return a._noteRange;
},getNativeRange:function(){return i.getRange(window)},isCollapsed:function(){var a=this,b=a._noteRange;if(b)return b.isCollapsed()},collapseToStart:function(){var a=this,b=a._noteRange;b&&b.collapse&&(b.collapse(!0),a._drawRange(),a._triggerSelectionChange())},collapseToEnd:function(){var a=this,b=a._noteRange;b&&b.collapse&&(b.collapse(!1),a._drawRange(),a._triggerSelectionChange())},reset:function(){var a=this;a._noteRange=null}},f.extend(c,e.Events),b=d.extend(c)}({}),yne_common_commands_Command=function(a){var b=yne_jtk_core_Class;return b.extend({name:"UnknownCommand",isSimple:!1,apply:function(){throw"Method not implemented."},doReapply:function(){throw"Method not implemented."},doUnapply:function(){throw"Method not implemented."}})}({}),yne_common_commands_SimpleCommand=function(a){var b=yne_common_commands_Command,c=yne_jtk_core_L;return b.extend({name:"UnknownSimpleCommand",isSimple:!0,initialize:function(){},apply:function(){throw"Method not implemented."},doReapply:function(){var a=this;c.log("doReapply(): `"+a.name+"`"),a.apply()},doUnapply:function(){var a=this;throw c.log("doReapply(): `"+a.name+"`"),"Method not implemented."}})}({}),yne_common_commands_ManagerAdapter=function(a){var b=yne_common_commands_SimpleCommand,c=b.extend({name:"managerAdapter",initialize:function(a){var b=this;b.undoManager=a.undoManager},apply:function(){},doReapply:function(){var a=this;a.undoManager.redo()},doUnapply:function(){var a=this;a.undoManager.undo()}},{create:function(a){if(a&&a.redo&&a.undo)return new c({undoManager:a})}});return c}({}),yne_common_commands_CommandManager=function(a){var b,c,d=yne_jtk_core_Class,e=yne_underscore,f=yne_jtk_core_L,g=yne_backbone,h=yne_common_commands_ManagerAdapter;return c={_undoStack:null,_redoStack:null,initialize:function(){var a=this;a._undoStack=[],a._redoStack=[]},exec:function(a){var b,c,d,e=this;return a.apply(),d={cmdName:a.name,cmdType:"do",cmd:a},c=a.getEndingRange(),a.effected?(e._undoStack.push(a),e._redoStack=[],e.trigger("update-selection",c,d),void e.trigger("command-exec",a.name)):(b=a.getStartingRange(),void(b!==c&&e.trigger("update-selection",c,d)))},canUndo:function(){var a=this;return 0!==a._undoStack.length},undo:function(){if(!this.canUndo())return f.warn("Can Not undo"),!1;var a,b=this,c=b._undoStack,d=b._redoStack,e=c.pop();return e.doUnapply(),d.push(e),b.trigger("command-exec",e.name),"managerAdapter"!==e.name&&(a={cmdName:e.name,cmdType:"undo",cmd:e},b.trigger("update-selection",e.getStartingRange(),a)),!0},canRedo:function(){var a=this;return 0!==a._redoStack.length},redo:function(){if(!this.canRedo())return!1;var a,b=this,c=b._undoStack,d=b._redoStack,e=d.pop();return e.doReapply(),c.push(e),b.trigger("command-exec",e.name),"managerAdapter"!==e.name&&(a={cmdName:e.name,cmdType:"redo",cmd:e},b.trigger("update-selection",e.getEndingRange(),a)),!0},reset:function(){var a=this;a._undoStack=[],a._redoStack=[]},registerManager:function(a){var b=this;return a&&a.on?(b.unregisterManager(a),void a.on("execute-command",function(){var c=h.create(a);return c?(b._undoStack.push(c),b._redoStack=[],void b.trigger("command-exec",c.name)):void f.warn("ManagerAdapter failed to create command!")})):void f.warn("undoManager is not Valid!")},unregisterManager:function(a){a&&a.on&&a.off("execute-command")}},e.extend(c,g.Events),b=d.extend(c)}({}),yne_common_commands_CompositeCommand=function(a){var b=yne_common_commands_Command,c=yne_jtk_core_L;return b.extend({name:"UnknownCompositeCommand",isSimple:!1,startingRange:null,endingRange:null,effected:!1,initialize:function(){},_applyCommandToComposite:function(a,b){var c=this,d=c._cmds;d||(d=c._cmds=[]),a.apply(),a.isSimple?c.effected=!0:c.effected=c.effected||a.effected,b||a.isSimple||!a.getEndingRange||(b=a.getEndingRange()),b&&c.setEndingRange(b),d.push(a)},apply:function(){throw"Method not implemented."},doReapply:function(){var a,b,d=this,e=d._cmds;if(c.log("doReapply(): `"+d.name+"`"),!e||!e.length)return void c.warn("doReapply(): the composite command `"+d.name+"`no _cmds");for(a=e.length,b=0;b<a;++b)e[b].doReapply()},doUnapply:function(){var a,b=this,d=b._cmds;if(c.log("doUnapply(): `"+b.name+"`"),!d||!d.length)return void c.warn("doUnapply(): the composite command `"+b.name+"`no _cmds");for(a=d.length-1;a>=0;--a)d[a].doUnapply()},setStartingRange:function(a){this.startingRange=a},setEndingRange:function(a){this.endingRange=a},getStartingRange:function(){return this.startingRange},getEndingRange:function(){return this.endingRange}})}({}),yne_common_commands_paragraph_DeleteRange=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"DeleteRange",_paragraph:null,_args:null,_deletedText:null,initialize:function(a){var b=this,c=a.paragraph,d=a.args;b._paragraph=c,b._args=d},apply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range,e=b.getRangeText(d);return!!e&&(a._deletedText=e,b.deleteText(d),!0)},doUnapply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range,e=a._deletedText;e&&b.insertText(d.start,e)}})}({}),yne_common_commands_paragraph_SetStyle=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"SetStyle",_paragraph:null,_args:null,_oldValue:null,initialize:function(a){var b=this;b._paragraph=a.paragraph,b._args=a.args},apply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range,e=c.name,f=c.value;a._oldValue=b.getTextStyle(e,d),b.setTextStyle(e,f,d)},doUnapply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range,e=c.name;b.setTextStyle(e,a._oldValue,d)}})}({}),yne_common_commands_link_DeleteLink=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_paragraph_SetStyle,d=yne_common_selection_ParagraphRange,e=yne_underscore;return b.extend({name:"DeleteLink",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){function a(a){var f;f=new d({block:g.block,start:a,end:j.length}),e.each(k,function(a,d){b._applyCommandToComposite(new c({paragraph:h,args:{range:f,name:d,value:a}}))})}var b=this,f=b._args,g=f.range,h=g.block,i=g.end-1,j=h.getText().toString(),k={href:"",color:"#000000",underline:!1};" "===j[i]&&i--;for(var l=i;l>0;l--){if(!h.getTextStyle("href",l,l+1))return!1;if(h.getTextStyle("href",l,l+1)[0]!==h.getTextStyle("href",l-1,l)[0])return a(l);if(1===l)return a(0)}}})}({}),yne_common_commands_paragraph_DeleteBackward=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_selection_NoteRange,d=yne_common_selection_ParagraphRange,e=yne_common_data_Paragraph,f=yne_common_commands_paragraph_DeleteRange,g=yne_jtk_core_assert,h=yne_common_commands_link_DeleteLink;return b.extend({name:"DeleteBackward",initialize:function(a){var b=this;b._block=a.block,b._args=a.args},apply:function(){var a,b,i,j=this,k=j._block,l=j._args.range,m=l.start,n=l.end;g(k instanceof e),g(m>0),g(m===n),b=a=m-1,b>0&&(i=k.getTextStyle("href",b-1,b),i[0]&&j._applyCommandToComposite(new h({args:{range:l}}))),j._applyCommandToComposite(new f({paragraph:k,args:{range:{start:a,end:m}}}),new c({blockRanges:[new d({block:k,start:a,end:b})]}))}})}({}),yne_common_commands_paragraph_Merge=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"Merge",_note:null,_args:null,_paragraphLength:null,initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b=this,c=b._note,d=b._args,e=d.paragraph,f=d.preParagraph;a=f.getEndOffset(),c.removeBlock(e),f.insertText(a,e.getText()),b._mergedIndex=a,b._paragraph=e},doUnapply:function(){var a,b=this,c=b._note,d=b._args,e=d.paragraph,f=d.preParagraph,g=b._mergedIndex;f.deleteText(g),a=c.getBlockIndex(f),c.insert(a+1,e)}})}({}),yne_common_commands_paragraph_DeleteAtStart=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_data_Paragraph,d=yne_common_commands_paragraph_Merge,e=yne_common_selection_NoteRange,f=yne_common_selection_ParagraphRange,g=yne_jtk_core_assert,h=yne_common_commands_link_DeleteLink;return b.extend({name:"DeleteAtStart",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b=this,i=b._note,j=b._args,k=j.range,l=k.block,m=i.getPreBlock(l),n=new f({block:m,start:m.getEndOffset(),end:m.getEndOffset()});g(l instanceof c),g(m instanceof c),g(0===k.start&&0===k.end),n.end>0&&(a=m.getTextStyle("href",n.end-1,n.end),a[0]&&b._applyCommandToComposite(new h({args:{range:n}}))),b._applyCommandToComposite(new d({note:i,args:{paragraph:l,preParagraph:m}}),new e({blockRanges:[n]}))}})}({}),yne_common_commands_block_SetBlockStyle=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"SetBlockStyle",_block:null,_args:null,_oldValue:null,initialize:function(a){var b=this;b._block=a.block,b._args=a.args},apply:function(){var a=this,b=a._block,c=a._args,d=c.name,e=c.value;null===a._oldValue&&(a._oldValue=b.getBlockStyle(d)),b.setBlockStyle(d,e)},doUnapply:function(){var a=this,b=a._block,c=a._args,d=c.name,e=a._oldValue;b.setBlockStyle(d,e)}})}({}),yne_common_commands_note_TextIndent=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_block_SetBlockStyle,d=yne_common_data_Paragraph,e=yne_jtk_core_assert,f=yne_underscore;return b.extend({name:"TextIndent",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,g=a._args,h=g.range,i=g.step,j=h.getStartBlockRange().block,k=h.getEndBlockRange().block,l=b.getInterBlocks(j,k,!0);e(1===i||i===-1,"Invalid indent step."),f.each(l,function(b){if(b instanceof d){var e=b.getBlockStyle("text-indent");1===i?e+=1:e-=1,e<0&&(e=0),a._applyCommandToComposite(new c({block:b,args:{name:"text-indent",value:e}}))}})}})}({}),yne_common_commands_note_ReplaceBlock=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"ReplaceBlock",_note:null,_args:null,_oldBlock:null,initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a=this,b=a._note,c=a._args,d=c.index,e=c.block;return a._oldBlock=b.replace(d,e),!0},doUnapply:function(){var a=this,b=a._note,c=a._args,d=c.index,e=a._oldBlock;b.replace(d,e)}})}({}),yne_common_commands_note_ReplaceListItemWithParagraph=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_selection_NoteRange,d=yne_common_data_Paragraph,e=yne_common_selection_ParagraphRange,f=yne_common_commands_note_ReplaceBlock,g=yne_jtk_core_assert,h=yne_underscore;return b.extend({name:"ReplaceListItemWithParagraph",_note:null,_args:null,_newParagraph:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,i=a._args,j=i.range,k=j.block,l=a._newParagraph;g("list-item"===k.getType(),'block must be of type "list-item"'),l||(l=new d,l.setText(k.getText()),h.each(k.getBlockStyles(),function(a,b){l.setBlockStyle(b,a)}),a._newParagraph=l),a._applyCommandToComposite(new f({note:b,args:{index:b.getBlockIndex(k),block:l}}),new c({blockRanges:[new e({block:l,start:j.start,end:j.end})]}))}})}({}),yne_common_commands_list_SetLevel=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"SetLevel",_listItem:null,_args:null,_oldLevel:null,initialize:function(a){var b=this;b._listItem=a.listItem,b._args=a.args},apply:function(){var a=this,b=a._listItem,c=a._args,d=c.level;return a._oldLevel=b.getLevel(),b.setLevel(d),!0},doUnapply:function(){var a=this,b=a._listItem,c=a._oldLevel;b.setLevel(c)}})}({}),yne_common_commands_list_DeleteAtStart=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_ReplaceListItemWithParagraph,d=yne_common_commands_list_SetLevel,e=yne_common_data_ListItem,f=yne_jtk_core_assert;return b.extend({name:"DeleteAtStart",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,g=a._args.range,h=g.block;f(h instanceof e),f(0===g.start&&0===g.end),h.getLevel()<=1?a._applyCommandToComposite(new c({note:b,args:{range:g}})):a._applyCommandToComposite(new d({listItem:h,args:{level:h.getLevel()-1}}))}})}({}),yne_common_commands_note_DeleteBlock=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"DeleteBlock",_note:null,_args:null,_block:null,_blockIndex:null,initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b=this,c=b._note,d=b._args,e=d.block;a=c.getBlockIndex(e),b._block=e,b._blockIndex=a,c.remove(a)},doUnapply:function(){var a=this,b=a._note,c=a._block,d=a._blockIndex;b.insert(d,c)}})}({}),yne_common_selection_ListItemRange=function(a){var b,c=yne_common_selection_ParagraphRange;return b=c.extend({_type:"list-item",initialize:function(){var a=this;c.prototype.initialize.apply(a,arguments)}})}({}),yne_common_selection_rangeUtil=function(a){var b=yne_underscore,c=yne_common_selection_ParagraphRange,d=yne_common_selection_ListItemRange,e=yne_common_selection_ImageRange,f=yne_osTableRange,g=yne_common_selection_AttachmentRange,h=yne_common_selection_HrRange,i=yne_common_selection_UnknownRange,j=yne_jtk_core_L;return{createWholeRangeOfBlock:function(a){if(a&&a.getType){var b,f,g=a.getType();switch(g){case"paragraph":case"list-item":f="paragraph"===g?c:d,b=new f({start:0,end:a.getEndOffset(),block:a});break;case"image":b=new e({block:a});break;default:j.error("block type is not valid!")}return b}},createRangeByBlock:function(a){if(j.log(a),!a||!a.block)return void j.warn("arguments is not valid!");var d,k=a.block,l=k.getType(),m=0,n=0;switch(a=b.extend({allContent:!0,collapseToStart:!1},a),l){case"paragraph":case"list-item":a.allContent?n=k.getEndOffset():a.collapseToStart||(m=k.getEndOffset(),n=m),d=new c({block:k,start:m,end:n});break;case"image":d=new e({block:k});break;case"attachment":d=new g({block:k});break;case"table":d=new f({block:k,type:a.collapseToStart?f.TYPES.FIRST_ROW:f.TYPES.LAST_ROW});break;case"horizontal-line":d=new h({block:k});break;case"unknown":d=new i({block:k});break;default:j.error("block.type ["+l+"] is not valid!")}return d}}}({}),yne_common_commands_utils_CmdUtils=function(a){var b=yne_common_selection_rangeUtil;return{getBackwardBlockRange:function(a,c){var d=a.getPreBlock(c);if(d)return b.createRangeByBlock({block:d,allContent:!1,collapseToStart:!1})},getForwardBlockRange:function(a,c){var d=a.getNextBlock(c);if(d)return b.createRangeByBlock({block:d,allContent:!1,collapseToStart:!0})}}}({}),yne_common_commands_image_Delete=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_DeleteBlock,d=yne_common_selection_NoteRange,e=yne_common_commands_utils_CmdUtils,f=yne_osImage,g=yne_jtk_core_assert,h=yne_jtk_core_L;return b.extend({name:"Delete",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b,i=this,j=i._args,k=i._note,l=j.range,m=l.getStartBlockRange(),n=m.block;g(n instanceof f),b=e.getBackwardBlockRange(k,n)||e.getForwardBlockRange(k,n),b||h.error("pre or next block not found"),a=new d({startRange:b,endRange:b}),i._applyCommandToComposite(new c({note:k,args:{block:n}}),a)}})}({}),yne_common_commands_attachment_Delete=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_DeleteBlock,d=yne_common_selection_NoteRange,e=yne_common_commands_utils_CmdUtils,f=yne_jtk_core_L;return b.extend({name:"Delete",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b,g=this,h=g._args,i=g._note,j=h.range,k=j.getStartBlockRange(),l=k.block;b=e.getBackwardBlockRange(i,l)||e.getForwardBlockRange(i,l),b||f.error("pre or next block not found"),a=new d({startRange:b,endRange:b}),g._applyCommandToComposite(new c({note:i,args:{block:l}}),a)}})}({}),yne_common_commands_table_Delete=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_DeleteBlock,d=yne_common_selection_NoteRange,e=yne_common_commands_utils_CmdUtils,f=yne_jtk_core_L;return b.extend({name:"Delete",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b,g=this,h=g._args,i=g._note,j=h.range,k=j.getStartBlockRange(),l=k.block;b=e.getBackwardBlockRange(i,l)||e.getForwardBlockRange(i,l),b||f.error("pre or next block not found"),a=new d({startRange:b,endRange:b}),g._applyCommandToComposite(new c({note:i,args:{block:l}}),a)}})}({}),yne_common_commands_note_DeleteRange=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_selection_NoteRange,d=yne_common_selection_ParagraphRange,e=yne_common_data_Paragraph,f=yne_common_data_blockTypes,g=yne_common_commands_paragraph_DeleteRange,h=yne_common_commands_note_DeleteBlock,i=yne_common_commands_image_Delete,j=yne_common_commands_attachment_Delete,k=yne_common_commands_table_Delete,l=yne_common_commands_paragraph_Merge,m=yne_underscore,n=yne_jtk_core_assert,o=yne_jtk_core_L;return b.extend({name:"DeleteRange",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a=this,b=a._args.range;return n(!b.isCollapsed()),b.canDrawedByNative()?void(b.isInSingleBlock()?a._deleteSingle():b.isInMultiBlock()?a._deleteMulti():o.error("invalid noteRange")):void a._deleteCustom()},_deleteSingle:function(){var a=this,b=a._args,f=b.range,h=f.getStartBlockRange(),i=h.block;n(i instanceof e),n(h.end>h.start),a._applyCommandToComposite(new g({paragraph:i,args:{range:h}}),new c({blockRanges:[new d({block:i,start:h.start,end:h.start})]}))},_deleteMulti:function(){var a,b,f,i,j,k=this,n=k._note,p=k._args,q=p.range,r=q.getStartBlockRange(),s=r.block,t=[];a=q.getEndBlockRange(),b=a.block,i=s instanceof e,j=b instanceof e,i?k._applyCommandToComposite(new g({paragraph:s,args:{range:r}})):t.push(s),f=n.getInterBlocks(s,b),t=t.concat(f),j?k._applyCommandToComposite(new g({paragraph:b,args:{range:a}})):t.push(b),m.each(t,function(a){k._applyCommandToComposite(new h({note:n,args:{block:a}}))}),i&&j&&k._applyCommandToComposite(new l({note:n,args:{preParagraph:s,paragraph:b}})),i?k.setEndingRange(new c({blockRanges:[new d({block:s,start:r.start,end:r.start})]})):j?k.setEndingRange(new c({blockRanges:[new d({block:b,start:0,end:0})]})):o.error("执行DeleteRange Command时，NoteRange的边界都不在段落中!")},_deleteCustom:function(){var a=this,b=a._note,c=a._args.range,d=c.getStartBlockRange(),e=d.block;f.isImage(e)?a._applyCommandToComposite(new i({note:b,args:{range:c}})):f.isAttachment(e)?a._applyCommandToComposite(new j({note:b,args:{range:c}})):f.isTable(e)?a._applyCommandToComposite(new k({note:b,args:{range:c}})):o.warn("unsupported block type")}})}({}),yne_common_commands_key_Backspace=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_data_Paragraph,d=yne_common_data_ListItem,e=yne_common_selection_ImageRange,f=yne_common_selection_AttachmentRange,g=yne_osTableRange,h=yne_common_selection_NoteRange,i=yne_common_commands_paragraph_DeleteBackward,j=yne_common_commands_paragraph_DeleteAtStart,k=yne_common_commands_note_TextIndent,l=yne_common_commands_list_DeleteAtStart,m=yne_common_commands_note_DeleteRange,n=yne_common_commands_note_DeleteBlock,o=yne_common_data_blockTypes,p=yne_jtk_core_assert,q=yne_jtk_core_L;return b.extend({name:"Backspace",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a=this,b=a._args,c=b.range;c.isCollapsed()?a._deleteBackward():a._deleteRange()},_deleteBackward:function(){var a,b=this,e=b._note,f=b._args.range,g=f.getStartBlockRange(),h=g.block;p(h instanceof c),a=g.start,a>0?b._applyCommandToComposite(new i({block:h,args:{range:g}})):f.isCollapsed()&&0===a&&h.getBlockStyle("text-indent")>0?b._applyCommandToComposite(new k({note:e,args:{range:f,step:-1}})):h instanceof d?b._applyCommandToComposite(new l({note:e,args:{range:g}})):b._deleteAtParagraphStart()},_deleteAtParagraphStart:function(){var a,b,c,d=this,i=d._note,k=d._args.range,l=k.getStartBlockRange(),m=l.block,p=i.getPreBlock(m);if(!p)return void q.log("caret at start of note");switch(a=p.getType()){case o.PARAGRAPH:case o.LIST_ITEM:d._applyCommandToComposite(new j({note:i,args:{range:l}}));break;case o.IMAGE:d.setEndingRange(new h({blockRanges:[new e({block:p})]}));break;case o.ATTACHMENT:d.setEndingRange(new h({blockRanges:[new f({block:p})]}));break;case o.TABLE:b=new g({block:p,type:g.TYPES.LAST_ROW}),c=new h({startRange:b,endRange:b}),d.setEndingRange(c);break;case o.HR:case o.UNKNOWN:d._applyCommandToComposite(new n({note:i,args:{block:p}}));break;default:q.warn("unsupported block type")}},_deleteRange:function(){var a=this,b=a._note,c=a._args.range;a._applyCommandToComposite(new m({note:b,args:{range:c}}))},getStylesBeforeDelete:function(){return this._args.stylesBeforeDelete}})}({}),yne_osBackspaceCmd=function(a){var b=yne_common_commands_key_Backspace,c=yne_common_commands_paragraph_DeleteAtStart,d=yne_common_commands_note_DeleteBlock,e=yne_common_data_blockTypes,f=yne_jtk_core_L;return b.extend({_deleteAtParagraphStart:function(){var a,b=this,g=b._note,h=b._args.range,i=h.getStartBlockRange(),j=i.block,k=g.getPreBlock(j);if(!k)return void f.log("caret at start of note");switch(a=k.getType()){case e.PARAGRAPH:case e.LIST_ITEM:b._applyCommandToComposite(new c({note:g,args:{range:i}}));break;case e.IMAGE:case e.ATTACHMENT:case e.TABLE:case e.HR:case e.UNKNOWN:b._applyCommandToComposite(new d({note:g,args:{block:k}}));break;default:f.warn("unsupported block type")}}})}({}),yne_common_commands_paragraph_SplitParagraph=function(a){var b=yne_underscore,c=yne_common_commands_SimpleCommand,d=yne_common_data_Paragraph,e=yne_common_data_ListItem,f=yne_common_data_blockTypes;return c.extend({name:"SplitParagraph",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,c=this,g=c._note,h=c._args,i=h.block,j=h.range,k=c._insertedBlock,l=j.start,m=g.getBlockIndex(i);c._start&&(l=c._start),a=i.sliceText(0,l),i.deleteText(0,l),k||(k=f.isListItem(i)?new e({level:i.getLevel(),list:i.getOwnerList()}):new d,k.setText(a),b.each(i.getBlockStyles(),function(a,b){k.setBlockStyle(b,a)}),c._insertedBlock=k,c._splitedInlineStyles=i.getDefaultInlineStyles()),i.setDefaultInlineStyles(h.insertedInlineStyles),k.setDefaultInlineStyles(c._splitedInlineStyles),g.insert(m,k),c._start=l},doUnapply:function(){var a=this,b=a._note,c=a._args,d=c.block,e=a._insertedBlock,f=b.getBlockIndex(e);b.remove(f),d.insertText(0,e.getText()),d.setDefaultInlineStyles(a._splitedInlineStyles),e.setDefaultInlineStyles(c.insertedInlineStyles)}})}({}),yne_common_commands_paragraph_InsertText=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"InsertText",_paragraph:null,_args:null,_isInserted:null,initialize:function(a){var b=this,c=a.paragraph,d=a.args;b._paragraph=c,b._args=d},apply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range.start,e=c.richText;return a._isInserted=b.insertText(d,e),a._isInserted},doUnapply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range.start,e=c.richText.getLength();a._isInserted&&b.deleteText(d,d+e)}})}({}),yne_common_commands_key_InsertLink=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_data_Paragraph,d=yne_common_commands_paragraph_SetStyle,e=yne_common_commands_paragraph_InsertText,f=yne_common_selection_NoteRange,g=yne_common_selection_ParagraphRange,h=yne_common_data_RichText,i=yne_underscore,j={color:"#0000ff",underline:!0};return b.extend({name:"InsertLink",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,b,k,l,m,n,o=this,p=o._args,q=p.range,r=p.src||"";q.canDrawedByNative()&&(b=q.getStartBlockRange(),a=b.block,q.isInSingleBlock()&&a instanceof c&&(b.isCollapsed()?(k=new h({text:r}),l=k.getLength(),k.setStyle(0,l,"href",r),i.each(j,function(a,b){k.setStyle(0,l,b,a)}),n=b.start+l,m=new g({block:a,start:n,end:n}),o._applyCommandToComposite(new e({paragraph:a,args:{range:b,richText:k}}),new f({startRange:m,endRange:m}))):(o._applyCommandToComposite(new d({paragraph:a,args:{range:b,name:"href",value:r,_isToRangeEnd:p._isToRangeEnd}})),i.each(j,function(c,e){o._applyCommandToComposite(new d({paragraph:a,args:{range:b,name:e,value:c,_isToRangeEnd:p._isToRangeEnd}}))}))))}})}({}),yne_common_commands_link_RecognitionLink=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_key_InsertLink,d=yne_common_selection_NoteRange,e=yne_common_selection_ParagraphRange,f=yne_common_commands_link_LinkMatch;return b.extend({name:"RecognitionLink",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){function a(a,b){var f;f=new e({block:l.block,start:a,end:n}),i._applyCommandToComposite(new c({args:{src:b,range:new d({startRange:f,endRange:f})}}))}var b,g,h,i=this,j=i._args,k=j.range,l=k.getStartBlockRange(),m=l.block,n=l.end,o=0;if(m.getText){b=m.getText().toString().slice(0,n),g=b.length-1;for(var p=g;p>0;p--)if(m.getTextStyle("href",p,p+1)[0]){o=p,b=b.slice(p,n);break}h=f.matchEnd(b),h&&h.result&&a(h.result.index+o,h.fullURI)}}})}({}),yne_common_commands_key_Enter=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_DeleteRange,d=yne_common_commands_list_DeleteAtStart,e=yne_common_commands_paragraph_SplitParagraph,f=yne_common_selection_NoteRange,g=yne_common_selection_ParagraphRange,h=yne_common_data_Paragraph,i=yne_common_data_ListItem,j=yne_jtk_core_assert,k=yne_underscore,l=yne_common_commands_link_RecognitionLink;return b.extend({name:"Enter",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,b,m=this,n=m._note,o=m._args,p=o.range;return m._applyCommandToComposite(new l(m.options)),p.isCollapsed()||(m._applyCommandToComposite(new c({note:n,args:{range:p}})),p=m.getEndingRange()),j(p),j(p.isCollapsed()),a=p.getStartBlockRange(),b=a.block,j(b instanceof h),b instanceof i&&b.isEmpty()?void m._applyCommandToComposite(new d({note:n,args:{range:a}})):void m._applyCommandToComposite(new e({note:n,args:{range:a,block:b,insertedInlineStyles:k.clone(o.inlineStyles)}}),new f({blockRanges:[new g({block:b,start:0,end:0})]}))}})}({}),yne_common_commands_note_InsertText=function(a){var b=yne_common_commands_CompositeCommand,c=yne_jtk_core_assert,d=yne_common_data_Paragraph,e=yne_common_selection_NoteRange,f=yne_common_selection_ParagraphRange,g=yne_common_commands_paragraph_InsertText,h=yne_common_commands_note_DeleteRange;return b.extend({name:"InsertText",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b,i,j,k=this,l=k._note,m=k._args,n=m.range,o=m.richText;c(o),n.isCollapsed()||(k._applyCommandToComposite(new h({note:l,args:{range:n}})),n=k.getEndingRange()),c(n),c(n.isCollapsed()),a=n.getStartBlockRange(),b=a.block,c(b instanceof d),j=i=a.start+o.getLength(),k._applyCommandToComposite(new g({paragraph:b,args:{range:a,richText:o}}),new e({blockRanges:[new f({block:b,start:i,end:j})]}))}})}({}),yne_common_commands_key_TextInput=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertText;return b.extend({name:"TextInput",initialize:function(){},apply:function(){var a=this;a._applyCommandToComposite(new c(a.options))}})}({}),yne_common_commands_key_Space=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_link_RecognitionLink,d=yne_common_commands_key_TextInput,e=yne_common_data_RichText;return b.extend({name:"Space",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,f=a._args,g=f.range,h=g.getEndBlockRange(),i=h.block,j=f.inlineStyles,k=new e({text:" "});k.setStyles(0,k.getLength(),j),a._applyCommandToComposite(new c(a.options)),a._applyCommandToComposite(new d({paragraph:i,note:b,args:{range:g,richText:k}}))}})}({}),yne_common_commands_note_IndentOutdent=function(a){var b=yne_underscore,c=yne_common_commands_CompositeCommand,d=yne_common_commands_block_SetBlockStyle,e=yne_common_commands_list_SetLevel,f=yne_common_data_ListItem,g=yne_jtk_core_assert;return c.extend({name:"IndentOutdent",_note:null,_args:null,initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,c,d,e=this,h=e._note,i=e._args,j=i.step,k=i.range,l=k.getStartBlockRange().block,m=!1,n=null;g(1===j||j===-1),k.canDrawedByNative()&&(k.isInMultiBlock()?(a=k.getEndBlockRange().block,c=h.getInterBlocks(l,a,!0)):c=[l],m=b.every(c,function(a,b){if(a instanceof f){if(0===b)return n=a.getOwnerList(),!0;if(a.getOwnerList()===n)return!0}return!1}),m?(d=n.getItems(),0===b.indexOf(d,l)?e._updateBlocksIndentLevel(d,j):e._updateListItemsLevel(c,j)):e._updateBlocksIndentLevel(c,j))},_updateBlocksIndentLevel:function(a,c){var e,f=this;b.each(a,function(a){e=a.getBlockStyle("indent"),!b.isNumber(e)||0===e&&c===-1||(e=e<0?0:e+c,f._applyCommandToComposite(new d({block:a,args:{name:"indent",value:e}})))})},_updateListItemsLevel:function(a,c){var h=this;b.each(a,function(a){var i,j;if(g(a instanceof f),i=a.getLevel(),i+=c,i>=1&&i<=9&&h._applyCommandToComposite(new e({listItem:a,args:{level:i}})),c===-1){if(j=a.getBlockStyle("indent"),!b.isNumber(j)||0===j)return;h._applyCommandToComposite(new d({block:a,args:{name:"indent",value:0}}))}})}})}({}),yne_common_commands_key_Tab=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_IndentOutdent,d=yne_common_commands_note_TextIndent,e=yne_common_data_ListItem,f=yne_common_data_Paragraph,g=yne_common_data_RichText,h=yne_common_commands_note_InsertText,i=yne_jtk_core_assert,j=yne_jtk_core_L,k={INSERT_TEXT:0,INDENT:1,TEXT_INDENT:2},l=function(a){var b,c,d,g,h;return b=a.getStartBlockRange(),c=b.block,a.isInSingleBlock()?(i(c instanceof f),d=b.start,0!==d?k.INSERT_TEXT:(g=b.end,h=c.getLength(),g===h&&g>0?k.INDENT:c instanceof e&&d===g?k.INDENT:c instanceof e||d!==g?k.INSERT_TEXT:k.TEXT_INDENT)):a.isInMultiBlock()?k.INDENT:void j.error("invalid noteRange")};return b.extend({name:"Tab",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,b=this,c=b._args.range;if(c.canDrawedByNative())switch(a=l(c)){case k.INSERT_TEXT:b._insertText();break;case k.INDENT:b._indent();break;case k.TEXT_INDENT:b._indentFirstLine();break;default:j.error("unsupported tab action")}},_insertText:function(){var a,b=this,c=b._note,d=b._args,e=d.inlineStyles;a=new g({text:"\t"}),a.setStyles(0,a.getLength(),e),b._applyCommandToComposite(new h({note:c,args:{range:d.range,richText:a}}))},_indent:function(){var a=this,b=a._note,d=a._args.range;a._applyCommandToComposite(new c({note:b,args:{range:d,step:1}}))},_indentFirstLine:function(){var a=this,b=a._note,c=a._args.range;a._applyCommandToComposite(new d({note:b,args:{range:c,step:1}}))}})}({}),yne_common_commands_key_Indent=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_IndentOutdent;return b.extend({name:"Indent",_note:null,_args:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,d=a._args.range;a._applyCommandToComposite(new c({note:b,args:{range:d,step:1}}))}})}({}),yne_common_commands_key_Outdent=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_IndentOutdent;return b.extend({name:"Outdent",_note:null,_args:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,d=a._args.range;a._applyCommandToComposite(new c({note:b,args:{range:d,step:-1}}))}})}({}),yne_common_commands_paragraph_ForwardDelete=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"ForwardDelete",_paragraph:null,_args:null,_deletedText:null,initialize:function(a){var b=this,c=a.paragraph,d=a.args;b._paragraph=c,b._args=d},apply:function(){var a,b=this,c=b._paragraph,d=b._args,e=d.range,f=e.clone();return f.isCollapsed()&&(f.end=f.start+1),!!(a=c.getRangeText(f))&&(b._deletedText=a,void c.deleteText(f))},doUnapply:function(){var a=this,b=a._paragraph,c=a._args,d=c.range,e=a._deletedText;b.insertText(d.start,e)}})}({}),yne_common_commands_paragraph_ForwardDeleteAtStart=function(a,b,c,d,e,f){return a.extend({name:"ForwardDeleteAtStart",initialize:function(a){var b=this;
b._note=a.note,b._args=a.args},apply:function(){var a=this,g=a._note,h=a._args,i=h.range,j=i.block,k=g.getNextBlock(j);f(j instanceof b),f(k instanceof b),a._applyCommandToComposite(new c({note:g,args:{paragraph:k,preParagraph:j}}),new d({blockRanges:[new e({block:j,start:j.getEndOffset(),end:j.getEndOffset()})]}))}})}(yne_common_commands_CompositeCommand,yne_common_data_Paragraph,yne_common_commands_paragraph_Merge,yne_common_selection_NoteRange,yne_common_selection_ParagraphRange,yne_jtk_core_assert),yne_common_commands_key_Delete=function(a,b,c,d,e,f,g,h,i,j,k,l,m){return a.extend({name:"Delete",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a=this,b=a._args,c=b.range;c.isCollapsed()?a._deleteForward():a._deleteRange()},_deleteForward:function(){var a,b=this,f=b._args.range,g=f.getStartBlockRange(),h=g.block;c(h instanceof d),a=g.start,a<h.getEndOffset()?b._applyCommandToComposite(new e({paragraph:h,args:{range:g}})):b._deleteAtParagraphEnd()},_deleteRange:function(){var a=this,c=a._note,d=a._args.range;a._applyCommandToComposite(new b({note:c,args:{range:d}}))},_deleteAtParagraphEnd:function(){var a,b,c,d=this,e=d._note,n=d._args.range,o=n.getStartBlockRange(),p=o.block,q=e.getNextBlock(p);if(!q)return void m.log("delete at end of note");switch(a=q.getType()){case f.PARAGRAPH:case f.LIST_ITEM:d._applyCommandToComposite(new g({note:e,args:{range:o}}));break;case f.IMAGE:d.setEndingRange(new h({blockRanges:[new i({block:q})]}));break;case f.ATTACHMENT:d.setEndingRange(new h({blockRanges:[new j({block:q})]}));break;case f.TABLE:b=new k({block:q,type:k.TYPES.FIRST_ROW}),c=new h({startRange:b,endRange:b}),d.setEndingRange(c);break;case f.HR:case f.UNKNOWN:d._applyCommandToComposite(new l({note:e,args:{block:q}}));break;default:m.warn("unsupported block type")}}})}(yne_common_commands_CompositeCommand,yne_common_commands_note_DeleteRange,yne_jtk_core_assert,yne_common_data_Paragraph,yne_common_commands_paragraph_ForwardDelete,yne_common_data_blockTypes,yne_common_commands_paragraph_ForwardDeleteAtStart,yne_common_selection_NoteRange,yne_common_selection_ImageRange,yne_common_selection_AttachmentRange,yne_osTableRange,yne_common_commands_note_DeleteBlock,yne_jtk_core_L),yne_osDeleteCmd=function(a){var b=yne_common_commands_key_Delete,c=yne_common_commands_paragraph_ForwardDeleteAtStart,d=yne_common_commands_note_DeleteBlock,e=yne_common_data_blockTypes,f=yne_jtk_core_L;return b.extend({_deleteAtParagraphEnd:function(){var a,b=this,g=b._note,h=b._args.range,i=h.getStartBlockRange(),j=i.block,k=g.getNextBlock(j);if(!k)return void f.log("delete at end of note");switch(a=k.getType()){case e.PARAGRAPH:case e.LIST_ITEM:b._applyCommandToComposite(new c({note:g,args:{range:i}}));break;case e.IMAGE:case e.ATTACHMENT:case e.TABLE:case e.HR:case e.UNKNOWN:b._applyCommandToComposite(new d({note:g,args:{block:k}}));break;default:f.warn("unsupported block type")}}})}({}),yne_common_commands_block_InsertBlock=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({initialize:function(a){var b=this;b._note=a.note,b._block=a.args.block,b._index=a.args.index},apply:function(){var a=this;a._note.insert(a._index,a._block)},doUnapply:function(){var a=this;a._note.remove(a._index)}})}({}),yne_common_commands_block_InsertBlocks=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_block_InsertBlock;return b.extend({initialize:function(a){var b=this;b._note=a.note,b._blocks=a.args.blocks,b._index=a.args.index},apply:function(){var a=this,b=a._note,d=a._blocks,e=a._index;d.forEach(function(d){a._applyCommandToComposite(new c({note:b,args:{block:d,index:e++}}))})}})}({}),yne_common_commands_note_InsertBlocks=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_DeleteRange,d=yne_common_commands_note_DeleteBlock,e=yne_common_commands_block_InsertBlocks,f=yne_common_commands_paragraph_SplitParagraph,g=yne_common_selection_NoteRange,h=yne_common_selection_ParagraphRange,i=yne_common_commands_paragraph_InsertText,j=yne_common_data_List,k=yne_common_data_Paragraph,l=yne_common_data_blockTypes,m=yne_underscore,n=yne_jtk_core_L,o=function(a,b,c){var d,e,f=0;l.isListItem(b)&&l.isListItem(c)&&(e=c.getOwnerList().getId(),d=b.getOwnerList(),f=b.getLevel()-c.getLevel()),m.chain(a).groupBy(function(a){if(l.isListItem(a))return a.getOwnerList().getId()}).each(function(a,b){var c;"undefined"!==b&&a.length>0&&(d&&b===e?m.each(a,function(a){0!==f&&a.setLevel(a.getLevel()+f),a.setOwnerList(d)}):(c=new j({type:a[0].getListType()}),m.each(a,function(a){a.setOwnerList(c)})))})};return b.extend({name:"InsertBlocks",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,b,d,e,f=this,g=f._note,h=f._args,i=h.range,j=h.blocks;if(i.isCollapsed()||(f._applyCommandToComposite(new c({note:g,args:{range:i}})),i=f.getEndingRange()),!m.isEmpty(j)){if(a=i.getStartBlockRange(),b=a.block,!l.isParagraph(b))return o(j),void f._insertBlocksAndSetEndingRange(j,b);if(d=a.end,e=b.getLength(),e<=0)f._insertAtEmptyParagraph(b,0,j);else if(d===e)f._insertAtParagraphEnd(b,d,j);else if(0===d)f._insertAtParagraphStart(b,0,j);else{if(!(d>0&&d<e))return void n.error("Invaid ParagraphRange for InsertBlocks Command");f._insertAtParagraphMiddle(b,d,j)}}},_insertAtEmptyParagraph:function(a,b,c){var e=this,f=e.options,g=m.first(c),h=l.getType(a)===l.PARAGRAPH&&l.isListItem(g);l.isParagraph(g)&&!h?e._insertAtParagraphEnd(a,b,c):(e._insertBlocksAndSetEndingRange(c,a),f.keepBlock||e._applyCommandToComposite(new d({note:e._note,args:{block:a}})))},_insertAtParagraphEnd:function(a,b,c){var d=this,e=m.first(c),f=b;return l.isParagraph(e)&&(f=d._insertParagraphContent(a,b,e),c.shift(),m.isEmpty(c))?void d._setEndingRangeAtParagraph(a,f):(o(c,a,e),void d._insertBlocksAndSetEndingRange(c,a))},_insertAtParagraphStart:function(a,b,c){var d,e=this,f=e._note,g=m.last(c),h=b;l.isParagraph(g)&&(h=e._insertParagraphContent(a,b,g),c.pop()),m.isEmpty(c)||(o(c,a,g),d=f.getBlockIndex(a),e._insertBlocksAtIndex(c,d)),e._setEndingRangeAtParagraph(a,h)},_insertAtParagraphMiddle:function(a,b,c){var d,e,g,h,i,j=this,k=j._note,n=b;return g=m.first(c),1===c.length&&l.isParagraph(g)?(n=j._insertParagraphContent(a,b,g),void j._setEndingRangeAtParagraph(a,n)):(j._applyCommandToComposite(new f({note:k,args:{range:{block:a,start:b,end:b},block:a}})),d=k.getPreBlock(a),e=a,n=0,l.isParagraph(g)&&(j._insertParagraphContent(d,b,g),c.shift()),h=m.last(c),l.isParagraph(h)&&(n=j._insertParagraphContent(e,0,h),c.pop()),o(c,a,g),i=k.getBlockIndex(d)+1,j._insertBlocksAtIndex(c,i),void j._setEndingRangeAtParagraph(e,n))},_insertParagraphContent:function(a,b,c){var d=c.getText(),e=b+d.getLength();return this._applyCommandToComposite(new i({paragraph:a,args:{range:{start:b,end:b},richText:d}})),e},_insertBlocksAndSetEndingRange:function(a,b){var c,d,e=this,f=e._note;c=f.getBlockIndex(b)+1,d=m.last(a),l.isParagraph(d)||(d=new k,a.push(d)),e._insertBlocksAtIndex(a,c),e._setEndingRangeAtParagraph(d,d.getLength())},_insertBlocksAtIndex:function(a,b){var c=this,d=c._note;c._applyCommandToComposite(new e({note:d,args:{blocks:a,index:b}}))},_setEndingRangeAtParagraph:function(a,b){this.setEndingRange(new g({blockRanges:[new h({block:a,start:b,end:b})]}))}})}({}),yne_common_commands_key_InsertHorizontalRule=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertBlocks,d=yne_common_data_Hr;return b.extend({name:"InsertHorizontalRule",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,e=a._args,f=e.range;a._applyCommandToComposite(new c({note:b,args:{range:f,blocks:[new d]}}))}})}({}),yne_osInsertImageCmd=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertBlocks,d=yne_osImage,e=yne_common_selection_rangeUtil,f=yne_common_selection_NoteRange,g=yne_common_data_Paragraph;return b.extend({name:"InsertImage",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,b,h,i=this,j=i._note,k=j.getLastBlock(),l=i._args,m=l.range,n=m.getEndBlockRange(),o=n.block,p=l.styles,q=new g,r=!1,s=new d({source:l.src});k&&o&&k.getBlockId()===o.getBlockId()&&(r=!0),a=[s,q],r&&(a.push(new g),b=e.createRangeByBlock({block:q,allContent:!1,collapseToStart:!0}),h=f.create({startRange:b,endRange:b})),p&&q.setDefaultInlineStyles(p),i._applyCommandToComposite(new c({note:j,args:{range:m,blocks:a}}),h)}})}({}),yne_common_commands_key_InsertAttachment=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertBlocks,d=yne_osAttachment,e=yne_common_data_Paragraph;return b.extend({name:"InsertAttachment",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,f=a._args,g=f.range;a._applyCommandToComposite(new c({note:b,args:{range:g,blocks:[new d({source:f.src,resource:f.resource,fileName:f.fileName,fileLength:f.fileLength}),new e]}}))}})}({}),yne_common_commands_key_InsertTable=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertBlocks,d=yne_osTable,e=yne_osTableRange,f=yne_common_selection_NoteRange,g=yne_ytable_client_shared_const,h=function(a,b){for(var c=[];a--;)c[a]=b;return c};return b.extend({name:"InsertTable",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a,b,i,j,k=this,l=k._note,m=k._args,n=m.range,o=m.cols||1,p=m.rows||1;a=new d({data:{widths:h(o,g.DEFAULT_COLUMN_WIDTH),heights:h(p,g.DEFAULT_ROW_HEIGHT),cells:h(o*p,{value:""})}}),b=new e({block:a,type:e.TYPES.FIRST_ROW}),i=new f({startRange:b,endRange:b}),j=new c({note:l,args:{range:n,blocks:[a]}}),k._applyCommandToComposite(j,i)}})}({}),yne_common_commands_note_ApplyInlineStyle=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_paragraph_SetStyle,d=yne_common_data_blockTypes,e=yne_underscore,f=yne_jtk_core_L;return b.extend({name:"ApplyInlineStyle",initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a,b=this,g=b._args,h=b._note,i=g.range,j=g.name,k=g.value,l=i.getStartBlockRange(),m=l.block,n=i.getEndBlockRange(),o=n.block;return i.isCollapsed()?void f.error("invalid noteRange"):(d.isParagraph(m)&&b._applyCommandToComposite(new c({paragraph:l.block,args:{range:l,name:j,value:k}})),void(i.isInMultiBlock()&&(a=h.getInterBlocks(m,o),e.each(a,function(a){d.isParagraph(a)&&b._applyCommandToComposite(new c({paragraph:a,args:{range:{start:a.getStartOffset(),end:a.getEndOffset()},name:j,value:k}}))}),d.isParagraph(o)&&b._applyCommandToComposite(new c({paragraph:o,args:{range:n,name:j,value:k}})))))}})}({}),yne_common_commands_note_ApplyBlockStyle=function(a){var b=yne_underscore,c=yne_common_commands_CompositeCommand,d=yne_common_commands_block_SetBlockStyle,e=yne_jtk_core_L;return c.extend({name:"ApplyBlockStyle",_note:null,_args:null,initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a=this,c=a._args,f=c.range,g=a._note,h=c.name,i=c.value,j=f.getStartBlockRange().block,k=f.getEndBlockRange().block,l=g.getInterBlocks(j,k,!0);return j&&k?void b.each(l,function(b){a._applyCommandToComposite(new d({block:b,args:{name:h,value:i}}))}):void e.error("选区状态不正确")}})}({}),yne_common_commands_note_ReplaceParagraphWithListItem=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_selection_NoteRange,d=yne_common_data_ListItem,e=yne_common_selection_ParagraphRange,f=yne_common_commands_note_ReplaceBlock,g=yne_jtk_core_assert,h=yne_underscore;return b.extend({name:"ReplaceParagraphWithListItem",_note:null,_args:null,_newListItem:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note,i=a._args,j=i.range,k=j.block,l=i.list,m=a._newListItem;g("paragraph"===k.getType(),'block must be of type "paragraph"'),m||(m=new d({list:l}),m.setText(k.getText()),h.each(k.getBlockStyles(),function(a,b){m.setBlockStyle(b,a)}),a._newListItem=m),a._applyCommandToComposite(new f({note:b,args:{index:b.getBlockIndex(k),block:m}}),new c({blockRanges:[new e({block:m,start:j.start,end:j.end})]}))}})}({}),yne_common_commands_list_ToggleType=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"ToggleType",_list:null,_args:null,initialize:function(a){var b=this;b._list=a.list,b._args=a.args},apply:function(){var a=this,b=a._list;return b.isUnordered()?b.setType("ordered"):b.setType("unordered"),!0},doUnapply:function(){this.apply()}})}({}),yne_common_commands_note_InsertList=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_ReplaceParagraphWithListItem,d=yne_common_commands_note_ReplaceListItemWithParagraph,e=yne_common_commands_note_ReplaceBlock,f=yne_common_commands_list_ToggleType,g=yne_common_data_Paragraph,h=yne_common_data_ListItem,i=yne_common_data_List,j=yne_common_selection_NoteRange,k=yne_common_selection_ParagraphRange,l=yne_underscore;return b.extend({name:"InsertList",_note:null,_args:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._args,c=b.range;c.isInSingleBlock()?a._applySingle():a._applyMultiple()},_applySingle:function(){var a,b,e,g=this,h=g._note,j=g._args,k=j.range,l=j.type,m=k.getStartBlockRange(),n=m.block,o=n.getType();switch(o){case"paragraph":e=(a=h.getPreBlock(n))&&"list-item"===a.getType()&&a.getOwnerList().getType()===l?a.getOwnerList():(b=h.getNextBlock(n))&&"list-item"===b.getType()&&b.getOwnerList().getType()===l?b.getOwnerList():new i({type:l}),g._applyCommandToComposite(new c({note:h,args:{range:m,list:e}}));break;case"list-item":e=n.getOwnerList(),e.getType()!==l?g._applyCommandToComposite(new f({list:e})):g._applyCommandToComposite(new d({note:h,args:{range:m}}))}},_applyMultiple:function(){var a,b,c,d,f,m,n,o,p,q,r=this,s=r._note,t=r._args,u=t.range,v=t.type,w=u.getStartBlockRange(),x=w.block,y=u.getEndBlockRange(),z=y.block,A=s.getInterBlocks(x,z,!0),B=s.getBlockIndex(x),C=A.length,D=null,E="do-nothing";for(b=0;b<C;++b)if(c=A[b],d=c.getType(),"paragraph"===d||"list-item"===d){if("paragraph"===d){E="make-new-list";break}if(f=c.getOwnerList(),f.getType()!==v&&(E="make-new-list"),D&&D!==f){E="make-new-list";break}D=f}switch(D&&D.getType()===v?E="cancel-list":D&&(E="make-new-list"),E){case"make-new-list":m=(a=s.getPreBlock(x))&&"list-item"===a.getType()&&a.getOwnerList().getType()===v?a.getOwnerList():new i({type:v}),n=[],l.each(A,function(a,b){var c=a.getType(),d=null,f=1;"paragraph"!==c&&"list-item"!==c||("list-item"===c&&(f=a.getLevel()),d=new h({list:m,level:f}),l.each(a.getBlockStyles(),function(a,b){d.setBlockStyle(b,a)}),d.setText(a.getText()),r._applyCommandToComposite(new e({note:s,args:{index:B+b,block:d}}))),n.push(d)});break;case"cancel-list":n=[],l.each(A,function(a,b){var c=null;"list-item"===a.getType()&&(c=new g,c.setText(a.getText()),l.each(a.getBlockStyles(),function(a,b){c.setBlockStyle(b,a)}),r._applyCommandToComposite(new e({note:s,args:{index:B+b,block:c}}))),n.push(c)})}n&&(o=n[0],p=n[n.length-1],q=new j({blockRanges:[new k({block:o||x,start:w.start,end:w.end}),new k({block:p||z,start:y.start,end:y.end})]}),r.setEndingRange(q))}})}({}),yne_common_commands_note_InsertOrderedList=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertList;return b.extend({name:"InsertOrderedList",_note:null,_args:null,_noteRange:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note;a._applyCommandToComposite(new c({note:b,args:{range:a._args.range,type:"ordered"}}))}})}({}),yne_common_commands_note_InsertUnorderedList=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_InsertList;return b.extend({name:"InsertUnorderedList",_note:null,_args:null,_noteRange:null,initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._note;a._applyCommandToComposite(new c({note:b,args:{range:a._args.range,type:"unordered"}}))}})}({}),yne_common_commands_key_RemoveFormat=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_data_supportedInlineStyles,d=yne_common_commands_note_ApplyInlineStyle,e=yne_common_commands_block_SetBlockStyle,f=yne_common_data_Paragraph,g=yne_underscore,h=function(a){var b=a.block;return!(b instanceof f)||0===a.start&&a.end===b.getLength()};return b.extend({name:"RemoveFormat",initialize:function(a){this.note=a.note,this.args=a.args},apply:function(){var a,b,f,i,j,k,l=this,m=l.note,n=l.args,o=n.range;o.isCollapsed()||(a=o.getStartBlockRange(),b=a.block,f=o.getEndBlockRange(),i=f.block,k=c.getAllConfig(["href"]),g.each(k,function(a,b){l._applyCommandToComposite(new d({note:m,args:g.extend(n,{name:b,value:a.default})}))}),j=m.getInterBlocks(b,i),h(a)&&j.unshift(b),b!==i&&h(f)&&j.push(i),g.each(j,function(a){g.each(a.getDefaultBlockStyles(),function(b,c){l._applyCommandToComposite(new e({block:a,args:{name:c,value:b}}))})}))}})}({}),yne_common_commands_key_FormatPainter=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_key_RemoveFormat,d=yne_common_commands_note_ApplyInlineStyle,e=yne_common_commands_note_ApplyBlockStyle,f=yne_common_constants,g=yne_underscore;return b.extend({name:"FormatPainter",initialize:function(a){this._note=a.note,this._args=a.args},apply:function(){var a=this,b=a._note,h=a._args,i=h.range,j=h.data,k=j.inlineStyles,l=j.blockStyles;i.isCollapsed()||(a._applyCommandToComposite(new c({note:b,args:{range:i}})),k=g.omit(k,"href"),g.each(k,function(c,e){c&&c!==f.INTERM&&a._applyCommandToComposite(new d({note:b,args:{range:i,name:e,value:c}}))}),g.each(l,function(c,d){c&&c!==f.INTERM&&a._applyCommandToComposite(new e({note:b,args:{range:i,name:d,value:c}}))}))}})}({}),yne_common_commands_image_ReplaceSrc=function(a){var b=yne_common_commands_SimpleCommand,c=b.extend({name:"ReplaceSrc",_image:null,_oldSrc:null,_isChanged:null,initialize:function(a){var b=this;b._args=a.args,b._image=a.args.image},apply:function(){var a=this,b=a._args,c=b.image;c&&c.setSource&&b&&b.src&&(a._oldSrc=c.getSource(),a._isChanged=c.setSource(b.src))},doReapply:function(){var a=this;a._isChanged&&a._image.setSource(a._args.src)},doUnapply:function(){var a=this;a._isChanged&&a._image.setSource(a._oldSrc)}});return c}({}),yne_common_commands_image_Replace=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_image_ReplaceSrc,d=yne_jtk_core_L,e=b.extend({name:"Replace",initialize:function(){},apply:function(){var a=this,b=a.options,e=b.args;e&&(e.src&&a._applyCommandToComposite(new c(b)),e.styles&&d.log("TODO"))}});return e}({}),yne_common_commands_attachment_ReplaceSource=function(a,b){return a.extend({name:"Replace",_attach:null,_isChanged:null,_oldSrc:null,_oldResource:null,_oldFileName:null,_oldFileLength:null,initialize:function(a){var b=this;b._args=a.args,b._attach=a.args.attachment},apply:function(){var a=this,c=a._args,d=c.attachment;b.some([d,c.src,c.resource],b.isUndefined)||(a._oldSrc=d.getSource(),a._oldResource=d.getResource(),a._oldFileName=d.getFileName(),a._oldFileLength=d.getFileLength(),a._isChanged=d.setSource(c.src)&&d.setResource(c.resource),c.fileName&&d.setFileName(c.fileName),c.fileLength&&d.setFileLength(c.fileLength))},doReapply:function(){var a=this,b=a._args,c=a._attach;a._isChanged&&(c.setSource(b.src),c.setResource(b.resource),c.setFileName(b.fileName),c.setFileLength(b.fileLength))},doUnapply:function(){var a=this,b=a._attach;a._isChanged&&(b.setSource(a._oldSrc),b.setResource(a._oldResource),b.setFileName(a._oldFileName),b.setFileLength(a._oldFileLength))}})}(yne_common_commands_SimpleCommand,yne_underscore),yne_common_commands_attachment_Replace=function(a,b){return a.extend({name:"Replace",initialize:function(){},apply:function(){var a=this,c=a.options,d=c.args;d&&d.src&&d.resource&&a._applyCommandToComposite(new b(c))}})}(yne_common_commands_CompositeCommand,yne_common_commands_attachment_ReplaceSource),yne_common_commands_note_DragBlocks=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_DeleteRange,d=yne_common_commands_note_InsertBlocks;return b.extend({initialize:function(a){var b=this,c=a.note,d=a.args;b._note=c,b._args=d},apply:function(){var a=this,b=a._args,e=a._note,f=b.range,g=b.dropRange,h=f.getStartBlockRange(),i=b.blocks,j=h.end-h.start;a._applyCommandToComposite(new c({note:e,args:{range:f}})),g.block===h.block&&h.end<g.start&&(g.start-=j,g.end-=j),f.setBlockRanges([g]),a._applyCommandToComposite(new d({note:e,args:{range:f,blocks:i}}))}})}({}),yne_common_commands_key_InsertDate=function(a){var b=yne_underscorestring,c=yne_common_commands_CompositeCommand,d=yne_common_commands_key_TextInput,e=yne_common_data_RichText,f=function(a){return b.pad(a,2,"0","left")};return c.extend({name:"insertDate",initialize:function(a){var b=this;b._note=a.note,b._args=a.args},apply:function(){var a=this,b=a._args,c=b.range,g=b.inlineStyles,h=new Date,i=h.getFullYear()+"/"+f(h.getMonth()+1)+"/"+f(h.getDate())+" "+f(h.getHours())+":"+f(h.getMinutes()),j=new e({text:" "+i+" "});j.setStyles(0,j.getLength(),g),a._applyCommandToComposite(new d({args:{range:c,richText:j}}))}})}({}),yne_common_commands_note_SetCellValue=function(a){var b=yne_common_commands_SimpleCommand;return b.extend({name:"SetCellValue",_args:null,_table:null,initialize:function(a){var b=this;b._table=a.table,b._args=a.args},apply:function(){var a=this,b=a._table,c=a._args,d=c.uid,e=b.getCellByUID(d),f=e.value,g={uid:d,stringValue:f||""};a._oldArgs||(a._oldArgs=g),b.setCellValue(c)},doUnapply:function(){var a=this,b=a._table;b.setCellValue(a._oldArgs)}})}({}),yne_common_commands_table_SetCellValue=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_note_SetCellValue;return b.extend({name:"setCellValue",_table:null,_args:null,initialize:function(a){var b=this,c=a.note,d=a.args;b._table=c.getBlockById(d.tableId),b._args=d},apply:function(){var a,b,d=this,e=d._args,f=d._table,g=e.stringValue;a=f.getCellByUID(e.uid),a&&(b=a.value),b===g?d.effected=!1:d._applyCommandToComposite(new c({args:e,table:f}),e.range),d.setEndingRange(e.endNoteRange)}})}({}),yne_common_commands_CommandFactory=function(a){var b=yne_jtk_core_Class,c=yne_jtk_core_L,d={backspace:yne_osBackspaceCmd,enter:yne_common_commands_key_Enter,space:yne_common_commands_key_Space,textInput:yne_common_commands_key_TextInput,deleteRange:yne_common_commands_note_DeleteRange,tab:yne_common_commands_key_Tab,indent:yne_common_commands_key_Indent,outdent:yne_common_commands_key_Outdent,delete:yne_osDeleteCmd,insertHorizontalRule:yne_common_commands_key_InsertHorizontalRule,insertImage:yne_osInsertImageCmd,insertAttachment:yne_common_commands_key_InsertAttachment,insertTable:yne_common_commands_key_InsertTable,insertLink:yne_common_commands_key_InsertLink,applyInlineStyle:yne_common_commands_note_ApplyInlineStyle,applyBlockStyle:yne_common_commands_note_ApplyBlockStyle,insertOrderedList:yne_common_commands_note_InsertOrderedList,insertUnorderedList:yne_common_commands_note_InsertUnorderedList,insertBlocks:yne_common_commands_note_InsertBlocks,removeFormat:yne_common_commands_key_RemoveFormat,formatPainter:yne_common_commands_key_FormatPainter,replaceImage:yne_common_commands_image_Replace,replaceAttachment:yne_common_commands_attachment_Replace,dragBlocks:yne_common_commands_note_DragBlocks,recognitionLinks:yne_common_commands_link_RecognitionLink,insertDate:yne_common_commands_key_InsertDate,setCellValue:yne_common_commands_table_SetCellValue};return b.extend({initialize:function(){},create:function(a,b,e){var f,g=null;return a+="",f=d[a],f?(g=new f({note:b,args:e}),g.isSimple||(g.setStartingRange(e.range),g.setEndingRange(e.range))):c.warn("No class for `"+a+"` command"),g}})}({}),yne_mobile_core_Controller=function(a){var b,c,d=yne_jtk_core_Class,e=yne_common_selection_NoteSelection,f=yne_common_selection_SelectionChangeEvent,g=yne_common_commands_CommandManager,h=yne_common_commands_CommandFactory,i=yne_common_selection_NoteRange,j=yne_common_data_RichText,k=yne_parser_Parser,l=yne_common_data_Paragraph,m=yne_common_constants,n=yne_underscore,o=yne_jtk_core_L,p=yne_backbone,q=yne_common_selection_rangeUtil,r=yne_common_data_blockTypes,s=yne_common_data_supportedInlineStyles,t=yne_common_data_supportedBlockStyles,u=yne_parser_html_utils_convertColor,v=yne_osTableRange,w={"(":")","{":"}","[":"]","<":">","'":"'",'"':'"',"《":"》","〔":"〕","【":"】","「":"」","『":"』","（":"）","〖":"〗","〈":"〉","［":"］","‘":"’","“":"”","｛":"｝"},x=n.map(w,function(a,b){return b+a}),y=100,z=100;return c={note:null,noteSelection:null,_isReadOnly:!1,_expectedPairEndChar:null,_rangeAtPairStart:null,_timeAtPairStart:0,initialize:function(a){var b=this,c=a.noteView;b.cmdManager=new g,b.cmdFactory=new h,n.bindAll(b,"onUpdateSelection","_onSelectionChange","_onDeleteSelection","_onKey","_onTextInput","onCommand","_onCopy","_onCut","onPaste"),b.setOptions(a),b.noteView=c,b.noteSelection=new e({noteView:c}),b._bindEvents()},reset:function(){var a=this;a.cmdManager&&a.cmdManager.reset(),a.noteSelection&&a.noteSelection.reset(),a._isReadOnly=!1},setOptions:function(a){var b=this;b._unbindNoteEvents(),b.reset(),b.note=a.note,b._bindNoteEvents()},_bindNoteEvents:function(){var a=this,b=a.note,c=["insert-block","remove-block"];b&&n.each(c,function(c){b.on(c,a.trigger.bind(a,c))})},_unbindNoteEvents:function(){this.note&&this.note.off()},_bindEvents:function(){var a=this,b=a.cmdManager,c=a.noteView;b.on("update-selection",a.onUpdateSelection),b.on("command-exec",a.trigger.bind(a,"command-exec")),a.noteSelection.on("selection-change",a._onSelectionChange),c.on("delete-selection",a._onDeleteSelection),c.on("text-input",a._onTextInput),c.on("key-pressed",a._onKey),c.on("command",a.onCommand),c.on("copy",a._onCopy),c.on("cut",a._onCut),c.on("paste",a.onPaste),c.on("selectstart",a.trigger.bind(a,"selectstart")),c.on("blur",a.trigger.bind(a,"blur")),c.on("open-link",a.trigger.bind(a,"yne-open-link")),c.on("click-image",a.trigger.bind(a,"click-image")),c.on("click-attachment",a.trigger.bind(a,"click-attachment")),c.on("get-editing-styles",function(b){b(a.editingInlineStates)}),c.on("get-note-range",function(b){var c=a.getNoteRange();c&&c.clone&&b(c.clone(!0))}),c.on("tricky-backspace",function(b){b&&a.execDeleteBackward(b)})},execCommand:function(a,b){var c,d,e=this,f=e.cmdManager;if(!e.isReadOnly())return"applyInlineStyle"===a&&(d=e.getNoteRange(),d.isCollapsed())?void e.setEditingInlineState(b.name,b.value):("insertImage"===a&&(d=e.getNoteRange(),b.styles=e.queryInsertPositionInlineStyles(d)),c=e._createCmd(a,b),!!c&&f.exec(c))},_createCmd:function(a,b){var c=this,d=c.cmdFactory;if(b=b||{},b.range=b.range||c.getNoteRange(),b.range)return d.create(a,c.note,b)},undo:function(){var a=this,b=a.cmdManager;return b.undo()},redo:function(){var a=this,b=a.cmdManager;return b.redo()},canUndo:function(){var a=this,b=a.cmdManager;return b.canUndo()},canRedo:function(){var a=this,b=a.cmdManager;return b.canRedo()},_onSelectionChange:function(a){var b,c,d,e=this,f=e.getNoteRange();f&&(e._lastNoteRange=f),a&&(c=a.getData(),c&&"Backspace"===c.cmdName&&(d=c.cmd,d&&d.getStylesBeforeDelete()&&(b=d.getStylesBeforeDelete()))),e.updateSelectionStates(b)},_onDeleteSelection:function(){var a=this,b=a.getNoteRange();b.isCollapsed()||a.execCommand("deleteRange",{range:b})},onUpdateSelection:function(a,b){var c,d,e,g,h,i,j=this,k={};if("Backspace"===b.cmdName&&b.cmd&&b.cmd.getStylesBeforeDelete()&&(c=f.createCommandTypeEvent(b)),j.noteSelection.setRange(a,c),b&&(d=b.cmd,d&&"setCellValue"===d.name)){if("undo"===b.cmdType?e=d.getStartingRange():"redo"===b.cmdType&&(e=d.getEndingRange()),!e)return;g=e.getStartBlockRange(),h=g.block,e.isInSingleBlock()&&r.isTable(h)&&(i=h.getCellByUID(g.uid),k.stringValue=i.value,k.hasImage=!1,k.tableId=h.getBlockId(),k.uid=g.uid,h.getNextDownCellByUID(k.uid)?k.isLastRow=!1:k.isLastRow=!0,j.trigger("enter-table-cell",k))}},getNoteRange:function(){var a=this,b=a.noteSelection.getRange();return b},_onKey:function(a,b){var c,d=this,e=d.noteView;if(d.isReadOnly())return void b.preventDefault();switch(e&&(e.directionKeyJustMoved=!1),a){case"backspace":e._isOnComposition||(b.preventDefault(),d.execDeleteBackward());break;case"del":b.preventDefault(),d.execDeleteForward();break;case"enter":b.preventDefault(),d._enterKeyDown();break;case"tab":b.preventDefault(),d._tabKeyDown();break;case"space":b.preventDefault(),d._spaceKeyDown();break;case"mod+z":b.preventDefault(),d.undo();break;case"mod+y":case"mod+shift+z":b.preventDefault(),d.redo();break;case"mod+shift+r":o.DEBUG&&(window.clearJstCache&&(window.clearJstCache(),window.alert("Clear JST cache... Done!")),c=window.location.href,window.location.href=c);break;case"mod+b":b.preventDefault(),d.toggleInlineStyle("bold");break;case"mod+i":b.preventDefault(),d.toggleInlineStyle("italic");break;case"mod+u":b.preventDefault(),d.toggleInlineStyle("underline");break;case"left":case"up":e&&(e.directionKeyJustMoved=!0),d._moveCaretWithDirection(!1,b);break;case"right":case"down":e&&(e.directionKeyJustMoved=!0),d._moveCaretWithDirection(!0,b);break;case"esc":d.trigger("esc");break;case"mod+s":b.preventDefault(),d.trigger("yne-save-content")}},execDeleteBackward:function(a){var b,c,d=this;return(a=a||d.getNoteRange())?(a&&a._startRange&&(b=a._startRange,b&&b.block instanceof l&&!b.block.isEmpty()&&b.end>0&&(b=b.clone(),b.start===b.end&&b.start--,c=this.querySelectionInlineStyles(new i({startRange:b,endRange:b})))),void d.execCommand("backspace",{range:a,stylesBeforeDelete:c})):void o.error("noteRange not found")},execDeleteForward:function(){var a=this,b=a.getNoteRange();return b?void a.execCommand("delete"):void o.error("noteRange not found")},_enterKeyDown:function(){this.execCommand("enter",{inlineStyles:this.queryInsertPositionInlineStyles()})},_tabKeyDown:function(){var a,b=this;a=b.queryInsertPositionInlineStyles(),b.execCommand("tab",{inlineStyles:a})},_spaceKeyDown:function(){var a,b=this;a=b.queryInsertPositionInlineStyles(),b.execCommand("space",{inlineStyles:a})},_onTextInput:function(a){var b,c=this;return c._insertText(a),1!==a.length?(c._expectedPairEndChar=null,c._rangeAtPairStart=null,void(2===a.length&&x.indexOf(a)>-1&&c._relocateRangeAfterInputPairs())):a===c._expectedPairEndChar?(Date.now()-c._timeAtPairStart<y&&c._relocateRangeAfterInputPairEndChar(),c._expectedPairEndChar=null,void(c._rangeAtPairStart=null)):(c._rangeAtPairStart=null,c._expectedPairEndChar=w[a],void(c._expectedPairEndChar&&(b=c.noteSelection.getRange(),b&&(c._rangeAtPairStart=b.clone(!0),c._timeAtPairStart=Date.now()))))},_relocateRangeAfterInputPairEndChar:function(){var a=this,b=a._rangeAtPairStart;b&&window.setTimeout(function(){a.noteSelection.setRange(b)},z)},_relocateRangeAfterInputPairs:function(){var a,b,c,d=this,e=d.getNoteRange();e&&(a=e.clone(!0),a.isCollapsed()&&(b=a.getStartBlockRange(),b&&b.setStartAndEnd&&(c=b.start-1,b.setStartAndEnd(c,c),window.setTimeout(function(){d.noteSelection.setRange(a)},z))))},_insertText:function(a){var b,c,d=this,e=d.getNoteRange();o.log("===> insertText...",a),c=d.queryInsertPositionInlineStyles(e),b=new j({text:a}),b.setStyles(0,b.getLength(),c),d.execCommand("textInput",{range:e,richText:b})},_moveCaretWithDirection:function(a,b){var c,d,e,f,g,h,j,k,l,m=this;return c=m.getNoteRange(),!c||(k=c.canDrawedByNative())?(l=c?"The noteRange can be drawed by native selection!":"The noteRange is null!",void o.warn(l)):(e=c.getStartBlockRange(),d=e.block,void((r.isImage(d)||r.isAttachment(d)||r.isTable(d)||r.isHr(d)||r.isUnknown(d))&&(a?(f=m._getNextCaretBlock(d),g=!0):(f=m._getPreCaretBlock(d),g=!1),f?(h=q.createRangeByBlock({block:f,allContent:!1,collapseToStart:g}),j=new i({startRange:h,endRange:h}),m.noteSelection.setRange(j,!0),b&&b.preventDefault()):a&&m.noteView.focusLastBlankLine())))},_getNextCaretBlock:function(a){for(var b=this.note.getNextBlock(a);b&&!this._isCaretBlock(b);)b=this.note.getNextBlock(b);
return b},_getPreCaretBlock:function(a){for(var b=this.note.getPreBlock(a);b&&!this._isCaretBlock(b);)b=this.note.getPreBlock(b);return b},_isCaretBlock:function(a){return r.isParagraph(a)||r.isImage(a)||r.isAttachment(a)||r.isTable(a)},toggleInlineStyle:function(a){var b,c=this,d=c.getNoteRange();return d?(d.isCollapsed()?b=!c.editingInlineStates[a]:(b=c.querySelectionInlineStyle(a),b=b!==!0),void c.execCommand("applyInlineStyle",{name:a,value:b})):void o.warn("noteRange not found")},updateEditingInlineStates:function(a){var b=this;b.editingInlineStates=a,b.isLinkStylesChanged=!1},toggleEditingInlineState:function(a){var b=this,c=!b.editingInlineStates[a];b.editingInlineStates[a]=c,b.trigger("yne-editing-state-change",a,c),b.isLinkStylesChanged=b._isLinkStyles(a)},setEditingInlineState:function(a,b){var c=this;c.editingInlineStates[a]=b,c.trigger("yne-editing-state-change",a,b),c.isLinkStylesChanged=c._isLinkStyles(a)},_isLinkStyles:function(a){return n.contains(["color","underline"],a)},updateSelectionStates:function(a){var b,c=this,d=c.noteSelection.getRange();b=a||c.querySelectionInlineStyles(d),c.updateEditingInlineStates(b),c.trigger("yne-selection-change",a)},queryInsertPositionInlineStyles:function(a){var b,c,d,e,f=this;if(a=a||f.getNoteRange(),!a)return void o.error("noteRange is null");if(a.isCollapsed())e=f.editingInlineStates||f.querySelectionInlineStyles(a);else{if(b=a.getStartBlockRange(),c=b.block,!r.isParagraph(c))return null;d=b.clone(),d.collapse(),c.getEndOffset()>d.end&&d.end++,e=c.getCommonStyles(d)}return e.href&&f._isPartlyOverlapWithAnchor(a)&&(e.href=void 0,f.isLinkStylesChanged||(e.color="black",e.underline=!1)),e},_isPartlyOverlapWithAnchor:function(a){var b,c,d,e,f,g,h;return!!a.isInSingleBlock()&&(b=a.getStartBlockRange(),c=b.block,c instanceof l&&(d=b.start,e=b.end,d===e?(d>0&&(g=c.getTextStyle("href",d-1,d)[0]),d<c.getLength()&&(h=c.getTextStyle("href",d,d+1)[0]),(g||h)&&g!==h):(f=c.getCommonStyle("href",{start:d,end:e}),f&&f===m.INTERM)))},querySelectionInlineStyle:function(a,b){var c=this,d=c.note;return b=b||c.getNoteRange(),b?d.getCommonInlineStyle(b,a):void o.warn("noteRange not found")},querySelectionBlockStyle:function(a,b){var c=this,d=c.note;return b=b||c.getNoteRange(),b?d.getRangeBlockStyle(b,a):void o.warn("noteRange not found")},querySelectionInlineStyles:function(a){var b=this,c={},d=s.getKeys();return(a=a||b.getNoteRange())?(n.each(d,function(d){c[d]=b.querySelectionInlineStyle(d,a)}),c.color&&(c.color=u(c.color)),c):void o.warn("noteRange not found")},querySelectionBlockStyles:function(a){var b,c=this,d={};return(a=a||c.getNoteRange())?(b=t.getAllKeys(),n.each(b,function(b){d[b]=c.querySelectionBlockStyle(b,a)}),d):void o.warn("noteRange not found")},isSameList:function(a){var b=this,c=b.note,d=b.getNoteRange();return!!d&&c.isSameList(d,a)},onCommand:function(a,b){var c=this;c.execCommand(a,b)},_onCut:function(a){var b=this,c=a.originalEvent,d=c.clipboardData,e=b.getNoteRange();a.preventDefault(),o.log("on cut!"),b._setClipboardByRange(e,d),e&&!e.isCollapsed()&&b.execCommand("deleteRange",{range:e})},_onCopy:function(a){var b=this,c=a.originalEvent,d=c.clipboardData,e=b.getNoteRange();a.preventDefault(),o.log("on copy!"),b._setClipboardByRange(e,d)},_setClipboardByRange:function(){o.warn("_setClipboardByRange() should be implemented by subclass!")},onPaste:function(){o.warn("onPaste() should be implemented by subclass!")},_pasteJSON:function(a){var b=this,c=k.parseJSON(a);return c=n.reject(c,b._isAttachmentBlock),b._pasteBlockList(c)},_pasteHTML:function(a){o.log("Paste HTML\n",a);var b=this,c=k.parseHtml(a);return c=n.reject(c,b._isAttachmentBlock),b._pasteBlockList(c)},_pastePlain:function(a){var b=this,c=k.parsePlain(a);return c=n.reject(c,b._isResourceBlock),b._pasteBlockList(c)},_pasteBlockList:function(a){var b=this;if(a&&a.length)return b.execCommand("insertBlocks",{range:b.getNoteRange(),blocks:a}),!0},_isAttachmentBlock:function(a){return r.isAttachment(a)},_isResourceBlock:function(a){return r.isImage(a)||r.isAttachment(a)},selectAll:function(){var a=this,b=a.noteView;return b.onSelectAll()},canRemoveFormat:function(){var a=this,b=a.getNoteRange();return b&&!b.isCollapsed()},focusAtNoteStart:function(){this.noteSelection.setRange(this.getStartNoteRange())},getStartNoteRange:function(){var a,b,c=this,d=c.note.getBlockAt(0);if(d)return a=q.createRangeByBlock({block:d,allContent:!1,collapseToStart:!0}),b=new i({startRange:a,endRange:a})},setReadOnly:function(a){var b=this;a=!!a,b.isReadOnly()!==a&&(b._isReadOnly=a,n.each(["note"],function(c){var d=b[c];d&&d.setReadOnly&&d.setReadOnly(a)}))},isReadOnly:function(){return this._isReadOnly},setCellValue:function(a){var b,c,d,e,f,g=this,h=g.note,j=h.getBlockById(a.tableId),k=a.uid;c=new v({block:j,uid:k}),d=c,a.moveToNext!==!1&&(b=j.getNextDownCellByUID(k),b&&(d=new v({block:j,uid:b}))),e=new i({startRange:c,endRange:c}),f=new i({startRange:d,endRange:d}),a.range=e,a.endNoteRange=f,this.execCommand("setCellValue",a)},setViewportHeight:function(a){var b=this,c=b.noteView,d=b.getNoteRange();c.setViewportHeight(a),c.trigger("resize",d)},setBackground:function(a){var b=this,c=b.noteView;c.setBackground(a)}},n.extend(c,p.Events),b=d.extend(c)}({}),yne_iphone_utils_getPointByChar=function(a){return"A"<=a&&a<="Z"||"a"<=a&&a<="z"||"0"<=a&&a<="9"?".":/^[\u4E00-\u9FA5]$/.test(a)?"。":void 0};yne_osController=function(a){var b=yne_mobile_core_Controller,c=yne_jtk_core_L,d=yne_underscore,e=yne_parser_Parser,f=yne_common_data_blockTypes,g="public.plain-text",h="public.html",i="private.ynote-bulb-json",j=500,k=yne_iphone_utils_getPointByChar,l=yne_mobile_util_keyboardMode;return b.extend({_keyboardMode:l.HIDE,_isTextEditMenuActive:!1,_fixNoteRangeForInputMethod:function(){var a,b,c,d=this,e=d.noteSelection,f=e.getNativeRange(),g=d.getNoteRange(),h=e._convertToNoteRange(f);return!g.isEqual(h)&&(a=g.clone(!0),b=a.getStartBlockRange(),c=h.getStartBlockRange().start,b.setStart(c),d.noteSelection.setRange(a),!0)},_onTextInput:function(a,b){var c=this;b&&c._fixNoteRangeForInputMethod(),c.constructor.__super__._onTextInput.call(c,a)},_bindEvents:function(){var a=this,b=a.noteView,c=["request-image-rendered-src","request-attachment-rendered-src","notify-native-touchstart"];a.constructor.__super__._bindEvents.apply(a,arguments),d.each(c,function(c){b.on(c,a.trigger.bind(a,c))}),b.on("extend-select-character-backward",a._extendSelectionCharacterBackward.bind(a)),b.on("get-note-range",function(b){var c=a.getNoteRange();c&&c.clone&&b(c.clone(!0))}),b.on("get-keyboard-mode",function(b){b(a._keyboardMode)}),b.on("get-text-edit-menu-state",function(b){b(a._isTextEditMenuActive)}),b.on("tricky-backspace",function(b){b&&a.execDeleteBackward(b)})},_extendSelectionCharacterBackward:function(){var a,b=this.getNoteRange();b&&b.isCollapsed()&&(a=b.getStartBlockRange(),a&&a.start>0&&a.start--)},_onSelectionChange:function(){this._lastNoteRange=this.getNoteRange(),this.updateSelectionStates()},_setClipboardByRange:function(a){var b,d,e,f=this,j={};return!a||a.isCollapsed()?void c.log("no note range or note range is collapsed!"):(e=a.getDataAsJSON(f.note,f._isAttachmentBlock),d=a.getDataAsHtml(f.note,f._isAttachmentBlock),b=a.getDataAsPlain(f.note,f._isResourceBlock),j[g]=b,j[h]=d,j[i]=e,void f.trigger("set-clipboard",j))},doPaste:function(a,b){var d=this;a===i?d._pasteJSON(b):a===h?d._pasteHTML(b):a===g?d._pastePlain(b):c.warn("paste with invalid type",a)},_pasteHTML:function(a){c.log("Paste HTML\n",a);var b=this,g=e.parseHtml(a);return g=d.reject(g,function(a){return b._isAttachmentBlock(a)||b._isBlankImageBlock(a)}),d.each(g,function(a){var b,c;(f.isParagraph(a)||f.isListItem(a))&&(b=a.getLength(),c=a.getReadOnlyText(),c.setStyle(0,b,"font-size",null),a.setBlockStyle("line-height",null))}),b._pasteBlockList(g)},_isBlankImageBlock:function(a){return f.isImage(a)&&!a.getSource()},onPaste:function(a){a.preventDefault(),this.trigger("get-clipboard")},focusEditor:function(){var a=this._lastNoteRange||this.getStartNoteRange();this.noteSelection.setRange(a),this.noteView.el.focus()},_spaceKeyDown:function(){var a,b,c=this;if(!c._fixNoteRangeForInputMethod()){if(b=c._fixForDoubleSpace())return c._extendSelectionCharacterBackward(),void c._onTextInput(b);a=c.queryInsertPositionInlineStyles(),c.execCommand("space",{inlineStyles:a})}},_fixForDoubleSpace:function(){var a,b,c,d=this,e=d.getNoteRange(),f=e.getEndBlockRange();if(e.isCollapsed())if(a=(new Date).getTime(),a-d._firstSpaceTime<j){if(b=f.block.getReadOnlyText&&f.block.getReadOnlyText())return c=b.getReadOnlyData()[f.start-2],c&&k(c.toString());delete d._firstSpaceTime}else d._firstSpaceTime=a},setKeyboardMode:function(a){a!==l.HIDE&&a!==l.SHOW||(this._keyboardMode=a)},setTextEditMenuState:function(a){var b=this;a=!!a,b._isTextEditMenuActive=a}})}({});yne_common_core_Editor=function(a){var b,c,d=yne_common_data_Note,e=yne_jtk_core_Class,f=yne_underscore,g=yne_jtk_core_L,h=yne_backbone,i=yne_common_util_unknownInlineStyles,j=yne_common_data_supportedInlineStyles,k=yne_common_data_Rich2HtmlConvertor,l=yne_common_data_blankLine;return c={initialize:function(){g.error("The  initialize method should be implemented by subclass")},reset:function(){var a=this;a.controller&&a.controller.reset(),a.noteView&&a.noteView.reset(),a.note&&(a.note.destroy(),a.note=null),i.reset()},setHtmlContent:function(a){var b,c=this;c.reset(),b=d.fromHtml(a),b||(b=d.createBlank(),g.warn("empty note!")),c.note=b,c.noteView.setOptions({note:b}),c.controller.setOptions({note:b}),c.noteView.render()},setXmlContent:function(a){var b,c=this;c.reset(),b=d.fromXml(a),b||(b=d.createBlank(),g.warn("empty note!")),c.note=b,c.noteView.setOptions({note:b}),c.controller.setOptions({note:b}),c.noteView.render()},setTextContent:function(a){var b,c=this;c.reset(),b=d.fromPlain(a),b||(b=d.createBlank(),g.warn("empty note!")),c.note=b,c.noteView.setOptions({note:b}),c.controller.setOptions({note:b}),c.noteView.render()},getXmlContent:function(){var a=this;return a.note.toXml()},getHtmlContent:function(){var a=this;return a.note.toHtml()},getPlainContent:function(a){var b=this;return b.note.toPlain(a)},render:function(){g.error("The  render method should be implemented by subclass")},execCommand:function(a,b){var c=this;return c.controller.execCommand(a,b)},undo:function(){var a=this;return a.controller.undo()},redo:function(){var a=this;return a.controller.redo()},canUndo:function(){var a=this;return a.controller.canUndo()},canRedo:function(){var a=this;return a.controller.canRedo()},selectAll:function(){return this.controller.selectAll()},setReadOnly:function(a){this.controller.setReadOnly(a)},isReadOnly:function(){return this.controller.isReadOnly()},getNoteRange:function(){var a=this,b=a.controller.getNoteRange();return b},getSchemaVersion:function(){return this.note.getSchemaVersion()},setFont:function(a,b){if(a||b){var c,d=this,e={};a&&(c=j.getDefault("font-size"),e["font-size"]=function(b){var d=b["font-size"];if(null!=d)return Math.round(a*d/c)+"px"},k.setCssRules(e),l.reset()),b&&(j.setDefault("font-family",b),k.resetInlineStyleDefaultForHtml("font-family")),d.noteView.reRenderTextBlockView()}},resetFont:function(){var a=this;k.resetCssRules(),l.reset(),j.reset(),a.noteView.reRenderTextBlockView()},countWords:function(){return this.note.countWords()},highlight:function(a){var b=this.note;b&&b.highlight(a)},removeHighlight:function(){var a=this.note;a&&a.removeHighlight()}},f.extend(c,h.Events),b=e.extend(c)}({}),yne_mobile_core_Editor=function(a){var b=yne_osNoteView,c=yne_common_data_Note,d=yne_osController,e=yne_jquery,f=yne_underscore,g=yne_jtk_core_L,h=yne_common_core_Editor,i=yne_common_data_blockTypes;return h.extend({controllerEventList:null,_isCellSelected:!1,_lastSelectedCellUID:null,_isNativeInputHidden:null,initialize:function(a){var e=this;e.parentEl=a.parentEl,e.note=c.createBlank(),e.noteView=new b({note:e.note}),e.controller=new d({note:e.note,noteView:e.noteView}),e._bindEventsForController(),e._bindEventsForWindow(),e.setReadOnly(a.readonly)},render:function(){var a=this,b=a.noteView;b&&(e(a.parentEl).append(b.$el),b.render())},_bindEventsForController:function(){var a=this,b=a.controller;return b?(f.each(a.controllerEventList,function(c){b.on(c,a.trigger.bind(a,c))}),b.on("command-exec",function(){a.trigger("yne-content-change")}),b.on("yne-selection-change",function(){var c,d,e,f=b.getNoteRange(),g=!1,h={};f&&(c=f.getStartBlockRange(),d=c.block,g=f.isInSingleBlock()&&i.isTable(d)),g?(e=d.getCellByUID(c.uid),e&&(h.stringValue=e.value,h.hasImage=!1,h.tableId=d.getBlockId(),h.uid=c.uid,d.getNextDownCellByUID(h.uid)?h.isLastRow=!1:h.isLastRow=!0,(a._isNativeInputHidden||a._lastSelectedCellUID!==h.uid)&&(a.trigger("enter-table-cell",h),a._isNativeInputHidden=!1),a._lastSelectedCellUID=h.uid)):a._isCellSelected&&(a.trigger("leave-table"),a._lastSelectedCellUID=null),a._isCellSelected=g}),void b.on("enter-table-cell",a.trigger.bind(a,"enter-table-cell"))):void g.warn("no controller!")},_bindEventsForWindow:function(){var a=this,b=a.parentEl.ownerDocument,c=b.defaultView,d=f.debounce(a._onResize.bind(a),100);e(c).resize(d)},_onResize:function(){var a=this,b=a.noteView,c=a.controller.getNoteRange();b&&b.trigger("resize",c)},querySelectionInlineStyle:function(a){return this.controller.querySelectionInlineStyle(a)},querySelectionBlockStyle:function(a){return this.controller.querySelectionBlockStyle(a)},querySelectionInlineStyles:function(){return this.controller.querySelectionInlineStyles()},querySelectionBlockStyles:function(){return this.controller.querySelectionBlockStyles()},isSameList:function(a){return this.controller.isSameList(a)},getFirstParagraphContent:function(a){var b=this,c=b.note.getAllBlocks(),d="";return f.find(c,function(b){if(d=b.toPlain(void 0,void 0,a)||"",d.length>0)return!0}),d},getAttachments:function(){return f.filter(this.note.getAllBlocks(),function(a){return i.isAttachment(a)})},getImages:function(){return f.filter(this.note.getAllBlocks(),function(a){return i.isImage(a)})},focusAtNoteStart:function(){this.controller.focusAtNoteStart()},setCellValue:function(a){var b=this;this.controller.setCellValue(a),a.moveToNext===!1?b._isNativeInputHidden=!0:a.moveToNext===!0&&(b._isNativeInputHidden=!1)},setViewportHeight:function(a){this.controller.setViewportHeight(a)},setBackground:function(a){this.controller.setBackground(a)}})}({}),yne_iphone_core_Editor=function(a){var b=yne_mobile_core_Editor;return b.extend({controllerEventList:["yne-selection-change","yne-editing-state-change","notify-native-touchstart","yne-open-link","command-exec","insert-block","remove-block","request-image-rendered-src","request-attachment-rendered-src","click-image","click-attachment","set-clipboard","get-clipboard"],doPaste:function(a,b){this.controller.doPaste(a,b)},setEditorContainerMinHeight:function(a){this.noteView.el.style.minHeight=a+"px"},focusEditor:function(){this.controller.focusEditor()}})}({}),yne_iphone_BulbEditor=function(a){var b,c=yne_underscore,d=yne_jtk_core_Base,e=yne_iphone_utils_eventHandlers,f=yne_iphone_io_Bridge,g=yne_iphone_core_Editor;return b={_editor:null,bridge:null,initialize:function(a){this._editor=new g({parentEl:a.parentEl}),this.bridge=new f({editor:this}),this.bindEditorEvents(),this._editor.render()},ready:function(){this.bridge.ready()},bindEditorEvents:function(){var a=this,b=a._editor;c.each(e,function(c,d){b.on(d,c.bind(a))})}},d.extend(b)}({}),yne_iphone_init_iphone=function(a){var b,c=yne_iphone_BulbEditor,d=yne_jtk_core_L;b=new c({parentEl:document.getElementById("editor-container")}),d.DEBUG&&(window.debugEditor=b,["keydown","keypress","keyup","input","textInput","compositionstart","compositionupdate","compositionend"].forEach(function(a){document.body.addEventListener(a,function(a){d.warn(a.type,a)})})),window.onerror=function(a,c,e,f){var g,h=[];h.push("message: "+a),h.push("source file: "+c),h.push("line number: "+e),h.push("column number: "+f),g="[BulbEditor window.onerror]"+h.join(", "),d.DEBUG?d.error(g):b.bridge.callNativeApi("StoreLog",[g])},b.ready()}({})}();