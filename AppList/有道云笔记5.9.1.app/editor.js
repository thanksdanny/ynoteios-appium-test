var STYLE_TYPE_FONT_SIZE=1;var STYLE_TYPE_FONT_WEIGHT=2;var STYLE_TYPE_FONT_COLOR=3;var STYLE_TYPE_FONT_ITALIC=4;var STYLE_TYPE_FONT_UNDERLINE=5;var STYLE_TYPE_FONT_STRIKE=6;var STYLE_TYPE_BKG_COLOR=7;var STYLE_TYPE_TEXT_ALIGN_LEFT=8;var STYLE_TYPE_TEXT_ALIGN_MID=9;var STYLE_TYPE_TEXT_ALIGN_RIGHT=10;var STYLE_TYPE_TEXT_ALIGN_JUSTIFY=11;var STYLE_TYPE_REVERSE_COLOR=12;var STYLE_TYPE_LIST_ITEM=20;var STYLE_OBJ_PARA=1;var STYLE_OBJ_BLOCK=2;var STYLE_OBJ_EDITOR=3;var STYLE_OBJ_EDITING_BLOCK=4;var DEFAULT_FONT_SIZE=11;var COLOR_LIST=["#FF0000","#FF8000","#FFFF00","#00FF00","#0080C0","#0000FF","#FF00FF","#000000","#FFFFFF","#CCCCCC"];var VK_BACKSPACE=8;var VK_ENTER=13;var VK_DELETE=46;var VK_LEFT=37;var VK_RIGHT=39;var VK_UP=38;var VK_DOWN=40;var VK_ADD1=107;var VK_SUB1=109;var VK_ADD2=187;var VK_SUB2=189;var VK_0=48;var VK_9=57;var VK_NUM0=96;var VK_NUM9=105;var VK_B=66;var VK_C=67;var VK_D=68;var VK_I=73;var VK_J=74;var VK_L=76;var VK_M=77;var VK_N=78;var VK_R=82;var VK_S=83;var VK_U=85;var debug=false;var hasBorder=true;var isClientMode=true;var isPhoneMode=isClientMode?true:false;var lastE=null;var nextId=0;var mousePos={};var isInEditingMode=false;var textInfoHelper={};function isTextNode(a){return(a.nodeType==document.TEXT_NODE)}function isEmptyTextNode(a){return(isTextNode(a)&&(!a.textContent||a.textContent.trim().length<=0))}Text.prototype.removeMe=function(){this.nodeValue=""};Text.prototype.insertAfter=function(b){var a=b?b.parentNode:null;if(!a){return}if(a.lastChild==b){a.appendChild(this)}else{a.insertBefore(this,b.nextSibling)}};String.prototype.charLen=function(){return this.replace(/[^\x00-\xff]/g,"**").length};String.prototype.calcTextLen=function(b){charText=this.replace(/\*/g,"x").replace(/[^\x00-\xff]/g,"**");if(charText.length<=b){return this.length}else{charText=charText.substring(0,b);var a=charText.replace(/\*\*/g,"x").length;return a}};String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")};function isElement(a){return(a&&a.nodeType==document.ELEMENT_NODE)}Element.prototype.visible=function(){return this.style.display!="none"};Element.prototype.hide=function(){this.style.display="none"};Element.prototype.show=function(){this.style.display=""};Element.prototype.toggle=function(){if(this.visible()){this.hide()}else{this.show()}};Element.prototype.removeMe=function(){if(this.parentNode){this.parentNode.removeChild(this);return true}else{return false}};Element.prototype.setPos=function(a,b){this.style.top=b;this.style.left=a};Element.prototype.setSize=function(a,b){this.style.width=a;this.style.height=b};Element.prototype.insertAfter=function(b){var a=b?b.parentNode:null;if(!a){return}if(a.lastChild==b){a.appendChild(this)}else{a.insertBefore(this,b.nextSibling)}};Element.prototype.setTextEx=function(a){var c=this.childNodes;if(c){for(var b=0;b<c.length;b++){if(c[b].nodeType!=document.TEXT_NODE){continue}c[b].textContent=a;a=null}}else{this.textContent=a}};Element.prototype.moveFrom=function(c){var a=c.firstChild;while(a){var b=a.nextSibling;this.appendChild(a);a=b}};Element.prototype.getHtmlListType=function(){var a=this.tagName=="OL"?"decimal":(this.tagName=="UL"?"disc":null);if(this.style.listStyleType){a=this.style.listStyleType.toLowerCase()}return a};Element.prototype.clrStyle=function(){if(!this.style){return}for(var b=this.style.length-1;b>=0;b--){var a=this.style[b];this.style.removeProperty(a)}};Element.prototype.styleEqual=function(c){if(!c||!c.style){return false}if(this.style.length!=c.style.length){return false}for(var b=0;b<c.style.length;b++){var a=c.style[b];a=a.replace(/-([a-z])/ig,function(d,e){return e.toUpperCase()});if(this.style[a]!=c.style[a]){return false}}return true};function $(a){return document.getElementById(a)}function convertRGBtoInt(f){var g=f.toLowerCase();if(g.indexOf("rgb(")==0){var e=g.indexOf(",");if(e<4){return 0}var d=parseInt(g.substring(4,e));g=g.substring(e+1);e=g.indexOf(",");if(e<=0){return 0}var c=parseInt(g.substring(0,e));g=g.substring(e+1);var a=parseInt(g);var b=d+256*c+65536*a;return b}else{if(g.charAt(0)=="#"&&g.length==7){var d=parseInt(g.substring(1,3),16);var c=parseInt(g.substring(3,5),16);var a=parseInt(g.substring(5,7),16);var b=d+256*c+65536*a;return b}else{return parseInt(g)}}}function convertInttoRGB(e){var d=e%256;e=e>>8;var b=e%256;e=e>>8;var a=e%256;var c="#"+(parseInt(d/16)).toString(16)+(parseInt(d>>4)).toString(16)+(parseInt(b/16)).toString(16)+(parseInt(b>>4)).toString(16)+(parseInt(a/16)).toString(16)+(parseInt(a>>4)).toString(16);return c}function setCursorToEnd(a){setCursorPosition(a,a.value.length,a.value.length)}function setCursorPosition(b,d,c){if(document.selection){var a=b.createTextRange();a.collapse(true);a.moveStart("character",d);a.moveEnd("character",c-d);a.select()}else{if(b.selectionStart||(b.selectionStart=="0")){b.selectionStart=d;b.selectionEnd=c}}b.focus()}function insertText(b,f){b.focus();if(document.selection){var e=document.selection.createRange();e.text=f}else{if(typeof b.selectionStart=="number"&&typeof b.selectionEnd=="number"){var d=b.selectionStart,c=b.selectionEnd,g=d,a=b.value;b.value=a.substring(0,d)+f+a.substring(c,a.length);g+=f.length;b.selectionStart=b.selectionEnd=g}else{b.value+=f}}}function hasClass(b,a){return(" "+b.className+" ").indexOf(" "+a+" ")>-1}function parentByTag(c,b){b=b.toUpperCase();while(c&&c.nodeName!=b){c=c.parentNode}return c}function parentByClass(a,c){while(a&&hasClass(a,c)){a=a.parentNode}return a}function max(d,c){return(d>c?d:c)}function min(d,c){return(d<c?d:c)}var ENUM_FUNCTION=1;var ENUM_PROPERTY=2;var ENUM_ALL=ENUM_FUNCTION|ENUM_PROPERTY;function enumObject(c,a){if(!c){return}if(!a){a=ENUM_ALL}var d;for(o in c){var b=typeof(c[o]);if((b=="function"&&(a&ENUM_FUNCTION))||(b!="function"&&(a&ENUM_PROPERTY))){d+=b+":#:"+o+":#:"+c[o]+"\n"}}}Element.prototype.appendStyle=function(c){if(!c||!c.style){return}if(debug){if(c.text){}}for(var b=0;b<c.style.length;b++){var a=c.style[b];if(a=="top"||a=="left"||a=="height"||a=="width"||a=="text-indent"){continue}a=a.replace(/-([a-z])/ig,function(d,e){return e.toUpperCase()});if(debug){alert(c.style[b]+": "+c.style[a]);alert("text now: "+c.text)}this.style[a]=c.style[a];if(debug){alert("text after: "+c.text)}}this.align=c.align};Element.prototype.cpStyle=function(a){if(!a||!a.style||!this.style){return}this.clrStyle();this.appendStyle(a)};Element.prototype.checkStyle=function(a){if(!this.style){return}if(a==STYLE_OBJ_BLOCK){this.style.removeProperty("text-align")}else{if(a==STYLE_OBJ_EDITOR){this.style.removeProperty("text-align")}else{if(a==STYLE_OBJ_EDITING_BLOCK){this.style.removeProperty("text-align");this.style.color="transparent"}}}};Element.prototype.isTextContainer=function(){return(this.tagName=="P"||this.tagName=="DIV")};Element.prototype.isTextHolder=function(){return(this.tagName=="SPAN"||this.tagName=="STRONG"||this.tagName=="B"||this.tagName=="EM"||this.tagName=="I"||this.tagName=="U"||this.tagName=="STRIKE"||this.tagName=="SUB"||this.tagName=="SUP"||this.tagName=="DIV")};Element.prototype.convertStyle=function(a){switch(a){case"STRONG":case"B":this.style.fontWeight="bold";break;case"EM":case"I":this.style.fontStyle="italic";break;case"U":this.style.textDecoration="underline";break;case"STRIKE":this.style.textDecoration="line-through";break;case"SUB":this.style.fontSize="x-small";this.style.verticalAlign="sub";break;case"SUP":this.style.fontSize="x-small";this.style.verticalAlign="super";break;default:break}};Text.prototype.isPara=function(a){return false};Text.prototype.isListItem=function(a){return false};Text.prototype.isBlock=function(a){return false};Element.prototype.isPara=function(a){return((this.tagName=="P"||this.tagName=="DIV")&&(a||parseInt(this.id)>0))};Element.prototype.isListItem=function(a){return(this.tagName=="DIV"&&this.firstElementChild&&this.firstElementChild.tagName=="OL"&&(a||parseInt(this.id)>0))};Element.prototype.isBlock=function(a){return(this.tagName=="A"&&(a||parseInt(this.id)>0))};Element.prototype.getListType=function(){if(this.isListItem()){return(this.firstElementChild.style.listStyleType?this.firstElementChild.style.listStyleType.toLowerCase():"decimal")}else{return null}};Element.prototype.changeListType=function(a){if(a&&this.isListItem()){this.firstElementChild.style.listStyleType=a}};Element.prototype.getListNumber=function(){if(this.isListItem()){var a=this.firstElementChild;return parseInt(a.getAttribute("start"))}else{return -1}};Element.prototype.setListNumber=function(b){if(this.isListItem()){var a=this.firstElementChild;a.setAttribute("start",b)}};Element.prototype.getListTextElement=function(){if(this.isListItem()){var a=this.firstElementChild;return a.nextElementSibling}else{return null}};function findTheLastBlock(a){if(!a){return null}if(a.isBlock()){return a}var e=null;var d=a.childNodes;if(d){for(var c=0;c<d.length;c++){if(d[c].nodeType!=document.ELEMENT_NODE){continue}var b=findTheLastBlock(d[c]);if(b){e=b}}}return e}function getMaxBlockId(a){var d=0;if(!a){return d}if(a.isBlock()){return parseInt(a.id,10)}var c=a.childNodes;if(c){for(var b=0;b<c.length;b++){if(c[b].nodeType!=document.ELEMENT_NODE){continue}d=max(d,getMaxBlockId(c[b]))}}return d}function hideEditor(){var a=$("ll");for(var b=0;b<10;b++){if(!a){break}a.hide();a=a.nextElementSibling}var c=$("editor");c.clrStyle();c.style.top=-100}function borderSwitcher(a){hasBorder=a;var b=$("bl");for(var c=0;c<8;c++){if(!b){break}b.className=(a?"bd":"bdt");b=b.nextElementSibling}}function setEditorBorder(j,g,h){if(h){if(h.top<(j.top+j.height)||h.height<=0||h.width<=0||g<j.height){g=null;h=null}}if(!h){var e=$("bl2");for(var f=0;f<4;f++){if(!e){break}e.hide();e=e.nextElementSibling}}var k=$("ll");if(j.left>0){k.setPos(0,j.top);k.setSize(j.left,j.height);k.show()}else{k.hide()}k=k.nextElementSibling;if(h){if(h.left+h.width<j.left+j.width){k.setPos(h.left+h.width,h.top);k.setSize(j.left+j.width-(h.left+h.width),h.height);k.show()}else{k.hide()}}else{if(j.left+j.width<document.body.offsetWidth){k.setPos(j.left+j.width,j.top);k.setSize(document.body.offsetWidth-(j.left+j.width),j.height);k.show()}else{k.hide()}}var b=(h?false:true);var c=(h?(g-h.height<j.height*2?true:false):false);var d=(!b&&!c?true:false);var e=k.nextElementSibling;e.setPos(j.left-2,j.top-2);e.style.height=j.height+(b?6:4);e.show();e=e.nextElementSibling;e.setPos(j.left+j.width,j.top-2);var a;if(g&&h){e.style.height=g-h.height+(b?6:4);a=j.top+g-h.height+2}else{e.style.height=j.height+6;a=j.top+j.height+2}e.show();e=e.nextElementSibling;e.setPos(j.left,j.top-2);e.style.width=j.width;e.show();e=e.nextElementSibling;if(!h||h.width<=0){e.setPos(j.left,a);e.style.width=j.width;e.show()}else{e.setPos(h.left+h.width,a-2);e.style.width=j.left+j.width-h.left-h.width;if(parseInt(e.style.width)>0){if(parseInt(e.style.width)>j.width&&c){e.setPos(j.left-2,a-2);e.style.width=j.width+4}e.show()}else{e.hide()}e=e.nextElementSibling;e.setPos(h.left-2,j.top+j.height);e.style.height=g-h.height+6;e.show();e=e.nextElementSibling;e.setPos(h.left+h.width,a-2);e.style.height=h.height+6;e.show();e=e.nextElementSibling;e.setPos(h.left,j.top+j.height);e.style.width=j.left-h.left;if(parseInt(e.style.width)>0){if(parseInt(e.style.width)>h.width&&c){e.style.width=h.width+2}e.show()}else{e.hide()}e=e.nextElementSibling;e.setPos(h.left,j.top+g+4);e.style.width=h.width;e.show()}}function getBlockByIndex(c,a){var b=0;var e=a.childNodes;if(e){for(var d=0;d<e.length;d++){if(e[d].nodeType!=document.ELEMENT_NODE){continue}if(e[d].isBlock()){if(b==c){return e[d]}b++}}}return null}function getFirstBlockInPara(a){var b=a?a.firstElementChild:null;if(!a||!b){return null}if(b.isBlock()){return b}else{return getNearbyBlock(b,true)}}function getLastBlockInPara(a){if(!a){return null}var b=a.lastElementChild;if(b.isBlock()){return b}else{return getNearbyBlock(b,false)}}function getNearbyListItem(a,d){if(!a){return null}var c=a.getListType();var b=(d?a.nextElementSibling:a.previousElementSibling);if(b&&b.isListItem()&&b.getListType()==c){return b}else{return null}}function getNearbyPara(c,b){if(!c){return null}var a=(b?c.nextElementSibling:c.previousElementSibling);while(a){if(a.isPara()){return a}a=(b?a.currentPara:a.currentPara)}return null}function getNearbyBlock(c,b){if(!c){return null}var a=(b?c.nextElementSibling:c.previousElementSibling);while(a){if(a.isBlock()){return a}a=(b?a.nextElementSibling:a.previousElementSibling)}return null}function getBlockByPoint(a,d,c){var b=getNearbyBlock(d,c);while(b){if(b.isBlock()&&a>=b.offsetLeft&&a<b.offsetLeft+b.offsetWidth){return b}b=getNearbyBlock(b,c)}return null}function getBlockCount(d){var a=0;var c=d.childNodes;if(c){for(var b=0;b<c.length;b++){if(c[b].nodeType!=document.ELEMENT_NODE){continue}if(c[b].isBlock()){a++}}}return a}function getBlockIndex(b){var c={};c.index=0;c.count=0;var e=b.parentNode.childNodes;if(e){for(var d=0;d<e.length;d++){if(e[d].nodeType!=document.ELEMENT_NODE){continue}if(e[d].isBlock()){if(e[d].id==b.id){c.index=c.count}c.count++}}}return c}function updateEditorBorder(){var c=$("editor");if(!lastE||!c){return}var i=lastE.offsetHeight;lastE.setTextEx(c.value);if(i!=lastE.offsetHeight&&lastE.offsetHeight>0){updateEditorPosition()}if(lastE.textContent==""){recoverBlock();return}var d=lastE.parentNode;var b=0;if(d&&d.style){if(d.style.textAlign=="right"||d.align=="right"){b=3}}var a=false;if(lastE.getClientRects){var j=lastE.getClientRects();var l=j.length;if(l>=2){a=true;var k=j[0].left-lastE.offsetLeft;var h=j[0].top-lastE.offsetTop;var f={};f.left=lastE.offsetLeft-2;f.top=lastE.offsetTop;f.height=j[0].height;f.width=max(0,document.body.offsetWidth-f.left+2);var e={};e.left=-2;e.top=j[l-1].top-h;e.height=j[l-1].height;e.width=j[l-1].width+4;var g=getBlockIndex(lastE);if(g.index==g.count-1){e.width=document.body.offsetWidth-e.left+2}f.left-=b;f.width+=3;setEditorBorder(f,lastE.offsetHeight,e)}}if(!a){var f={};f.left=lastE.offsetLeft-2;f.top=lastE.offsetTop;f.height=lastE.offsetHeight;f.width=lastE.offsetWidth;var g=getBlockIndex(lastE);if(g.index==g.count-1){f.width=document.body.offsetWidth-f.left+2}f.left-=b;f.width+=3;setEditorBorder(f)}c.style.textIndent=max(lastE.offsetLeft-b,3);return lastE.offsetLeft}function updateEditorPosition(){if(lastE){editor.setPos(0,lastE.offsetTop);editor.setSize(document.body.offsetWidth+8,lastE.offsetHeight+2)}else{hideEditor()}}function calcCaretPosition(d,h,g,c,b){if(!h||h=="undefined"||!c||c=="undefined"){return -1}if(document.caretRangeFromPoint){var a=document.caretRangeFromPoint(h,g);if(a&&a.startOffset){return a.startOffset}}var m=d?d.getClientRects():null;var n=m?m.length:0;if(n<=0){return -1}var l=d.textContent.charLen();var f=0;var j=c;for(var e=0;e<n;e++){f+=m[e].width;if(m[e].top+m[e].height<b){j+=m[e].width}}if(j==c){j-=m[0].left}var k=d.textContent.calcTextLen(min(l,(l*j)/f));return k}function mergeBlocksInPara(a){if(!a.isPara()){return}var c=getFirstBlockInPara(a);var b=c.nextSibling;while(c&&b){if(isElement(c)&&isElement(b)&&c.isBlock()&&b.isBlock()&&b.styleEqual(c)){b.setTextEx(c.textContent+b.textContent);c.removeMe()}c=b;b=b.nextSibling;while(b&&isEmptyTextNode(b)){b=b.nextSibling}}}function mergePrevBlock(d,b){if(!d){return -1}var c=d.previousSibling;var a=d;if(!c||!a||!isElement(c)||!isElement(a)||!c.isBlock()||!a.isBlock()){return -1}recoverBlock();var e=-1;if(a.styleEqual(c)){e=c.textContent.length;c.setTextEx(c.textContent+a.textContent);a.removeMe();changeBlock(c)}else{if(b){changeBlock(c)}else{changeBlock(a)}}if(e>=0){setCursorPosition($("editor"),e,e)}return e}function recoverBlock(){if(lastE){var a=$("editor");lastE.cpStyle(a);lastE.setTextEx(a.value);hideEditor();if(lastE.text&&lastE.text.length==0){var c=((!getNearbyBlock(lastE,true)&&!getNearbyBlock(lastE,false))?true:false);var b=lastE.parentNode;b.removeChild(lastE);if(c){b.removeMe()}}lastE=null}}function selectBlock(b){if(!b){return}lastE=b;var a=$("editor");a.value=b.text;a.cpStyle(b.parentNode);a.appendStyle(b);a.checkStyle(STYLE_OBJ_EDITOR);b.checkStyle(STYLE_OBJ_EDITING_BLOCK);updateEditorBorder();updateEditorPosition();a.show();setCursorToEnd(a)}function createBlock(b,a){var c=document.createElement("a");c.id=nextId.toString();nextId++;if(!b||b==""){c.innerHTML="&#8203;"}else{c.textContent=b}if(a){c.cpStyle(a)}c.appendChild(document.createElement("wbr"));return c}function insertBlock(c,b,a){var d=createBlock(a,b);d.insertAfter(c);return d}function appendBlockInPara(c,b,a){var d=createBlock(a,b);c.appendChild(d);return d}function copyStylePara(a){var b=document.createElement("p");b.id=nextId.toString();nextId++;if(a){b.cpStyle(a)}return b}function createListItem(e,b,f){var c=document.createElement("div");c.id=nextId.toString();nextId++;if(e){c.cpStyle(e)}var d=document.createElement("ol");var a=document.createElement("li");d.appendChild(a);d.style.listStyleType=b;c.appendChild(d);c.setListNumber(f);return c}function copyStyleListItem(a){return createListItem(a,a.firstElementChild.style.listStyleType,a.getListNumber()+1)}function reorderListNumber(c,a){var b=getNearbyListItem(c,true);while(b){b.setListNumber(a++);b=getNearbyListItem(b,true)}}function changeToListItem(b,a){if(!a||!b||!b.isPara()){return}var d=b;if(b.isListItem()){var h=b.getListType();if(h==a||!h){reorderListNumber(d,b.getListNumber());b.removeChild(b.firstElementChild);var e=document.createElement("p");e.cpStyle(b);e.id=b.id;e.moveFrom(b);b.parentNode.replaceChild(e,b)}else{b.changeListType(a)}}else{var c=b.previousElementSibling;var g=(c&&c.isListItem())?(c.getListNumber()+1):1;var f=document.createElement("ol");f.appendChild(document.createElement("li"));f.style.listStyleType=a;f.setAttribute("start",g);var e=document.createElement("div");e.cpStyle(b);e.id=b.id;e.appendChild(f);e.moveFrom(b);d=e;if(b.parentNode){b.parentNode.replaceChild(e,b)}else{e.insertAfter(b);b.removeMe()}reorderListNumber(d,g+1)}updateEditorBorder()}function changeStyle(a,b){if(lastE){if(a==STYLE_TYPE_LIST_ITEM){changeToListItem(lastE.parentNode,b)}else{paritialChangeStyle(lastE,a,b)}}}function paritialChangeStyle(e,n,d){if(!lastE){return}var i=$("editor");var h=i.value;var l=(i.selectionStart==0&&i.selectionEnd==h.length)?true:false;if(i.selectionStart>=i.selectionEnd){l=true}var b=i.selectionStart;var g=i.selectionEnd-i.selectionStart;var j=e;if(!l){if(i.selectionStart>0){j=insertBlock(lastE,i,h.substring(i.selectionStart,i.selectionEnd))}if(i.selectionEnd<h.length){insertBlock(j,i,h.substring(i.selectionEnd))}if(i.selectionStart>0){i.value=h.substring(0,i.selectionStart)}else{i.value=h.substring(0,i.selectionEnd)}b=0}recoverBlock();switch(n){case STYLE_TYPE_FONT_SIZE:var a=j.style.fontSize;if(!a||a.length==0){a=DEFAULT_FONT_SIZE}else{a=parseInt(a)}if(!d||d.length==0){j.style.fontSize=""}else{if(d=="+"){a++;j.style.fontSize=a.toString()+"pt"}else{if(d=="-"){a--;j.style.fontSize=a.toString()+"pt"}else{if(parseInt(d)>0){j.style.fontSize=d}}}}break;case STYLE_TYPE_FONT_ITALIC:j.style.fontStyle=(j.style.fontStyle!="italic"?"italic":"");break;case STYLE_TYPE_FONT_WEIGHT:j.style.fontWeight=(j.style.fontWeight!="bold"?"bold":"");break;case STYLE_TYPE_FONT_COLOR:j.style.color=(convertRGBtoInt(j.style.color)!=convertRGBtoInt(d)?d:"");break;case STYLE_TYPE_FONT_UNDERLINE:j.style.textDecoration=(j.style.textDecoration!="underline"?"underline":"");break;case STYLE_TYPE_FONT_STRIKE:j.style.textDecoration=(j.style.textDecoration!="line-through"?"line-through":"");break;case STYLE_TYPE_BKG_COLOR:j.style.backgroundColor=(convertRGBtoInt(j.style.backgroundColor)!=convertRGBtoInt(d)?d:"");break;case STYLE_TYPE_REVERSE_COLOR:if(!j.style.color){j.style.color="#FFFFFF"}else{var p=convertRGBtoInt("#FFFFFF")-convertRGBtoInt(j.style.color);j.style.color=convertInttoRGB(p)}if(!j.style.backgroundColor){j.style.backgroundColor="#000000"}else{var p=convertRGBtoInt("#FFFFFF")-convertRGBtoInt(j.style.backgroundColor);var f=p>0?p.toString(16):"000000";j.style.backgroundColor=convertInttoRGB(p)}break;case STYLE_TYPE_TEXT_ALIGN_LEFT:if(j.parentNode&&j.parentNode.isPara()){j.parentNode.style.textAlign=(j.parentNode.style.textAlign!="left"?"left":"")}break;case STYLE_TYPE_TEXT_ALIGN_MID:if(j.parentNode&&j.parentNode.isPara()){j.parentNode.style.textAlign=(j.parentNode.style.textAlign!="center"?"center":"")}break;case STYLE_TYPE_TEXT_ALIGN_RIGHT:if(j.parentNode&&j.parentNode.isPara()){j.parentNode.style.textAlign=(j.parentNode.style.textAlign!="right"?"right":"")}break;case STYLE_TYPE_TEXT_ALIGN_JUSTIFY:if(j.parentNode&&j.parentNode.isPara()){j.parentNode.style.textAlign=(j.parentNode.style.textAlign!="justify"?"justify":"")}break;default:break}var c=j.nextSibling;var m=mergePrevBlock(j,false);var k=mergePrevBlock(c,true);if(!lastE){selectBlock(j)}i.selectionStart=max(0,m)+b;i.selectionEnd=i.selectionStart+g;updateEditorBorder()}function changeBlock(a){if(a){recoverBlock();selectBlock(a);return true}else{return false}}function handleKeyPress(d){var f=d.target||d.srcElement||document;if(f.nodeType===3){f=f.parentNode}if(f.id!="editor"||!lastE){return}if(d.keyCode==VK_ENTER){d.returnValue=false;d.preventDefault();d.stopPropagation();var j=getBlockIndex(lastE);var a=lastE.parentNode;var h=a.isListItem();var b=h?copyStyleListItem(a):copyStylePara(a);lastE.cpStyle(f);var g=null;if(f.selectionEnd<lastE.text.length){g=appendBlockInPara(b,f,f.value.substring(f.selectionEnd))}if(f.selectionStart<lastE.text.length){if(f.selectionStart==0){lastE.innerHTML="&#8203;"}else{lastE.setTextEx(f.value.substring(0,editor.selectionStart))}}if(j.index==j.count-1){if(!g){g=appendBlockInPara(b,f,"")}}else{if(!g){g=lastE.nextElementSibling}var i=lastE.nextSibling;while(i){var c=i.nextSibling;b.appendChild(i);i=c}}b.insertAfter(a);lastE=null;if(h){reorderListNumber(a,a.getListNumber()+1)}if(g.text){}selectBlock(g);setCursorPosition(f,0,0)}}function handleTextUpdate(a){if(isClientMode){window.open("app:textUpdate")}}function handleKeyDown(b){textInfoHelper={};var a=b.target||b.srcElement||document;if(a.nodeType===3){a=a.parentNode}if(a.id!="editor"||!lastE){return}textInfoHelper.selectionStart=a.selectionStart;textInfoHelper.selectionEnd=a.selectionEnd;textInfoHelper.keyCode=b.keyCode}function handleKeyUp(i){var j=i.target||i.srcElement||document;if(j.nodeType===3){j=j.parentNode}if(j.id!="editor"||!lastE){return}if(i.keyCode==VK_BACKSPACE&&!i.ctrlKey&&!i.shiftKey&&j.selectionStart==0&&j.selectionEnd==0){var h=false;var p=getBlockIndex(lastE);var b=true;if(textInfoHelper.keyCode==i.keyCode&&(textInfoHelper.selectionStart!=0||textInfoHelper.selectionEnd!=0)){b=false}textInfoHelper={};if(p.index==0&&b){var q=lastE.parentNode;if(q.style.textAlign=="right"||q.style.textAlign=="center"||q.align=="right"||q.align=="center"||q.style.marginLeft>0){q.style.textAlign=null;q.align=null;q.style.marginLeft=0;j.style.textIndent=0;updateEditorBorder();h=true}else{var m=lastE.previousElementSibling?null:getNearbyPara(q,false);if(m){var l=lastE;while(l){var d=l.nextElementSibling;m.appendChild(l);l=d}if(q.isListItem()){reorderListNumber(q,q.getListNumber())}q.removeMe();if(getNearbyBlock(lastE,false)){h=true;mergePrevBlock(lastE,true)}}}}if(!h){changeBlock(getNearbyBlock(lastE,false))}}else{if(i.keyCode==VK_DELETE&&!i.ctrlKey&&!i.shiftKey&&j.selectionStart==lastE.text.length&&j.selectionEnd==lastE.text.length){var p=getBlockIndex(lastE);var b=true;if(textInfoHelper.keyCode==i.keyCode&&(textInfoHelper.selectionStart!=lastE.text.length||textInfoHelper.selectionEnd!=lastE.text.length)){b=false}textInfoHelper={};if(p.index==p.count-1&&b){var q=lastE.parentNode;var a=getNearbyPara(q,true);if(a){var l=a.firstElementChild;while(l){var d=l.nextElementSibling;q.appendChild(l);l=d}a.removeMe()}}if(changeBlock(getNearbyBlock(lastE,true))){setCursorPosition(j,0,0)}}else{if((i.keyCode==VK_B||i.keyCode==VK_I||i.keyCode==VK_S||i.keyCode==VK_U||i.keyCode==VK_ADD1||i.keyCode==VK_SUB1||i.keyCode==VK_ADD2||i.keyCode==VK_SUB2||i.keyCode==VK_L||i.keyCode==VK_M||i.keyCode==VK_R||i.keyCode==VK_J||i.keyCode==VK_C||(i.keyCode>=VK_0&&i.keyCode<=VK_9)||(i.keyCode>=VK_NUM0&&i.keyCode<=VK_NUM9))&&i.ctrlKey&&!i.shiftKey&&i.altKey){i.returnValue=false;i.preventDefault();i.stopPropagation();var n=null;var c=null;switch(i.keyCode){case VK_B:n=STYLE_TYPE_FONT_WEIGHT;break;case VK_I:n=STYLE_TYPE_FONT_ITALIC;break;case VK_U:n=STYLE_TYPE_FONT_UNDERLINE;break;case VK_S:n=STYLE_TYPE_FONT_STRIKE;break;case VK_ADD1:case VK_ADD2:n=STYLE_TYPE_FONT_SIZE;c="+";break;case VK_SUB1:case VK_SUB2:n=STYLE_TYPE_FONT_SIZE;c="-";break;case VK_L:n=STYLE_TYPE_TEXT_ALIGN_LEFT;break;case VK_M:n=STYLE_TYPE_TEXT_ALIGN_MID;break;case VK_R:n=STYLE_TYPE_TEXT_ALIGN_RIGHT;break;case VK_J:n=STYLE_TYPE_TEXT_ALIGN_JUSTIFY;break;case VK_C:n=STYLE_TYPE_REVERSE_COLOR;break;default:var g=i.keyCode-VK_0;if(g>=0&&g<=9){n=STYLE_TYPE_FONT_COLOR;c=COLOR_LIST[g]}else{g=i.keyCode-VK_NUM0;if(g>=0&&g<=9){n=STYLE_TYPE_BKG_COLOR;c=COLOR_LIST[g]}}break}if(n){paritialChangeStyle(lastE,n,c)}}else{if((i.keyCode==VK_D||i.keyCode==VK_N)&&i.ctrlKey&&!i.shiftKey&&i.altKey){var k=null;switch(i.keyCode){case VK_D:k="disc";break;case VK_N:k="decimal";break}if(k){changeToListItem(lastE.parentNode,k)}}else{if(i.keyCode==VK_B&&i.ctrlKey&&i.shiftKey&&i.altKey){borderSwitcher(!hasBorder)}else{if(i.keyCode==VK_D&&i.ctrlKey&&i.shiftKey&&i.altKey){done()}else{if(i.keyCode==VK_LEFT&&j.selectionStart==0){var b=true;if(textInfoHelper.keyCode==i.keyCode&&textInfoHelper.selectionStart!=0){b=false}textInfoHelper={};if(b&&!changeBlock(getNearbyBlock(lastE,false))){var f=getNearbyPara(lastE.parentNode,false);if(f){changeBlock(getLastBlockInPara(f))}}}else{if(i.keyCode==VK_RIGHT&&j.selectionEnd==lastE.text.length){var b=true;if(textInfoHelper.keyCode==i.keyCode&&textInfoHelper.selectionEnd!=lastE.text.length){b=false}textInfoHelper={};if(b&&changeBlock(getNearbyBlock(lastE,true))){setCursorPosition(j,0,0)}else{var f=getNearbyPara(lastE.parentNode,true);if(f){if(changeBlock(getFirstBlockInPara(f))){setCursorPosition(j,0,0)}}}}else{if(i.keyCode==VK_UP&&j.selectionStart==0){var f=getNearbyPara(lastE.parentNode,false);if(f){recoverBlock();selectBlock(getFirstBlockInPara(f));setCursorPosition(j,0,0)}}else{if(i.keyCode==VK_DOWN&&j.selectionEnd==lastE.text.length){var f=getNearbyPara(lastE.parentNode,true);if(f){recoverBlock();selectBlock(getFirstBlockInPara(f));setCursorPosition(j,0,0)}}else{updateEditorBorder()}}}}}}}}}}}function handleClick(a){if(!isPhoneMode){handleTouchClick(a)}}function handleTouchClick(u){var z=u.target||u.srcElement||document;if(z.nodeType===3){z=z.parentNode}if(z.tagName=="BODY"&&!lastE){u.returnValue=false;u.preventDefault();u.stopPropagation();var x=findTheLastBlock(document.body);if(x){selectBlock(x)}return}if(z.id=="editor"){u.cancelBubble=false;return}var v=window.scrollX?window.scrollX:0;var r=window.scrollY?window.scrollY:0;var w=(u.touches&&u.touches.length>0?u.touches[0].pageX:(u.changedTouches&&u.changedTouches.length>0?u.changedTouches[0].pageX:u.pageX));var t=(u.touches&&u.touches.length>0?u.touches[0].pageY:(u.changedTouches&&u.changedTouches.length>0?u.changedTouches[0].pageY:u.pageY));var h=w-v;var d=t-r;if(mousePos.x&&mousePos.y){var f=mousePos.x;var m=mousePos.y;var c=(u.touches&&u.touches.length>0?u.touches[0].pageX:(u.changedTouches&&u.changedTouches.length>0?u.changedTouches[0].pageX:u.pageX));var b=(u.touches&&u.touches.length>0?u.touches[0].pageY:(u.changedTouches&&u.changedTouches.length>0?u.changedTouches[0].pageY:u.pageY));var q=c-v;var n=b-r;var k={};k.x=f-parseInt(q);k.y=m-parseInt(n);k.dis=k.x*k.x+k.y*k.y;mousePos={};if(k.dis>900){return}}var j=(lastE?lastE.parentNode:null);var i=null;if(j&&z.tagName=="DIV"&&(z.id=="ll"||z.id=="rr")){i=getBlockByPoint(u.clientX,lastE,z.id=="rr"?true:false)}recoverBlock();if(!i){if(z.isPara()){i=getLastBlockInPara(z)}else{if(z.isBlock()){i=z}}}if(i){u.returnValue=false;u.preventDefault();u.stopPropagation();var s=window.getSelection?window.getSelection():(document.getSelection?document.getSelection():(document.selection?document.selection.createRange().text:""));var p=-1;var a=-1;if(s&&s.rangeCount==1){var l=s.toString();if(l.length>0){var g=s.anchorNode;while(g&&g.nodeType!=document.ELEMENT_NODE){g=g.parentNode}if(g==i){p=s.anchorOffset;a=p+l.length}}}var y=-1;if(!(p>=0&&a>=p)){if(u.rangeParent&&u.rangeOffset&&isTextNode(u.rangeParent)){y=u.rangeOffset}else{y=calcCaretPosition(i,w,t,h,d)}}selectBlock(i);if(p>=0&&a>=p){setCursorPosition($("editor"),p,a)}else{if(y>=0){setCursorPosition($("editor"),y,y)}}}}function handleTouchStart(b){isPhoneMode=true;var a=window.scrollX?window.scrollX:0;var c=window.scrollY?window.scrollY:0;if(b.touches&&b.touches.length>0){mousePos.x=b.touches[0].pageX-a;mousePos.y=b.touches[0].pageY-c}else{if(b.changedTouches&&b.changedTouches.length>0){mousePos.x=b.changedTouches[0].pageX-a;mousePos.y=b.changedTouches[0].pageY-c}}}function createAssistant(c,g,d,e,f){var b=document.createElement(c);if(g){b.id=g}if(d){b.className=d}if(!f){b.hide()}var a=document.body;if(e){b.insertAfter(e)}else{if(a.firstElementChild){a.insertBefore(b,a.firstElementChild)}else{a.appendChild(b)}}return b}function prepareAssistants(){var a=document.body;a.className="mm";a.style.color="#000000";var b=createAssistant("textarea","editor","ta",null);b=createAssistant("div","ll","tt",b);b=createAssistant("div","rr","tt",b);b=createAssistant("div","bl","bd",b);b=createAssistant("div","br","bd",b);b=createAssistant("div","bt","bd",b);b=createAssistant("div","bb","bd",b);b=createAssistant("div","bl2","bd",b);b=createAssistant("div","br2","bd",b);b=createAssistant("div","bt2","bd",b);b=createAssistant("div","bb2","bd",b);borderSwitcher(hasBorder)}function appendContent(a){var e=document.getElementsByTagName("p");if(e&&e.length<16){var b=e.length;for(var d=b;d<16;++d){var c=document.createElement("p");c.className="tq_hack";a.appendChild(c)}}}function removeContent(){var b=document.getElementsByClassName("tq_hack");var c=b.length-1;while(c>0){var a=b[c];if(encodeURIComponent(a.textContent)==="%E2%80%8B"){a.removeMe()}else{break}c--}}function iterAppendBlock(d,m,e){var g=isTextNode(d);var l=d.textContent?d.textContent.trim():"";if((g||d.isTextHolder())&&!(l.length==0)){if(l.length==0){return null}var c=d.firstChild;if(!c){var i=createBlock(l,g?null:d);i.appendStyle(e);i.convertStyle(d.tagName);i.insertAfter(m);return i}else{var k=null;var f=document.createElement("a");f.cpStyle(e);f.appendStyle(d);f.convertStyle(d.tagName);while(c){var b=c.nextSibling;var h=iterAppendBlock(c,(k?k:m),f);if(h){k=h}c=b}return k}}else{var j=d.cloneNode(true);j.insertAfter(m);return j}}function iterConvertBlocks(e,j,b){var g=isTextNode(e);var l=e.textContent?e.textContent.trim():"";if(l.length==0){return null}if(g||e.isTextHolder()){if(!j){if(b){b.id=nextId.toString();nextId++}else{if(e.parentNode){e.parentNode.id=nextId.toString();nextId++}}}var d=e.firstChild;if(d){var k=null;var f=document.createElement("a");f.cpStyle(e);f.convertStyle(e.tagName);while(d){var c=d.nextSibling;var h=iterAppendBlock(d,(k?k:e),f);if(h){k=h}d=c}return k}else{var i=createBlock(l,g?null:e);i.convertStyle(e.tagName);i.insertAfter(e);return i}}else{return null}}function iterConvertList(d,e,n,f,c){if(d.tagName=="LI"){var k=createListItem(e,n,f);k.appendStyle(d);var j=false;var b=d.childNodes;if(b){var h=document.createElement("a");var p=k.lastChild;for(var g=0;g<b.length;g++){var l=iterAppendBlock(b[g],p,h);if(l){p=l;if(l.isBlock()||l.tagName=="A"){j=true}}}}if(!j){var m=createBlock(d.textContent.trim(),null);k.appendChild(m)}k.insertAfter(c);return k}else{d.insertAfter(c);if(iterConvertMain(d)&&c.nextSibling.isPara()){c.nextSibling.appendStyle(e)}return c.nextSibling}}function iterConvertMain(c){if(isTextNode(c)){if(isEmptyTextNode(c)){return false}var a=copyStylePara(null);appendBlockInPara(a,null,c.textContent.trim());c.parentNode.replaceChild(a,c);return true}var b=c.firstChild;var l=c;var j=isElement(c)?c.getHtmlListType():null;var i=false;var d=(!j||!c.getAttribute("start"))?1:c.getAttribute("start");while(b){var f=b.nextSibling;if(!b.id||b.id.length<=0){if(c.isTextContainer()){l=iterConvertBlocks(b,i);if(l){if(getFirstBlockInPara(c)){i=true}try{b.removeMe()}catch(g){c.removeChild(b)}}}else{if(j&&!isEmptyTextNode(b)){var k=l;l=iterConvertList(b,c,j,d,l);if(l){if(isElement(l)&&l.isListItem()){d++}i=true}else{l=k}}else{if(b.nodeType==document.ELEMENT_NODE||isTextNode(b)){iterConvertMain(b)}}}}b=f}if(i){var h=c;if(!j){c.setTextEx("");if(c.tagName!="P"){var a=document.createElement("p");a.cpStyle(c);a.id=c.id;a.moveFrom(c);c.parentNode.replaceChild(a,c);h=a}}else{c.removeMe()}mergeBlocksInPara(h)}else{if(c.tagName=="P"){if(c.textContent.trim().length==0){c.id=nextId.toString();nextId++;appendBlockInPara(c)}}}return i}function iterDone(c,a){if(!c){return}var j=false;if(a&&a==c.getListType()){j=true}else{a=null}var n=false;if(c.isPara()||c.isBlock()){if(c.isBlock()){var l=document.createElement("span");l.cpStyle(c);l.textContent=c.text;c.parentNode.replaceChild(l,c);n=true}else{if(c.isListItem()){var d=c.getListNumber();var k=c.getListType();if(k==="decimal"){var h=document.createElement("ol")}else{var h=document.createElement("ul")}if(k){h.setAttribute("list-style-type",k)}h.setAttribute("start",d);c.parentNode.insertBefore(h,c);while(c){var e=c.childNodes;if(e&&e.length>1){var m=document.createElement("li");for(var f=1;f<e.length;f++){styleNode=e[f];if(styleNode.text&&!(styleNode.tagName=="A"&&!styleNode.id)){var l=document.createElement("span");l.cpStyle(styleNode);l.textContent=styleNode.text;m.appendChild(l)}else{m.appendChild(styleNode.cloneNode(true))}}h.appendChild(m)}var g=getNearbyListItem(c,true);c.removeMe();c=g}return}}if(!n){c.removeAttribute("id")}}else{if(c.tagName=="WBR"&&c.parentNode.isBlock()){c.removeMe();n=true}}if(!n){var b=c.childNodes;if(b){for(var f=0;f<b.length;f++){if(b[f].nodeType!=document.ELEMENT_NODE){continue}iterDone(b[f])}}}}function done(){if(!isInEditingMode){return"Not in editing mode"}removeAssistants();iterDone(document.body,null);removeContent();isInEditingMode=false;return"Done Succeeded"}function removeAssistants(){recoverBlock();var a=document.body;if(!a){return}var f=$("editor");if(f){a.removeChild(f)}var c=$("ll");for(var d=0;d<10;d++){if(!c){break}var e=c.nextElementSibling;a.removeChild(c);c=e}var b=$("done");if(b){a.removeChild(b)}a.removeEventListener("keypress",handleKeyPress,false);a.removeEventListener("keyup",handleKeyUp,false);a.removeEventListener("click",handleClick,false);a.removeEventListener("touchstart",handleTouchStart,false);a.removeEventListener("touchend",handleClick,false)}function handleWindowResize(){updateEditorPosition();updateEditorBorder()}function initAll(){if(isInEditingMode){return"Already In Editing Mode"}var a=document.body;if(!a){return"document Error: No Body."}a.addEventListener("keydown",handleKeyDown,false);a.addEventListener("keypress",handleKeyPress,false);a.addEventListener("keyup",handleKeyUp,false);a.addEventListener("keyup",handleTextUpdate,false);a.addEventListener("click",handleClick,false);a.addEventListener("touchstart",handleTouchStart,false);a.addEventListener("touchend",handleTouchClick,false);window.addEventListener("resize",handleWindowResize,false);if(a.textContent){var c=a.textContent.trim();if(a.textContent.trim().length==0){a.appendChild(document.createElement("p"))}}nextId=1;if(a){appendContent(a);iterConvertMain(a);nextId=getMaxBlockId(a)+1;prepareAssistants()}isInEditingMode=true;var b=$("editor");return"init Succeed"}document.addEventListener("DOMContentLoaded",initAll,false);